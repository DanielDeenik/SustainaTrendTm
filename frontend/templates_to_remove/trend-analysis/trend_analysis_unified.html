{% extends "layouts/finchat_inspired_layout.html" %}

{% set active_page = 'trend-analysis' %}

{% block title %}Trend Analysis | SustainaTrendâ„¢{% endblock %}

{% block additional_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/sustainability-copilot.css') }}">
<style>
    /* Additional styles specific to trend analysis if needed */
    .finchat-trend-card {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }
    
    .finchat-trend-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .finchat-trend-title {
        font-size: 1.1rem;
        font-weight: 600;
    }
    
    .finchat-trend-category {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
        border-radius: 1rem;
        background-color: var(--primary-light);
        color: var(--primary);
    }
    
    .finchat-virality-meter {
        height: 8px;
        width: 100%;
        background-color: #efefef;
        border-radius: 4px;
        margin: 0.25rem 0;
        overflow: hidden;
    }
    
    .finchat-virality-fill {
        height: 100%;
        background-color: var(--primary);
        border-radius: 4px;
    }
    
    .finchat-trend-stats {
        display: flex;
        gap: 1rem;
        font-size: 0.85rem;
        color: var(--text-light);
    }
</style>
{% endblock %}

{% block header_title %}Sustainability Trend Analysis{% endblock %}

{% block header_actions %}
<span class="finchat-badge finchat-badge-primary">AI-POWERED</span>
<span class="finchat-badge finchat-badge-secondary">TREND INTELLIGENCE</span>
{% endblock %}

{% block main_content %}
<!-- Trend Overview -->
<div class="finchat-card">
    <div class="finchat-card-header">
        <div class="finchat-card-title">Sustainability Trend Intelligence</div>
        <div>
            <select id="category-filter" class="finchat-select">
                <option value="all">All Categories</option>
                {% for category in categories %}
                <option value="{{ category }}">{{ category|title }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="finchat-card-content">
        <p>Our AI-powered trend analysis identifies and tracks emerging sustainability topics, providing real-time insights into market movements and stakeholder sentiments.</p>
        
        <div class="finchat-alert finchat-alert-info finchat-mt-md">
            <i class="fas fa-info-circle"></i>
            <span>Trend virality scores measure the momentum and reach of sustainability topics based on market data, social signals, and regulatory developments.</span>
        </div>
    </div>
</div>

<!-- Trend Chart -->
<div class="finchat-card">
    <div class="finchat-card-header">
        <div class="finchat-card-title">Trend Virality Over Time</div>
        <span class="finchat-badge finchat-badge-primary">LIVE DATA</span>
    </div>
    <div class="finchat-card-content">
        <div class="finchat-chart-container" id="trend-chart" style="height: 320px;"></div>
    </div>
    <div class="finchat-card-footer">
        <div class="finchat-fs-sm finchat-text-light">
            <i class="fas fa-info-circle"></i> Higher virality scores indicate more significant trend momentum
        </div>
    </div>
</div>

<!-- Trend Cards Grid -->
<div class="finchat-card">
    <div class="finchat-card-header">
        <div class="finchat-card-title">Top Sustainability Trends</div>
        <div class="finchat-card-actions">
            <button id="refresh-trends" class="finchat-button finchat-button-sm finchat-button-outline">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>
    <div class="finchat-card-content">
        <div id="trend-cards-container" class="finchat-grid-2">
            <!-- Trend cards will be populated here -->
            <div class="finchat-loader">Loading trends...</div>
        </div>
    </div>
</div>

<!-- Category Distribution -->
<div class="finchat-card">
    <div class="finchat-card-header">
        <div class="finchat-card-title">Trend Category Distribution</div>
    </div>
    <div class="finchat-card-content">
        <div class="finchat-chart-container" id="category-distribution-chart" style="height: 280px;"></div>
    </div>
</div>

<!-- Predictive Analysis -->
<div class="finchat-card">
    <div class="finchat-card-header">
        <div class="finchat-card-title">Predictive Sustainability Analysis</div>
        <span class="finchat-badge finchat-badge-primary">AI-POWERED</span>
    </div>
    <div class="finchat-card-content">
        <div class="finchat-alert finchat-alert-info" style="display: flex; align-items: flex-start; gap: 1rem;">
            <i class="fas fa-lightbulb" style="margin-top: 0.25rem; color: #2196f3;"></i>
            <div>
                <div style="font-weight: 600; margin-bottom: 0.25rem;">Key Insights</div>
                <p style="margin-top: 0;">Based on current trend data, our AI predicts these emerging sustainability focus areas over the next 6-12 months:</p>
            </div>
        </div>
        
        <div class="finchat-mt-md finchat-grid-2">
            <div class="finchat-card">
                <div class="finchat-card-header">
                    <div class="finchat-card-title">1. Carbon Capture Technology</div>
                </div>
                <div class="finchat-card-content">
                    <p class="finchat-fs-sm">Projected to gain 35% momentum in the next 2 quarters as regulations tighten and market adoption increases.</p>
                </div>
            </div>
            
            <div class="finchat-card">
                <div class="finchat-card-header">
                    <div class="finchat-card-title">2. Water Footprint Optimization</div>
                </div>
                <div class="finchat-card-content">
                    <p class="finchat-fs-sm">Expected to become a priority focus area due to increased drought conditions and stakeholder pressure.</p>
                </div>
            </div>
            
            <div class="finchat-card">
                <div class="finchat-card-header">
                    <div class="finchat-card-title">3. Circular Supply Chains</div>
                </div>
                <div class="finchat-card-content">
                    <p class="finchat-fs-sm">Trend data indicates a 28% increase in market initiatives for closed-loop supply chain systems.</p>
                </div>
            </div>
            
            <div class="finchat-card">
                <div class="finchat-card-header">
                    <div class="finchat-card-title">4. Biodiversity Impact Assessment</div>
                </div>
                <div class="finchat-card-content">
                    <p class="finchat-fs-sm">Natural capital accounting is gaining traction with a 42% increase in corporate adoption expected.</p>
                </div>
            </div>
        </div>
        
        <div class="finchat-mt-lg finchat-text-center">
            <button class="finchat-button finchat-button-primary" id="trends-copilot-button">
                <i class="fas fa-robot" style="margin-right: 0.5rem;"></i> Ask the AI Co-Pilot About Trends
            </button>
            <p class="finchat-fs-sm finchat-text-light finchat-mt-sm">Get AI-powered predictions and recommendations for your specific industry and sustainability goals.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block insights_panel %}
<div class="finchat-insights-panel">
    <div class="finchat-insights-header">Trend Insights</div>
    
    <div class="finchat-insight-item">
        <div class="finchat-insight-title">Carbon Reduction</div>
        <div class="finchat-insight-content">
            Carbon emission reduction initiatives show a 42% increase in corporate adoption rates since Q1 2024.
        </div>
    </div>
    
    <div class="finchat-insight-item">
        <div class="finchat-insight-title">Regulatory Alignment</div>
        <div class="finchat-insight-content">
            ESRS compliance is growing as a priority trend with 37% more companies mentioning it in publications.
        </div>
    </div>
    
    <div class="finchat-insight-item">
        <div class="finchat-insight-title">Renewable Investment</div>
        <div class="finchat-insight-content">
            Trend analysis shows a 29% increase in renewable energy investments across the manufacturing sector.
        </div>
    </div>
    
    <div class="finchat-insight-item">
        <div class="finchat-insight-title">Circular Economy</div>
        <div class="finchat-insight-content">
            Circular business models are trending with 54% higher search volume and industry adoption.
        </div>
    </div>
    
    <div class="finchat-insight-item">
        <div class="finchat-insight-title">Water Conservation</div>
        <div class="finchat-insight-content">
            Water footprint reduction initiatives have increased 33% in virality over the past quarter.
        </div>
    </div>
</div>
{% endblock %}

{% block additional_scripts %}
<!-- Co-Pilot Integration -->
<script src="{{ url_for('static', filename='js/sustainability-copilot.js') }}"></script>

<!-- Trend Co-Pilot Context -->
<script type="application/json" id="trend-copilot-context">
{
    "context": "trend-analysis",
    "top_trends": [
        {"name": "Carbon Capture Technology", "category": "emissions", "virality": "high"},
        {"name": "Water Footprint Optimization", "category": "water", "virality": "medium-high"},
        {"name": "Circular Supply Chains", "category": "waste", "virality": "medium-high"},
        {"name": "Biodiversity Impact Assessment", "category": "environmental", "virality": "medium"}
    ],
    "suggested_prompts": [
        "Explain why carbon capture is trending now",
        "What industries should focus on water footprint?",
        "How can we implement circular supply chains?",
        "What are best practices for biodiversity assessment?",
        "Which sustainability trends will impact my industry?"
    ]
}
</script>

<!-- Trend Analysis Scripts -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize trend analysis
        initializeTrendAnalysis();
        
        // Set up category filter
        const categoryFilter = document.getElementById('category-filter');
        if (categoryFilter) {
            categoryFilter.addEventListener('change', function() {
                const category = this.value;
                loadTrendData(category);
            });
        }
        
        // Set up refresh button
        const refreshButton = document.getElementById('refresh-trends');
        if (refreshButton) {
            refreshButton.addEventListener('click', function() {
                const category = categoryFilter ? categoryFilter.value : 'all';
                loadTrendData(category, true);
            });
        }
        
        // Set up Co-Pilot button
        const trendsCopilotButton = document.getElementById('trends-copilot-button');
        if (trendsCopilotButton && window.copilotInstance) {
            trendsCopilotButton.addEventListener('click', function() {
                window.copilotInstance.toggleCopilot();
            });
        }
        
        // Initialize Co-Pilot context
        const trendContextElement = document.getElementById('trend-copilot-context');
        if (trendContextElement) {
            try {
                const contextData = JSON.parse(trendContextElement.textContent);
                // Set data attribute for Co-Pilot to read
                document.body.setAttribute('data-copilot-context', JSON.stringify(contextData));
                console.log('Trend Co-Pilot context loaded:', contextData);
            } catch (e) {
                console.error('Error parsing trend context:', e);
            }
        }
    });
    
    // Initialize trend analysis with data and charts
    function initializeTrendAnalysis() {
        // Load trend data
        loadTrendData('all');
    }
    
    // Load trend data from API
    function loadTrendData(category = 'all', forceRefresh = false) {
        const container = document.getElementById('trend-cards-container');
        const chartContainer = document.getElementById('trend-chart');
        const distributionContainer = document.getElementById('category-distribution-chart');
        
        if (container) {
            container.innerHTML = '<div class="finchat-loader">Loading trends...</div>';
        }
        
        // API URL with category filter
        let apiUrl = `/api/trends?source=mock_service`;
        if (category && category !== 'all') {
            apiUrl += `&category=${category}`;
        }
        if (forceRefresh) {
            apiUrl += `&refresh=true&t=${Date.now()}`;
        }
        
        // Fetch trend data
        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load trend data');
                }
                
                // Display trend cards
                displayTrendCards(container, data.trends);
                
                // Create trend chart
                if (chartContainer && data.chart_data) {
                    createTrendChart(chartContainer, data.chart_data);
                }
                
                // Create category distribution chart
                if (distributionContainer && data.category_counts) {
                    createDistributionChart(distributionContainer, data.category_counts);
                }
            })
            .catch(error => {
                console.error('Error loading trend data:', error);
                if (container) {
                    container.innerHTML = `<div class="finchat-alert finchat-alert-error">
                        <i class="fas fa-exclamation-circle"></i>
                        <span>Error loading trend data: ${error.message}</span>
                    </div>`;
                }
            });
    }
    
    // Display trend cards
    function displayTrendCards(container, trends) {
        if (!container || !trends || !trends.length) {
            container.innerHTML = '<div class="finchat-alert finchat-alert-info">No trend data available.</div>';
            return;
        }
        
        // Clear container
        container.innerHTML = '';
        
        // Add trend cards
        trends.forEach(trend => {
            // Limit to top 6 trends
            if (container.children.length >= 6) return;
            
            // Create trend card
            const card = document.createElement('div');
            card.className = 'finchat-card';
            
            // Format category name
            const categoryName = trend.category ? trend.category.charAt(0).toUpperCase() + trend.category.slice(1) : 'General';
            
            // Format trend momentum
            const momentum = trend.momentum || 'steady';
            const momentumIcon = momentum === 'rising' ? 'fa-arrow-up' : momentum === 'falling' ? 'fa-arrow-down' : 'fa-arrow-right';
            const momentumClass = momentum === 'rising' ? 'finchat-trend-up' : momentum === 'falling' ? 'finchat-trend-down' : '';
            
            // Determine virality score percentage (for meter)
            const viralityPercent = Math.min(100, Math.max(0, Math.round(trend.virality_score * 100)));
            
            // Populate card content
            card.innerHTML = `
                <div class="finchat-card-content finchat-trend-card">
                    <div class="finchat-trend-header">
                        <div class="finchat-trend-title">${trend.name}</div>
                        <div class="finchat-trend-category">${categoryName}</div>
                    </div>
                    
                    <div>
                        <div class="finchat-fs-sm">Virality: <strong>${Math.round(trend.virality_score * 100)}%</strong></div>
                        <div class="finchat-virality-meter">
                            <div class="finchat-virality-fill" style="width: ${viralityPercent}%"></div>
                        </div>
                    </div>
                    
                    <div class="finchat-trend-stats">
                        <div class="finchat-trend ${momentumClass}">
                            <i class="fas ${momentumIcon}"></i> ${momentum.charAt(0).toUpperCase() + momentum.slice(1)}
                        </div>
                        <div><i class="fas fa-calendar"></i> ${formatDate(trend.timestamp)}</div>
                    </div>
                </div>
            `;
            
            // Add card to container
            container.appendChild(card);
        });
    }
    
    // Create trend chart
    function createTrendChart(container, chartData) {
        if (!container || !chartData || !chartData.length) return;
        
        // Prepare data for Plotly
        const timestamps = chartData.map(point => point.timestamp);
        const categories = Object.keys(chartData[0]).filter(key => key !== 'timestamp');
        
        const traces = categories.map(category => {
            return {
                type: 'scatter',
                mode: 'lines',
                name: category.charAt(0).toUpperCase() + category.slice(1),
                x: timestamps,
                y: chartData.map(point => point[category] * 100), // Convert to percentage
                line: {
                    width: 3
                }
            };
        });
        
        // Create the Plotly chart
        Plotly.newPlot(container, traces, {
            margin: { t: 10, r: 10, b: 40, l: 60 },
            xaxis: {
                title: 'Date',
                showgrid: true,
                gridcolor: '#eee'
            },
            yaxis: {
                title: 'Virality Score (%)',
                showgrid: true,
                gridcolor: '#eee',
                range: [0, 100]
            },
            legend: {
                orientation: 'h',
                y: -0.2
            },
            template: 'plotly_white'
        }, {
            responsive: true
        });
    }
    
    // Create category distribution chart
    function createDistributionChart(container, categoryData) {
        if (!container || !categoryData) return;
        
        // Prepare data for Plotly
        const categories = Object.keys(categoryData);
        const counts = Object.values(categoryData);
        
        // Create color array (customize as needed)
        const colors = [
            '#2196F3', '#4CAF50', '#FF9800', '#F44336', '#9C27B0',
            '#3F51B5', '#00BCD4', '#009688', '#FFEB3B', '#795548'
        ];
        
        // Create the Plotly chart (pie chart)
        Plotly.newPlot(container, [{
            type: 'pie',
            labels: categories.map(cat => cat.charAt(0).toUpperCase() + cat.slice(1)),
            values: counts,
            hole: 0.4,
            marker: {
                colors: colors.slice(0, categories.length)
            },
            textinfo: 'label+percent',
            hoverinfo: 'label+value+percent'
        }], {
            margin: { t: 10, r: 10, b: 10, l: 10 },
            showlegend: false,
            template: 'plotly_white'
        }, {
            responsive: true
        });
    }
    
    // Format date string
    function formatDate(dateStr) {
        if (!dateStr) return 'N/A';
        
        try {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        } catch (e) {
            return dateStr;
        }
    }
</script>
{% endblock %}