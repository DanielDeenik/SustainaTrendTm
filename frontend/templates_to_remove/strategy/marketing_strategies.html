{% extends "layouts/finchat_inspired_layout.html" %}

{% set active_page = 'marketing-strategies' %}

{% block title %}Marketing Strategies | SustainaTrendâ„¢{% endblock %}

{% block additional_styles %}
<style>
    .strategy-card {
        border-radius: 10px;
        transition: transform 0.2s, box-shadow 0.2s;
        height: 100%;
    }
    
    .strategy-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .category-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.75rem;
        border-radius: 50px;
        display: inline-block;
        font-weight: 500;
    }
    
    .category-badge.storytelling {
        background-color: rgba(41, 128, 185, 0.15);
        color: #2980b9;
    }
    
    .category-badge.stakeholder {
        background-color: rgba(46, 204, 113, 0.15);
        color: #27ae60;
    }
    
    .category-badge.metrics {
        background-color: rgba(155, 89, 182, 0.15);
        color: #8e44ad;
    }
    
    .category-badge.channels {
        background-color: rgba(230, 126, 34, 0.15);
        color: #d35400;
    }
    
    .category-badge.branding {
        background-color: rgba(231, 76, 60, 0.15);
        color: #c0392b;
    }
    
    .effectiveness-indicator {
        height: 6px;
        border-radius: 3px;
        background-color: #ecf0f1;
        margin-top: 8px;
    }
    
    .effectiveness-indicator .bar {
        height: 100%;
        border-radius: 3px;
        background-color: #3498db;
    }
    
    .strategy-header {
        padding: 20px;
        background-color: rgba(52, 152, 219, 0.05);
        border-radius: 10px;
        margin-bottom: 20px;
    }
    
    .category-filter {
        display: inline-block;
        margin-right: 10px;
        margin-bottom: 10px;
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        background-color: #ecf0f1;
        color: #7f8c8d;
        transition: all 0.2s;
    }
    
    .category-filter.active {
        background-color: #3498db;
        color: white;
    }
    
    .complexity-indicator {
        font-size: 0.8rem;
        padding: 2px 8px;
        border-radius: 4px;
        display: inline-block;
    }
    
    .complexity-low {
        background-color: rgba(46, 204, 113, 0.15);
        color: #27ae60;
    }
    
    .complexity-medium {
        background-color: rgba(241, 196, 15, 0.15);
        color: #f39c12;
    }
    
    .complexity-high, .complexity-very_high {
        background-color: rgba(231, 76, 60, 0.15);
        color: #c0392b;
    }
    
    .recommendation-card {
        border-left: 4px solid #3498db;
        margin-top: 20px;
        transition: transform 0.2s;
    }
    
    .recommendation-card:hover {
        transform: translateX(5px);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="mb-0">Marketing Strategies</h1>
                <div>
                    <button type="button" class="btn btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#analysisModal">
                        <i class="bi bi-search"></i> Analyze Current Strategy
                    </button>
                    <button type="button" class="btn btn-primary" id="getRecommendationsBtn" data-bs-toggle="modal" data-bs-target="#recommendationsModal">
                        <i class="bi bi-lightbulb"></i> Get Recommendations
                    </button>
                </div>
            </div>
            <p class="text-muted">Effective marketing strategies for sustainability communication and ESG reporting</p>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-12">
            <div class="strategy-header">
                <h5 class="mb-3">Filter by Category</h5>
                <div>
                    <div class="category-filter {% if category == 'all' %}active{% endif %}" data-category="all">All Strategies</div>
                    {% for cat_id, cat_name in categories.items() %}
                    <div class="category-filter {% if category == cat_id %}active{% endif %}" data-category="{{ cat_id }}">{{ cat_name }}</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="row" id="strategiesContainer">
        {% for strategy in strategies %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card strategy-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <span class="category-badge {{ strategy.category }}">{{ categories[strategy.category] }}</span>
                        <span class="complexity-indicator complexity-{{ strategy.implementation_complexity }}">
                            {{ strategy.implementation_complexity|replace('_', ' ')|title }} Complexity
                        </span>
                    </div>
                    <h5 class="card-title">{{ strategy.name }}</h5>
                    <p class="card-text">{{ strategy.description }}</p>
                    
                    <div class="mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="text-muted small">Effectiveness</span>
                            <span class="text-muted small">{{ strategy.effectiveness }}%</span>
                        </div>
                        <div class="effectiveness-indicator">
                            <div class="bar" style="width: {{ strategy.effectiveness }}%;"></div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <h6 class="mb-2">Best Channels:</h6>
                        <div>
                            {% for channel in strategy.best_channels %}
                            <span class="badge bg-light text-dark me-1 mb-1">{{ channel|replace('_', ' ')|title }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <h6 class="mb-1">Example:</h6>
                        <p class="small text-muted fst-italic">{{ strategy.example }}</p>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Analysis Modal -->
<div class="modal fade" id="analysisModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Analyze Current Marketing Strategy</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="analysisForm">
                    <div class="mb-3">
                        <label for="contentInput" class="form-label">Paste your sustainability communication content:</label>
                        <textarea class="form-control" id="contentInput" rows="10" placeholder="Paste content from your sustainability reports, marketing materials, or website..."></textarea>
                        <div class="form-text">Content should be at least 500 characters for meaningful analysis.</div>
                    </div>
                </form>
                
                <div id="analysisResults" style="display: none;">
                    <h5 class="mb-3">Analysis Results</h5>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">Overall Score</h6>
                                    <div class="d-flex align-items-center">
                                        <div class="display-4 me-3" id="overallScoreDisplay">--</div>
                                        <div class="effectiveness-indicator flex-grow-1">
                                            <div class="bar" id="overallScoreBar" style="width: 0%;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">Category Scores</h6>
                                    <div id="categoryScores"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">Strengths</h6>
                                    <div id="strengthsList"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">Improvement Areas</h6>
                                    <div id="gapsList"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">Recommended Strategies</h6>
                            <div id="recommendationsList"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="analyzeBtn">Analyze</button>
            </div>
        </div>
    </div>
</div>

<!-- Recommendations Modal -->
<div class="modal fade" id="recommendationsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Personalized Strategy Recommendations</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="recommendationsForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="industrySelect" class="form-label">Industry</label>
                            <select class="form-select" id="industrySelect" required>
                                <option value="" selected disabled>Select industry...</option>
                                <option value="technology">Technology</option>
                                <option value="consumer_goods">Consumer Goods</option>
                                <option value="financial">Financial Services</option>
                                <option value="energy">Energy</option>
                                <option value="healthcare">Healthcare</option>
                                <option value="manufacturing">Manufacturing</option>
                                <option value="real_estate">Real Estate</option>
                                <option value="transportation">Transportation</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="audienceSelect" class="form-label">Primary Audience</label>
                            <select class="form-select" id="audienceSelect" required>
                                <option value="" selected disabled>Select audience...</option>
                                <option value="investors">Investors</option>
                                <option value="consumers">Consumers</option>
                                <option value="employees">Employees</option>
                                <option value="regulators">Regulators</option>
                                <option value="partners">Partners & Suppliers</option>
                                <option value="community">Community & NGOs</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Goals (Select up to 3)</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input class="form-check-input goal-checkbox" type="checkbox" value="increase_awareness" id="goal1">
                                    <label class="form-check-label" for="goal1">Increase Sustainability Awareness</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input goal-checkbox" type="checkbox" value="build_trust" id="goal2">
                                    <label class="form-check-label" for="goal2">Build Trust & Credibility</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input goal-checkbox" type="checkbox" value="enhance_reporting" id="goal3">
                                    <label class="form-check-label" for="goal3">Enhance ESG Reporting</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input class="form-check-input goal-checkbox" type="checkbox" value="improve_engagement" id="goal4">
                                    <label class="form-check-label" for="goal4">Improve Stakeholder Engagement</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input goal-checkbox" type="checkbox" value="differentiate_brand" id="goal5">
                                    <label class="form-check-label" for="goal5">Differentiate Brand</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input goal-checkbox" type="checkbox" value="address_challenges" id="goal6">
                                    <label class="form-check-label" for="goal6">Address Sustainability Challenges</label>
                                </div>
                            </div>
                        </div>
                        <div class="text-danger small" id="goalsError" style="display: none;">Please select at least one goal (maximum 3)</div>
                    </div>
                </form>
                
                <div id="personalizedRecommendations" style="display: none;">
                    <h5 class="mb-3">Your Personalized Recommendations</h5>
                    <div id="recommendationsContainer"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="getPersonalizedBtn">Get Recommendations</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Category filters
        const categoryFilters = document.querySelectorAll('.category-filter');
        categoryFilters.forEach(filter => {
            filter.addEventListener('click', function() {
                const category = this.getAttribute('data-category');
                window.location.href = `/marketing-strategies?category=${category}`;
            });
        });
        
        // Analysis modal
        const analyzeBtn = document.getElementById('analyzeBtn');
        const analysisForm = document.getElementById('analysisForm');
        const analysisResults = document.getElementById('analysisResults');
        
        if (analyzeBtn) {
            analyzeBtn.addEventListener('click', function() {
                const contentInput = document.getElementById('contentInput');
                const content = contentInput.value.trim();
                
                if (content.length < 100) {
                    alert('Please provide more content for meaningful analysis (at least 100 characters).');
                    return;
                }
                
                // Simulate API call
                fetch('/api/analyze-strategy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ content: content })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayAnalysisResults(data.analysis);
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred during analysis.');
                });
            });
        }
        
        function displayAnalysisResults(analysis) {
            // Show results section
            analysisResults.style.display = 'block';
            
            // Update overall score
            document.getElementById('overallScoreDisplay').textContent = analysis.overall_score;
            document.getElementById('overallScoreBar').style.width = `${analysis.overall_score}%`;
            
            // Update category scores
            const categoryScoresContainer = document.getElementById('categoryScores');
            categoryScoresContainer.innerHTML = '';
            
            for (const [category, score] of Object.entries(analysis.category_scores)) {
                const categoryName = getCategoryName(category);
                const scoreItem = document.createElement('div');
                scoreItem.classList.add('mb-2');
                
                scoreItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="small">${categoryName}</span>
                        <span class="small">${score}%</span>
                    </div>
                    <div class="effectiveness-indicator">
                        <div class="bar" style="width: ${score}%;"></div>
                    </div>
                `;
                
                categoryScoresContainer.appendChild(scoreItem);
            }
            
            // Update strengths
            const strengthsList = document.getElementById('strengthsList');
            strengthsList.innerHTML = '';
            
            if (analysis.strengths.length === 0) {
                strengthsList.innerHTML = '<p class="text-muted small">No significant strengths identified.</p>';
            } else {
                analysis.strengths.forEach(strength => {
                    const strengthItem = document.createElement('div');
                    strengthItem.classList.add('mb-3');
                    
                    strengthItem.innerHTML = `
                        <h6>${strength.name} <span class="badge bg-success">${strength.score}%</span></h6>
                        <p class="small mb-0">${strength.description}</p>
                    `;
                    
                    strengthsList.appendChild(strengthItem);
                });
            }
            
            // Update gaps
            const gapsList = document.getElementById('gapsList');
            gapsList.innerHTML = '';
            
            if (analysis.gaps.length === 0) {
                gapsList.innerHTML = '<p class="text-muted small">No significant gaps identified.</p>';
            } else {
                analysis.gaps.forEach(gap => {
                    const gapItem = document.createElement('div');
                    gapItem.classList.add('mb-3');
                    
                    gapItem.innerHTML = `
                        <h6>${gap.name} <span class="badge bg-warning text-dark">${gap.score}%</span></h6>
                        <p class="small mb-0">${gap.description}</p>
                    `;
                    
                    gapsList.appendChild(gapItem);
                });
            }
            
            // Update recommendations
            const recommendationsList = document.getElementById('recommendationsList');
            recommendationsList.innerHTML = '';
            
            if (analysis.recommendations.length === 0) {
                recommendationsList.innerHTML = '<p class="text-muted small">No specific recommendations available.</p>';
            } else {
                analysis.recommendations.forEach(recommendation => {
                    const recommendationItem = document.createElement('div');
                    recommendationItem.classList.add('card', 'recommendation-card', 'mb-3');
                    
                    recommendationItem.innerHTML = `
                        <div class="card-body">
                            <h6 class="mb-2">${recommendation.name}</h6>
                            <p class="small mb-2">${recommendation.description}</p>
                            <p class="small text-muted mb-0"><strong>Why:</strong> ${recommendation.rationale}</p>
                        </div>
                    `;
                    
                    recommendationsList.appendChild(recommendationItem);
                });
            }
        }
        
        // Recommendations modal
        const getPersonalizedBtn = document.getElementById('getPersonalizedBtn');
        const recommendationsForm = document.getElementById('recommendationsForm');
        const personalizedRecommendations = document.getElementById('personalizedRecommendations');
        const goalCheckboxes = document.querySelectorAll('.goal-checkbox');
        const goalsError = document.getElementById('goalsError');
        
        // Limit goal selection to 3
        goalCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const checked = document.querySelectorAll('.goal-checkbox:checked');
                if (checked.length > 3) {
                    this.checked = false;
                }
                
                goalsError.style.display = 'none';
            });
        });
        
        if (getPersonalizedBtn) {
            getPersonalizedBtn.addEventListener('click', function() {
                const industrySelect = document.getElementById('industrySelect');
                const audienceSelect = document.getElementById('audienceSelect');
                const checkedGoals = document.querySelectorAll('.goal-checkbox:checked');
                
                if (!industrySelect.value || !audienceSelect.value || checkedGoals.length === 0) {
                    if (checkedGoals.length === 0) {
                        goalsError.style.display = 'block';
                    }
                    return;
                }
                
                const selectedGoals = Array.from(checkedGoals).map(checkbox => checkbox.value);
                
                // API call for recommendations
                fetch('/api/marketing-recommendations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        industry: industrySelect.value,
                        goals: selectedGoals,
                        audience: audienceSelect.value
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayPersonalizedRecommendations(data.recommendations);
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while getting recommendations.');
                });
            });
        }
        
        function displayPersonalizedRecommendations(recommendations) {
            // Show results section
            personalizedRecommendations.style.display = 'block';
            
            // Update recommendations
            const recommendationsContainer = document.getElementById('recommendationsContainer');
            recommendationsContainer.innerHTML = '';
            
            if (recommendations.length === 0) {
                recommendationsContainer.innerHTML = '<p class="text-muted">No matching strategies found for your requirements.</p>';
                return;
            }
            
            recommendations.forEach(recommendation => {
                const card = document.createElement('div');
                card.classList.add('card', 'mb-4');
                
                const relevanceClass = recommendation.relevance_score >= 80 ? 'text-success' : 
                                      (recommendation.relevance_score >= 60 ? 'text-primary' : 'text-muted');
                
                card.innerHTML = `
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <span class="category-badge ${recommendation.category}">${getCategoryName(recommendation.category)}</span>
                            <span class="badge bg-light ${relevanceClass}">Relevance: ${recommendation.relevance_score}%</span>
                        </div>
                        <h5 class="card-title">${recommendation.name}</h5>
                        <p class="card-text">${recommendation.description}</p>
                        
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <h6 class="mb-1">Implementation Notes:</h6>
                                    <p class="small">${recommendation.implementation_notes}</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <h6 class="mb-1">Resource Requirements:</h6>
                                    <ul class="small">
                                        <li><strong>Budget:</strong> ${recommendation.resource_requirements.budget}</li>
                                        <li><strong>Team:</strong> ${recommendation.resource_requirements.team}</li>
                                        <li><strong>Expertise:</strong> ${recommendation.resource_requirements.expertise}</li>
                                        ${recommendation.resource_requirements.expertise_focus ? `<li><strong>Focus:</strong> ${recommendation.resource_requirements.expertise_focus}</li>` : ''}
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <h6 class="mb-1">Example:</h6>
                                    <p class="small text-muted fst-italic">${recommendation.example}</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <h6 class="mb-1">Timeframe:</h6>
                                    <p class="small">${recommendation.estimated_timeframe}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                recommendationsContainer.appendChild(card);
            });
        }
        
        function getCategoryName(categoryId) {
            const categories = {
                "storytelling": "Storytelling & Narratives",
                "stakeholder": "Stakeholder Engagement",
                "metrics": "Impact Metrics & KPIs",
                "channels": "Communication Channels",
                "branding": "Sustainable Branding"
            };
            
            return categories[categoryId] || categoryId;
        }
    });
</script>
{% endblock %}