{% extends "layouts/collapsible_layout.html" %}

{% block title %}AI Search | SustainaTrendâ„¢{% endblock %}

{% block header_title %}Sustainability Search{% endblock %}

{% block header_actions %}
    <button class="btn-primary" id="toggle-copilot-button" onclick="window.copilotInstance.toggleCopilot()">
        <span class="material-icons">smart_toy</span>
        Open Co-Pilot
    </button>
{% endblock %}

{% block additional_css %}
<style>
    .search-container {
        max-width: 800px;
        margin: 0 auto;
    }
    .search-result {
        margin-bottom: 20px;
        padding: 15px;
        border-radius: 5px;
        background-color: #f8f9fa;
        border-left: 4px solid #198754;
        transition: all 0.3s ease;
        opacity: 1;
    }
    .search-result.new-result {
        animation: fadeIn 0.5s ease-in-out;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .search-highlight {
        background-color: rgba(25, 135, 84, 0.1);
        padding: 0 3px;
        border-radius: 3px;
    }
    .search-metadata {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 8px;
    }
    .search-confidence {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: bold;
        color: white;
    }
    .confidence-high {
        background-color: #198754;
    }
    .confidence-medium {
        background-color: #ffc107;
        color: #212529;
    }
    .confidence-low {
        background-color: #dc3545;
    }
    .result-actions {
        margin-top: 10px;
    }
    .result-action-button {
        font-size: 0.85rem;
        padding: 2px 8px;
        background: none;
        border: 1px solid #ced4da;
        border-radius: 3px;
        color: #6c757d;
        margin-right: 5px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .result-action-button:hover {
        background-color: #f8f9fa;
        color: #198754;
        border-color: #198754;
    }
    .search-source {
        background-color: #e9ecef;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: bold;
        margin-right: 5px;
        color: #495057;
    }
    .category-badge {
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: bold;
        margin-right: 5px;
    }
    .category-climate {
        background-color: #198754;
        color: white;
    }
    .category-energy {
        background-color: #fd7e14;
        color: white;
    }
    .category-water {
        background-color: #0d6efd;
        color: white;
    }
    .category-waste {
        background-color: #6c757d;
        color: white;
    }
    .category-social {
        background-color: #6f42c1;
        color: white;
    }
    
    .search-loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #198754;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 10px;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .live-search-toggle {
        margin-left: 10px;
        font-size: 0.85rem;
    }
    .search-error {
        display: none;
        padding: 10px;
        background-color: #f8d7da;
        color: #842029;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    .search-stats {
        font-size: 0.85rem;
        color: #6c757d;
        margin-bottom: 15px;
    }
    
    /* Filter panel styles */
    .filter-panel {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .filter-panel .form-label {
        font-weight: 600;
        font-size: 0.9rem;
        color: #495057;
    }
    .filter-panel .form-select, 
    .filter-panel .form-check {
        margin-bottom: 0.5rem;
    }
    .filter-badge {
        display: inline-block;
        background-color: #e9ecef;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        margin-right: 5px;
        margin-bottom: 5px;
        color: #495057;
    }
    .filter-badge button {
        background: none;
        border: none;
        padding: 0;
        margin-left: 5px;
        cursor: pointer;
        color: #6c757d;
    }
    .filter-badge button:hover {
        color: #dc3545;
    }
    
    /* AI summary styles */
    .summary-container {
        background-color: #f0f9ff;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        border-left: 4px solid #0dcaf0;
        display: none;
    }
    .summary-title {
        color: #0a58ca;
        font-weight: 600;
        margin-bottom: 10px;
    }
    .summary-content {
        line-height: 1.6;
    }
    .summary-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="st-content-area">
    <div class="st-content-header">
        <div class="st-content-header-info">
            <h1 class="st-content-title">Sustainability Search</h1>
            <p class="st-content-description">Search for sustainability insights across multiple sources</p>
        </div>
    </div>

    <div class="st-data-card">
        <div class="st-data-card-header">
            <h3 class="st-data-card-title">AI Co-Pilot Upgrade</h3>
            <button class="st-data-toggle">
                <span class="material-icons">expand_more</span>
            </button>
        </div>
        <div class="st-data-content">
            <p class="lead mb-4">Our search functionality has been enhanced with an intelligent AI Co-Pilot</p>
            
            <div class="mb-4">
                <h4>Benefits of the new Co-Pilot:</h4>
                <ul class="st-feature-list">
                    <li><span class="material-icons text-success">check_circle</span> Natural language conversations instead of simple searches</li>
                    <li><span class="material-icons text-success">check_circle</span> Context-aware responses that understand your sustainability goals</li>
                    <li><span class="material-icons text-success">check_circle</span> Actionable insights tailored to your specific questions</li>
                    <li><span class="material-icons text-success">check_circle</span> Persistent conversation history to build on previous insights</li>
                </ul>
            </div>
            
            <button class="st-btn-primary" onclick="window.copilotInstance.toggleCopilot()">
                <span class="material-icons">smart_toy</span> Open the AI Co-Pilot
            </button>
            
            <p class="mt-3 text-muted">Try asking: "What sustainability trends should I focus on in 2025?"</p>
        </div>
    </div>

    <div class="st-data-card">
        <div class="st-data-card-header">
            <h3 class="st-data-card-title">Search</h3>
            <button class="st-data-toggle">
                <span class="material-icons">expand_more</span>
            </button>
        </div>
        <div class="st-data-content">
            <div class="search-container">
                <div class="search-form-container mb-4">
                    <form action="/search" method="get" id="search-form">
                        <div class="st-input-group">
                            <input type="text" 
                                   class="st-input-text" 
                                   name="query" 
                                   id="search-query"
                                   placeholder="Search for sustainability insights..." 
                                   value="{{ query }}" 
                                   autocomplete="off"
                                   required>
                            <button type="submit" class="st-btn-primary">
                                <span class="material-icons">search</span>
                            </button>
                            <input type="hidden" name="model" value="{{ model }}">
                            <input type="hidden" name="collapsible" value="true">
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <div>
                                <button type="button" class="st-btn-text" id="toggle-filters">
                                    <span class="material-icons">tune</span> Filters
                                </button>
                                
                                <div class="live-search-toggle">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="live-search-toggle" checked>
                                        <label class="form-check-label" for="live-search-toggle">Live Search</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <button type="button" class="st-btn-text" id="summarize-results" disabled>
                                    <span class="material-icons">summarize</span> AI Summary
                                </button>
                            </div>
                        </div>
                    </form>
                    
                    <div class="search-error" id="search-error"></div>
                    
                    <div class="filter-panel" id="filter-options" style="display: none;">
                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label">Categories</label>
                                <div>
                                    <div class="form-check">
                                        <input class="form-check-input category-filter" type="checkbox" value="climate" id="filter-climate">
                                        <label class="form-check-label" for="filter-climate">
                                            Climate
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input category-filter" type="checkbox" value="energy" id="filter-energy">
                                        <label class="form-check-label" for="filter-energy">
                                            Energy
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input category-filter" type="checkbox" value="water" id="filter-water">
                                        <label class="form-check-label" for="filter-water">
                                            Water
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input category-filter" type="checkbox" value="waste" id="filter-waste">
                                        <label class="form-check-label" for="filter-waste">
                                            Waste
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input category-filter" type="checkbox" value="social" id="filter-social">
                                        <label class="form-check-label" for="filter-social">
                                            Social Impact
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Time Period</label>
                                <select class="form-select" id="date-filter">
                                    <option value="all" selected>All Time</option>
                                    <option value="week">Last Week</option>
                                    <option value="month">Last Month</option>
                                    <option value="year">Last Year</option>
                                </select>
                                <label class="form-label mt-3">Sort By</label>
                                <select class="form-select" id="sort-filter">
                                    <option value="relevance" selected>Relevance</option>
                                    <option value="date-new">Date (Newest First)</option>
                                    <option value="date-old">Date (Oldest First)</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Source</label>
                                <div class="form-check">
                                    <input class="form-check-input source-filter" type="checkbox" value="DuckDuckGo" id="filter-duckduckgo" checked>
                                    <label class="form-check-label" for="filter-duckduckgo">
                                        <span class="material-icons">public</span> DuckDuckGo
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input source-filter" type="checkbox" value="Sustainability AI" id="filter-ai" checked>
                                    <label class="form-check-label" for="filter-ai">
                                        <span class="material-icons">psychology</span> Sustainability AI
                                    </label>
                                </div>
                                <label class="form-label mt-3">Confidence Level</label>
                                <div class="form-check">
                                    <input class="form-check-input confidence-filter" type="checkbox" value="high" id="filter-high" checked>
                                    <label class="form-check-label" for="filter-high">
                                        High
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input confidence-filter" type="checkbox" value="medium" id="filter-medium" checked>
                                    <label class="form-check-label" for="filter-medium">
                                        Medium
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input confidence-filter" type="checkbox" value="low" id="filter-low" checked>
                                    <label class="form-check-label" for="filter-low">
                                        Low
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <button type="button" class="st-btn-secondary" id="reset-filters">Reset</button>
                            <button type="button" class="st-btn-primary" id="apply-filters">Apply Filters</button>
                        </div>
                    </div>
                    
                    <div id="active-filters" class="mb-3 mt-2" style="display: none;"></div>
                </div>
                
                <div class="search-stats" id="search-stats" style="display: none;">
                    Showing <span id="filtered-count">0</span> results for "<span id="search-query-display">{{ query }}</span>"
                </div>
                
                <div class="summary-container" id="summary-container">
                    <div class="summary-title">
                        <span class="material-icons">summarize</span> AI Summary
                    </div>
                    <div class="summary-content" id="summary-content"></div>
                    <div class="summary-loading" id="summary-loading">
                        <div class="search-loading-spinner"></div>
                        <div>Generating summary...</div>
                    </div>
                </div>
                
                <div class="search-loading" id="search-loading" style="display: none;">
                    <div class="search-loading-spinner"></div>
                    <div>Searching...</div>
                </div>
                
                <div class="search-results" id="search-results">
                    {% if results %}
                        {% for result in results %}
                            <div class="search-result">
                                <h3><a href="{{ result.url }}" target="_blank">{{ result.title }}</a></h3>
                                <div class="search-url">{{ result.source_display }}</div>
                                <p class="search-description">{{ result.description }}</p>
                                <div class="search-metadata">
                                    {% if result.source %}
                                        <span class="search-source">{{ result.source }}</span>
                                    {% endif %}
                                    {% if result.date %}
                                        <span class="search-date">{{ result.date }}</span>
                                    {% endif %}
                                    {% if result.category %}
                                        <span class="category-badge category-{{ result.category|lower }}">{{ result.category }}</span>
                                    {% endif %}
                                    {% if result.confidence %}
                                        <span class="search-confidence confidence-{{ result.confidence|lower }}">{{ result.confidence|upper }}</span>
                                    {% endif %}
                                </div>
                                <div class="result-actions">
                                    <button class="result-action-button save-button">
                                        <span class="material-icons">bookmark</span> Save
                                    </button>
                                    <button class="result-action-button share-button">
                                        <span class="material-icons">share</span> Share
                                    </button>
                                    <button class="result-action-button analyze-button">
                                        <span class="material-icons">insights</span> Analyze
                                    </button>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        {% if query %}
                            <div class="no-results">
                                <h3>No results found for "{{ query }}"</h3>
                                <p>Try modifying your search terms or use the AI Co-Pilot for more advanced assistance.</p>
                                <button class="st-btn-primary mt-3" onclick="window.copilotInstance.toggleCopilot()">
                                    <span class="material-icons">smart_toy</span> Open the AI Co-Pilot
                                </button>
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/sustainability-copilot.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchForm = document.getElementById('search-form');
        const searchQuery = document.getElementById('search-query');
        const searchResults = document.getElementById('search-results');
        const searchLoading = document.getElementById('search-loading');
        const searchError = document.getElementById('search-error');
        const searchStats = document.getElementById('search-stats');
        const searchQueryDisplay = document.getElementById('search-query-display');
        const liveSearchToggle = document.getElementById('live-search-toggle');
        const toggleFiltersBtn = document.getElementById('toggle-filters');
        const filterOptions = document.getElementById('filter-options');
        const applyFiltersBtn = document.getElementById('apply-filters');
        const resetFiltersBtn = document.getElementById('reset-filters');
        const activeFiltersContainer = document.getElementById('active-filters');
        const filteredCountDisplay = document.getElementById('filtered-count');
        const categoryFilters = document.querySelectorAll('.category-filter');
        const sourceFilters = document.querySelectorAll('.source-filter');
        const confidenceFilters = document.querySelectorAll('.confidence-filter');
        const dateFilter = document.getElementById('date-filter');
        const sortFilter = document.getElementById('sort-filter');
        const summarizeBtn = document.getElementById('summarize-results');
        const summaryContainer = document.getElementById('summary-container');
        const summaryContent = document.getElementById('summary-content');
        const summaryLoading = document.getElementById('summary-loading');

        let debounceTimer;
        let lastQuery = '';
        let isSearching = false;
        let currentFilters = {
            categories: [],
            dateRange: 'all',
            sources: ['DuckDuckGo', 'Sustainability AI'],
            confidenceLevels: ['high', 'medium', 'low'],
            sortBy: 'relevance'
        };
        let allResults = []; // Store all results for filtering

        // Toggle filter panel
        if (toggleFiltersBtn && filterOptions) {
            toggleFiltersBtn.addEventListener('click', function() {
                const isVisible = filterOptions.style.display !== 'none';
                filterOptions.style.display = isVisible ? 'none' : 'block';
                toggleFiltersBtn.innerHTML = isVisible ? 
                    '<span class="material-icons">tune</span> Filters' : 
                    '<span class="material-icons">tune</span> Close Filters';
            });
        }

        // Apply filters
        if (applyFiltersBtn) {
            applyFiltersBtn.addEventListener('click', function() {
                // Get selected categories
                currentFilters.categories = [];
                categoryFilters.forEach(filter => {
                    if (filter.checked) {
                        currentFilters.categories.push(filter.value);
                    }
                });

                // Get selected sources
                currentFilters.sources = [];
                sourceFilters.forEach(filter => {
                    if (filter.checked) {
                        currentFilters.sources.push(filter.value);
                    }
                });

                // Get selected confidence levels
                currentFilters.confidenceLevels = [];
                confidenceFilters.forEach(filter => {
                    if (filter.checked) {
                        currentFilters.confidenceLevels.push(filter.value);
                    }
                });

                // Get date range
                currentFilters.dateRange = dateFilter ? dateFilter.value : 'all';

                // Get sort order
                currentFilters.sortBy = sortFilter ? sortFilter.value : 'relevance';

                // Update active filters display
                updateActiveFilters();

                // Apply filters to results
                filterResults();

                // Close filter panel
                if (filterOptions) {
                    filterOptions.style.display = 'none';
                    if (toggleFiltersBtn) {
                        toggleFiltersBtn.innerHTML = '<span class="material-icons">tune</span> Filters';
                    }
                }
            });
        }

        // Reset filters
        if (resetFiltersBtn) {
            resetFiltersBtn.addEventListener('click', function() {
                // Reset category filters
                categoryFilters.forEach(filter => {
                    filter.checked = false;
                });

                // Reset source filters
                sourceFilters.forEach(filter => {
                    filter.checked = true;
                });

                // Reset confidence filters
                confidenceFilters.forEach(filter => {
                    filter.checked = true;
                });

                // Reset date filter
                if (dateFilter) {
                    dateFilter.value = 'all';
                }

                // Reset sort filter
                if (sortFilter) {
                    sortFilter.value = 'relevance';
                }

                // Reset current filters
                currentFilters = {
                    categories: [],
                    dateRange: 'all',
                    sources: ['DuckDuckGo', 'Sustainability AI'],
                    confidenceLevels: ['high', 'medium', 'low'],
                    sortBy: 'relevance'
                };

                // Update active filters display
                updateActiveFilters();

                // Apply filters to results
                filterResults();
            });
        }

        // Update active filters display
        function updateActiveFilters() {
            if (!activeFiltersContainer) return;
            
            // Clear current filters
            activeFiltersContainer.innerHTML = '';
            
            let hasFilters = false;
            
            // Add category filters
            if (currentFilters.categories.length > 0) {
                hasFilters = true;
                currentFilters.categories.forEach(category => {
                    const badge = document.createElement('span');
                    badge.className = 'filter-badge';
                    badge.innerHTML = `Category: ${category} <button data-type="category" data-value="${category}">Ã—</button>`;
                    activeFiltersContainer.appendChild(badge);
                });
            }
            
            // Add date range filter if not 'all'
            if (currentFilters.dateRange !== 'all') {
                hasFilters = true;
                const badge = document.createElement('span');
                badge.className = 'filter-badge';
                badge.innerHTML = `Time: ${currentFilters.dateRange} <button data-type="date" data-value="${currentFilters.dateRange}">Ã—</button>`;
                activeFiltersContainer.appendChild(badge);
            }
            
            // Add source filters if not all sources
            if (currentFilters.sources.length < sourceFilters.length) {
                hasFilters = true;
                currentFilters.sources.forEach(source => {
                    const badge = document.createElement('span');
                    badge.className = 'filter-badge';
                    badge.innerHTML = `Source: ${source} <button data-type="source" data-value="${source}">Ã—</button>`;
                    activeFiltersContainer.appendChild(badge);
                });
            }
            
            // Add confidence filters if not all confidence levels
            if (currentFilters.confidenceLevels.length < confidenceFilters.length) {
                hasFilters = true;
                currentFilters.confidenceLevels.forEach(level => {
                    const badge = document.createElement('span');
                    badge.className = 'filter-badge';
                    badge.innerHTML = `Confidence: ${level} <button data-type="confidence" data-value="${level}">Ã—</button>`;
                    activeFiltersContainer.appendChild(badge);
                });
            }
            
            // Add sort filter if not relevance
            if (currentFilters.sortBy !== 'relevance') {
                hasFilters = true;
                const sortLabel = currentFilters.sortBy === 'date-new' ? 'Newest First' : 
                                 currentFilters.sortBy === 'date-old' ? 'Oldest First' : 
                                 currentFilters.sortBy;
                const badge = document.createElement('span');
                badge.className = 'filter-badge';
                badge.innerHTML = `Sort: ${sortLabel} <button data-type="sort" data-value="${currentFilters.sortBy}">Ã—</button>`;
                activeFiltersContainer.appendChild(badge);
            }
            
            // Show/hide active filters container
            activeFiltersContainer.style.display = hasFilters ? 'block' : 'none';
            
            // Add event listeners to remove buttons
            const removeButtons = activeFiltersContainer.querySelectorAll('button');
            removeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const type = this.getAttribute('data-type');
                    const value = this.getAttribute('data-value');
                    
                    // Remove the filter
                    if (type === 'category') {
                        currentFilters.categories = currentFilters.categories.filter(c => c !== value);
                        const checkbox = document.getElementById(`filter-${value}`);
                        if (checkbox) checkbox.checked = false;
                    } else if (type === 'date') {
                        currentFilters.dateRange = 'all';
                        if (dateFilter) dateFilter.value = 'all';
                    } else if (type === 'source') {
                        currentFilters.sources = currentFilters.sources.filter(s => s !== value);
                        const checkbox = document.getElementById(`filter-${value.toLowerCase()}`);
                        if (checkbox) checkbox.checked = false;
                    } else if (type === 'confidence') {
                        currentFilters.confidenceLevels = currentFilters.confidenceLevels.filter(c => c !== value);
                        const checkbox = document.getElementById(`filter-${value}`);
                        if (checkbox) checkbox.checked = false;
                    } else if (type === 'sort') {
                        currentFilters.sortBy = 'relevance';
                        if (sortFilter) sortFilter.value = 'relevance';
                    }
                    
                    // Update active filters display
                    updateActiveFilters();
                    
                    // Apply filters to results
                    filterResults();
                });
            });
        }

        // Filter results based on current filters
        function filterResults() {
            if (!searchResults || allResults.length === 0) return;
            
            // Filter results based on current filters
            let filteredResults = allResults;
            
            // Filter by category if categories are selected
            if (currentFilters.categories.length > 0) {
                filteredResults = filteredResults.filter(result => {
                    return currentFilters.categories.includes(result.category);
                });
            }
            
            // Filter by source
            filteredResults = filteredResults.filter(result => {
                return currentFilters.sources.includes(result.source);
            });
            
            // Filter by confidence level
            filteredResults = filteredResults.filter(result => {
                return currentFilters.confidenceLevels.includes(result.confidence);
            });
            
            // Filter by date range
            if (currentFilters.dateRange !== 'all') {
                const now = new Date();
                let cutoffDate;
                
                if (currentFilters.dateRange === 'week') {
                    cutoffDate = new Date(now.setDate(now.getDate() - 7));
                } else if (currentFilters.dateRange === 'month') {
                    cutoffDate = new Date(now.setMonth(now.getMonth() - 1));
                } else if (currentFilters.dateRange === 'year') {
                    cutoffDate = new Date(now.setFullYear(now.getFullYear() - 1));
                }
                
                filteredResults = filteredResults.filter(result => {
                    if (!result.date) return false;
                    const resultDate = new Date(result.date);
                    return resultDate >= cutoffDate;
                });
            }
            
            // Sort results
            if (currentFilters.sortBy === 'date-new') {
                filteredResults.sort((a, b) => {
                    if (!a.date) return 1;
                    if (!b.date) return -1;
                    return new Date(b.date) - new Date(a.date);
                });
            } else if (currentFilters.sortBy === 'date-old') {
                filteredResults.sort((a, b) => {
                    if (!a.date) return 1;
                    if (!b.date) return -1;
                    return new Date(a.date) - new Date(b.date);
                });
            } else {
                // Sort by relevance (default sort)
                filteredResults.sort((a, b) => b.relevance - a.relevance);
            }
            
            // Update the filtered count
            if (filteredCountDisplay) {
                filteredCountDisplay.textContent = filteredResults.length;
            }
            
            // Show/hide stats
            if (searchStats) {
                searchStats.style.display = allResults.length > 0 ? 'block' : 'none';
            }
            
            // Update search query display
            if (searchQueryDisplay) {
                searchQueryDisplay.textContent = searchQuery.value;
            }
            
            // Clear results container
            searchResults.innerHTML = '';
            
            // Enable/disable summarize button
            if (summarizeBtn) {
                summarizeBtn.disabled = filteredResults.length === 0;
            }
            
            // Add filtered results to the container
            if (filteredResults.length > 0) {
                filteredResults.forEach((result, index) => {
                    const resultElement = document.createElement('div');
                    resultElement.className = 'search-result';
                    
                    // Add animation class for new results
                    setTimeout(() => {
                        resultElement.classList.add('new-result');
                    }, index * 50);
                    
                    // Format the result HTML
                    resultElement.innerHTML = `
                        <h3><a href="${result.url}" target="_blank">${result.title}</a></h3>
                        <div class="search-url">${result.source_display || result.url}</div>
                        <p class="search-description">${result.description}</p>
                        <div class="search-metadata">
                            ${result.source ? `<span class="search-source">${result.source}</span>` : ''}
                            ${result.date ? `<span class="search-date">${result.date}</span>` : ''}
                            ${result.category ? `<span class="category-badge category-${result.category.toLowerCase()}">${result.category}</span>` : ''}
                            ${result.confidence ? `<span class="search-confidence confidence-${result.confidence.toLowerCase()}">${result.confidence.toUpperCase()}</span>` : ''}
                        </div>
                        <div class="result-actions">
                            <button class="result-action-button save-button">
                                <span class="material-icons">bookmark</span> Save
                            </button>
                            <button class="result-action-button share-button">
                                <span class="material-icons">share</span> Share
                            </button>
                            <button class="result-action-button analyze-button">
                                <span class="material-icons">insights</span> Analyze
                            </button>
                        </div>
                    `;
                    
                    searchResults.appendChild(resultElement);
                });
            } else {
                const noResults = document.createElement('div');
                noResults.className = 'no-results';
                noResults.innerHTML = `
                    <h3>No results match your filters</h3>
                    <p>Try changing your filter settings or start a new search.</p>
                `;
                searchResults.appendChild(noResults);
            }
        }

        // Handle search form submission
        if (searchForm) {
            searchForm.addEventListener('submit', function(e) {
                if (!searchQuery.value.trim()) {
                    // Don't submit if query is empty
                    e.preventDefault();
                    return;
                }
                
                if (isSearching) {
                    // Don't submit if already searching
                    e.preventDefault();
                    return;
                }
                
                // If live search is disabled or if the page is being loaded for the first time, allow the form submission
                if (!liveSearchToggle || !liveSearchToggle.checked) {
                    // Regular form submission
                    return;
                }
                
                // Otherwise, handle with AJAX for live search
                e.preventDefault();
                performSearch(searchQuery.value);
            });
        }

        // Handle live search with input event
        if (searchQuery && liveSearchToggle) {
            searchQuery.addEventListener('input', function() {
                if (!liveSearchToggle.checked) return;
                
                const query = searchQuery.value.trim();
                
                // Don't search if query is too short or the same as the last query
                if (query.length < 3 || query === lastQuery) return;
                
                // Clear any existing timer
                clearTimeout(debounceTimer);
                
                // Set a new timer to delay the search
                debounceTimer = setTimeout(() => {
                    performSearch(query);
                }, 500);
            });
        }

        // Perform search via AJAX
        function performSearch(query) {
            if (isSearching || !query) return;
            
            // Update last query
            lastQuery = query;
            
            // Show loading indicator
            isSearching = true;
            if (searchLoading) searchLoading.style.display = 'flex';
            if (searchError) searchError.style.display = 'none';
            
            // Make API request
            fetch(`/api/realtime-search?query=${encodeURIComponent(query)}&model=hybrid`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Search error: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Store all results
                        allResults = data.results;
                        
                        // Assign confidence and category if not present
                        allResults.forEach(result => {
                            if (!result.confidence) {
                                result.confidence = 'medium';
                            }
                            if (!result.category) {
                                // Assign a category based on keywords in title or description
                                const text = (result.title + ' ' + result.description).toLowerCase();
                                if (text.includes('carbon') || text.includes('emission') || text.includes('climate')) {
                                    result.category = 'climate';
                                } else if (text.includes('energy') || text.includes('electricity') || text.includes('renewable')) {
                                    result.category = 'energy';
                                } else if (text.includes('water') || text.includes('ocean') || text.includes('marine')) {
                                    result.category = 'water';
                                } else if (text.includes('waste') || text.includes('recycle') || text.includes('circular')) {
                                    result.category = 'waste';
                                } else if (text.includes('social') || text.includes('community') || text.includes('diversity')) {
                                    result.category = 'social';
                                } else {
                                    result.category = 'climate'; // Default
                                }
                            }
                            // Add relevance score for sorting
                            if (!result.relevance) {
                                result.relevance = Math.random() * 0.5 + 0.5; // Random between 0.5 and 1.0
                            }
                        });
                        
                        // Filter results
                        filterResults();
                        
                        // Show query explanation if available
                        if (data.explanation) {
                            const explanationElement = document.createElement('div');
                            explanationElement.className = 'search-explanation mb-4';
                            explanationElement.innerHTML = `
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">AI-Enhanced Query Understanding</h5>
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text">${data.explanation}</p>
                                    </div>
                                </div>
                            `;
                            if (searchResults.previousElementSibling.className !== 'search-explanation') {
                                searchResults.parentNode.insertBefore(explanationElement, searchResults);
                            }
                        }
                    } else {
                        throw new Error(data.error || 'Unknown search error');
                    }
                })
                .catch(error => {
                    console.error('Search error:', error);
                    if (searchError) {
                        searchError.textContent = `Search error: ${error.message}`;
                        searchError.style.display = 'block';
                    }
                    
                    if (searchResults) {
                        searchResults.innerHTML = `
                            <div class="no-results">
                                <h3>Search Error</h3>
                                <p>${error.message}</p>
                                <p>Try again or use the AI Co-Pilot for assistance.</p>
                                <button class="st-btn-primary mt-3" onclick="window.copilotInstance.toggleCopilot()">
                                    <span class="material-icons">smart_toy</span> Open the AI Co-Pilot
                                </button>
                            </div>
                        `;
                    }
                })
                .finally(() => {
                    // Hide loading indicator
                    isSearching = false;
                    if (searchLoading) searchLoading.style.display = 'none';
                });
        }

        // Handle AI summary generation
        if (summarizeBtn) {
            summarizeBtn.addEventListener('click', function() {
                if (allResults.length === 0) return;
                
                // Show summary container and loading
                if (summaryContainer) summaryContainer.style.display = 'block';
                if (summaryContent) summaryContent.style.display = 'none';
                if (summaryLoading) summaryLoading.style.display = 'flex';
                
                // Create a combined text of all results for the summary
                const combinedText = allResults.map(result => 
                    `Title: ${result.title}\nDescription: ${result.description}`
                ).join('\n\n');
                
                // Make API request to summarize
                fetch('/api/summarize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: combinedText,
                        query: searchQuery.value
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Summary error: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success && data.summary) {
                        // Display the summary
                        if (summaryContent) {
                            summaryContent.innerHTML = data.summary.replace(/\n/g, '<br>');
                            summaryContent.style.display = 'block';
                        }
                    } else {
                        throw new Error(data.error || 'Failed to generate summary');
                    }
                })
                .catch(error => {
                    console.error('Summary error:', error);
                    if (summaryContent) {
                        summaryContent.innerHTML = `<div class="error">Error generating summary: ${error.message}</div>`;
                        summaryContent.style.display = 'block';
                    }
                })
                .finally(() => {
                    if (summaryLoading) summaryLoading.style.display = 'none';
                });
            });
        }

        // Initialize on page load
        if (searchQuery && searchQuery.value) {
            // Show filter buttons if there's a query
            if (searchStats) searchStats.style.display = 'block';
            
            // Set the query display
            if (searchQueryDisplay) {
                searchQueryDisplay.textContent = searchQuery.value;
            }
            
            // Initialize results from the server-rendered results
            if (searchResults) {
                const resultElements = searchResults.querySelectorAll('.search-result');
                
                allResults = Array.from(resultElements).map(element => {
                    const titleEl = element.querySelector('h3 a');
                    const urlEl = element.querySelector('.search-url');
                    const descriptionEl = element.querySelector('.search-description');
                    const sourceEl = element.querySelector('.search-source');
                    const dateEl = element.querySelector('.search-date');
                    const categoryEl = element.querySelector('.category-badge');
                    const confidenceEl = element.querySelector('.search-confidence');
                    
                    return {
                        title: titleEl ? titleEl.textContent : '',
                        url: titleEl ? titleEl.getAttribute('href') : '',
                        source_display: urlEl ? urlEl.textContent : '',
                        description: descriptionEl ? descriptionEl.textContent : '',
                        source: sourceEl ? sourceEl.textContent : 'DuckDuckGo',
                        date: dateEl ? dateEl.textContent : '',
                        category: categoryEl ? categoryEl.textContent : 'climate',
                        confidence: confidenceEl ? confidenceEl.textContent.toLowerCase() : 'medium',
                        relevance: 1.0 - (Math.random() * 0.5) // Random between 0.5 and 1.0
                    };
                });
                
                // Enable the summarize button if there are results
                if (summarizeBtn) {
                    summarizeBtn.disabled = allResults.length === 0;
                }
                
                // Update filtered count
                if (filteredCountDisplay) {
                    filteredCountDisplay.textContent = allResults.length;
                }
            }
        }

        // Initialize Co-Pilot
        if (window.initSustainabilityCopilot) {
            window.initSustainabilityCopilot({
                defaultGreeting: "Hi! I'm your Sustainability Co-Pilot. How can I help you understand sustainability trends today?",
                suggestedPrompts: [
                    "What are the latest trends in carbon emissions reduction?",
                    "Explain the EU's CSRD and its impact on businesses",
                    "How can companies improve their water sustainability metrics?",
                    "What are the best practices for sustainability reporting?"
                ]
            });
        }
    });
</script>
{% endblock %}