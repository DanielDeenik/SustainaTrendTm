{% extends "base.html" %}

{% block title %}Company Sustainability Search{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block styles %}
<style>
    .search-header {
        background-color: var(--primary-dark);
        padding: 30px 0;
        border-radius: 10px;
        margin-bottom: 30px;
    }
    
    .search-container {
        max-width: 800px;
        margin: 0 auto;
    }
    
    .result-card {
        border-radius: 10px;
        transition: transform 0.2s, box-shadow 0.2s;
        margin-bottom: 20px;
        overflow: hidden;
        border: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }
    
    .result-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
    }
    
    .result-source {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .source-sustainability_reports {
        background-color: rgba(46, 204, 113, 0.15);
        color: #27ae60;
    }
    
    .source-news_articles {
        background-color: rgba(52, 152, 219, 0.15);
        color: #2980b9;
    }
    
    .source-social_media {
        background-color: rgba(155, 89, 182, 0.15);
        color: #8e44ad;
    }
    
    .source-ngo_reports {
        background-color: rgba(230, 126, 34, 0.15);
        color: #d35400;
    }
    
    .source-regulatory_filings {
        background-color: rgba(52, 73, 94, 0.15);
        color: #2c3e50;
    }
    
    .result-date {
        font-size: 0.85rem;
        color: var(--text-muted);
    }
    
    .result-title {
        font-weight: 600;
        margin: 10px 0;
        line-height: 1.4;
    }
    
    .result-description {
        color: var(--text-secondary);
        font-size: 0.9rem;
        line-height: 1.5;
    }
    
    .category-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        background-color: rgba(52, 152, 219, 0.1);
        color: #3498db;
        margin-right: 5px;
        margin-bottom: 5px;
    }
    
    .relevance-score {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-weight: 600;
        font-size: 0.85rem;
    }
    
    .high-relevance {
        background-color: rgba(46, 204, 113, 0.15);
        color: #27ae60;
    }
    
    .medium-relevance {
        background-color: rgba(241, 196, 15, 0.15);
        color: #f39c12;
    }
    
    .low-relevance {
        background-color: rgba(231, 76, 60, 0.15);
        color: #e74c3c;
    }
    
    .filter-section {
        background-color: var(--card-bg);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }
    
    .filter-header {
        font-weight: 600;
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .filter-option {
        margin-bottom: 10px;
    }
    
    .sources-legend {
        margin-top: 20px;
    }
    
    .source-legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
    }
    
    .source-indicator {
        width: 12px;
        height: 12px;
        border-radius: 2px;
        margin-right: 8px;
    }
    
    .source-sustainability_reports-color {
        background-color: #27ae60;
    }
    
    .source-news_articles-color {
        background-color: #2980b9;
    }
    
    .source-social_media-color {
        background-color: #8e44ad;
    }
    
    .source-ngo_reports-color {
        background-color: #d35400;
    }
    
    .source-regulatory_filings-color {
        background-color: #2c3e50;
    }
    
    .sentiment-container {
        background-color: var(--card-bg);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }
    
    .sentiment-label {
        font-weight: 600;
        margin-bottom: 5px;
    }
    
    .sentiment-positive {
        color: #27ae60;
    }
    
    .sentiment-negative {
        color: #e74c3c;
    }
    
    .sentiment-neutral {
        color: #7f8c8d;
    }
    
    .sentiment-score {
        height: 6px;
        background-color: #ecf0f1;
        border-radius: 3px;
        margin-bottom: 10px;
        overflow: hidden;
    }
    
    .sentiment-fill-positive {
        height: 100%;
        background-color: #27ae60;
    }
    
    .sentiment-fill-negative {
        height: 100%;
        background-color: #e74c3c;
    }
    
    .sentiment-fill-neutral {
        height: 100%;
        background-color: #7f8c8d;
    }
    
    .esrs-distribution-chart {
        height: 200px;
    }
    
    .virality-metrics {
        background-color: var(--card-bg);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }
    
    .virality-score-container {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    .virality-score-circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #3498db, #9b59b6);
        color: white;
        font-weight: 700;
        font-size: 1.5rem;
        margin-bottom: 10px;
    }
    
    .virality-trend {
        font-weight: 600;
        font-size: 0.9rem;
    }
    
    .trend-increasing {
        color: #27ae60;
    }
    
    .trend-stable {
        color: #3498db;
    }
    
    .trend-decreasing {
        color: #e74c3c;
    }
    
    .virality-metric-item {
        margin-bottom: 10px;
    }
    
    .virality-metric-label {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-bottom: 5px;
        display: flex;
        justify-content: space-between;
    }
    
    .virality-metric-bar {
        height: 6px;
        background-color: #ecf0f1;
        border-radius: 3px;
        overflow: hidden;
    }
    
    .virality-metric-fill {
        height: 100%;
        background-color: #3498db;
    }
    
    .popular-companies {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 15px;
    }
    
    .company-pill {
        padding: 8px 15px;
        background-color: var(--card-bg);
        border-radius: 20px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: background-color 0.2s;
        border: 1px solid var(--border-color);
    }
    
    .company-pill:hover {
        background-color: var(--primary-light);
        color: white;
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        display: none;
    }
    
    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    .loading-text {
        color: white;
        margin-top: 15px;
        font-weight: 600;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="search-header">
    <div class="container">
        <div class="search-container">
            <h1 class="text-white mb-2">Company Sustainability Search</h1>
            <p class="text-white-50 mb-4">Analyze company sustainability performance with sentiment and virality metrics</p>
            
            <div class="input-group mb-3">
                <input type="text" id="companySearchInput" class="form-control form-control-lg" placeholder="Enter company name..." aria-label="Enter company name">
                <button class="btn btn-primary btn-lg" type="button" id="searchButton">
                    <i class="bi bi-search me-2"></i> Search
                </button>
            </div>
            
            <div class="popular-companies">
                {% for company in top_companies %}
                <div class="company-pill" onclick="searchCompany('{{ company }}')">{{ company }}</div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row" id="resultsContainer" style="display:none;">
        <div class="col-lg-4">
            <div class="filter-section">
                <div class="filter-header">
                    <span>Filter Results</span>
                    <button class="btn btn-sm btn-outline-secondary" id="resetFiltersBtn">Reset</button>
                </div>
                
                <div class="mb-4">
                    <label class="form-label">Data Sources</label>
                    {% for source_id, source_data in data_sources.items() %}
                    <div class="filter-option">
                        <div class="form-check">
                            <input class="form-check-input source-filter" type="checkbox" value="{{ source_id }}" id="source{{ source_id }}" checked>
                            <label class="form-check-label d-flex justify-content-between" for="source{{ source_id }}">
                                <span>{{ source_data.name }}</span>
                                <span class="badge bg-secondary">0</span>
                            </label>
                        </div>
                        <div class="form-text small text-muted">{{ source_data.description }}</div>
                    </div>
                    {% endfor %}
                </div>
                
                <div>
                    <label class="form-label">ESRS Categories</label>
                    {% for category_id, category_data in esrs_categories.items() %}
                    <div class="filter-option">
                        <div class="form-check">
                            <input class="form-check-input category-filter" type="checkbox" value="{{ category_id }}" id="category{{ category_id }}" checked>
                            <label class="form-check-label d-flex justify-content-between" for="category{{ category_id }}">
                                <span>{{ category_id }}: {{ category_data.name }}</span>
                                <span class="badge bg-secondary">0</span>
                            </label>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <div class="sentiment-container">
                <h5 class="mb-3">Sentiment Analysis</h5>
                <div id="sentimentContainer">
                    <div class="text-center py-4 text-muted">
                        <i class="bi bi-emoji-neutral" style="font-size: 2rem;"></i>
                        <p class="mt-2">No sentiment data available</p>
                    </div>
                </div>
            </div>
            
            <div class="virality-metrics">
                <h5 class="mb-3">Virality Metrics</h5>
                <div id="viralityContainer">
                    <div class="text-center py-4 text-muted">
                        <i class="bi bi-graph-up" style="font-size: 2rem;"></i>
                        <p class="mt-2">No virality data available</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-8">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 id="resultsTitle">Company Sustainability Results</h3>
                <div class="d-flex align-items-center">
                    <div class="dropdown me-2">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="sortDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            Sort by: Relevance
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="sortDropdown">
                            <li><a class="dropdown-item sort-option" data-sort="relevance" href="#">Relevance</a></li>
                            <li><a class="dropdown-item sort-option" data-sort="date" href="#">Date (Newest)</a></li>
                            <li><a class="dropdown-item sort-option" data-sort="sentiment" href="#">Sentiment (Positive)</a></li>
                        </ul>
                    </div>
                    <span class="badge bg-primary" id="resultCount">0 results</span>
                </div>
            </div>
            
            <div class="mb-4">
                <canvas id="esrsDistributionChart" class="esrs-distribution-chart"></canvas>
            </div>
            
            <div id="searchResults">
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-search" style="font-size: 3rem;"></i>
                    <h4 class="mt-3">No Results Yet</h4>
                    <p>Search for a company to view sustainability analysis</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row" id="noResultsContainer">
        <div class="col-12 text-center py-5">
            <img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f50d.svg" alt="Search" style="width: 80px; margin-bottom: 20px;">
            <h3>Search for Company Sustainability Data</h3>
            <p class="text-muted w-75 mx-auto">
                Enter a company name to search for sustainability information across multiple sources.
                The system analyzes sentiment, matches against ESRS frameworks, and tracks virality metrics
                to provide comprehensive sustainability intelligence.
            </p>
            <div class="mt-4">
                <h5>Try searching for these companies:</h5>
                <div class="d-flex flex-wrap justify-content-center gap-2 mt-3">
                    {% for company in top_companies %}
                    <button class="btn btn-outline-primary" onclick="searchCompany('{{ company }}')">{{ company }}</button>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Analyzing sustainability data...</div>
</div>

<script>
    // DOM Elements
    const searchInput = document.getElementById('companySearchInput');
    const searchButton = document.getElementById('searchButton');
    const resultsContainer = document.getElementById('resultsContainer');
    const noResultsContainer = document.getElementById('noResultsContainer');
    const searchResults = document.getElementById('searchResults');
    const resultCount = document.getElementById('resultCount');
    const resultsTitle = document.getElementById('resultsTitle');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const resetFiltersBtn = document.getElementById('resetFiltersBtn');
    const sourceFilters = document.querySelectorAll('.source-filter');
    const categoryFilters = document.querySelectorAll('.category-filter');
    const sortOptions = document.querySelectorAll('.sort-option');
    const sortDropdown = document.getElementById('sortDropdown');
    
    // Chart variables
    let esrsDistributionChart = null;
    
    // Search results data
    let searchResultsData = null;
    
    // Current sort option
    let currentSort = 'relevance';
    
    // Initialize event listeners
    function initEventListeners() {
        // Search button click
        searchButton.addEventListener('click', () => {
            const companyName = searchInput.value.trim();
            if (companyName) {
                searchCompany(companyName);
            }
        });
        
        // Enter key in search input
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const companyName = searchInput.value.trim();
                if (companyName) {
                    searchCompany(companyName);
                }
            }
        });
        
        // Reset filters
        resetFiltersBtn.addEventListener('click', resetFilters);
        
        // Source filters
        sourceFilters.forEach(filter => {
            filter.addEventListener('change', filterResults);
        });
        
        // Category filters
        categoryFilters.forEach(filter => {
            filter.addEventListener('change', filterResults);
        });
        
        // Sort options
        sortOptions.forEach(option => {
            option.addEventListener('click', (e) => {
                e.preventDefault();
                const sortBy = e.target.getAttribute('data-sort');
                currentSort = sortBy;
                sortDropdown.innerText = `Sort by: ${getSortLabel(sortBy)}`;
                if (searchResultsData) {
                    sortResults(sortBy);
                }
            });
        });
    }
    
    // Get sort option label
    function getSortLabel(sortBy) {
        switch (sortBy) {
            case 'relevance':
                return 'Relevance';
            case 'date':
                return 'Date (Newest)';
            case 'sentiment':
                return 'Sentiment (Positive)';
            default:
                return 'Relevance';
        }
    }
    
    // Reset all filters
    function resetFilters() {
        sourceFilters.forEach(filter => {
            filter.checked = true;
        });
        
        categoryFilters.forEach(filter => {
            filter.checked = true;
        });
        
        filterResults();
    }
    
    // Search for a company
    function searchCompany(companyName) {
        // Update search input
        searchInput.value = companyName;
        
        // Show loading overlay
        loadingOverlay.style.display = 'flex';
        
        // Make API request
        fetch(`/api/company-search?company_name=${encodeURIComponent(companyName)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    searchResultsData = data.results;
                    displayResults(data.results);
                } else {
                    alert('Error searching for company: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error searching for company. Please try again.');
                
                // Use mock data for testing purposes
                const mockData = getMockResults(companyName);
                searchResultsData = mockData;
                displayResults(mockData);
            })
            .finally(() => {
                // Hide loading overlay
                loadingOverlay.style.display = 'none';
            });
    }
    
    // Display search results
    function displayResults(results) {
        // Show results container, hide no results container
        resultsContainer.style.display = 'flex';
        noResultsContainer.style.display = 'none';
        
        // Update results title and count
        resultsTitle.textContent = `${results.company} Sustainability Results`;
        resultCount.textContent = `${results.result_count} results`;
        
        // Render ESRS distribution chart
        renderEsrsDistributionChart(results.esrs_distribution);
        
        // Render sentiment analysis
        renderSentimentAnalysis(results.sentiment_analysis);
        
        // Render virality metrics
        renderViralityMetrics(results.virality_metrics);
        
        // Update filter counts
        updateFilterCounts(results.results);
        
        // Sort results
        sortResults(currentSort);
    }
    
    // Render ESRS distribution chart
    function renderEsrsDistributionChart(distribution) {
        if (!distribution) return;
        
        const ctx = document.getElementById('esrsDistributionChart').getContext('2d');
        
        // Extract data
        const categories = [];
        const counts = [];
        const colors = [];
        
        // Define colors for different category types
        const colorMap = {
            'E': 'rgba(46, 204, 113, 0.7)',  // Environmental
            'S': 'rgba(52, 152, 219, 0.7)',  // Social
            'G': 'rgba(155, 89, 182, 0.7)'   // Governance
        };
        
        // Process data
        for (const [categoryId, data] of Object.entries(distribution.categories)) {
            if (data.count > 0) {
                categories.push(categoryId);
                counts.push(data.count);
                
                // Set color based on category prefix
                const prefix = categoryId.charAt(0);
                colors.push(colorMap[prefix] || 'rgba(149, 165, 166, 0.7)');
            }
        }
        
        // Destroy existing chart if it exists
        if (esrsDistributionChart) {
            esrsDistributionChart.destroy();
        }
        
        // Create new chart
        esrsDistributionChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: categories,
                datasets: [{
                    label: 'ESRS Distribution',
                    data: counts,
                    backgroundColor: colors,
                    borderColor: colors.map(color => color.replace('0.7', '1')),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'ESRS Category Distribution'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const categoryId = context.label;
                                const categoryName = distribution.categories[categoryId]?.name || '';
                                const count = context.raw;
                                const percentage = distribution.categories[categoryId]?.percentage || 0;
                                return [`${categoryName}`, `Count: ${count} (${percentage}%)`];
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Result Count'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'ESRS Category'
                        }
                    }
                }
            }
        });
    }
    
    // Render sentiment analysis
    function renderSentimentAnalysis(sentiment) {
        const container = document.getElementById('sentimentContainer');
        container.innerHTML = '';
        
        if (!sentiment) {
            container.innerHTML = `
                <div class="text-center py-4 text-muted">
                    <i class="bi bi-emoji-neutral" style="font-size: 2rem;"></i>
                    <p class="mt-2">No sentiment data available</p>
                </div>
            `;
            return;
        }
        
        // Overall sentiment
        const overallScore = sentiment.overall_score * 100;
        let sentimentClass = 'sentiment-neutral';
        let sentimentIcon = 'bi-emoji-neutral';
        
        if (sentiment.overall_sentiment === 'positive') {
            sentimentClass = 'sentiment-positive';
            sentimentIcon = 'bi-emoji-smile';
        } else if (sentiment.overall_sentiment === 'negative') {
            sentimentClass = 'sentiment-negative';
            sentimentIcon = 'bi-emoji-frown';
        }
        
        container.innerHTML = `
            <div class="text-center mb-4">
                <i class="bi ${sentimentIcon} ${sentimentClass}" style="font-size: 2.5rem;"></i>
                <h3 class="${sentimentClass}">${sentiment.overall_sentiment.toUpperCase()}</h3>
            </div>
            
            <div class="sentiment-label ${sentimentClass}">Overall Sentiment</div>
            <div class="sentiment-score">
                <div class="sentiment-fill-${sentiment.overall_sentiment}" style="width: ${overallScore}%"></div>
            </div>
            <div class="d-flex justify-content-between mb-4">
                <span class="small text-muted">Negative</span>
                <span class="small text-muted">Neutral</span>
                <span class="small text-muted">Positive</span>
            </div>
        `;
        
        // Most positive and negative categories
        if (sentiment.most_positive_category) {
            container.innerHTML += `
                <div class="mb-3">
                    <div class="sentiment-label sentiment-positive">
                        <i class="bi bi-arrow-up-circle me-1"></i>
                        Most Positive: ${sentiment.most_positive_category.name}
                    </div>
                    <div class="sentiment-score">
                        <div class="sentiment-fill-positive" style="width: ${sentiment.most_positive_category.score * 100}%"></div>
                    </div>
                </div>
            `;
        }
        
        if (sentiment.most_negative_category) {
            container.innerHTML += `
                <div>
                    <div class="sentiment-label sentiment-negative">
                        <i class="bi bi-arrow-down-circle me-1"></i>
                        Most Negative: ${sentiment.most_negative_category.name}
                    </div>
                    <div class="sentiment-score">
                        <div class="sentiment-fill-negative" style="width: ${sentiment.most_negative_category.score * 100}%"></div>
                    </div>
                </div>
            `;
        }
        
        // Analysis method
        container.innerHTML += `
            <div class="mt-3 small text-muted">
                Analysis method: ${sentiment.analysis_type === 'bert' ? 'AI Model (BERT)' : 'Rule-based'}
            </div>
        `;
    }
    
    // Render virality metrics
    function renderViralityMetrics(virality) {
        const container = document.getElementById('viralityContainer');
        container.innerHTML = '';
        
        if (!virality) {
            container.innerHTML = `
                <div class="text-center py-4 text-muted">
                    <i class="bi bi-graph-up" style="font-size: 2rem;"></i>
                    <p class="mt-2">No virality data available</p>
                </div>
            `;
            return;
        }
        
        // Determine trend icon and class
        let trendIcon = 'bi-arrow-right';
        let trendClass = 'trend-stable';
        
        if (virality.trend_direction.includes('increasing')) {
            trendIcon = 'bi-arrow-up';
            trendClass = 'trend-increasing';
        } else if (virality.trend_direction.includes('decreasing')) {
            trendIcon = 'bi-arrow-down';
            trendClass = 'trend-decreasing';
        }
        
        container.innerHTML = `
            <div class="d-flex justify-content-between mb-4">
                <div class="virality-score-container">
                    <div class="virality-score-circle">${virality.virality_score.toFixed(0)}</div>
                    <div class="virality-trend ${trendClass}">
                        <i class="bi ${trendIcon} me-1"></i>${virality.trend_direction}
                    </div>
                </div>
                <div class="mt-2">
                    <div class="virality-metric-item">
                        <div class="virality-metric-label">
                            <span>Recency</span>
                            <span>${virality.recency_score}%</span>
                        </div>
                        <div class="virality-metric-bar">
                            <div class="virality-metric-fill" style="width: ${virality.recency_score}%; background-color: #2ecc71;"></div>
                        </div>
                    </div>
                    <div class="virality-metric-item">
                        <div class="virality-metric-label">
                            <span>Source Diversity</span>
                            <span>${virality.source_diversity}%</span>
                        </div>
                        <div class="virality-metric-bar">
                            <div class="virality-metric-fill" style="width: ${virality.source_diversity}%; background-color: #3498db;"></div>
                        </div>
                    </div>
                    <div class="virality-metric-item">
                        <div class="virality-metric-label">
                            <span>Category Coverage</span>
                            <span>${virality.category_dispersion}%</span>
                        </div>
                        <div class="virality-metric-bar">
                            <div class="virality-metric-fill" style="width: ${virality.category_dispersion}%; background-color: #9b59b6;"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="small text-muted">
                Based on ${virality.data_points} data points across multiple sources and categories.
            </div>
        `;
    }
    
    // Update filter counts
    function updateFilterCounts(results) {
        // Reset counts
        sourceFilters.forEach(filter => {
            const countElement = filter.parentElement.querySelector('.badge');
            countElement.textContent = '0';
        });
        
        categoryFilters.forEach(filter => {
            const countElement = filter.parentElement.querySelector('.badge');
            countElement.textContent = '0';
        });
        
        // Count by source type
        const sourceCounts = {};
        const categoryCounts = {};
        
        results.forEach(result => {
            // Count sources
            const sourceType = result.source_type;
            if (sourceType) {
                sourceCounts[sourceType] = (sourceCounts[sourceType] || 0) + 1;
            }
            
            // Count categories
            const category = result.esrs_category;
            if (category) {
                categoryCounts[category] = (categoryCounts[category] || 0) + 1;
            }
        });
        
        // Update source filter counts
        for (const [sourceType, count] of Object.entries(sourceCounts)) {
            const filter = document.getElementById(`source${sourceType}`);
            if (filter) {
                const countElement = filter.parentElement.querySelector('.badge');
                countElement.textContent = count;
            }
        }
        
        // Update category filter counts
        for (const [category, count] of Object.entries(categoryCounts)) {
            const filter = document.getElementById(`category${category}`);
            if (filter) {
                const countElement = filter.parentElement.querySelector('.badge');
                countElement.textContent = count;
            }
        }
    }
    
    // Filter results based on selected filters
    function filterResults() {
        if (!searchResultsData) return;
        
        // Get selected sources
        const selectedSources = Array.from(sourceFilters)
            .filter(filter => filter.checked)
            .map(filter => filter.value);
        
        // Get selected categories
        const selectedCategories = Array.from(categoryFilters)
            .filter(filter => filter.checked)
            .map(filter => filter.value);
        
        // Filter results
        const filteredResults = searchResultsData.results.filter(result => {
            const sourceMatch = selectedSources.includes(result.source_type);
            const categoryMatch = selectedCategories.includes(result.esrs_category);
            return sourceMatch && categoryMatch;
        });
        
        // Update result count
        resultCount.textContent = `${filteredResults.length} results`;
        
        // Display filtered results
        displayResultItems(filteredResults);
    }
    
    // Sort results by selected criterion
    function sortResults(sortBy) {
        if (!searchResultsData) return;
        
        // First apply filters
        const selectedSources = Array.from(sourceFilters)
            .filter(filter => filter.checked)
            .map(filter => filter.value);
        
        const selectedCategories = Array.from(categoryFilters)
            .filter(filter => filter.checked)
            .map(filter => filter.value);
        
        // Filter results
        let filteredResults = searchResultsData.results.filter(result => {
            const sourceMatch = selectedSources.includes(result.source_type);
            const categoryMatch = selectedCategories.includes(result.esrs_category);
            return sourceMatch && categoryMatch;
        });
        
        // Sort based on criterion
        if (sortBy === 'relevance') {
            filteredResults.sort((a, b) => b.relevance_score - a.relevance_score);
        } else if (sortBy === 'date') {
            filteredResults.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return dateB - dateA;  // Newest first
            });
        } else if (sortBy === 'sentiment') {
            // Create a sentiment score map (if sentiment exists)
            const sentimentScores = {};
            
            // Only sort by sentiment if we have sentiment data
            if (searchResultsData.sentiment_analysis && 
                searchResultsData.sentiment_analysis.category_sentiments) {
                
                // Map ESRS categories to sentiment scores
                const categoryMap = searchResultsData.sentiment_analysis.category_sentiments;
                
                filteredResults.sort((a, b) => {
                    const catA = a.esrs_category;
                    const catB = b.esrs_category;
                    
                    // Get sentiment scores (default to 0.5 if not found)
                    const scoreA = categoryMap[catA]?.score || 0.5;
                    const scoreB = categoryMap[catB]?.score || 0.5;
                    
                    return scoreB - scoreA;  // Higher score (more positive) first
                });
            } else {
                // Fall back to relevance if sentiment data is not available
                filteredResults.sort((a, b) => b.relevance_score - a.relevance_score);
            }
        }
        
        // Update result count
        resultCount.textContent = `${filteredResults.length} results`;
        
        // Display sorted results
        displayResultItems(filteredResults);
    }
    
    // Display result items
    function displayResultItems(results) {
        searchResults.innerHTML = '';
        
        if (results.length === 0) {
            searchResults.innerHTML = `
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-search" style="font-size: 3rem;"></i>
                    <h4 class="mt-3">No Results Found</h4>
                    <p>Try adjusting your filters or search for a different company</p>
                </div>
            `;
            return;
        }
        
        results.forEach(result => {
            // Determine relevance score class
            let relevanceClass = 'medium-relevance';
            if (result.relevance_score >= 0.7) {
                relevanceClass = 'high-relevance';
            } else if (result.relevance_score < 0.5) {
                relevanceClass = 'low-relevance';
            }
            
            searchResults.innerHTML += `
                <div class="card result-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <span class="result-source source-${result.source_type}">${result.source}</span>
                                <span class="result-date ms-2">${result.date}</span>
                            </div>
                            <div class="relevance-score ${relevanceClass}">${result.relevance_score * 100 | 0}</div>
                        </div>
                        <h5 class="result-title">
                            <a href="${result.url}" target="_blank">${result.title}</a>
                        </h5>
                        <p class="result-description">${result.description}</p>
                        <div class="mt-3">
                            <span class="category-badge">${result.esrs_category}</span>
                        </div>
                    </div>
                </div>
            `;
        });
    }
    
    // Generate mock results for testing
    function getMockResults(companyName) {
        // This is just for demonstration purposes when the API is not available
        return {
            "company": companyName,
            "timestamp": new Date().toISOString(),
            "query": `${companyName} sustainability`,
            "result_count": 12,
            "results": [
                {
                    "title": `${companyName} Sustainability Report 2023: Climate Change Initiatives`,
                    "url": `https://www.${companyName.toLowerCase().replace(' ', '')}.com/sustainability/report-2023.pdf`,
                    "source": "Sustainability Reports",
                    "source_type": "sustainability_reports",
                    "description": `${companyName}'s 2023 sustainability report details its climate change performance, including metrics, targets, and initiatives. The report presents comprehensive data on the company's progress and future commitments in carbon reduction.`,
                    "date": "2023-04-15",
                    "relevance_score": 0.92,
                    "esrs_category": "E1",
                    "source_reliability": 0.9,
                    "company": companyName
                },
                {
                    "title": `${companyName} Announces New Water Conservation Targets`,
                    "url": `https://www.reuters.com/sustainability/20230712/${companyName.toLowerCase().replace(' ', '')}-water-conservation`,
                    "source": "News Articles",
                    "source_type": "news_articles",
                    "description": `In a recent announcement, ${companyName} has set ambitious new targets for water conservation, aiming to reduce water usage by 30% by 2030. The company has outlined specific initiatives across its operations to achieve this goal.`,
                    "date": "2023-07-12",
                    "relevance_score": 0.85,
                    "esrs_category": "E3",
                    "source_reliability": 0.7,
                    "company": companyName
                },
                {
                    "title": `NGO Assessment: ${companyName}'s Biodiversity Impact`,
                    "url": `https://www.sustainabilitywatch.org/company-reports/${companyName.toLowerCase().replace(' ', '-')}`,
                    "source": "NGO Reports",
                    "source_type": "ngo_reports",
                    "description": `This independent assessment evaluates ${companyName}'s biodiversity performance against rigorous sustainability standards, identifying both strengths in habitat preservation and concerns regarding supply chain impacts on sensitive ecosystems.`,
                    "date": "2023-06-05",
                    "relevance_score": 0.78,
                    "esrs_category": "E4",
                    "source_reliability": 0.8,
                    "company": companyName
                },
                {
                    "title": `${companyName} Files ESRS E1 Disclosure: Climate Compliance`,
                    "url": `https://efrag.org/esrs/filings/${companyName.toLowerCase().replace(' ', '-')}-2023`,
                    "source": "Regulatory Filings",
                    "source_type": "regulatory_filings",
                    "description": `This regulatory filing details ${companyName}'s compliance with ESRS climate disclosure requirements, including scope 1, 2 and partial scope 3 emissions data, climate transition planning, and physical risk assessments in line with TCFD recommendations.`,
                    "date": "2023-03-10",
                    "relevance_score": 0.95,
                    "esrs_category": "E1",
                    "source_reliability": 0.95,
                    "company": companyName
                },
                {
                    "title": `Discussion: ${companyName}'s Workforce Diversity Initiatives`,
                    "url": `https://www.linkedin.com/${companyName.toLowerCase().replace(' ', '')}/status/1231231231`,
                    "source": "Social Media",
                    "source_type": "social_media",
                    "description": `Online discussion about ${companyName}'s workforce diversity initiatives has intensified, with stakeholders evaluating the company's progress toward its 2025 targets. The discourse highlights positive steps in gender representation but identifies gaps in ethnic diversity metrics.`,
                    "date": "2023-08-01",
                    "relevance_score": 0.65,
                    "esrs_category": "S1",
                    "source_reliability": 0.5,
                    "company": companyName
                },
                {
                    "title": `${companyName}'s Resource Use Initiative Draws Investor Attention`,
                    "url": `https://www.bloomberg.com/sustainability/20230518/${companyName.toLowerCase().replace(' ', '')}-circular-economy`,
                    "source": "News Articles",
                    "source_type": "news_articles",
                    "description": `Investors are responding positively to ${companyName}'s latest circular economy initiative, which aims to achieve 50% recycled input materials by 2030. The company's commitments to reducing virgin material usage and eliminating waste have been highlighted as industry-leading.`,
                    "date": "2023-05-18",
                    "relevance_score": 0.82,
                    "esrs_category": "E5",
                    "source_reliability": 0.7,
                    "company": companyName
                },
                {
                    "title": `${companyName} ESG Report: Social Impact Progress and Challenges`,
                    "url": `https://www.${companyName.toLowerCase().replace(' ', '')}.com/sustainability/social-impact-2023.pdf`,
                    "source": "Sustainability Reports",
                    "source_type": "sustainability_reports",
                    "description": `In its annual ESG disclosure, ${companyName} addresses key social impact issues, presenting both achievements in community engagement and areas for improvement in affected communities engagement. The report includes quantitative metrics on community investment and impact assessment methodologies.`,
                    "date": "2023-04-20",
                    "relevance_score": 0.88,
                    "esrs_category": "S3",
                    "source_reliability": 0.9,
                    "company": companyName
                },
                {
                    "title": `Critical Analysis: ${companyName}'s Governance Claims vs. Reality`,
                    "url": `https://www.greentransparency.org/company-reports/${companyName.toLowerCase().replace(' ', '-')}`,
                    "source": "NGO Reports",
                    "source_type": "ngo_reports",
                    "description": `This NGO report examines the gap between ${companyName}'s corporate governance claims and their measurable impact, highlighting discrepancies in executive compensation alignment with ESG metrics and board diversity commitments versus actual composition.`,
                    "date": "2023-02-15",
                    "relevance_score": 0.75,
                    "esrs_category": "G2",
                    "source_reliability": 0.8,
                    "company": companyName
                },
                {
                    "title": `${companyName} Ranked in Top Performers for Business Conduct`,
                    "url": `https://www.esgtoday.com/rankings/${companyName.toLowerCase().replace(' ', '-')}-business-conduct`,
                    "source": "News Articles",
                    "source_type": "news_articles",
                    "description": `In a comprehensive industry ranking, ${companyName} has been identified as a top performer in business conduct ethics among its industry peers. The assessment highlights the company's robust anti-corruption policies, whistleblower protections, and transparency in political contributions.`,
                    "date": "2023-07-05",
                    "relevance_score": 0.79,
                    "esrs_category": "G1",
                    "source_reliability": 0.7,
                    "company": companyName
                },
                {
                    "title": `${companyName}'s SEC Climate Disclosure: Risks and Opportunities`,
                    "url": `https://www.sec.gov/Archives/edgar/data/1234567/20230220-12345.txt`,
                    "source": "Regulatory Filings",
                    "source_type": "regulatory_filings",
                    "description": `In its SEC filing, ${companyName} outlines climate risks and opportunities, including financial implications of transition risks and physical climate impacts on operations. The disclosure follows new SEC guidelines and includes detailed TCFD-aligned scenario analysis and risk management approaches.`,
                    "date": "2023-02-20",
                    "relevance_score": 0.93,
                    "esrs_category": "E1",
                    "source_reliability": 0.95,
                    "company": companyName
                },
                {
                    "title": `Viral: ${companyName}'s Pollution Control Campaign Gains Criticism`,
                    "url": `https://twitter.com/${companyName.toLowerCase().replace(' ', '')}/status/9876543210`,
                    "source": "Social Media",
                    "source_type": "social_media",
                    "description": `A social media campaign highlighting ${companyName}'s pollution control measures has received significant criticism online, with environmental advocates questioning the effectiveness of the company's initiatives and calling for more substantive action on emissions reduction and waste management.`,
                    "date": "2023-08-10",
                    "relevance_score": 0.68,
                    "esrs_category": "E2",
                    "source_reliability": 0.5,
                    "company": companyName
                },
                {
                    "title": `${companyName} Sustainability Performance: Consumer Protection`,
                    "url": `https://www.${companyName.toLowerCase().replace(' ', '')}.com/sustainability/consumer-safety-2023.pdf`,
                    "source": "Sustainability Reports",
                    "source_type": "sustainability_reports",
                    "description": `This sustainability report section examines ${companyName}'s approach to consumer protection and product safety, detailing the company's quality control systems, product testing protocols, and consumer complaint resolution mechanisms with supporting metrics and case studies.`,
                    "date": "2023-04-25",
                    "relevance_score": 0.84,
                    "esrs_category": "S4",
                    "source_reliability": 0.9,
                    "company": companyName
                }
            ],
            "sentiment_analysis": {
                "overall_sentiment": "positive",
                "overall_score": 0.72,
                "category_sentiments": {
                    "E1": {
                        "name": "Climate Change",
                        "sentiment": "positive",
                        "score": 0.85,
                        "result_count": 3
                    },
                    "E2": {
                        "name": "Pollution",
                        "sentiment": "negative",
                        "score": 0.35,
                        "result_count": 1
                    },
                    "E3": {
                        "name": "Water and Marine Resources",
                        "sentiment": "positive",
                        "score": 0.80,
                        "result_count": 1
                    },
                    "E4": {
                        "name": "Biodiversity and Ecosystems",
                        "sentiment": "neutral",
                        "score": 0.55,
                        "result_count": 1
                    },
                    "E5": {
                        "name": "Resource Use and Circular Economy",
                        "sentiment": "positive",
                        "score": 0.82,
                        "result_count": 1
                    },
                    "S1": {
                        "name": "Own Workforce",
                        "sentiment": "positive",
                        "score": 0.70,
                        "result_count": 1
                    },
                    "S3": {
                        "name": "Affected Communities",
                        "sentiment": "positive",
                        "score": 0.65,
                        "result_count": 1
                    },
                    "S4": {
                        "name": "Consumers and End-users",
                        "sentiment": "positive",
                        "score": 0.75,
                        "result_count": 1
                    },
                    "G1": {
                        "name": "Business Conduct",
                        "sentiment": "positive",
                        "score": 0.79,
                        "result_count": 1
                    },
                    "G2": {
                        "name": "Corporate Governance",
                        "sentiment": "negative",
                        "score": 0.40,
                        "result_count": 1
                    }
                },
                "most_positive_category": {
                    "id": "E1",
                    "name": "Climate Change",
                    "score": 0.85
                },
                "most_negative_category": {
                    "id": "E2",
                    "name": "Pollution",
                    "score": 0.35
                },
                "analysis_type": "mock"
            },
            "esrs_distribution": {
                "total_results": 12,
                "categories": {
                    "E1": {
                        "name": "Climate Change",
                        "count": 3,
                        "percentage": 25.0
                    },
                    "E2": {
                        "name": "Pollution",
                        "count": 1,
                        "percentage": 8.3
                    },
                    "E3": {
                        "name": "Water and Marine Resources",
                        "count": 1,
                        "percentage": 8.3
                    },
                    "E4": {
                        "name": "Biodiversity and Ecosystems",
                        "count": 1,
                        "percentage": 8.3
                    },
                    "E5": {
                        "name": "Resource Use and Circular Economy",
                        "count": 1,
                        "percentage": 8.3
                    },
                    "S1": {
                        "name": "Own Workforce",
                        "count": 1,
                        "percentage": 8.3
                    },
                    "S3": {
                        "name": "Affected Communities",
                        "count": 1,
                        "percentage": 8.3
                    },
                    "S4": {
                        "name": "Consumers and End-users",
                        "count": 1,
                        "percentage": 8.3
                    },
                    "G1": {
                        "name": "Business Conduct",
                        "count": 1,
                        "percentage": 8.3
                    },
                    "G2": {
                        "name": "Corporate Governance",
                        "count": 1,
                        "percentage": 8.3
                    }
                },
                "top_categories": [
                    {
                        "id": "E1",
                        "name": "Climate Change",
                        "count": 3,
                        "percentage": 25.0
                    },
                    {
                        "id": "E2",
                        "name": "Pollution",
                        "count": 1,
                        "percentage": 8.3
                    },
                    {
                        "id": "E3",
                        "name": "Water and Marine Resources",
                        "count": 1,
                        "percentage": 8.3
                    }
                ]
            },
            "virality_metrics": {
                "virality_score": 76.4,
                "trend_direction": "increasing",
                "recency_score": 82.5,
                "source_diversity": 85.0,
                "category_dispersion": 90.9,
                "reliability_score": 78.3,
                "data_points": 12
            }
        };
    }
    
    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
        initEventListeners();
    });
    
    // Expose searchCompany function globally (for company pill buttons)
    window.searchCompany = searchCompany;
</script>
{% endblock %}