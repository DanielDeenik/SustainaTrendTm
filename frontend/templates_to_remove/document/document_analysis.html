{% extends "base.html" %}

{% block title %}Document Analysis - {{ filename }}{% endblock %}

{% block styles %}
<style>
    .document-container {
        display: flex;
        height: calc(100vh - 80px);
    }
    
    .document-preview {
        flex: 1;
        padding: 20px;
        border-right: 1px solid #eaeaea;
        overflow-y: auto;
        background-color: #f9fafb;
    }
    
    .document-chat {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 20px;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 20px;
        padding: 10px;
        border: 1px solid #eaeaea;
        border-radius: 5px;
        background-color: #fff;
    }
    
    .message {
        margin-bottom: 15px;
        padding: 10px 15px;
        border-radius: 18px;
        max-width: 85%;
        position: relative;
    }
    
    .message-user {
        background-color: #e9f5ff;
        align-self: flex-end;
        margin-left: auto;
    }
    
    .message-ai {
        background-color: #f5f5f5;
        align-self: flex-start;
    }
    
    .chat-input-container {
        display: flex;
        margin-top: auto;
    }
    
    .chat-input {
        flex: 1;
        padding: 12px;
        border: 1px solid #d1d5db;
        border-radius: 5px;
        margin-right: 10px;
    }
    
    .chat-send-btn {
        padding: 12px 20px;
        background-color: #3b82f6;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }
    
    .nav-tabs {
        display: flex;
        border-bottom: 1px solid #eaeaea;
        margin-bottom: 20px;
    }
    
    .nav-tabs .nav-link {
        padding: 10px 15px;
        margin-right: 5px;
        cursor: pointer;
        border-bottom: 2px solid transparent;
    }
    
    .nav-tabs .nav-link.active {
        border-bottom: 2px solid #3b82f6;
        color: #3b82f6;
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    .data-point-card {
        background-color: white;
        border: 1px solid #eaeaea;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 15px;
    }
    
    .data-point-card h5 {
        margin-top: 0;
        color: #374151;
    }
    
    .data-point-context {
        font-size: 0.9rem;
        color: #6b7280;
        margin-top: 10px;
        padding: 8px;
        background-color: #f9fafb;
        border-radius: 4px;
    }
    
    .figure-reference {
        padding: 10px;
        margin-bottom: 10px;
        border-left: 3px solid #3b82f6;
        background-color: #f0f7ff;
    }
    
    .compliance-score {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .compliance-label {
        flex: 1;
    }
    
    .compliance-bar {
        flex: 2;
        height: 10px;
        background-color: #eaeaea;
        border-radius: 5px;
        overflow: hidden;
    }
    
    .compliance-bar-progress {
        height: 100%;
        background-color: #3b82f6;
    }
    
    .download-btn {
        display: inline-block;
        padding: 8px 15px;
        background-color: #059669;
        color: white;
        border-radius: 5px;
        text-decoration: none;
        margin-top: 10px;
        font-size: 0.9rem;
    }
    
    .download-btn:hover {
        background-color: #047857;
    }
    
    .source-reference {
        font-size: 0.8rem;
        color: #6b7280;
        margin-top: 5px;
    }
    
    .drill-down-btn {
        font-size: 0.8rem;
        color: #3b82f6;
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
        text-decoration: underline;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h2>Document Analysis: {{ filename }}</h2>
            <p>Use the AI chat interface to query this document or explore the data analysis tabs.</p>
        </div>
    </div>
    
    <div class="document-container">
        <div class="document-preview">
            <div class="nav-tabs">
                <div class="nav-link active" data-tab="preview">Document Preview</div>
                <div class="nav-link" data-tab="metrics">ESG Metrics</div>
                <div class="nav-link" data-tab="compliance">Compliance</div>
                <div class="nav-link" data-tab="figures">Figures & Tables</div>
            </div>
            
            <div class="tab-content active" id="preview-tab">
                <h4>Document Preview</h4>
                <p>{{ analysis.page_count }} pages, {{ analysis.word_count }} words</p>
                <pre style="white-space: pre-wrap; font-size: 0.9rem;">{{ analysis.preview }}</pre>
                
                <div class="mt-4">
                    <h5>Document Structure</h5>
                    <ul>
                        {% if analysis.document_structure and analysis.document_structure.headings %}
                            {% for heading in analysis.document_structure.headings %}
                                <li style="margin-left: {{ heading.level * 15 }}px">
                                    {{ heading.title }} (p. {{ heading.page }})
                                </li>
                            {% endfor %}
                        {% else %}
                            <li>No detailed structure available</li>
                        {% endif %}
                    </ul>
                </div>
            </div>
            
            <div class="tab-content" id="metrics-tab">
                <h4>ESG Metrics Identified</h4>
                
                {% if analysis.metrics %}
                    {% for category, mentions in analysis.metrics.items() %}
                        <div class="data-point-card">
                            <h5>{{ category|capitalize }}</h5>
                            <p>{{ mentions|length }} mentions found</p>
                            
                            {% if mentions %}
                                {% for mention in mentions[:3] %}
                                    <div class="data-point-context">
                                        "...{{ mention.context }}..."
                                        <div class="source-reference">Page reference: automatically extracted from context</div>
                                        <button class="drill-down-btn" data-query="Explain {{ mention.pattern }} in more detail">Ask AI about this</button>
                                    </div>
                                {% endfor %}
                                
                                {% if mentions|length > 3 %}
                                    <p><i>{{ mentions|length - 3 }} more mentions hidden</i></p>
                                {% endif %}
                            {% endif %}
                        </div>
                    {% endfor %}
                {% else %}
                    <p>No ESG metrics were identified in this document.</p>
                {% endif %}
                
                <h4>Numerical KPIs</h4>
                {% if analysis.kpis %}
                    {% for kpi in analysis.kpis %}
                        <div class="data-point-card">
                            <h5>{{ kpi.value }} {{ kpi.unit }}</h5>
                            <div class="data-point-context">
                                "...{{ kpi.context }}..."
                                <div class="source-reference">Page reference: automatically extracted from context</div>
                                <button class="drill-down-btn" data-query="Explain how the value {{ kpi.value }} {{ kpi.unit }} was calculated">Ask about calculation</button>
                                <button class="drill-down-btn" data-query="Is there any underlying data for {{ kpi.value }} {{ kpi.unit }}">View underlying data</button>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p>No numerical KPIs were identified in this document.</p>
                {% endif %}
            </div>
            
            <div class="tab-content" id="compliance-tab">
                <h4>Regulatory Compliance Assessment</h4>
                
                {% if analysis.compliance_assessment %}
                    <div class="data-point-card">
                        <h5>Overall Compliance: {{ analysis.compliance_assessment.overall_compliance }}</h5>
                        <div class="compliance-score">
                            <div class="compliance-label">Overall Score:</div>
                            <div class="compliance-bar">
                                <div class="compliance-bar-progress" style="width: {{ analysis.compliance_assessment.overall_score }}%"></div>
                            </div>
                            <div class="compliance-value">{{ analysis.compliance_assessment.overall_score }}%</div>
                        </div>
                    </div>
                    
                    <h5>Framework Compliance</h5>
                    {% for framework, score in analysis.compliance_assessment.framework_scores.items() %}
                        <div class="data-point-card">
                            <h5>{{ framework }}</h5>
                            <div class="compliance-score">
                                <div class="compliance-label">Compliance Score:</div>
                                <div class="compliance-bar">
                                    <div class="compliance-bar-progress" style="width: {{ score }}%"></div>
                                </div>
                                <div class="compliance-value">{{ score }}%</div>
                            </div>
                            <button class="drill-down-btn" data-query="Explain {{ framework }} compliance requirements in detail">More details on {{ framework }}</button>
                        </div>
                    {% endfor %}
                    
                    <h5>Key Recommendations</h5>
                    <div class="data-point-card">
                        <ul>
                            {% for recommendation in analysis.compliance_assessment.key_recommendations %}
                                <li>{{ recommendation }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                {% else %}
                    <p>No compliance assessment is available for this document.</p>
                {% endif %}
            </div>
            
            <div class="tab-content" id="figures-tab">
                <h4>Figures & Tables Referenced</h4>
                
                {% if analysis.figures %}
                    <h5>Figures</h5>
                    {% for figure in analysis.figures %}
                        {% if figure.type != 'table' %}
                            <div class="figure-reference">
                                <strong>{{ figure.type|capitalize }} {{ figure.number }}</strong> 
                                <span class="badge bg-secondary">Page {{ figure.page }}</span>
                                <div class="data-point-context">
                                    "...{{ figure.context }}..."
                                </div>
                                <button class="drill-down-btn" data-query="Explain {{ figure.type }} {{ figure.number }} on page {{ figure.page }}">Explain this figure</button>
                                <button class="drill-down-btn" data-query="What is the data source for {{ figure.type }} {{ figure.number }}">View data source</button>
                            </div>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <p>No figures were identified in this document.</p>
                {% endif %}
                
                {% if analysis.tables %}
                    <h5>Tables</h5>
                    {% for table in analysis.tables %}
                        <div class="figure-reference">
                            <strong>{{ table.type|capitalize }} {{ table.number }}</strong> 
                            <span class="badge bg-secondary">Page {{ table.page }}</span>
                            <div class="data-point-context">
                                "...{{ table.context }}..."
                            </div>
                            <button class="drill-down-btn" data-query="Explain the data in {{ table.type }} {{ table.number }} on page {{ table.page }}">Explain this table</button>
                            <button class="drill-down-btn" data-query="What is the source data for {{ table.type }} {{ table.number }}">View source data</button>
                            <button class="drill-down-btn" data-query="Can I download the underlying data for {{ table.type }} {{ table.number }}">Download data</button>
                        </div>
                    {% endfor %}
                {% else %}
                    <p>No tables were identified in this document.</p>
                {% endif %}
            </div>
        </div>
        
        <div class="document-chat">
            <h4>AI-Powered Document Query</h4>
            <p>Ask questions about this document to get AI-generated responses with data traceability.</p>
            
            <div class="chat-messages" id="chat-messages">
                <div class="message message-ai">
                    <p>Hello! I'm your sustainability report assistant. You can ask me questions about this document, such as:</p>
                    <ul>
                        <li>"Explain Figure 4.1 on page 16"</li>
                        <li>"What is the underlying data for carbon emissions reported in table 5.2?"</li>
                        <li>"What assumption was used for Scope 3 emissions?"</li>
                        <li>"How does this report comply with CSRD requirements?"</li>
                    </ul>
                    <p>I'll provide answers with references to the document and access to underlying data where available.</p>
                </div>
            </div>
            
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chat-input" placeholder="Ask a question about this document...">
                <button class="chat-send-btn" id="chat-send-btn">Send</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Tab switching logic
        const tabLinks = document.querySelectorAll('.nav-link');
        const tabContents = document.querySelectorAll('.tab-content');
        
        tabLinks.forEach(link => {
            link.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                
                // Remove active class from all tabs
                tabLinks.forEach(item => item.classList.remove('active'));
                tabContents.forEach(item => item.classList.remove('active'));
                
                // Add active class to current tab
                this.classList.add('active');
                document.getElementById(tabId + '-tab').classList.add('active');
            });
        });
        
        // Chat functionality
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        
        function addMessage(message, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'message-user' : 'message-ai'}`;
            messageDiv.innerHTML = `<p>${message}</p>`;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;
            
            // Add user message to chat
            addMessage(message, true);
            chatInput.value = '';
            
            // Add loading message
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message message-ai';
            loadingDiv.innerHTML = '<p>Analyzing document and generating response...</p>';
            chatMessages.appendChild(loadingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Make API call to get AI response
            fetch('/api/document-query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    query: message,
                    document_id: '{{ filename }}',
                    session_id: Date.now().toString()
                })
            })
            .then(response => response.json())
            .then(data => {
                // Remove loading message
                chatMessages.removeChild(loadingDiv);
                
                if (data.success) {
                    // Add response to chat
                    let responseHTML = `<p>${data.response}</p>`;
                    
                    // Add sources if available
                    if (data.sources && data.sources.length > 0) {
                        responseHTML += '<p><strong>Sources:</strong></p><ul>';
                        data.sources.forEach(source => {
                            responseHTML += `<li>${source}</li>`;
                        });
                        responseHTML += '</ul>';
                    }
                    
                    // Add data download option if available
                    if (data.data_available) {
                        responseHTML += `<p><a href="${data.data_url}" class="download-btn" target="_blank">Download Data</a></p>`;
                    }
                    
                    addMessage(responseHTML);
                } else {
                    addMessage('Sorry, I encountered an error analyzing this document. Please try a different question or check if the document contains the information you\'re looking for.');
                }
            })
            .catch(error => {
                // Remove loading message
                chatMessages.removeChild(loadingDiv);
                addMessage('Sorry, there was a technical error. Please try again later.');
                console.error('Error:', error);
            });
        }
        
        // Send message on button click
        chatSendBtn.addEventListener('click', sendMessage);
        
        // Send message on Enter key
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Make drill-down buttons work
        document.querySelectorAll('.drill-down-btn').forEach(button => {
            button.addEventListener('click', function() {
                const query = this.getAttribute('data-query');
                chatInput.value = query;
                sendMessage();
            });
        });
    });
</script>
{% endblock %}