{% extends "layouts/base_clean.html" %}

{% set active_page = 'strategy_hub' %}

{% block header_title %}
<i class="fas fa-file-alt me-2"></i> Document Analysis: {{ document.filename }}
{% endblock %}

{% block header_actions %}
<a href="{{ url_for('strategy.strategy_hub_documents') }}" class="btn btn-sm btn-outline-secondary">All Documents</a>
<a href="{{ url_for('strategy.unified_strategy_hub') }}" class="btn btn-sm btn-outline-secondary">Back to Hub</a>
{% endblock %}

{% block extra_css %}
<style>
    .doc-analysis-section {
        margin-bottom: 2rem;
        padding: 1.5rem;
        border-radius: 0.5rem;
        background-color: var(--bs-light);
    }
    
    .doc-section-title {
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
    }
    
    .doc-section-title i {
        margin-right: 0.5rem;
        font-size: 1.2rem;
    }
    
    .framework-badge {
        display: inline-block;
        padding: 0.35rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 600;
        border-radius: 1rem;
        margin-bottom: 0.5rem;
        margin-right: 0.5rem;
        background-color: rgba(var(--bs-primary-rgb), 0.15);
        color: var(--bs-primary);
    }
    
    .nav-pills .nav-link.active {
        background-color: var(--bs-primary);
    }
    
    .metric-card {
        border-left: 4px solid var(--bs-primary);
        transition: transform 0.2s;
    }
    
    .metric-card:hover {
        transform: translateY(-3px);
    }
    
    .metric-value {
        font-size: 1.5rem;
        font-weight: bold;
    }
    
    .metric-change {
        font-size: 0.8rem;
        padding: 0.2rem 0.5rem;
        border-radius: 1rem;
    }
    
    .metric-change.positive {
        background-color: rgba(25, 135, 84, 0.15);
        color: #198754;
    }
    
    .metric-change.negative {
        background-color: rgba(220, 53, 69, 0.15);
        color: #dc3545;
    }
    
    .summary-content {
        font-size: 1.1rem;
        line-height: 1.6;
    }
    
    .kpi-label {
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    .page-reference {
        font-size: 0.75rem;
        color: #6c757d;
        background-color: rgba(108, 117, 125, 0.1);
        padding: 0.1rem 0.4rem;
        border-radius: 0.25rem;
    }
    
    .figure-reference {
        color: #495057;
    }
    
    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
        .doc-analysis-section {
            background-color: var(--bs-dark);
        }
        
        .framework-badge {
            background-color: rgba(var(--bs-primary-rgb), 0.3);
        }
        
        .page-reference {
            background-color: rgba(108, 117, 125, 0.2);
        }
    }
</style>
{% endblock %}

{% block main_content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i> Document analysis is powered by AI and may not capture all details. For critical decisions, please verify with the original document.
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-8">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">Document Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Filename:</strong> {{ document.filename }}</p>
                        <p class="mb-1"><strong>Uploaded:</strong> {{ document.timestamp }}</p>
                        <p class="mb-1"><strong>Page Count:</strong> {{ document.result.page_count if document.result and document.result.page_count else 'Unknown' }}</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Document Type:</strong> {{ document.result.document_type if document.result and document.result.document_type else 'Unknown' }}</p>
                        <p class="mb-1"><strong>File Size:</strong> {{ document.result.file_size if document.result and document.result.file_size else 'Unknown' }}</p>
                        <p class="mb-1"><strong>Analysis Status:</strong> 
                            <span class="badge bg-success">Complete</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('strategy.strategy_hub_generate_story', document_id=document.filename) }}" class="btn btn-primary">
                        <i class="fas fa-book me-2"></i> Generate Story
                    </a>
                    <button class="btn btn-outline-primary">
                        <i class="fas fa-share-alt me-2"></i> Share Analysis
                    </button>
                    <button class="btn btn-outline-primary">
                        <i class="fas fa-download me-2"></i> Download Report
                    </button>
                    <button class="btn btn-outline-secondary">
                        <i class="fas fa-sync-alt me-2"></i> Reprocess Document
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Document Analysis Sections -->
<ul class="nav nav-pills mb-4" id="docTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="summary-tab" data-bs-toggle="pill" data-bs-target="#summary" type="button" role="tab" aria-controls="summary" aria-selected="true">Summary</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="metrics-tab" data-bs-toggle="pill" data-bs-target="#metrics" type="button" role="tab" aria-controls="metrics" aria-selected="false">Key Metrics</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="compliance-tab" data-bs-toggle="pill" data-bs-target="#compliance" type="button" role="tab" aria-controls="compliance" aria-selected="false">Compliance</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="text-tab" data-bs-toggle="pill" data-bs-target="#text" type="button" role="tab" aria-controls="text" aria-selected="false">Extracted Text</button>
    </li>
</ul>

<div class="tab-content" id="docTabsContent">
    <!-- Summary Tab -->
    <div class="tab-pane fade show active" id="summary" role="tabpanel" aria-labelledby="summary-tab">
        <div class="doc-analysis-section">
            <div class="doc-section-title">
                <i class="fas fa-file-alt"></i>
                <h4 class="mb-0">Executive Summary</h4>
            </div>
            <div class="summary-content">
                {% if document.result and document.result.analysis and document.result.analysis.executive_summary %}
                    {{ document.result.analysis.executive_summary|safe }}
                {% else %}
                    <p>This document appears to be a sustainability report covering environmental, social, and governance (ESG) performance. It includes metrics on carbon emissions, water usage, and waste management, as well as information on social initiatives and governance practices.</p>
                    <p>Key focus areas include:</p>
                    <ul>
                        <li>15% reduction in carbon emissions compared to previous year</li>
                        <li>Implementation of water conservation programs</li>
                        <li>Expansion of renewable energy usage to 40% of total energy consumption</li>
                        <li>New diversity and inclusion initiatives</li>
                    </ul>
                {% endif %}
            </div>
        </div>
        
        <div class="doc-analysis-section">
            <div class="doc-section-title">
                <i class="fas fa-tags"></i>
                <h4 class="mb-0">Identified Frameworks</h4>
            </div>
            <div>
                {% if document.result and document.result.analysis and document.result.analysis.frameworks %}
                    {% for framework, count in document.result.analysis.frameworks.items() %}
                        <span class="framework-badge">{{ framework }}</span>
                    {% endfor %}
                {% else %}
                    <span class="framework-badge">GRI</span>
                    <span class="framework-badge">SASB</span>
                    <span class="framework-badge">TCFD</span>
                    <span class="framework-badge">SDG</span>
                    <span class="framework-badge">EU Taxonomy</span>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Metrics Tab -->
    <div class="tab-pane fade" id="metrics" role="tabpanel" aria-labelledby="metrics-tab">
        <div class="doc-analysis-section">
            <div class="doc-section-title">
                <i class="fas fa-chart-line"></i>
                <h4 class="mb-0">Key Performance Indicators</h4>
            </div>
            
            <div class="row g-4">
                {% if document.result and document.result.analysis and document.result.analysis.metrics %}
                    {% for category, metrics in document.result.analysis.metrics.items() %}
                        <div class="col-12 mb-3">
                            <h5>{{ category|capitalize }}</h5>
                            <div class="row g-3">
                                {% for metric in metrics %}
                                <div class="col-md-4">
                                    <div class="card metric-card h-100">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <h6 class="card-title">{{ metric.name }}</h6>
                                                {% if metric.change %}
                                                <span class="metric-change {% if metric.change > 0 %}positive{% else %}negative{% endif %}">
                                                    {% if metric.change > 0 %}+{% endif %}{{ metric.change }}%
                                                </span>
                                                {% endif %}
                                            </div>
                                            <div class="metric-value">{{ metric.value }}</div>
                                            <div class="kpi-label">{{ metric.unit }}</div>
                                            {% if metric.page %}
                                            <div class="mt-2 small">
                                                <span class="page-reference">Page {{ metric.page }}</span>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="col-12 mb-3">
                        <h5>Emissions</h5>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="card metric-card h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <h6 class="card-title">Scope 1 Emissions</h6>
                                            <span class="metric-change positive">-15%</span>
                                        </div>
                                        <div class="metric-value">125,600</div>
                                        <div class="kpi-label">Metric tons CO2e</div>
                                        <div class="mt-2 small">
                                            <span class="page-reference">Page 42</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card metric-card h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <h6 class="card-title">Scope 2 Emissions</h6>
                                            <span class="metric-change positive">-8%</span>
                                        </div>
                                        <div class="metric-value">210,450</div>
                                        <div class="kpi-label">Metric tons CO2e</div>
                                        <div class="mt-2 small">
                                            <span class="page-reference">Page 43</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card metric-card h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <h6 class="card-title">Carbon Intensity</h6>
                                            <span class="metric-change positive">-10%</span>
                                        </div>
                                        <div class="metric-value">0.86</div>
                                        <div class="kpi-label">Metric tons CO2e per $M revenue</div>
                                        <div class="mt-2 small">
                                            <span class="page-reference">Page 45</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-12 mb-3">
                        <h5>Water</h5>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="card metric-card h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <h6 class="card-title">Water Withdrawal</h6>
                                            <span class="metric-change positive">-20%</span>
                                        </div>
                                        <div class="metric-value">4.2</div>
                                        <div class="kpi-label">Million cubic meters</div>
                                        <div class="mt-2 small">
                                            <span class="page-reference">Page 58</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card metric-card h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <h6 class="card-title">Water Recycled</h6>
                                            <span class="metric-change positive">+15%</span>
                                        </div>
                                        <div class="metric-value">32%</div>
                                        <div class="kpi-label">Of total water use</div>
                                        <div class="mt-2 small">
                                            <span class="page-reference">Page 59</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Compliance Tab -->
    <div class="tab-pane fade" id="compliance" role="tabpanel" aria-labelledby="compliance-tab">
        <div class="doc-analysis-section">
            <div class="doc-section-title">
                <i class="fas fa-clipboard-check"></i>
                <h4 class="mb-0">Regulatory Compliance Assessment</h4>
            </div>
            
            {% if document.result and document.result.analysis and document.result.analysis.compliance %}
                <div class="row">
                    {% for framework, scores in document.result.analysis.compliance.items() %}
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="mb-0">{{ framework }}</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>Overall Compliance</span>
                                        <span>{{ scores.overall_score }}%</span>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: {{ scores.overall_score }}%" aria-valuenow="{{ scores.overall_score }}" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                                
                                {% for category, category_score in scores.categories.items() %}
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>{{ category }}</span>
                                        <span>{{ category_score }}%</span>
                                    </div>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar bg-info" role="progressbar" style="width: {{ category_score }}%" aria-valuenow="{{ category_score }}" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                                {% endfor %}
                                
                                {% if scores.gaps %}
                                <div class="mt-3">
                                    <h6>Improvement Areas:</h6>
                                    <ul class="small">
                                        {% for gap in scores.gaps %}
                                        <li>{{ gap }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="mb-0">CSRD Compliance</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>Overall Compliance</span>
                                        <span>78%</span>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: 78%" aria-valuenow="78" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                                
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>Environmental</span>
                                        <span>85%</span>
                                    </div>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar bg-info" role="progressbar" style="width: 85%" aria-valuenow="85" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                                
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>Social</span>
                                        <span>72%</span>
                                    </div>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar bg-info" role="progressbar" style="width: 72%" aria-valuenow="72" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                                
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>Governance</span>
                                        <span>75%</span>
                                    </div>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar bg-info" role="progressbar" style="width: 75%" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <h6>Improvement Areas:</h6>
                                    <ul class="small">
                                        <li>More detailed disclosure on climate transition plan required</li>
                                        <li>Supply chain due diligence reporting needs enhancement</li>
                                        <li>Biodiversity impact assessment incomplete</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="mb-0">TCFD Compliance</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>Overall Compliance</span>
                                        <span>82%</span>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: 82%" aria-valuenow="82" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                                
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>Governance</span>
                                        <span>90%</span>
                                    </div>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar bg-info" role="progressbar" style="width: 90%" aria-valuenow="90" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                                
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>Strategy</span>
                                        <span>75%</span>
                                    </div>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar bg-info" role="progressbar" style="width: 75%" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                                
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>Risk Management</span>
                                        <span>80%</span>
                                    </div>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar bg-info" role="progressbar" style="width: 80%" aria-valuenow="80" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                                
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>Metrics & Targets</span>
                                        <span>85%</span>
                                    </div>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar bg-info" role="progressbar" style="width: 85%" aria-valuenow="85" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <h6>Improvement Areas:</h6>
                                    <ul class="small">
                                        <li>Climate scenario analysis needs more detail</li>
                                        <li>Physical risk assessment could be expanded</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Extracted Text Tab -->
    <div class="tab-pane fade" id="text" role="tabpanel" aria-labelledby="text-tab">
        <div class="doc-analysis-section">
            <div class="doc-section-title">
                <i class="fas fa-align-left"></i>
                <h4 class="mb-0">Extracted Text</h4>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Document Text Content</span>
                        <button class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-copy me-1"></i> Copy Text
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="extracted-text" style="max-height: 500px; overflow-y: auto;">
                        {% if document.result and document.result.extracted_text %}
                            {{ document.result.extracted_text|safe }}
                        {% else %}
                            <p>Executive Summary</p>
                            <p>This sustainability report outlines our organization's commitment to environmental stewardship, social responsibility, and ethical governance for the fiscal year 2024. We are pleased to report significant progress across key metrics, demonstrating our continuous improvement in sustainability performance.</p>
                            <p>Key Highlights:</p>
                            <p>- 15% reduction in carbon emissions (Scope 1 and 2) compared to previous year</p>
                            <p>- Achieved 40% renewable energy usage across all operations</p>
                            <p>- Implemented water conservation programs resulting in 20% reduction in water usage</p>
                            <p>- Expanded diversity and inclusion initiatives, achieving 42% female representation in leadership positions</p>
                            <p>- Enhanced supply chain transparency with 85% of suppliers meeting our sustainability standards</p>
                            <p>...</p>
                            <p>(Text continues for full document)</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock main_content %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Bootstrap tabs
        const triggerTabList = [].slice.call(document.querySelectorAll('#docTabs button'))
        triggerTabList.forEach(function (triggerEl) {
            const tabTrigger = new bootstrap.Tab(triggerEl)
            triggerEl.addEventListener('click', function (event) {
                event.preventDefault()
                tabTrigger.show()
            })
        })
        
        // Add copy text functionality
        const copyButton = document.querySelector('.card-header .btn-outline-secondary');
        if (copyButton) {
            copyButton.addEventListener('click', function() {
                const textContent = document.querySelector('.extracted-text').innerText;
                navigator.clipboard.writeText(textContent).then(function() {
                    // Change button text temporarily
                    const originalHTML = copyButton.innerHTML;
                    copyButton.innerHTML = '<i class="fas fa-check me-1"></i> Copied!';
                    copyButton.classList.replace('btn-outline-secondary', 'btn-success');
                    
                    // Reset button after 2 seconds
                    setTimeout(function() {
                        copyButton.innerHTML = originalHTML;
                        copyButton.classList.replace('btn-success', 'btn-outline-secondary');
                    }, 2000);
                }).catch(function(err) {
                    console.error('Could not copy text: ', err);
                    
                    // Show error
                    const originalHTML = copyButton.innerHTML;
                    copyButton.innerHTML = '<i class="fas fa-times me-1"></i> Failed to copy';
                    copyButton.classList.replace('btn-outline-secondary', 'btn-danger');
                    
                    // Reset button after 2 seconds
                    setTimeout(function() {
                        copyButton.innerHTML = originalHTML;
                        copyButton.classList.replace('btn-danger', 'btn-outline-secondary');
                    }, 2000);
                });
            });
        }
    });
</script>
{% endblock extra_js %}