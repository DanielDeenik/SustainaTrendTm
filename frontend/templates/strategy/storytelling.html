{% extends "layouts/finchat_dark_layout.html" %}

{% set active_page = 'storytelling' %}

{% block header_title %}
<i class="fas fa-newspaper me-2"></i> Sustainability Storytelling Hub
{% endblock %}

{% block header_actions %}
<a href="{{ url_for('enhanced_strategy.strategy_hub') }}" class="btn btn-sm btn-outline-secondary">Back to Strategy Hub</a>
<a href="{{ url_for('stories.create_story') }}" class="btn btn-primary">
    <i class="fas fa-plus me-2"></i> Create New Story
</a>
{% endblock %}

{% block additional_styles %}
<!-- Include Strategy Hub CSS styles for consistency -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/strategy-hub.css') }}">
<style>
    :root {
        --primary-color: #36b37e;
        --primary-light: #4eca94;
        --primary-dark: #2d9669;
        --secondary-color: #0052cc;
        --secondary-light: #2684ff;
        --secondary-dark: #0747a6;
        --accent-color: #ff5630;
        --accent-light: #ff7452;
        --accent-dark: #de350b;
        --dark-bg: #172b4d;
        --darker-bg: #101e35;
        --light-text: #f4f5f7;
        --medium-text: #c1c7d0;
        --light-bg: #f4f5f7;
        --card-bg: #1e3357;
        --card-highlight: #264473;
        --border-radius: 12px;
        --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        --transition-speed: 0.2s;
        --ai-primary: #36b37e;
        --ai-secondary: #00b8d9;
        --ai-tertiary: #6554c0;
        --ai-quaternary: #ff8b00;
    }
    
    /* Additional storytelling specific styles */
    .category-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 0.75rem;
        background: rgba(0, 128, 128, 0.2); /* Teal */
        color: #008080; /* Teal */
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
    }
    
    .audience-tag {
        font-size: 0.8rem;
        color: var(--medium-text);
        display: flex;
        align-items: center;
    }
    
    .timestamp {
        font-size: 0.8rem;
        color: var(--medium-text);
    }
    
    .story-card {
        height: 100%;
        transition: all var(--transition-speed) ease;
        border-left: 4px solid var(--primary-color);
        background: var(--card-bg);
        border-radius: var(--border-radius);
        border: 1px solid rgba(255, 255, 255, 0.05);
        overflow: hidden;
        position: relative;
    }
    
    .story-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--card-shadow);
        background: var(--card-highlight);
    }
    
    .generate-button {
        transition: all 0.3s;
        background: var(--primary-color);
        color: var(--light-text);
        border: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .generate-button:hover {
        transform: scale(1.05);
        background: var(--primary-light);
    }
    
    .story-recommendations {
        background: rgba(0, 0, 0, 0.1);
        border-radius: var(--border-radius);
        padding: 0.75rem;
        margin-top: 0.75rem;
    }
    
    .recommendation-item {
        display: flex;
        align-items: flex-start;
        margin-bottom: 0.5rem;
    }
    
    .recommendation-item i {
        color: var(--primary-color);
        margin-right: 0.5rem;
        margin-top: 0.25rem;
    }
    
    /* Story template cards */
    .template-card {
        background: var(--card-bg);
        border-radius: var(--border-radius);
        border: 1px solid rgba(255, 255, 255, 0.05);
        padding: 1.25rem;
        height: 100%;
        transition: all var(--transition-speed) ease;
    }
    
    .template-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--card-shadow);
        background: var(--card-highlight);
    }
    
    .template-icon {
        width: 3rem;
        height: 3rem;
        border-radius: 50%;
        background: rgba(var(--primary-color), 0.1);
        color: var(--primary-color);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-bottom: 1rem;
    }
    
    /* Animation for loading indicator */
    @keyframes pulse {
        0% { opacity: 0.6; }
        50% { opacity: 1; }
        100% { opacity: 0.6; }
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .quick-action-bar {
            flex-direction: column;
            gap: 0.5rem;
        }
    }
</style>
{% endblock %}

{% block main_content %}
<div class="strategy-hub-container">
    <!-- Header Section with Gradient Title -->
    <div class="strategy-header">
        <div>
            <h2 class="strategy-title">Sustainability Storytelling Hub</h2>
            <p class="strategy-subtitle">Create compelling data-driven narratives for various stakeholders</p>
        </div>
        <div>
            <a href="{{ url_for('stories.create_story') }}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i> Create New Story
            </a>
        </div>
    </div>

    <!-- Story Filter Tabs -->
    <div class="hub-tabs">
        <div class="hub-tab active" data-tab="all">All Stories</div>
        <div class="hub-tab" data-tab="emissions">Emissions</div>
        <div class="hub-tab" data-tab="water">Water</div>
        <div class="hub-tab" data-tab="social">Social</div>
        <div class="hub-tab" data-tab="governance">Governance</div>
    </div>
    
    <!-- Story Templates Section -->
    <div class="hub-card">
        <div class="hub-card-title">
            <i class="fas fa-magic"></i>
            Storytelling Templates
        </div>
        <div class="card-description">
            Select from our curated storytelling templates designed for specific stakeholder needs and objectives.
        </div>
        
        <div class="card-grid-2" id="templates-container">
            <!-- Templates will be loaded dynamically via API -->
            <div class="text-center p-5 w-100">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Loading storytelling templates...</p>
            </div>
        </div>
    </div>
    
    <!-- Quick Action Card -->
    <div class="hub-card">
        <div class="hub-card-title">
            <i class="fas fa-bolt"></i>
            Quick Actions
        </div>
        <div class="card-description">
            Create stories or access commonly used storytelling features
        </div>
        
        <div class="quick-action-bar mb-4">
            <a href="{{ url_for('stories.create_story') }}" class="quick-action-btn quick-action-primary">
                <i class="fas fa-plus"></i> New Story
            </a>
            <a href="{{ url_for('stories.stories_home', category='all') }}" class="quick-action-btn">
                <i class="fas fa-list"></i> All Stories
            </a>
            <a href="{{ url_for('stories.api_generate_chart') }}" class="quick-action-btn">
                <i class="fas fa-chart-line"></i> Generate Chart
            </a>

            <a href="{{ url_for('enhanced_strategy.strategy_hub') }}" class="quick-action-btn">
                <i class="fas fa-arrow-left"></i> Back to Strategy Hub
            </a>
        </div>
        
        {% if pinecone_status is defined or openai_status is defined or lcm_status is defined %}
        <div class="mt-4 pt-3 border-top">
            <h6 class="text-muted mb-2"><i class="fas fa-info-circle me-1"></i> Integration Status</h6>
            <div class="row g-2 small">
                {% if pinecone_status is defined %}
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <span class="badge {% if pinecone_status == 'Available' %}bg-success{% else %}bg-warning{% endif %} me-2">
                            <i class="fas {% if pinecone_status == 'Available' %}fa-check{% else %}fa-exclamation-triangle{% endif %}"></i>
                        </span>
                        <span>Pinecone: {{ pinecone_status }}</span>
                    </div>
                </div>
                {% endif %}
                
                {% if openai_status is defined %}
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <span class="badge {% if openai_status == 'Available' %}bg-success{% else %}bg-warning{% endif %} me-2">
                            <i class="fas {% if openai_status == 'Available' %}fa-check{% else %}fa-exclamation-triangle{% endif %}"></i>
                        </span>
                        <span>OpenAI: {{ openai_status }}</span>
                    </div>
                </div>
                {% endif %}
                
                {% if lcm_status is defined %}
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <span class="badge {% if lcm_status.startswith('Enabled') %}bg-success{% else %}bg-secondary{% endif %} me-2">
                            <i class="fas {% if lcm_status.startswith('Enabled') %}fa-check{% else %}fa-info-circle{% endif %}"></i>
                        </span>
                        <span>LCM: {{ lcm_status }}</span>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Recent Stories Section -->
    <div class="hub-card" id="recent-stories">
        <div class="hub-card-title">
            <i class="fas fa-history"></i>
            Recent Stories
        </div>
        <div class="card-description">
            Your recently created or viewed sustainability narratives
        </div>
        
        <!-- Story Cards Grid -->
        {% if stories %}
        <div class="story-cards-grid">
            {% for story in stories %}
            <div class="story-card">
                <div class="story-card-header">
                    <div class="story-card-category">{{ story.category }}</div>
                    <h3 class="story-card-title">{{ story.title }}</h3>
                    <span class="audience-tag"><i class="fas fa-users me-1"></i> {{ story.audience }}</span>
                </div>
                
                <div class="story-card-visualization">
                    {% if story.chart_type %}
                    <div class="chart-placeholder" data-chart-id="{{ story.id }}" data-chart-type="{{ story.chart_type }}">
                        <i class="fas fa-chart-{{ story.chart_type|default('bar') }} fa-3x text-muted"></i>
                        <p class="text-center text-muted small">Chart visualization will render here</p>
                    </div>
                    {% endif %}
                </div>
                
                <div class="story-card-narrative">
                    {{ story.content }}
                </div>
                
                <div class="story-card-actions">
                    <button class="story-card-action" title="Share">
                        <i class="fas fa-share-alt"></i>
                    </button>
                    <button class="story-card-action" title="Export">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
                
                <a href="{{ url_for('stories.view_story', story_id=story.id) }}" class="story-card-expand">
                    View Story
                </a>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center p-5">
            <i class="fas fa-newspaper fa-3x mb-3 text-muted"></i>
            <h5>No stories found</h5>
            <p class="text-muted">Use the Create New Story button above to generate sustainability narratives</p>
            <a href="{{ url_for('stories.create_story') }}" class="btn btn-primary mt-3">
                <i class="fas fa-plus me-2"></i> Create Your First Story
            </a>
        </div>
        {% endif %}
    </div>
    
    <!-- AI Copilot Floating Button -->
    <div class="ai-copilot-trigger ai-copilot-pulse" id="ai-storytelling-copilot">
        <i class="fas fa-robot"></i>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 1. Load storytelling templates
        loadStorytellingTemplates();
        
        // 2. Setup tab switching
        setupTabSwitching();
        
        // 3. Setup AI copilot trigger
        setupAiCopilot();
        
        // 4. Initialize chart placeholders if charts library is available
        initializeChartPlaceholders();
    });
    
    // Function to load storytelling templates from API
    function loadStorytellingTemplates() {
        const templatesContainer = document.getElementById('templates-container');
        
        fetch('/api/storytelling/templates')
            .then(response => response.json())
            .then(data => {
                // Clear loading state
                templatesContainer.innerHTML = '';
                
                // Process each template type and create template cards
                Object.keys(data).forEach(key => {
                    const template = data[key];
                    const templateHtml = createTemplateCard(key, template);
                    templatesContainer.innerHTML += templateHtml;
                });
                
                // Add event listeners to template cards
                document.querySelectorAll('.template-card').forEach(card => {
                    card.addEventListener('click', function() {
                        const templateType = this.getAttribute('data-template-type');
                        window.location.href = `{{ url_for('stories.create_story') }}?template=${templateType}`;
                    });
                });
            })
            .catch(error => {
                console.error('Error loading templates:', error);
                templatesContainer.innerHTML = `
                    <div class="text-center p-5 w-100">
                        <i class="fas fa-exclamation-triangle text-warning fa-3x mb-3"></i>
                        <h5>Error Loading Templates</h5>
                        <p class="text-muted">Unable to load storytelling templates. Please try again later.</p>
                        <button class="btn btn-primary mt-2" onclick="loadStorytellingTemplates()">Retry</button>
                    </div>
                `;
            });
    }
    
    // Function to create a template card HTML
    function createTemplateCard(key, template) {
        return `
            <div class="template-card" data-template-type="${key}">
                <div class="template-icon" style="background: rgba(${hexToRgb(template.color || '#36b37e')}, 0.1); color: ${template.color || '#36b37e'}">
                    <i class="fas ${template.icon || 'fa-file-alt'}"></i>
                </div>
                <h3 class="template-card-title">${template.title}</h3>
                <p class="template-card-description">${template.description}</p>
                
                ${template.frameworks ? `
                <div class="mb-3">
                    <small class="text-muted d-block mb-1">Key Frameworks:</small>
                    <div class="d-flex flex-wrap gap-1">
                        ${template.frameworks.map(framework => 
                            `<span class="badge rounded-pill" style="background: rgba(${hexToRgb(template.color || '#36b37e')}, 0.1); color: ${template.color || '#36b37e'}">
                                ${framework}
                            </span>`
                        ).join('')}
                    </div>
                </div>
                ` : ''}
                
                <div class="mt-auto">
                    <a href="{{ url_for('stories.create_story') }}?template=${key}" class="btn btn-sm" style="background: ${template.color || '#36b37e'}; color: #fff;">
                        <i class="fas fa-magic me-1"></i> Use Template
                    </a>
                </div>
            </div>
        `;
    }
    
    // Helper function to convert hex to rgb for styling
    function hexToRgb(hex) {
        // Remove # if present
        hex = hex.replace('#', '');
        
        // Convert 3-digit hex to 6-digits
        if (hex.length === 3) {
            hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2];
        }
        
        // Parse the hex values
        const r = parseInt(hex.substring(0, 2), 16);
        const g = parseInt(hex.substring(2, 4), 16);
        const b = parseInt(hex.substring(4, 6), 16);
        
        return `${r}, ${g}, ${b}`;
    }
    
    // Setup tab switching functionality
    function setupTabSwitching() {
        const tabs = document.querySelectorAll('.hub-tab');
        
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                // Remove active class from all tabs
                tabs.forEach(t => t.classList.remove('active'));
                
                // Add active class to clicked tab
                this.classList.add('active');
                
                // Get the selected category
                const category = this.getAttribute('data-tab');
                
                // Filter stories based on category (if implemented)
                filterStories(category);
            });
        });
    }
    
    // Filter stories based on selected category
    function filterStories(category) {
        // This would filter stories in a real implementation
        console.log(`Filtering stories by category: ${category}`);
        
        // For demo purposes, we'll just show all stories
        // In a real implementation, you would show/hide story cards based on their category
    }
    
    // Setup AI copilot trigger
    function setupAiCopilot() {
        const copilotButton = document.getElementById('ai-storytelling-copilot');
        
        if (copilotButton) {
            copilotButton.addEventListener('click', function() {
                // This would trigger the AI copilot in a real implementation
                alert('AI Storytelling Copilot would be triggered here.\n\nIn the full implementation, this would open an assistant to help generate stories.');
            });
        }
    }
    
    // Initialize chart placeholders
    function initializeChartPlaceholders() {
        const chartPlaceholders = document.querySelectorAll('.chart-placeholder');
        
        // If Chart.js is available, this would initialize charts
        if (typeof Chart !== 'undefined') {
            chartPlaceholders.forEach(placeholder => {
                // This would create actual charts in a real implementation
                console.log(`Chart would be initialized here for story ${placeholder.getAttribute('data-chart-id')}`);
            });
        }
    }
</script>
{% endblock %}