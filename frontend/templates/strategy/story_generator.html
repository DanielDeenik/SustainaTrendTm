{% extends "layouts/base_clean.html" %}

{% set active_page = 'strategy_hub' %}

{% block header_title %}
<i class="fas fa-book me-2"></i> Generate Story from Document
{% endblock %}

{% block header_actions %}
<a href="{{ url_for('strategy.strategy_hub_document_view', document_id=document.filename) }}" class="btn btn-sm btn-outline-secondary">Back to Document</a>
<a href="{{ url_for('strategy.unified_strategy_hub') }}" class="btn btn-sm btn-outline-secondary">Back to Hub</a>
{% endblock %}

{% block extra_css %}
<style>
    .doc-summary {
        background-color: var(--bs-light);
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .story-form {
        background-color: var(--bs-light);
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .insight-badge {
        display: inline-block;
        padding: 0.35rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 600;
        border-radius: 1rem;
        margin-bottom: 0.5rem;
        margin-right: 0.5rem;
        background-color: rgba(var(--bs-primary-rgb), 0.15);
        color: var(--bs-primary);
    }
    
    .metric-mini {
        background-color: rgba(var(--bs-primary-rgb), 0.05);
        border-radius: 0.5rem;
        padding: 0.75rem;
        margin-bottom: 0.75rem;
    }
    
    .metric-mini h6 {
        margin-bottom: 0.25rem;
    }
    
    .metric-value {
        font-size: 1.2rem;
        font-weight: bold;
    }
    
    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
        .doc-summary, .story-form {
            background-color: var(--bs-dark);
        }
        
        .insight-badge {
            background-color: rgba(var(--bs-primary-rgb), 0.3);
        }
        
        .metric-mini {
            background-color: rgba(var(--bs-primary-rgb), 0.15);
        }
    }
</style>
{% endblock %}

{% block main_content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i> You're about to generate an AI-powered sustainability story based on the document "<strong>{{ document.filename }}</strong>". Customize options below.
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-5">
        <div class="doc-summary">
            <h5 class="mb-3">Document Summary</h5>
            
            <div class="mb-3">
                <strong>Title:</strong> {{ document.filename }}
            </div>
            
            {% if document_data.insights %}
            <div class="mb-3">
                <strong>Key Insights:</strong>
                <div class="mt-2">
                    {% for insight in document_data.insights[:3] %}
                    <p class="small">{{ insight }}</p>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            {% if document_data.metrics %}
            <div class="mb-3">
                <strong>Key Metrics:</strong>
                <div class="row mt-2">
                    {% for metric in document_data.metrics[:6] %}
                    <div class="col-md-6">
                        <div class="metric-mini">
                            <h6>{{ metric.name }}</h6>
                            <div class="metric-value">{{ metric.value }} {{ metric.unit }}</div>
                            <div class="small text-muted">{{ metric.category|capitalize }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <div class="content-preview mt-3">
                <a data-bs-toggle="collapse" href="#contentPreview" role="button" aria-expanded="false" aria-controls="contentPreview" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-eye me-1"></i> View Document Content Preview
                </a>
                <div class="collapse mt-2" id="contentPreview">
                    <div class="card card-body">
                        {% if document_data.content %}
                        <p class="small">{{ document_data.content[:500] }}{% if document_data.content|length > 500 %}...{% endif %}</p>
                        {% else %}
                        <p class="small text-muted">No content preview available.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-7">
        <div class="story-form">
            <h5 class="mb-3">Generate Story</h5>
            <form action="{{ url_for('strategy.api_storytelling_generate') }}" method="POST" id="storyGeneratorForm">
                <input type="hidden" name="document_id" value="{{ document.filename }}">
                <input type="hidden" name="has_document_data" value="true">
                
                <div class="mb-3">
                    <label for="audience" class="form-label">Target Audience</label>
                    <select class="form-select" id="audience" name="audience" required>
                        <option value="" selected disabled>Select audience...</option>
                        {% for option in audience_options %}
                        <option value="{{ option.id }}">{{ option.name }}</option>
                        {% endfor %}
                    </select>
                    <div class="form-text">Who will be reading this sustainability story?</div>
                </div>
                
                <div class="mb-3">
                    <label for="category" class="form-label">Primary Focus</label>
                    <select class="form-select" id="category" name="category" required>
                        <option value="" selected disabled>Select focus area...</option>
                        {% for option in category_options %}
                        <option value="{{ option.id }}">{{ option.name }}</option>
                        {% endfor %}
                    </select>
                    <div class="form-text">Which sustainability area should the story focus on?</div>
                </div>
                
                <div class="mb-3">
                    <label for="prompt" class="form-label">Additional Context (Optional)</label>
                    <textarea class="form-control" id="prompt" name="prompt" rows="3" placeholder="Add any specific details or requirements for the story..."></textarea>
                    <div class="form-text">Add any specific details, context or questions you want addressed in the story.</div>
                </div>
                
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-magic me-2"></i> Generate Story
                    </button>
                </div>
            </form>
        </div>
        
        <div class="story-preview" id="storyPreview" style="display: none;">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Generated Story</h5>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="editStoryBtn">Edit</button>
                </div>
                <div class="card-body">
                    <h4 id="storyTitle"></h4>
                    <div class="mb-3">
                        <span class="badge bg-primary me-2" id="storyCategory"></span>
                        <span class="badge bg-secondary" id="storyAudience"></span>
                    </div>
                    <div class="mb-3" id="storyContent"></div>
                    
                    <h5>Key Insights</h5>
                    <ul id="storyInsights" class="mb-4"></ul>
                    
                    <h5>Recommendations</h5>
                    <ul id="storyRecommendations"></ul>
                </div>
                <div class="card-footer">
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-outline-secondary me-md-2">
                            <i class="fas fa-download me-1"></i> Download
                        </button>
                        <button type="button" class="btn btn-primary">
                            <i class="fas fa-share-alt me-1"></i> Share
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock main_content %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const storyForm = document.getElementById('storyGeneratorForm');
        const storyPreview = document.getElementById('storyPreview');
        const editStoryBtn = document.getElementById('editStoryBtn');
        
        // Handle form submission
        storyForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Show loading state
            const submitBtn = storyForm.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Generating...';
            submitBtn.disabled = true;
            
            // Get form data
            const formData = new FormData(storyForm);
            const jsonData = {};
            formData.forEach((value, key) => {
                jsonData[key] = value;
            });
            
            // Add document data
            jsonData.document_data = {
                title: "{{ document_data.title|safe }}",
                content: "{{ document_data.content|truncate(1000)|safe }}",
                insights: [],
                metrics: []
            };
            
            {% if document_data.insights %}
            {% for insight in document_data.insights %}
            jsonData.document_data.insights.push("{{ insight|safe }}");
            {% endfor %}
            {% endif %}
            
            {% if document_data.metrics %}
            {% for metric in document_data.metrics %}
            jsonData.document_data.metrics.push({
                name: "{{ metric.name|safe }}",
                value: "{{ metric.value|safe }}",
                unit: "{{ metric.unit|safe }}",
                category: "{{ metric.category|safe }}"
            });
            {% endfor %}
            {% endif %}
            
            // Call API
            fetch('{{ url_for("strategy.api_storytelling_generate") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(jsonData)
            })
            .then(response => response.json())
            .then(data => {
                // Restore button
                submitBtn.innerHTML = originalBtnText;
                submitBtn.disabled = false;
                
                if (data.error) {
                    alert('Error generating story: ' + data.message);
                    return;
                }
                
                // Display the story
                document.getElementById('storyTitle').textContent = data.title;
                document.getElementById('storyCategory').textContent = data.category;
                document.getElementById('storyAudience').textContent = data.audience;
                document.getElementById('storyContent').innerHTML = data.content;
                
                // Clear and populate insights
                const insightsList = document.getElementById('storyInsights');
                insightsList.innerHTML = '';
                if (data.insights && data.insights.length > 0) {
                    data.insights.forEach(insight => {
                        const li = document.createElement('li');
                        li.textContent = insight;
                        insightsList.appendChild(li);
                    });
                } else {
                    insightsList.innerHTML = '<li>No specific insights available</li>';
                }
                
                // Clear and populate recommendations
                const recommendationsList = document.getElementById('storyRecommendations');
                recommendationsList.innerHTML = '';
                if (data.recommendations && data.recommendations.length > 0) {
                    data.recommendations.forEach(recommendation => {
                        const li = document.createElement('li');
                        li.textContent = recommendation;
                        recommendationsList.appendChild(li);
                    });
                } else {
                    recommendationsList.innerHTML = '<li>No specific recommendations available</li>';
                }
                
                // Show the preview
                storyForm.style.display = 'none';
                storyPreview.style.display = 'block';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error generating story: ' + error);
                submitBtn.innerHTML = originalBtnText;
                submitBtn.disabled = false;
            });
        });
        
        // Handle edit button
        editStoryBtn.addEventListener('click', function() {
            storyPreview.style.display = 'none';
            storyForm.style.display = 'block';
        });
    });
</script>
{% endblock extra_js %}