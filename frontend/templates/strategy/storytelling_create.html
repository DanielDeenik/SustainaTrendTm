{% extends "layouts/finchat_dark_layout.html" %}

{% set active_page = 'storytelling' %}

{% block header_title %}
<i class="fas fa-edit me-2"></i> Create AI Sustainability Story
{% endblock %}

{% block extra_css %}
<style>
    .story-creator-form {
        max-width: 800px;
        margin: 0 auto;
    }
    
    .story-form-card {
        border-radius: 0.75rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .explanation-card {
        background-color: rgba(var(--bs-primary-rgb), 0.1);
        border-left: 4px solid var(--bs-primary);
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .category-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 1rem;
        margin-right: 0.5rem;
        display: inline-block;
        background-color: rgba(var(--bs-primary-rgb), 0.15);
        color: var(--bs-primary);
    }
    
    .audience-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 1rem;
        display: inline-block;
        background-color: rgba(33, 37, 41, 0.1);
        color: #212529;
    }
    
    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
        .explanation-card {
            background-color: rgba(var(--bs-primary-rgb), 0.2);
        }
        
        .category-badge {
            background-color: rgba(var(--bs-primary-rgb), 0.3);
        }
        
        .audience-badge {
            background-color: rgba(248, 249, 250, 0.2);
            color: #f8f9fa;
        }
    }
</style>
{% endblock %}

{% block main_content %}
<div class="story-creator-form">
    <div class="explanation-card mb-4">
        <h5><i class="fas fa-lightbulb me-2"></i> About AI Storytelling</h5>
        <p class="mb-0">
            Create data-driven sustainability stories tailored to different audiences and categories. 
            These stories transform sustainability data into compelling narratives that communicate your 
            environmental and social impact in a way that resonates with your target audience.
        </p>
    </div>
    
    <div class="card story-form-card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-edit me-2"></i> Create New Story</h5>
        </div>
        <div class="card-body">
            <form id="storyGenerationForm" method="POST" action="/stories/api/generate">
                <div class="mb-3">
                    <label for="audience" class="form-label">Target Audience</label>
                    <select class="form-select" id="audience" name="audience" required>
                        <option value="" disabled selected>Select audience</option>
                        <option value="board">Board of Directors</option>
                        <option value="investors">Investors</option>
                        <option value="sustainability_team">Sustainability Team</option>
                        <option value="employees">Employees</option>
                        <option value="customers">Customers</option>
                        <option value="regulators">Regulators</option>
                        <option value="public">General Public</option>
                        <option value="partners">Business Partners</option>
                        <option value="all">All Audiences</option>
                    </select>
                    <div class="form-text">Select the primary audience for this sustainability story.</div>
                </div>
                
                <div class="mb-3">
                    <label for="category" class="form-label">Sustainability Category</label>
                    <select class="form-select" id="category" name="category" required>
                        <option value="" disabled selected>Select category</option>
                        <option value="emissions">Carbon Emissions</option>
                        <option value="water">Water Management</option>
                        <option value="energy">Energy Efficiency</option>
                        <option value="waste">Waste Reduction</option>
                        <option value="social">Social Impact</option>
                        <option value="governance">Governance</option>
                        <option value="biodiversity">Biodiversity</option>
                        <option value="climate">Climate Resilience</option>
                        <option value="supply_chain">Supply Chain</option>
                        <option value="circular_economy">Circular Economy</option>
                        <option value="sdgs">Sustainable Development Goals</option>
                        <option value="strategy">Sustainability Strategy</option>
                        <option value="all">All Categories</option>
                    </select>
                    <div class="form-text">Select the sustainability category for this story.</div>
                </div>
                
                <div class="mb-4">
                    <label for="metrics" class="form-label">Select Metrics (Optional)</label>
                    <select class="form-select" id="metrics" name="metrics" multiple>
                        <!-- Metrics will be loaded dynamically based on category selection -->
                    </select>
                    <div class="form-text">
                        Select specific metrics to include in your sustainability story. The available metrics will update based on your 
                        selected category.
                    </div>
                </div>
                
                <div class="mb-4">
                    <label for="prompt" class="form-label">Custom Prompt (Optional)</label>
                    <textarea class="form-control" id="prompt" name="prompt" rows="4" placeholder="Enter specific details or instructions for the AI to include in the generated story..."></textarea>
                    <div class="form-text">
                        Provide any specific details, data points, or instructions you'd like the AI to include in the 
                        generated story. If left blank, a general story based on the audience and category will be created.
                    </div>
                </div>
                
                <div class="alert alert-danger d-none" id="storyGenerationError"></div>
                
                <div class="row mt-4">
                    <div class="col-6">
                        <a href="{{ url_for('stories.stories_home') }}" class="btn btn-secondary w-100">
                            <i class="fas fa-arrow-left me-2"></i> Back to Stories
                        </a>
                    </div>
                    <div class="col-6">
                        <button type="submit" class="btn btn-primary w-100" id="generateStoryBtn">
                            <i class="fas fa-magic me-2"></i> Generate Story
                        </button>
                    </div>
                </div>
            </form>
            
            <div id="generationSpinner" class="text-center my-4 d-none">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Generating sustainability story...</p>
            </div>
        </div>
    </div>
    
    <div class="card mt-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">Story Examples by Audience</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="audience-badge mb-2">Board of Directors</div>
                    <p class="small">Strategic stories focusing on long-term sustainability impact on business value, risk mitigation, and competitive positioning.</p>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="audience-badge mb-2">Investors</div>
                    <p class="small">Data-driven stories highlighting ESG performance, financial implications, and comparison to industry benchmarks.</p>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="audience-badge mb-2">Customers</div>
                    <p class="small">Stories connecting your sustainability efforts to customer values and how your products/services advance sustainability goals.</p>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="audience-badge mb-2">Regulators</div>
                    <p class="small">Compliance-focused stories demonstrating adherence to regulations, transparency in reporting, and proactive approaches.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock main_content %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('storyGenerationForm');
    const spinner = document.getElementById('generationSpinner');
    const errorElement = document.getElementById('storyGenerationError');
    const categorySelect = document.getElementById('category');
    const metricsSelect = document.getElementById('metrics');
    
    // Load metrics when category changes
    categorySelect.addEventListener('change', function() {
        loadMetricsForCategory(this.value);
    });
    
    // Initial metrics load
    if (categorySelect.value && categorySelect.value !== '') {
        loadMetricsForCategory(categorySelect.value);
    }
    
    // Function to load metrics for a selected category
    function loadMetricsForCategory(category) {
        // Clear existing options
        metricsSelect.innerHTML = '<option value="" disabled>Loading metrics...</option>';
        
        // Fetch metrics for the selected category
        fetch(`/stories/api/storytelling/metrics?category=${encodeURIComponent(category)}`)
            .then(response => response.json())
            .then(data => {
                metricsSelect.innerHTML = '';
                
                if (data && data.metrics && data.metrics.length > 0) {
                    // Add metrics as options
                    data.metrics.forEach(metric => {
                        const option = document.createElement('option');
                        option.value = metric.name;
                        option.textContent = `${metric.name} (${metric.value} ${metric.unit})`;
                        metricsSelect.appendChild(option);
                    });
                } else {
                    metricsSelect.innerHTML = '<option value="" disabled>No metrics available for this category</option>';
                }
            })
            .catch(error => {
                console.error('Error loading metrics:', error);
                metricsSelect.innerHTML = '<option value="" disabled>Failed to load metrics</option>';
            });
    }
    
    form.addEventListener('submit', function(e) {
        e.preventDefault(); // Prevent default form submission
        
        // Hide any previous errors
        errorElement.classList.add('d-none');
        
        // Show spinner
        spinner.classList.remove('d-none');
        
        // Disable submit button to prevent double submission
        document.getElementById('generateStoryBtn').disabled = true;
        
        // Get selected metrics
        const selectedMetrics = Array.from(metricsSelect.selectedOptions).map(option => option.value);
        
        // Get form data
        const formData = {
            audience: document.getElementById('audience').value,
            category: document.getElementById('category').value,
            metrics: selectedMetrics,
            prompt: document.getElementById('prompt').value
        };
        
        // Send AJAX request
        fetch(form.action, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            spinner.classList.add('d-none');
            if (data.success || data.status === 'success') {
                // Redirect to story detail page
                if (data.story && data.story.id) {
                    window.location.href = "{{ url_for('stories.stories_home') }}";
                } else {
                    showError('Story generated but no ID was returned');
                }
            } else {
                showError(data.error || 'An error occurred while generating the story');
            }
        })
        .catch(error => {
            spinner.classList.add('d-none');
            showError('Network error: ' + error.message);
            document.getElementById('generateStoryBtn').disabled = false;
        });
    });
    
    function showError(message) {
        errorElement.textContent = message;
        errorElement.classList.remove('d-none');
        document.getElementById('generateStoryBtn').disabled = false;
    }
});
</script>
{% endblock extra_js %}