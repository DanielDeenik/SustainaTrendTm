{% extends "layouts/finchat_dark_layout.html" %}

{% set active_page = 'storytelling' %}

{% block header_title %}
<i class="fas fa-newspaper me-2"></i> {{ story.title if story else 'Sustainability Story' }}
{% endblock %}

{% block header_actions %}
<a href="{{ url_for('stories.stories_home') }}" class="btn btn-sm btn-outline-secondary">
    <i class="fas fa-arrow-left me-1"></i> Back to Stories
</a>
<a href="{{ url_for('stories.edit_story', story_id=story.id) }}" class="btn btn-sm btn-primary">
    <i class="fas fa-edit me-1"></i> Edit Story
</a>
<button id="shareStoryBtn" class="btn btn-sm btn-outline-primary">
    <i class="fas fa-share-alt me-1"></i> Share
</button>
<a href="{{ url_for('stories.api_export_story_pdf', story_id=story.id) if story }}" class="btn btn-sm btn-outline-primary">
    <i class="fas fa-file-pdf me-1"></i> Export PDF
</a>
<button id="deleteStoryBtn" class="btn btn-sm btn-outline-danger">
    <i class="fas fa-trash-alt me-1"></i> Delete
</button>
{% endblock %}

{% block extra_css %}
<style>
    .story-header {
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .story-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .story-meta-item {
        display: flex;
        align-items: center;
        font-size: 0.875rem;
        color: #6c757d;
    }
    
    .story-meta-item i {
        margin-right: 0.5rem;
    }
    
    .story-content {
        font-size: 1.1rem;
        line-height: 1.6;
    }
    
    .story-content p {
        margin-bottom: 1.5rem;
    }
    
    .story-recommendations {
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .recommendation-item {
        margin-bottom: 1rem;
        padding: 1rem;
        border-radius: 0.5rem;
        background-color: rgba(16, 185, 129, 0.1);
        border-left: 4px solid #10b981;
    }
    
    .story-footer {
        margin-top: 3rem;
        padding-top: 1.5rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .category-badge {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .engagement-stats {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
        margin-top: 1rem;
    }
    
    .engagement-item {
        display: flex;
        align-items: center;
        font-size: 0.875rem;
        color: #6c757d;
    }
    
    .engagement-item i {
        margin-right: 0.5rem;
    }
    
    .share-modal .modal-header {
        border-bottom-color: rgba(255, 255, 255, 0.1);
    }
    
    .share-modal .modal-footer {
        border-top-color: rgba(255, 255, 255, 0.1);
    }
    
    .share-link-input {
        background-color: rgba(255, 255, 255, 0.05);
        color: #fff;
        border-color: rgba(255, 255, 255, 0.1);
    }
</style>
{% endblock %}

{% block main_content %}
{% if story %}
<div class="card">
    <div class="card-body">
        <div class="story-header">
            <span class="badge bg-success category-badge mb-2">{{ story.category }}</span>
            <h1 class="mb-3">{{ story.title }}</h1>
            
            <div class="story-meta">
                <div class="story-meta-item">
                    <i class="fas fa-users"></i> {{ story.audience }}
                </div>
                <div class="story-meta-item">
                    <i class="far fa-calendar"></i> {{ story.timestamp if story.timestamp else 'Generated today' }}
                </div>
                {% if story.template %}
                <div class="story-meta-item">
                    <i class="fas fa-file-alt"></i> {{ story.template|capitalize }} Template
                </div>
                {% endif %}
                {% if story.industry %}
                <div class="story-meta-item">
                    <i class="fas fa-industry"></i> {{ story.industry|replace('_', ' ')|capitalize }}
                </div>
                {% endif %}
                {% if story.tone %}
                <div class="story-meta-item">
                    <i class="fas fa-comment"></i> {{ story.tone|capitalize }} Tone
                </div>
                {% endif %}
                {% if story.generated_using_lcm %}
                <div class="story-meta-item">
                    <i class="fas fa-brain"></i> Generated with LCM
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="story-content">
            {% if story.content|length > 0 %}
                {% for paragraph in story.content.split('\n\n') %}
                    <p>{{ paragraph }}</p>
                {% endfor %}
            {% else %}
                <p>{{ story.content }}</p>
            {% endif %}
        </div>
        
        {% if story.metrics and story.metrics|length > 0 %}
        <div class="story-metrics mb-4">
            <h4 class="mb-3"><i class="fas fa-chart-line me-2"></i> Key Metrics</h4>
            
            <div class="row g-3">
                {% for metric in story.metrics %}
                <div class="col-md-4">
                    <div class="card bg-dark border-0 h-100">
                        <div class="card-body">
                            <h5 class="mb-1">{{ metric.name }}</h5>
                            <div class="d-flex align-items-center">
                                <span class="display-6 me-2">{{ metric.value }}</span>
                                <span class="text-muted">{{ metric.unit }}</span>
                            </div>
                            {% if metric.change %}
                            <div class="mt-2">
                                <span class="badge {{ 'bg-success' if metric.change > 0 else 'bg-danger' }}">
                                    <i class="fas {{ 'fa-arrow-up' if metric.change > 0 else 'fa-arrow-down' }}"></i>
                                    {{ metric.change|abs|round(1) }}%
                                </span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        {% if story.recommendations and story.recommendations|length > 0 %}
        <div class="story-recommendations">
            <h4 class="mb-3"><i class="fas fa-lightbulb me-2"></i> Recommendations</h4>
            
            {% for recommendation in story.recommendations %}
            <div class="recommendation-item">
                <p class="mb-0">{{ recommendation }}</p>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        
        <div class="story-footer">
            <h5 class="mb-3">Story Engagement</h5>
            
            <div class="engagement-stats">
                <div class="engagement-item">
                    <i class="far fa-eye"></i> {{ story.views|default(1) }} Views
                </div>
                <div class="engagement-item">
                    <i class="far fa-share-square"></i> {{ story.shares|default(0) }} Shares
                </div>
                <div class="engagement-item">
                    <i class="far fa-bookmark"></i> {{ story.bookmarks|default(0) }} Bookmarks
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Related Stories Section -->
{% if related_stories and related_stories|length > 0 %}
<div class="mt-4">
    <h4 class="mb-3">Related Stories</h4>
    
    <div class="row g-3">
        {% for related in related_stories %}
        <div class="col-md-6 col-lg-4">
            <div class="card h-100">
                <div class="card-body">
                    <span class="badge bg-success category-badge">{{ related.category }}</span>
                    <h5 class="card-title">{{ related.title }}</h5>
                    <p class="card-text small">{{ related.content|truncate(100) }}</p>
                </div>
                <div class="card-footer bg-transparent">
                    <a href="{{ url_for('storytelling.view_story', story_id=related.id) }}" class="btn btn-sm btn-outline-primary">View Story</a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Share Modal -->
<div class="modal fade share-modal" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shareModalLabel">Share This Story</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="shareLink" class="form-label">Story Link</label>
                    <div class="input-group">
                        <input type="text" class="form-control share-link-input" id="shareLink" value="{{ request.url }}" readonly>
                        <button class="btn btn-outline-secondary" type="button" id="copyLinkBtn">Copy</button>
                    </div>
                </div>
                
                <div class="d-flex gap-2 mt-4">
                    <button class="btn btn-outline-primary" type="button" id="shareLinkedIn">
                        <i class="fab fa-linkedin me-1"></i> LinkedIn
                    </button>
                    <button class="btn btn-outline-primary" type="button" id="shareTwitter">
                        <i class="fab fa-twitter me-1"></i> Twitter
                    </button>
                    <button class="btn btn-outline-primary" type="button" id="shareEmail">
                        <i class="fas fa-envelope me-1"></i> Email
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this story? This action cannot be undone.</p>
                <h6 class="mb-3">{{ story.title }}</h6>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="alert alert-warning">
    <i class="fas fa-exclamation-triangle me-2"></i> Story not found
</div>
{% endif %}
{% endblock main_content %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Share modal functionality
        const shareBtn = document.getElementById('shareStoryBtn');
        const shareModal = new bootstrap.Modal(document.getElementById('shareModal'));
        
        if (shareBtn) {
            shareBtn.addEventListener('click', function() {
                shareModal.show();
            });
        }
        
        // Delete modal functionality
        const deleteBtn = document.getElementById('deleteStoryBtn');
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        
        if (deleteBtn) {
            deleteBtn.addEventListener('click', function() {
                deleteModal.show();
            });
        }
        
        if (confirmDeleteBtn) {
            confirmDeleteBtn.addEventListener('click', function() {
                // Show loading state
                confirmDeleteBtn.disabled = true;
                confirmDeleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Deleting...';
                
                // Call delete API
                fetch('{{ url_for("storytelling.api_delete_story", story_id=story.id) }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Redirect to stories home page with success message
                        const successMessage = encodeURIComponent('Story deleted successfully');
                        window.location.href = '{{ url_for("storytelling.storytelling_home") }}?message=' + successMessage + '&type=success';
                    } else {
                        // Show error message
                        alert('Error deleting story: ' + (data.error || 'Unknown error'));
                        confirmDeleteBtn.disabled = false;
                        confirmDeleteBtn.innerHTML = 'Delete';
                    }
                })
                .catch(error => {
                    console.error('Error deleting story:', error);
                    alert('Error deleting story. Please try again.');
                    confirmDeleteBtn.disabled = false;
                    confirmDeleteBtn.innerHTML = 'Delete';
                });
            });
        }
        
        // Copy link functionality
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        const shareLinkInput = document.getElementById('shareLink');
        
        if (copyLinkBtn && shareLinkInput) {
            copyLinkBtn.addEventListener('click', function() {
                shareLinkInput.select();
                document.execCommand('copy');
                
                // Show copied indicator
                const originalText = copyLinkBtn.textContent;
                copyLinkBtn.textContent = 'Copied!';
                
                setTimeout(function() {
                    copyLinkBtn.textContent = originalText;
                }, 2000);
            });
        }
        
        // Social sharing functionality
        const shareLinkedIn = document.getElementById('shareLinkedIn');
        const shareTwitter = document.getElementById('shareTwitter');
        const shareEmail = document.getElementById('shareEmail');
        
        if (shareLinkedIn) {
            shareLinkedIn.addEventListener('click', function() {
                const url = encodeURIComponent(shareLinkInput.value);
                const title = encodeURIComponent(document.title);
                window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${url}`, '_blank');
            });
        }
        
        if (shareTwitter) {
            shareTwitter.addEventListener('click', function() {
                const url = encodeURIComponent(shareLinkInput.value);
                const title = encodeURIComponent(document.title);
                window.open(`https://twitter.com/intent/tweet?url=${url}&text=${title}`, '_blank');
            });
        }
        
        if (shareEmail) {
            shareEmail.addEventListener('click', function() {
                const url = shareLinkInput.value;
                const title = document.title;
                window.location.href = `mailto:?subject=${encodeURIComponent(title)}&body=${encodeURIComponent('Check out this sustainability story: ' + url)}`;
            });
        }
        
        // Record view
        fetch('{{ url_for("storytelling.api_record_story_view", story_id=story.id) if story }}', {
            method: 'POST'
        }).catch(err => console.error('Failed to record view', err));
    });
</script>
{% endblock extra_js %}