{% extends "layouts/finchat_dark_layout.html" %}

{% set active_page = 'storytelling' %}

{% block header_title %}
<i class="fas fa-plus-circle me-2"></i> Create Sustainability Story
{% endblock %}

{% block header_actions %}
<a href="{{ url_for('storytelling.storytelling_home') }}" class="btn btn-sm btn-outline-secondary">
    <i class="fas fa-arrow-left me-1"></i> Back to Stories
</a>
{% endblock %}

{% block extra_css %}
<style>
    .story-form {
        margin-bottom: 2rem;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .audience-card {
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.2s;
        height: 100%;
    }
    
    .audience-card:hover {
        transform: translateY(-3px);
    }
    
    .audience-card.selected {
        border-color: var(--bs-primary);
        background-color: rgba(var(--bs-primary-rgb), 0.05);
    }
    
    .audience-icon {
        font-size: 2rem;
        margin-bottom: 1rem;
    }
    
    .template-card {
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.2s;
        height: 100%;
    }
    
    .template-card:hover {
        transform: translateY(-3px);
    }
    
    .template-card.selected {
        border-color: var(--bs-primary);
        background-color: rgba(var(--bs-primary-rgb), 0.05);
    }
    
    .form-section {
        margin-bottom: 2rem;
        padding: 1.5rem;
        border-radius: 0.5rem;
        background-color: rgba(255, 255, 255, 0.05);
    }
    
    .form-section-header {
        margin-bottom: 1.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding-bottom: 0.75rem;
    }
    
    .preview-section {
        margin-top: 2rem;
        display: none;
    }
    
    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
        .audience-card.selected {
            background-color: rgba(var(--bs-primary-rgb), 0.2);
        }
        
        .template-card.selected {
            background-color: rgba(var(--bs-primary-rgb), 0.2);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h4 class="mb-0"><i class="fas fa-magic me-2"></i> Create New Sustainability Story</h4>
    </div>
    <div class="card-body">
        {% if not lcm_available %}
        <div class="alert alert-warning mb-4">
            <i class="fas fa-exclamation-triangle me-2"></i> <strong>Note:</strong> Enhanced story generation with Latent Concept Models is currently not available. Your stories will be generated using our built-in templates.
        </div>
        {% endif %}
        
        <form id="storyGenerationForm" action="{{ url_for('storytelling.api_generate_story') }}" method="POST" class="story-form">
            <div class="form-section">
                <div class="form-section-header">
                    <h5><i class="fas fa-bookmark me-2"></i> Story Topic</h5>
                    <p class="text-muted">What would you like your story to focus on?</p>
                </div>
                
                <div class="form-group">
                    <label for="topic" class="form-label">Topic or Focus Area</label>
                    <input type="text" class="form-control" id="topic" name="topic" placeholder="e.g., Carbon Emissions Reduction, Water Conservation" required>
                    <div class="form-text">The main subject of your sustainability story</div>
                </div>
                
                <div class="form-group">
                    <label for="industry" class="form-label">Industry Context (optional)</label>
                    <select class="form-select" id="industry" name="industry">
                        <option value="">Select an industry (optional)</option>
                        <option value="real_estate">Real Estate & Construction</option>
                        <option value="energy">Energy & Utilities</option>
                        <option value="manufacturing">Manufacturing</option>
                        <option value="retail">Retail & Consumer Goods</option>
                        <option value="technology">Technology</option>
                        <option value="finance">Financial Services</option>
                        <option value="healthcare">Healthcare</option>
                        <option value="transportation">Transportation & Logistics</option>
                        <option value="agriculture">Agriculture & Food</option>
                        <option value="hospitality">Hospitality & Tourism</option>
                    </select>
                    <div class="form-text">Add industry-specific context to your story</div>
                </div>
                
                <div class="form-group">
                    <label for="data" class="form-label">Key Data Points (optional)</label>
                    <textarea class="form-control" id="data" name="data" rows="3" placeholder="e.g., 30% emissions reduction by 2025, 50% renewable energy usage"></textarea>
                    <div class="form-text">Include key metrics or data points to highlight in your story</div>
                </div>
            </div>
            
            <div class="form-section">
                <div class="form-section-header">
                    <h5><i class="fas fa-users me-2"></i> Target Audience</h5>
                    <p class="text-muted">Who is this story primarily aimed at?</p>
                </div>
                
                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <div class="card audience-card text-center p-3" data-audience="investors">
                            <div class="audience-icon text-primary">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <h5>Investors</h5>
                            <p class="small text-muted mb-0">Focus on financial impact and long-term value</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card audience-card text-center p-3" data-audience="customers">
                            <div class="audience-icon text-success">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <h5>Customers</h5>
                            <p class="small text-muted mb-0">Emphasize product benefits and responsible choices</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card audience-card text-center p-3" data-audience="employees">
                            <div class="audience-icon text-info">
                                <i class="fas fa-users"></i>
                            </div>
                            <h5>Employees</h5>
                            <p class="small text-muted mb-0">Highlight corporate culture and engagement</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card audience-card text-center p-3" data-audience="regulators">
                            <div class="audience-icon text-warning">
                                <i class="fas fa-balance-scale"></i>
                            </div>
                            <h5>Regulators</h5>
                            <p class="small text-muted mb-0">Focus on compliance and best practices</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card audience-card text-center p-3" data-audience="community">
                            <div class="audience-icon text-danger">
                                <i class="fas fa-home"></i>
                            </div>
                            <h5>Community</h5>
                            <p class="small text-muted mb-0">Emphasize local impact and social responsibility</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card audience-card text-center p-3" data-audience="partners">
                            <div class="audience-icon text-secondary">
                                <i class="fas fa-handshake"></i>
                            </div>
                            <h5>Partners</h5>
                            <p class="small text-muted mb-0">Focus on collaboration and shared goals</p>
                        </div>
                    </div>
                </div>
                
                <input type="hidden" id="selectedAudience" name="audience" value="investors">
            </div>
            
            <div class="form-section">
                <div class="form-section-header">
                    <h5><i class="fas fa-file-alt me-2"></i> Story Template</h5>
                    <p class="text-muted">Choose a template for your story structure</p>
                </div>
                
                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <div class="card template-card text-center p-3" data-template="impact">
                            <h5>Impact Story</h5>
                            <p class="small text-muted">Focuses on the real-world impact of sustainability initiatives</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card template-card text-center p-3" data-template="journey">
                            <h5>Journey Narrative</h5>
                            <p class="small text-muted">Chronicles the sustainability journey with milestones</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card template-card text-center p-3" data-template="challenge">
                            <h5>Challenge & Solution</h5>
                            <p class="small text-muted">Presents a sustainability challenge and innovative solution</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card template-card text-center p-3" data-template="data">
                            <h5>Data-Driven</h5>
                            <p class="small text-muted">Uses metrics and data to tell a compelling story</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card template-card text-center p-3" data-template="future">
                            <h5>Future Vision</h5>
                            <p class="small text-muted">Outlines future goals and aspirational targets</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card template-card text-center p-3" data-template="comparison">
                            <h5>Comparative Analysis</h5>
                            <p class="small text-muted">Compares performance against industry benchmarks</p>
                        </div>
                    </div>
                </div>
                
                <input type="hidden" id="selectedTemplate" name="template" value="impact">
            </div>
            
            <div class="form-section">
                <div class="form-section-header">
                    <h5><i class="fas fa-cog me-2"></i> Advanced Options</h5>
                </div>
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="tone" class="form-label">Tone</label>
                            <select class="form-select" id="tone" name="tone">
                                <option value="professional">Professional</option>
                                <option value="conversational">Conversational</option>
                                <option value="inspiring">Inspiring</option>
                                <option value="analytical">Analytical</option>
                                <option value="educational">Educational</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="length" class="form-label">Story Length</label>
                            <select class="form-select" id="length" name="length">
                                <option value="short">Short (1-2 paragraphs)</option>
                                <option value="medium" selected>Medium (3-5 paragraphs)</option>
                                <option value="long">Long (6+ paragraphs)</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="form-check mt-3">
                    <input class="form-check-input" type="checkbox" id="includeRecommendations" name="include_recommendations" value="1" checked>
                    <label class="form-check-label" for="includeRecommendations">
                        Include actionable recommendations
                    </label>
                </div>
                
                {% if lcm_available %}
                <div class="form-check mt-2">
                    <input class="form-check-input" type="checkbox" id="useLCM" name="use_lcm" value="1" checked>
                    <label class="form-check-label" for="useLCM">
                        Use Latent Concept Model for enhanced storytelling
                    </label>
                    <div class="form-text">Leverages advanced AI to create more nuanced and contextually rich stories</div>
                </div>
                {% endif %}
            </div>
            
            <div class="d-grid gap-2 mt-4">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-magic me-2"></i> Generate Story
                </button>
                <div class="form-text text-center">
                    Story generation may take up to 30 seconds with LCM processing
                </div>
            </div>
        </form>
        
        <div id="previewSection" class="preview-section">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Story Preview</h4>
                <button id="editButton" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-edit me-1"></i> Edit
                </button>
            </div>
            <div class="card">
                <div class="card-body">
                    <h5 id="previewTitle" class="card-title"></h5>
                    <p id="previewAudience" class="card-subtitle mb-2 text-muted"></p>
                    <div id="previewContent" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Audience card selection
        const audienceCards = document.querySelectorAll('.audience-card');
        const selectedAudienceInput = document.getElementById('selectedAudience');
        
        audienceCards.forEach(card => {
            card.addEventListener('click', function() {
                // Remove selected class from all cards
                audienceCards.forEach(c => c.classList.remove('selected'));
                
                // Add selected class to clicked card
                this.classList.add('selected');
                
                // Update hidden input
                selectedAudienceInput.value = this.dataset.audience;
            });
        });
        
        // Set first audience card as selected by default
        if (audienceCards.length > 0) {
            audienceCards[0].classList.add('selected');
            selectedAudienceInput.value = audienceCards[0].dataset.audience;
        }
        
        // Template card selection
        const templateCards = document.querySelectorAll('.template-card');
        const selectedTemplateInput = document.getElementById('selectedTemplate');
        
        templateCards.forEach(card => {
            card.addEventListener('click', function() {
                // Remove selected class from all cards
                templateCards.forEach(c => c.classList.remove('selected'));
                
                // Add selected class to clicked card
                this.classList.add('selected');
                
                // Update hidden input
                selectedTemplateInput.value = this.dataset.template;
            });
        });
        
        // Set first template card as selected by default
        if (templateCards.length > 0) {
            templateCards[0].classList.add('selected');
            selectedTemplateInput.value = templateCards[0].dataset.template;
        }
        
        // Form submission
        const storyForm = document.getElementById('storyGenerationForm');
        storyForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Show loading state
            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Generating...';
            submitButton.disabled = true;
            
            // Collect form data
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            
            // Send AJAX request
            fetch(this.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Redirect to the story detail page
                    window.location.href = data.redirect || '/storytelling/';
                } else {
                    alert('Error: ' + (data.error || 'Failed to generate story'));
                    submitButton.innerHTML = originalText;
                    submitButton.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            });
        });
        
        // Preview functionality (if needed)
        const editButton = document.getElementById('editButton');
        if (editButton) {
            editButton.addEventListener('click', function() {
                const formSection = document.querySelector('.story-form');
                const previewSection = document.getElementById('previewSection');
                
                formSection.style.display = 'block';
                previewSection.style.display = 'none';
            });
        }
    });
</script>
{% endblock %}