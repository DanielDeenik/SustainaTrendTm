{% extends "layouts/finchat_dark_layout.html" %}

{% set active_page = 'strategy_hub' %}

{% block header_title %}
<i class="fas fa-chess me-2"></i> Strategy Hub
{% endblock %}

{% block additional_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/strategy-hub.css') }}">

<style>
    /* Strategy Hub 2025 Refresh Styles */
    .strategy-hub-container {
        padding: 1.5rem;
    }
    
    .story-cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.5rem;
        margin-top: 1.5rem;
    }
    
    .story-card {
        background: rgba(30, 32, 40, 0.6);
        border-radius: 0.75rem;
        border: 1px solid rgba(255, 255, 255, 0.05);
        transition: all 0.3s ease;
        overflow: hidden;
        position: relative;
        min-height: 320px;
    }
    
    .story-card:hover {
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        transform: translateY(-5px);
    }
    
    .story-card-header {
        padding: 1.25rem 1.25rem 0.75rem;
        position: relative;
    }
    
    .story-card-title {
        font-size: 1.25rem;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #fff;
    }
    
    .story-card-category {
        display: inline-block;
        font-size: 0.75rem;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        background: rgba(var(--bs-primary-rgb), 0.2);
        color: var(--bs-primary);
        margin-bottom: 0.5rem;
    }
    
    .story-card-visualization {
        padding: 0.75rem 1.25rem;
        height: 180px;
        position: relative;
        overflow: hidden;
    }
    
    .story-card-narrative {
        padding: 0.75rem 1.25rem;
        font-size: 0.875rem;
        color: rgba(255, 255, 255, 0.8);
        max-height: 100px;
        overflow: hidden;
        position: relative;
    }
    
    .story-card-narrative:after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 40px;
        background: linear-gradient(to bottom, rgba(30, 32, 40, 0), rgba(30, 32, 40, 1));
    }
    
    .story-card-actions {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .story-card:hover .story-card-actions {
        opacity: 1;
    }
    
    .story-card-action {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: rgba(30, 32, 40, 0.8);
        color: rgba(255, 255, 255, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.1);
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .story-card-action:hover {
        background: rgba(var(--bs-primary-rgb), 0.2);
        color: var(--bs-primary);
    }
    
    .story-card-expand {
        position: absolute;
        bottom: 0.75rem;
        right: 0.75rem;
        background: rgba(var(--bs-primary-rgb), 0.2);
        color: var(--bs-primary);
        border: none;
        border-radius: 20px;
        padding: 0.35rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .story-card:hover .story-card-expand {
        opacity: 1;
    }
    
    .hub-section {
        margin-bottom: 2rem;
    }
    
    .hub-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .hub-section-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
    }
    
    .hub-section-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .quick-action-btn {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        font-size: 0.875rem;
        transition: all 0.2s;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.9);
    }
    
    .quick-action-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateY(-2px);
    }
    
    .quick-action-btn i {
        margin-right: 0.5rem;
    }
    
    .quick-action-primary {
        background: rgba(var(--bs-primary-rgb), 0.2);
        color: var(--bs-primary);
    }
    
    .quick-action-primary:hover {
        background: rgba(var(--bs-primary-rgb), 0.3);
    }
    
    .template-card {
        background: rgba(30, 32, 40, 0.6);
        border-radius: 0.75rem;
        border: 1px solid rgba(255, 255, 255, 0.05);
        padding: 1.25rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        min-height: 320px;
    }
    
    .template-card:hover {
        background: rgba(30, 32, 40, 0.8);
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .template-card-icon {
        width: 64px;
        height: 64px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(var(--bs-primary-rgb), 0.1);
        color: var(--bs-primary);
        border-radius: 50%;
        margin-bottom: 1rem;
        font-size: 1.5rem;
    }
    
    .template-card-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    .template-card-description {
        font-size: 0.875rem;
        color: rgba(255, 255, 255, 0.7);
        margin-bottom: 1.5rem;
    }
    
    /* Filters area */
    .story-filters {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-bottom: 1rem;
    }
    
    .story-filter {
        padding: 0.35rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        background: rgba(255, 255, 255, 0.05);
        color: rgba(255, 255, 255, 0.8);
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .story-filter.active {
        background: rgba(var(--bs-primary-rgb), 0.2);
        color: var(--bs-primary);
    }
    
    .story-filter:hover:not(.active) {
        background: rgba(255, 255, 255, 0.1);
    }
    
    /* AI Copilot Floating Button */
    .ai-copilot-trigger {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: var(--bs-primary);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        z-index: 1000;
        transition: all 0.3s ease;
    }
    
    .ai-copilot-trigger:hover {
        transform: scale(1.1);
    }
    
    /* Animation for co-pilot pulse */
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(var(--bs-primary-rgb), 0.7);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(var(--bs-primary-rgb), 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(var(--bs-primary-rgb), 0);
        }
    }
    
    .ai-copilot-pulse {
        animation: pulse 2s infinite;
    }
    
    /* Story Detail Overlay */
    .story-detail-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1050;
        display: none;
    }
    
    /* Co-Pilot Dialog Styles */
    .copilot-dialog {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 450px;
        background: var(--card-bg);
        border-radius: 10px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        overflow: hidden;
        z-index: 1060;
        display: none;
    }
    
    .copilot-dialog-header {
        background: linear-gradient(135deg, var(--bs-primary), var(--bs-primary-dark, #0056b3));
        color: white;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .copilot-dialog-title {
        font-weight: 600;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
    }
    
    .copilot-dialog-title i {
        margin-right: 10px;
    }
    
    .copilot-dialog-close {
        background: transparent;
        border: none;
        color: white;
        cursor: pointer;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 5px;
        border-radius: 4px;
        transition: background-color 0.2s;
    }
    
    .copilot-dialog-close:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }
    
    .copilot-dialog-body {
        padding: 20px;
    }
    
    .copilot-chat-area {
        background: rgba(20, 20, 30, 0.3);
        border-radius: 8px;
        padding: 15px;
        max-height: 200px;
        overflow-y: auto;
        margin-bottom: 15px;
    }
    
    .copilot-message {
        margin-bottom: 15px;
        display: flex;
    }
    
    .copilot-message:last-child {
        margin-bottom: 0;
    }
    
    .copilot-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--bs-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        flex-shrink: 0;
    }
    
    .copilot-avatar i {
        color: white;
        font-size: 1rem;
    }
    
    .copilot-bubble {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        padding: 12px 15px;
        color: rgba(255, 255, 255, 0.9);
        font-size: 0.95rem;
        max-width: 85%;
        line-height: 1.5;
    }
    
    .copilot-input-area {
        display: flex;
        gap: 10px;
    }
    
    .copilot-input {
        flex: 1;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 12px 15px;
        color: white;
        resize: none;
        outline: none;
        transition: border-color 0.2s;
    }
    
    .copilot-input:focus {
        border-color: var(--bs-primary);
    }
    
    .copilot-send {
        background: var(--bs-primary);
        color: white;
        border: none;
        border-radius: 8px;
        width: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .copilot-send:hover {
        background-color: var(--bs-primary-dark, #0056b3);
    }
    
    .copilot-send i {
        font-size: 1.1rem;
    }
    
    .copilot-send:disabled {
        background-color: rgba(var(--bs-primary-rgb), 0.5);
        cursor: not-allowed;
    }
    
    .copilot-loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: copilot-spin 1s linear infinite;
    }
    
    @keyframes copilot-spin {
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block main_content %}
<div class="strategy-hub-container">
    <!-- Hub Introduction -->
    <div class="hub-section">
        <div class="hub-section-header">
            <h2 class="hub-section-title">Strategy Hub</h2>
            <div class="hub-section-actions">
                <a href="{{ url_for('enhanced_strategy.create_story') }}" class="quick-action-btn quick-action-primary">
                    <i class="fas fa-plus"></i> Create New Strategy
                </a>
                <a href="#story-templates" class="quick-action-btn">
                    <i class="fas fa-copy"></i> Use Template
                </a>
            </div>
        </div>
        <p class="text-muted">
            Develop powerful sustainability narratives that drive action. Create custom strategies or use pre-defined templates.
        </p>
    </div>
    
    <!-- Story Filters -->
    <div class="story-filters">
        <div class="story-filter active" data-filter="all">All Stories</div>
        <div class="story-filter" data-filter="emission">Emissions</div>
        <div class="story-filter" data-filter="water">Water</div>
        <div class="story-filter" data-filter="social">Social</div>
        <div class="story-filter" data-filter="governance">Governance</div>
        <div class="story-filter" data-filter="circular">Circular Economy</div>
    </div>
    
    <!-- Recent Stories Section -->
    <div class="hub-section">
        <div class="hub-section-header">
            <h3 class="hub-section-title">Recent Stories</h3>
            <div class="hub-section-actions">
                <button class="quick-action-btn" id="sort-by-date">
                    <i class="fas fa-sort"></i> Sort by Date
                </button>
                <button class="quick-action-btn" id="sort-by-impact">
                    <i class="fas fa-chart-line"></i> Sort by Impact
                </button>
            </div>
        </div>
        
        <!-- Story Cards Grid -->
        <div class="story-cards-grid">
            {% for story in stories %}
            <div class="story-card" data-category="{{ story.category }}">
                <div class="story-card-header">
                    <div class="story-card-category">{{ story.category|capitalize }}</div>
                    <h4 class="story-card-title">{{ story.title }}</h4>
                </div>
                
                <div class="story-card-visualization">
                    <canvas id="chart-{{ story.id }}" width="100%" height="100%"></canvas>
                </div>
                
                <div class="story-card-narrative">
                    {% if story.storytelling_elements and story.storytelling_elements.narrative %}
                        {{ story.storytelling_elements.narrative.content }}
                    {% else %}
                        {{ story.content|truncate(150) }}
                    {% endif %}
                </div>
                
                <div class="story-card-actions">
                    <div class="story-card-action" data-action="edit" data-story-id="{{ story.id }}">
                        <i class="fas fa-edit"></i>
                    </div>
                    <div class="story-card-action" data-action="share" data-story-id="{{ story.id }}">
                        <i class="fas fa-share-alt"></i>
                    </div>
                    <div class="story-card-action" data-action="download" data-story-id="{{ story.id }}">
                        <i class="fas fa-download"></i>
                    </div>
                </div>
                
                <button class="story-card-expand" data-story-id="{{ story.id }}">
                    <i class="fas fa-external-link-alt me-1"></i> Expand
                </button>
            </div>
            {% endfor %}
            
            <!-- Add Strategy Card - Always visible as last item -->
            <div class="template-card" onclick="window.location='{{ url_for('enhanced_strategy.create_story') }}'">
                <div class="template-card-icon">
                    <i class="fas fa-plus"></i>
                </div>
                <h4 class="template-card-title">Create New Strategy</h4>
                <p class="template-card-description">Start from scratch with a custom sustainability story</p>
                <button class="quick-action-btn quick-action-primary">
                    <i class="fas fa-plus"></i> Get Started
                </button>
            </div>
        </div>
    </div>
    
    <!-- Strategy Templates Section -->
    <div class="hub-section" id="story-templates">
        <div class="hub-section-header">
            <h3 class="hub-section-title">Strategy Templates</h3>
            <div class="hub-section-actions">
                <button class="quick-action-btn" id="toggle-templates">
                    <i class="fas fa-th-large"></i> Grid View
                </button>
            </div>
        </div>
        
        <div class="story-cards-grid">
            <!-- ESG Report Template -->
            <div class="template-card" onclick="window.location='{{ url_for('enhanced_strategy.create_from_template', template_id='esg_report') }}'">
                <div class="template-card-icon">
                    <i class="fas fa-file-alt"></i>
                </div>
                <h4 class="template-card-title">ESG Report</h4>
                <p class="template-card-description">Comprehensive ESG performance summary with key metrics and forward-looking statements</p>
                <button class="quick-action-btn">
                    <i class="fas fa-external-link-alt"></i> Use Template
                </button>
            </div>
            
            <!-- Impact Assessment Template -->
            <div class="template-card" onclick="window.location='{{ url_for('enhanced_strategy.create_from_template', template_id='impact_assessment') }}'">
                <div class="template-card-icon">
                    <i class="fas fa-chart-pie"></i>
                </div>
                <h4 class="template-card-title">Impact Assessment</h4>
                <p class="template-card-description">Detailed analysis of environmental and social impact with stakeholder perspectives</p>
                <button class="quick-action-btn">
                    <i class="fas fa-external-link-alt"></i> Use Template
                </button>
            </div>
            
            <!-- Net Zero Roadmap Template -->
            <div class="template-card" onclick="window.location='{{ url_for('enhanced_strategy.create_from_template', template_id='net_zero') }}'">
                <div class="template-card-icon">
                    <i class="fas fa-road"></i>
                </div>
                <h4 class="template-card-title">Net Zero Roadmap</h4>
                <p class="template-card-description">Strategic decarbonization plan with science-based targets and milestone tracking</p>
                <button class="quick-action-btn">
                    <i class="fas fa-external-link-alt"></i> Use Template
                </button>
            </div>
            
            <!-- Circular Economy Template -->
            <div class="template-card" onclick="window.location='{{ url_for('enhanced_strategy.create_from_template', template_id='circular_economy') }}'">
                <div class="template-card-icon">
                    <i class="fas fa-recycle"></i>
                </div>
                <h4 class="template-card-title">Circular Economy</h4>
                <p class="template-card-description">Material flow analysis with waste reduction strategies and circularity metrics</p>
                <button class="quick-action-btn">
                    <i class="fas fa-external-link-alt"></i> Use Template
                </button>
            </div>
        </div>
    </div>
    
    <!-- Sustainability Co-Pilot Floating Button -->
    <div class="ai-copilot-trigger ai-copilot-pulse" id="ai-copilot-trigger">
        <i class="fas fa-robot"></i>
    </div>
    
    <!-- Modal for Story Detail View (hidden by default) -->
    <div class="modal fade" id="storyDetailModal" tabindex="-1" aria-labelledby="storyDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="storyDetailModalLabel">Story Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="storyDetailContent">
                    <!-- Story details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="editStoryBtn">Edit Story</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal for AI Co-Pilot (hidden by default) -->
    <div class="modal fade" id="aiCopilotModal" tabindex="-1" aria-labelledby="aiCopilotModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="aiCopilotModalLabel">
                        <i class="fas fa-robot me-2"></i> Sustainability Co-Pilot
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="copilotPrompt" class="form-label">How can I help with your sustainability strategy?</label>
                        <textarea class="form-control" id="copilotPrompt" rows="3" placeholder="e.g., Suggest metrics for my carbon reduction story..."></textarea>
                    </div>
                    
                    <div id="copilotResponse" class="p-3 rounded bg-light" style="display: none;">
                        <div class="d-flex align-items-start">
                            <div class="me-3">
                                <i class="fas fa-robot text-primary fs-4"></i>
                            </div>
                            <div>
                                <div class="mb-2 fw-bold">Sustainability Co-Pilot</div>
                                <div id="copilotResponseContent"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="askCopilotBtn">Ask Co-Pilot</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- New Enhanced Copilot Interface -->
    <div class="story-detail-overlay" id="copilotOverlay"></div>
    
    <div class="copilot-dialog" id="copilotDialog">
        <div class="copilot-dialog-header">
            <div class="copilot-dialog-title">
                <i class="fas fa-robot"></i> Sustainability Co-Pilot
            </div>
            <button class="copilot-dialog-close" id="closeCopilotDialog">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="copilot-dialog-body">
            <div class="copilot-chat-area" id="copilotChatArea">
                <div class="copilot-message">
                    <div class="copilot-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="copilot-bubble">
                        Hello! I'm your Sustainability Co-Pilot. How can I assist with your sustainability strategy today?
                    </div>
                </div>
            </div>
            <div class="copilot-input-area">
                <textarea class="copilot-input" id="enhancedCopilotInput" placeholder="Type your question here..."></textarea>
                <button class="copilot-send" id="enhancedCopilotSend">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock main_content %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize charts for all story cards
    initializeStoryCharts();
    
    // Handle story filter clicks
    document.querySelectorAll('.story-filter').forEach(filter => {
        filter.addEventListener('click', function() {
            // Update active class
            document.querySelectorAll('.story-filter').forEach(f => f.classList.remove('active'));
            this.classList.add('active');
            
            // Filter story cards
            const category = this.getAttribute('data-filter');
            document.querySelectorAll('.story-card').forEach(card => {
                if (category === 'all' || card.getAttribute('data-category') === category) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        });
    });
    
    // Handle story card expand buttons
    document.querySelectorAll('.story-card-expand').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const storyId = this.getAttribute('data-story-id');
            showStoryDetails(storyId);
        });
    });
    
    // Handle story card actions
    document.querySelectorAll('.story-card-action').forEach(action => {
        action.addEventListener('click', function(e) {
            e.stopPropagation();
            const actionType = this.getAttribute('data-action');
            const storyId = this.getAttribute('data-story-id');
            
            switch(actionType) {
                case 'edit':
                    window.location.href = `/enhanced-strategy/edit/${storyId}`;
                    break;
                case 'share':
                    shareStory(storyId);
                    break;
                case 'download':
                    downloadStory(storyId);
                    break;
            }
        });
    });
    
    // Handle AI Co-Pilot trigger for new enhanced dialog
    document.getElementById('ai-copilot-trigger').addEventListener('click', function() {
        // Show the new dialog instead of the modal
        document.getElementById('copilotOverlay').style.display = 'block';
        document.getElementById('copilotDialog').style.display = 'block';
        
        // Focus the input
        document.getElementById('enhancedCopilotInput').focus();
    });
    
    // Close dialog when clicking the close button
    document.getElementById('closeCopilotDialog').addEventListener('click', function() {
        document.getElementById('copilotOverlay').style.display = 'none';
        document.getElementById('copilotDialog').style.display = 'none';
    });
    
    // Close dialog when clicking outside
    document.getElementById('copilotOverlay').addEventListener('click', function() {
        document.getElementById('copilotOverlay').style.display = 'none';
        document.getElementById('copilotDialog').style.display = 'none';
    });
    
    // Enhanced Co-Pilot send functionality
    document.getElementById('enhancedCopilotSend').addEventListener('click', function() {
        sendCopilotMessage();
    });
    
    // Handle Enter key in the input field
    document.getElementById('enhancedCopilotInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault(); // Prevent default behavior (new line)
            sendCopilotMessage();
        }
    });
    
    // Legacy modal functionality (kept for backward compatibility)
    document.getElementById('askCopilotBtn').addEventListener('click', function() {
        const prompt = document.getElementById('copilotPrompt').value;
        if (prompt.trim() === '') {
            return;
        }
        
        // Show loading state
        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Processing...';
        
        const responseElement = document.getElementById('copilotResponse');
        const responseContentElement = document.getElementById('copilotResponseContent');
        
        // Mock AI response for now - would be replaced with actual API call
        setTimeout(() => {
            responseElement.style.display = 'block';
            responseContentElement.innerHTML = generateCopilotResponse(prompt);
            
            // Reset button
            this.disabled = false;
            this.innerHTML = 'Ask Co-Pilot';
        }, 1500);
    });
    
    // Sort buttons functionality
    document.getElementById('sort-by-date').addEventListener('click', function() {
        sortStoryCards('date');
    });
    
    document.getElementById('sort-by-impact').addEventListener('click', function() {
        sortStoryCards('impact');
    });
});

function initializeStoryCharts() {
    document.querySelectorAll('.story-card').forEach(card => {
        const storyId = card.querySelector('.story-card-expand').getAttribute('data-story-id');
        const canvas = document.getElementById(`chart-${storyId}`);
        
        if (canvas) {
            try {
                const ctx = canvas.getContext('2d');
                const category = card.getAttribute('data-category');
                
                // Select chart type and colors based on category
                let chartType, colors;
                
                switch(category) {
                    case 'emission':
                        chartType = 'line';
                        colors = ['#34D399', '#10B981'];
                        break;
                    case 'water':
                        chartType = 'bar';
                        colors = ['#60A5FA', '#3B82F6'];
                        break;
                    case 'social':
                        chartType = 'radar';
                        colors = ['#A78BFA', '#8B5CF6'];
                        break;
                    case 'governance':
                        chartType = 'doughnut';
                        colors = ['#F59E0B', '#D97706', '#B45309', '#92400E'];
                        break;
                    case 'circular':
                        chartType = 'polarArea';
                        colors = ['#34D399', '#10B981', '#059669', '#047857'];
                        break;
                    default:
                        chartType = 'bar';
                        colors = ['#10B981', '#059669'];
                }
                
                // Generate data based on category
                let data;
                
                if (chartType === 'doughnut' || chartType === 'polarArea') {
                    data = {
                        labels: ['Category 1', 'Category 2', 'Category 3', 'Category 4'],
                        datasets: [{
                            data: [12, 19, 8, 5],
                            backgroundColor: colors,
                            hoverOffset: 4
                        }]
                    };
                } else if (chartType === 'radar') {
                    data = {
                        labels: ['Diversity', 'Inclusion', 'Community', 'Training', 'Wellbeing'],
                        datasets: [{
                            label: 'Current',
                            data: [65, 59, 90, 81, 56],
                            fill: true,
                            backgroundColor: `${colors[0]}33`,
                            borderColor: colors[0],
                            pointBackgroundColor: colors[0],
                            pointBorderColor: '#fff',
                        }, {
                            label: 'Target',
                            data: [28, 48, 40, 19, 96],
                            fill: true,
                            backgroundColor: `${colors[1]}33`,
                            borderColor: colors[1],
                            pointBackgroundColor: colors[1],
                            pointBorderColor: '#fff',
                        }]
                    };
                } else {
                    data = {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                        datasets: [{
                            label: 'Current Year',
                            data: generateRandomData(6, 10, 100),
                            backgroundColor: `${colors[0]}33`,
                            borderColor: colors[0],
                            fill: chartType === 'line',
                        }, {
                            label: 'Previous Year',
                            data: generateRandomData(6, 10, 100),
                            backgroundColor: `${colors[1]}33`,
                            borderColor: colors[1],
                            fill: chartType === 'line',
                        }]
                    };
                }
                
                // Create chart with minimal configuration for preview
                new Chart(ctx, {
                    type: chartType,
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: chartType === 'radar' || chartType === 'doughnut' || chartType === 'polarArea',
                                position: 'bottom',
                                labels: {
                                    color: 'rgba(255, 255, 255, 0.7)',
                                    font: {
                                        size: 10
                                    }
                                }
                            },
                            tooltip: {
                                enabled: false
                            }
                        },
                        scales: chartType !== 'doughnut' && chartType !== 'polarArea' && chartType !== 'radar' ? {
                            x: {
                                display: false
                            },
                            y: {
                                display: false
                            }
                        } : undefined
                    }
                });
            } catch (error) {
                console.error('Failed to create chart:', error);
            }
        }
    });
}

function generateRandomData(count, min, max) {
    const data = [];
    for (let i = 0; i < count; i++) {
        data.push(Math.floor(Math.random() * (max - min + 1)) + min);
    }
    return data;
}

function showStoryDetails(storyId) {
    // Fetch story details - in a real implementation, this would make an API call
    // For now, we'll use a placeholder approach
    
    // Show modal with loading state
    const modal = new bootstrap.Modal(document.getElementById('storyDetailModal'));
    document.getElementById('storyDetailContent').innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-3">Loading story details...</p></div>';
    modal.show();
    
    // In a real implementation, we'd fetch the story data here
    // For now, we'll simulate a network request
    setTimeout(() => {
        document.getElementById('storyDetailModalLabel').innerText = document.querySelector(`.story-card[data-story-id="${storyId}"] .story-card-title`).innerText;
        
        // Load the content using the story card component
        fetch(`/strategy/api/story/${storyId}`)
            .then(response => response.text())
            .then(html => {
                document.getElementById('storyDetailContent').innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading story details:', error);
                document.getElementById('storyDetailContent').innerHTML = '<div class="alert alert-danger">Error loading story details. Please try again.</div>';
            });
        
        // Setup edit button
        document.getElementById('editStoryBtn').onclick = function() {
            window.location.href = `/enhanced-strategy/edit/${storyId}`;
        };
    }, 500);
}

function shareStory(storyId) {
    // This would be implemented with a sharing API or modal
    alert(`Share functionality for story ${storyId} would open here`);
}

function downloadStory(storyId) {
    // This would be implemented with a download API
    alert(`Download functionality for story ${storyId} would start here`);
}

function sortStoryCards(sortBy) {
    const storyCardsGrid = document.querySelector('.story-cards-grid');
    const storyCards = Array.from(document.querySelectorAll('.story-card'));
    
    // Template card should always be last
    const templateCard = document.querySelector('.template-card');
    
    // Remove all cards from the grid
    storyCards.forEach(card => card.remove());
    templateCard.remove();
    
    // Sort cards
    if (sortBy === 'date') {
        storyCards.sort((a, b) => {
            // In a real implementation, we'd use actual dates
            // For now, we'll use the story ID as a proxy for date
            const aId = parseInt(a.querySelector('.story-card-expand').getAttribute('data-story-id'));
            const bId = parseInt(b.querySelector('.story-card-expand').getAttribute('data-story-id'));
            return bId - aId; // Descending order (newest first)
        });
    } else if (sortBy === 'impact') {
        storyCards.sort((a, b) => {
            // In a real implementation, we'd use actual impact scores
            // For now, we'll just randomize
            return Math.random() - 0.5;
        });
    }
    
    // Add sorted cards back to the grid
    storyCards.forEach(card => storyCardsGrid.appendChild(card));
    
    // Always add template card at the end
    storyCardsGrid.appendChild(templateCard);
}

function sendCopilotMessage() {
    const inputElement = document.getElementById('enhancedCopilotInput');
    const prompt = inputElement.value.trim();
    
    if (prompt === '') {
        return;
    }
    
    // Add user message to chat
    const chatArea = document.getElementById('copilotChatArea');
    const userMessage = document.createElement('div');
    userMessage.className = 'copilot-message';
    userMessage.style.justifyContent = 'flex-end';
    userMessage.innerHTML = `
        <div class="copilot-bubble" style="background: rgba(var(--bs-primary-rgb), 0.15);">
            ${prompt}
        </div>
    `;
    chatArea.appendChild(userMessage);
    
    // Clear input field
    inputElement.value = '';
    
    // Scroll to bottom of chat area
    chatArea.scrollTop = chatArea.scrollHeight;
    
    // Show loading indicator
    const sendButton = document.getElementById('enhancedCopilotSend');
    sendButton.disabled = true;
    sendButton.innerHTML = `<div class="copilot-loading"></div>`;
    
    // Add AI thinking message
    const loadingMessage = document.createElement('div');
    loadingMessage.className = 'copilot-message';
    loadingMessage.id = 'copilot-loading-message';
    loadingMessage.innerHTML = `
        <div class="copilot-avatar">
            <i class="fas fa-robot"></i>
        </div>
        <div class="copilot-bubble">
            <div class="d-flex align-items-center">
                <span class="me-2">Thinking</span>
                <div class="copilot-loading"></div>
            </div>
        </div>
    `;
    chatArea.appendChild(loadingMessage);
    chatArea.scrollTop = chatArea.scrollHeight;
    
    // Simulate AI response (would be replaced with actual API call)
    setTimeout(() => {
        // Remove loading message
        document.getElementById('copilot-loading-message').remove();
        
        // Add AI response
        const aiMessage = document.createElement('div');
        aiMessage.className = 'copilot-message';
        aiMessage.innerHTML = `
            <div class="copilot-avatar">
                <i class="fas fa-robot"></i>
            </div>
            <div class="copilot-bubble">
                ${generateCopilotResponse(prompt)}
            </div>
        `;
        chatArea.appendChild(aiMessage);
        
        // Reset send button
        sendButton.disabled = false;
        sendButton.innerHTML = `<i class="fas fa-paper-plane"></i>`;
        
        // Add suggested follow-up questions if needed
        if (!prompt.toLowerCase().includes('thank')) {
            const suggestionsMessage = document.createElement('div');
            suggestionsMessage.className = 'copilot-message';
            suggestionsMessage.innerHTML = `
                <div class="copilot-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="copilot-bubble">
                    <p class="mt-2 mb-1">You might also want to know:</p>
                    <div class="d-flex flex-wrap gap-2 mt-2">
                        <button class="btn btn-sm btn-outline-primary" onclick="document.getElementById('enhancedCopilotInput').value = 'How can I track progress on these metrics?'; sendCopilotMessage();">How to track progress?</button>
                        <button class="btn btn-sm btn-outline-primary" onclick="document.getElementById('enhancedCopilotInput').value = 'What technologies support this strategy?'; sendCopilotMessage();">Supporting technologies</button>
                    </div>
                </div>
            `;
            chatArea.appendChild(suggestionsMessage);
        }
        
        // Scroll to bottom of chat area
        chatArea.scrollTop = chatArea.scrollHeight;
    }, 1500);
}

function generateCopilotResponse(prompt) {
    // This is a mock implementation that would be replaced with an actual AI response
    const lowercasePrompt = prompt.toLowerCase();
    
    if (lowercasePrompt.includes('carbon') || lowercasePrompt.includes('emission')) {
        return `
            <p>For your carbon reduction strategy, I recommend including these key metrics:</p>
            <ul>
                <li><strong>Scope 1, 2, 3 Emissions</strong>: Measure direct and indirect emissions across your value chain</li>
                <li><strong>Carbon Intensity</strong>: Emissions per unit of revenue or production</li>
                <li><strong>Reduction Targets</strong>: Year-over-year percentage reduction goals</li>
                <li><strong>Carbon Avoided</strong>: Emissions avoided through products or services</li>
            </ul>
            <p>These metrics align with the GHG Protocol and TCFD reporting frameworks.</p>
        `;
    } else if (lowercasePrompt.includes('water')) {
        return `
            <p>For water management strategies, consider these insights:</p>
            <ul>
                <li><strong>Water Withdrawal</strong>: Total water intake by source</li>
                <li><strong>Water Consumption</strong>: Amount not returned to the original source</li>
                <li><strong>Water Quality</strong>: Contaminant levels in discharged water</li>
                <li><strong>Water Stress Exposure</strong>: Operations in water-stressed regions</li>
            </ul>
            <p>These align with CDP Water Security and AWS (Alliance for Water Stewardship) frameworks.</p>
        `;
    } else if (lowercasePrompt.includes('social') || lowercasePrompt.includes('employee')) {
        return `
            <p>For social sustainability strategies, focus on:</p>
            <ul>
                <li><strong>Diversity & Inclusion</strong>: Workforce diversity metrics across multiple dimensions</li>
                <li><strong>Employee Engagement</strong>: Satisfaction scores and retention rates</li>
                <li><strong>Health & Safety</strong>: Incident rates and well-being measures</li>
                <li><strong>Community Impact</strong>: Investment and volunteer hours in local communities</li>
            </ul>
            <p>Consider the GRI Social Standards and UN SDGs as frameworks for reporting.</p>
        `;
    } else if (lowercasePrompt.includes('track') || lowercasePrompt.includes('progress')) {
        return `
            <p>To track sustainability progress effectively:</p>
            <ul>
                <li><strong>Establish a Baseline</strong>: Document current performance across all metrics</li>
                <li><strong>Set SMART Goals</strong>: Specific, Measurable, Achievable, Relevant, Time-bound</li>
                <li><strong>Implement Data Collection</strong>: Automated systems where possible</li>
                <li><strong>Regular Reporting Cadence</strong>: Monthly or quarterly performance reviews</li>
                <li><strong>Visualization Tools</strong>: Dashboards for tracking trends over time</li>
            </ul>
            <p>Consider using specialized ESG software or sustainability management platforms to centralize data collection and reporting.</p>
        `;
    } else if (lowercasePrompt.includes('technolog')) {
        return `
            <p>Technologies supporting sustainability strategies include:</p>
            <ul>
                <li><strong>IoT Sensors</strong>: Real-time monitoring of resource usage and emissions</li>
                <li><strong>AI/ML</strong>: Predictive analytics for optimization and efficiency</li>
                <li><strong>Blockchain</strong>: Supply chain transparency and verification</li>
                <li><strong>Cloud Platforms</strong>: ESG data management and sustainability reporting</li>
                <li><strong>Digital Twins</strong>: Modeling infrastructure for efficiency improvements</li>
            </ul>
            <p>Integration of these technologies can create a comprehensive sustainability intelligence ecosystem.</p>
        `;
    } else {
        return `
            <p>I'd be happy to help with your sustainability strategy. Consider focusing on these components:</p>
            <ul>
                <li><strong>Materiality Assessment</strong>: Identify the most relevant topics for your industry</li>
                <li><strong>Baseline Measurement</strong>: Establish current performance on key metrics</li>
                <li><strong>Target Setting</strong>: Define science-based goals with clear timelines</li>
                <li><strong>Implementation Plan</strong>: Outline specific initiatives and responsible parties</li>
                <li><strong>Monitoring Framework</strong>: Regular measurement and reporting procedures</li>
            </ul>
            <p>Would you like me to elaborate on any specific aspect of your sustainability strategy?</p>
        `;
    }
}
</script>
{% endblock extra_js %}