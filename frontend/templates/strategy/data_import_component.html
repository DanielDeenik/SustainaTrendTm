<div class="card shadow-sm mb-4">
    <div class="card-header bg-dark">
        <h5 class="card-title mb-0 text-white">
            <i class="fas fa-file-import me-2"></i> Data Import
        </h5>
    </div>
    <div class="card-body bg-dark">
        <!-- File Upload Form -->
        <form id="dataImportForm" action="{{ url_for('strategy.upload_data_file') }}" method="post" enctype="multipart/form-data" class="mb-4">
            <div class="mb-3">
                <label for="fileType" class="form-label">Data Type</label>
                <select class="form-select bg-dark text-light border-secondary" id="fileType" name="file_type" required>
                    <option value="" selected disabled>Select data type</option>
                    <option value="sustainability_metrics">Sustainability Metrics</option>
                    <option value="emissions">Emissions Data</option>
                    <option value="resource_usage">Resource Usage</option>
                    <option value="esg_report">ESG Report</option>
                    <option value="strategy_document">Strategy Document</option>
                    <option value="other">Other</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="dataFile" class="form-label">Upload File</label>
                <input class="form-control bg-dark text-light border-secondary" type="file" id="dataFile" name="data_file" accept=".csv,.xlsx,.pdf,.json" required>
                <div class="form-text text-muted">Supported formats: CSV, Excel, PDF, JSON</div>
            </div>

            <div class="mb-3">
                <label for="dataDescription" class="form-label">Description (Optional)</label>
                <textarea class="form-control bg-dark text-light border-secondary" id="dataDescription" name="description" rows="2" placeholder="Brief description of the data..."></textarea>
            </div>

            <div class="mb-3">
                <label for="dataOrigin" class="form-label">Data Origin</label>
                <select class="form-select bg-dark text-light border-secondary" id="dataOrigin" name="data_origin" required>
                    <option value="" selected disabled>Select origin</option>
                    <option value="internal">Internal Data</option>
                    <option value="external">External Source</option>
                    <option value="third_party">Third-Party Provider</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="importOptions" class="form-label">Import Options</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="analyzeImmediate" name="analyze_immediate" checked>
                    <label class="form-check-label" for="analyzeImmediate">
                        Analyze data immediately after upload
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="generateRecommendations" name="generate_recommendations" checked>
                    <label class="form-check-label" for="generateRecommendations">
                        Generate AI recommendations based on data
                    </label>
                </div>
            </div>

            <div class="d-grid">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-upload me-2"></i> Upload & Analyze
                </button>
            </div>
        </form>

        <!-- Recent Imports Section -->
        <div id="recentImports">
            <h6 class="border-bottom pb-2 mb-3">Recent Imports</h6>
            <div class="recent-imports-list" id="recentImportsList">
                <!-- This will be populated by JavaScript -->
                <div class="text-center py-3" id="loadingImports">
                    <div class="spinner-border spinner-border-sm text-secondary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span class="ms-2">Loading recent imports...</span>
                </div>
                <div class="text-center py-3 d-none" id="noImportsMessage">
                    <p class="text-muted">No recent imports found</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Form validation and submission handling
    const dataImportForm = document.getElementById('dataImportForm');
    if (dataImportForm) {
        dataImportForm.addEventListener('submit', function(event) {
            const fileInput = document.getElementById('dataFile');
            const fileType = document.getElementById('fileType');
            
            if (!fileInput.files.length) {
                event.preventDefault();
                alert('Please select a file to upload');
                return false;
            }
            
            if (fileType.value === '') {
                event.preventDefault();
                alert('Please select a data type');
                return false;
            }
            
            // Show loading state
            const submitButton = this.querySelector('button[type="submit"]');
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Uploading...';
            submitButton.disabled = true;
        });
    }
    
    // Load recent imports
    loadRecentImports();
});

function loadRecentImports() {
    const recentImportsList = document.getElementById('recentImportsList');
    const loadingImports = document.getElementById('loadingImports');
    const noImportsMessage = document.getElementById('noImportsMessage');
    
    // Fetch recent imports from API
    fetch('/api/strategy-hub/imports')
        .then(response => response.json())
        .then(data => {
            // Hide loading indicator
            if (loadingImports) {
                loadingImports.classList.add('d-none');
            }
            
            if (data.imports && data.imports.length > 0) {
                // Hide no imports message if it was showing
                if (noImportsMessage) {
                    noImportsMessage.classList.add('d-none');
                }
                
                // Clear existing list items
                const existingItems = recentImportsList.querySelectorAll('.import-item');
                existingItems.forEach(item => item.remove());
                
                // Create list of recent imports
                data.imports.forEach(importItem => {
                    const importElement = document.createElement('div');
                    importElement.className = 'import-item d-flex justify-content-between align-items-center border-bottom pb-2 pt-2';
                    
                    // Format date
                    const importDate = new Date(importItem.created_at);
                    const formattedDate = importDate.toLocaleDateString() + ' ' + 
                                         importDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    // Get file icon based on type
                    let fileIcon = 'fa-file';
                    if (importItem.file_type === 'sustainability_metrics') fileIcon = 'fa-chart-line';
                    else if (importItem.file_type === 'emissions') fileIcon = 'fa-smog';
                    else if (importItem.file_type === 'resource_usage') fileIcon = 'fa-tint';
                    else if (importItem.file_type === 'esg_report') fileIcon = 'fa-file-pdf';
                    else if (importItem.file_type === 'strategy_document') fileIcon = 'fa-file-alt';
                    
                    importElement.innerHTML = `
                        <div>
                            <h6 class="mb-0"><i class="fas ${fileIcon} me-2"></i>${importItem.filename}</h6>
                            <small class="text-muted">${formattedDate} Â· ${importItem.file_type.replace('_', ' ')}</small>
                        </div>
                        <div>
                            <a href="/strategy-hub/analyze/${importItem.id}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-chart-bar"></i>
                            </a>
                        </div>
                    `;
                    
                    recentImportsList.appendChild(importElement);
                });
            } else {
                // Show no imports message
                if (noImportsMessage) {
                    noImportsMessage.classList.remove('d-none');
                }
            }
        })
        .catch(error => {
            console.error('Error loading recent imports:', error);
            if (loadingImports) {
                loadingImports.classList.add('d-none');
            }
            
            // Create error message
            const errorElement = document.createElement('div');
            errorElement.className = 'alert alert-danger mt-3';
            errorElement.textContent = 'Failed to load recent imports. Please try again later.';
            recentImportsList.appendChild(errorElement);
        });
}
</script>