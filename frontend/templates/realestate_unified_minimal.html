{% extends "layouts/unified_layout.html" %}

{% set active_page = 'realestate' %}

{% block title %}Real Estate Sustainability | SustainaTrend™{% endblock %}

{% block head_extras %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/sustainability-copilot.css') }}">
<script type="application/json" id="realestate-copilot-context">
{
    "context": "real_estate",
    "metrics": [
        {"name": "Energy Efficiency", "value": "A+", "trend": "up", "change": "15%", "unit": "EPC rating"},
        {"name": "Carbon Footprint", "value": "27.8", "trend": "down", "change": "8.2%", "unit": "kg CO₂e/m²"},
        {"name": "Water Management", "value": "183", "trend": "down", "change": "12%", "unit": "L/day"},
        {"name": "BREEAM Score", "value": "73.2", "trend": "up", "change": "5.7", "unit": "%"}
    ],
    "properties": {
        "total": 248,
        "epcDistribution": {
            "A": 42,
            "B": 78,
            "C": 89,
            "D": 25,
            "E": 10,
            "F": 4
        },
        "top_performers": ["Green Park Tower", "Eco Residences", "Horizon Offices", "Urban Lofts", "Riverside Complex"],
        "regions": ["Amsterdam, NL", "Stockholm, SE", "Copenhagen, DK", "Berlin, DE", "Vienna, AT"]
    },
    "insights": [
        "A+ rated properties commanding 12% higher rental yields",
        "24% of portfolio needs upgrading to meet 2028 regulations",
        "Smart building technology reduced carbon by 15.3%",
        "Rainwater harvesting systems showing 32% lower water costs",
        "Green financing rates 0.4% lower than standard rates",
        "Nordic properties 18% better energy efficiency"
    ]
}
</script>
{% endblock %}

{% block header_title %}Real Estate Sustainability{% endblock %}

{% block header_actions %}
<span class="finchat-badge finchat-badge-primary">REAL-TIME</span>
<span class="finchat-badge finchat-badge-secondary">BETA</span>
{% endblock %}

{% block main_content %}
<!-- Property Overview Summary -->
<div class="finchat-metrics-grid">
    <!-- Energy Efficiency -->
    <div class="finchat-card">
        <div class="finchat-card-header">
            <div class="finchat-card-title">Energy Efficiency</div>
            <i class="fas fa-bolt" style="color: #3a8c7e;"></i>
        </div>
        <div class="finchat-card-content">
            <div class="finchat-metric-value">A+</div>
            <div class="finchat-trend finchat-trend-up">
                <i class="fas fa-arrow-up finchat-trend-icon"></i>
                <span>15% improvement YoY</span>
            </div>
            <div class="finchat-fs-sm finchat-text-light finchat-mt-sm">
                Average EPC rating across portfolio
            </div>
        </div>
        <div class="finchat-card-footer">
            <span>Updated: Mar 10, 2025</span>
            <a href="#" class="finchat-text-primary">View Details</a>
        </div>
    </div>
    
    <!-- Carbon Footprint -->
    <div class="finchat-card">
        <div class="finchat-card-header">
            <div class="finchat-card-title">Carbon Footprint</div>
            <i class="fas fa-leaf" style="color: #4caf50;"></i>
        </div>
        <div class="finchat-card-content">
            <div class="finchat-metric-value">27.8 kg CO₂e/m²</div>
            <div class="finchat-trend finchat-trend-down">
                <i class="fas fa-arrow-down finchat-trend-icon"></i>
                <span>8.2% reduction</span>
            </div>
            <div class="finchat-fs-sm finchat-text-light finchat-mt-sm">
                Average emissions per square meter
            </div>
        </div>
        <div class="finchat-card-footer">
            <span>Updated: Mar 10, 2025</span>
            <a href="#" class="finchat-text-primary">View Details</a>
        </div>
    </div>
    
    <!-- Water Management -->
    <div class="finchat-card">
        <div class="finchat-card-header">
            <div class="finchat-card-title">Water Management</div>
            <i class="fas fa-tint" style="color: #2196f3;"></i>
        </div>
        <div class="finchat-card-content">
            <div class="finchat-metric-value">183 L/day</div>
            <div class="finchat-trend finchat-trend-down">
                <i class="fas fa-arrow-down finchat-trend-icon"></i>
                <span>12% reduction</span>
            </div>
            <div class="finchat-fs-sm finchat-text-light finchat-mt-sm">
                Average water usage per unit
            </div>
        </div>
        <div class="finchat-card-footer">
            <span>Updated: Mar 10, 2025</span>
            <a href="#" class="finchat-text-primary">View Details</a>
        </div>
    </div>
    
    <!-- BREEAM Score -->
    <div class="finchat-card">
        <div class="finchat-card-header">
            <div class="finchat-card-title">BREEAM Score</div>
            <i class="fas fa-award" style="color: #ff9800;"></i>
        </div>
        <div class="finchat-card-content">
            <div class="finchat-metric-value">73.2%</div>
            <div class="finchat-trend finchat-trend-up">
                <i class="fas fa-arrow-up finchat-trend-icon"></i>
                <span>+5.7 points</span>
            </div>
            <div class="finchat-fs-sm finchat-text-light finchat-mt-sm">
                Portfolio average (Excellent)
            </div>
        </div>
        <div class="finchat-card-footer">
            <span>Updated: Mar 10, 2025</span>
            <a href="#" class="finchat-text-primary">View Details</a>
        </div>
    </div>
</div>

<!-- Portfolio Performance Chart -->
<div class="finchat-card">
    <div class="finchat-card-header">
        <div class="finchat-card-title">Portfolio Sustainability Performance</div>
        <div>
            <select id="timeRange" class="finchat-select">
                <option value="1year" selected>Last 12 Months</option>
                <option value="2year">Last 24 Months</option>
                <option value="5year">Last 5 Years</option>
                <option value="all">All Time</option>
            </select>
        </div>
    </div>
    <div class="finchat-card-content">
        <div class="finchat-chart-container" id="portfolioChart"></div>
    </div>
    <div class="finchat-card-footer">
        <span>Data from certified property assessments</span>
        <span>Last updated: Mar 10, 2025</span>
    </div>
</div>

<!-- Property Categories Distribution -->
<div class="finchat-card">
    <div class="finchat-card-header">
        <div class="finchat-card-title">Property Categories</div>
        <div>
            <select id="propertyView" class="finchat-select">
                <option value="byEPC">By EPC Rating</option>
                <option value="byType">By Property Type</option>
                <option value="byRegion">By Region</option>
            </select>
        </div>
    </div>
    <div class="finchat-card-content">
        <div class="finchat-chart-container" id="categoriesChart"></div>
    </div>
    <div class="finchat-card-footer">
        <span>Total properties: 248</span>
        <span>Last updated: Mar 10, 2025</span>
    </div>
</div>

<!-- Top Performing Properties -->
<div class="finchat-card">
    <div class="finchat-card-header">
        <div class="finchat-card-title">Top Performing Properties</div>
        <div>
            <select id="performanceMetric" class="finchat-select">
                <option value="overall">Overall Score</option>
                <option value="energy">Energy Efficiency</option>
                <option value="water">Water Management</option>
                <option value="carbon">Carbon Reduction</option>
            </select>
        </div>
    </div>
    <div class="finchat-card-content">
        <table class="finchat-table">
            <thead>
                <tr>
                    <th>Property</th>
                    <th>Location</th>
                    <th>Type</th>
                    <th>Score</th>
                    <th>EPC</th>
                    <th>Trend</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Green Park Tower</td>
                    <td>Amsterdam, NL</td>
                    <td>Commercial</td>
                    <td>94.8</td>
                    <td><span class="finchat-badge finchat-badge-success">A+</span></td>
                    <td><i class="fas fa-arrow-up finchat-text-success"></i></td>
                </tr>
                <tr>
                    <td>Eco Residences</td>
                    <td>Stockholm, SE</td>
                    <td>Residential</td>
                    <td>92.3</td>
                    <td><span class="finchat-badge finchat-badge-success">A</span></td>
                    <td><i class="fas fa-arrow-up finchat-text-success"></i></td>
                </tr>
                <tr>
                    <td>Horizon Offices</td>
                    <td>Copenhagen, DK</td>
                    <td>Commercial</td>
                    <td>91.7</td>
                    <td><span class="finchat-badge finchat-badge-success">A</span></td>
                    <td><i class="fas fa-equals finchat-text-light"></i></td>
                </tr>
                <tr>
                    <td>Urban Lofts</td>
                    <td>Berlin, DE</td>
                    <td>Mixed Use</td>
                    <td>89.5</td>
                    <td><span class="finchat-badge finchat-badge-success">A</span></td>
                    <td><i class="fas fa-arrow-up finchat-text-success"></i></td>
                </tr>
                <tr>
                    <td>Riverside Complex</td>
                    <td>Vienna, AT</td>
                    <td>Residential</td>
                    <td>88.2</td>
                    <td><span class="finchat-badge finchat-badge-success">A</span></td>
                    <td><i class="fas fa-arrow-up finchat-text-success"></i></td>
                </tr>
            </tbody>
        </table>
    </div>
    <div class="finchat-card-footer">
        <span>Showing top 5 of 248 properties</span>
        <a href="#" class="finchat-text-primary">View All Properties</a>
    </div>
</div>

<!-- Improvement Recommendations -->
<div class="finchat-card">
    <div class="finchat-card-header">
        <div class="finchat-card-title">AI Improvement Recommendations</div>
        <span class="finchat-badge finchat-badge-primary">AI-POWERED</span>
    </div>
    <div class="finchat-card-content">
        <div class="finchat-alert finchat-alert-info" style="display: flex; align-items: flex-start; gap: 1rem;">
            <i class="fas fa-lightbulb" style="margin-top: 0.25rem; color: #2196f3;"></i>
            <div>
                <div style="font-weight: 600; margin-bottom: 0.25rem;">Portfolio-Wide Recommendations</div>
                <p style="margin-top: 0;">Based on your current data, we recommend focusing on water management improvements for your Central Europe properties, which could reduce water usage by an estimated 18% annually.</p>
            </div>
        </div>
        
        <div class="finchat-mb-md"></div>
        
        <table class="finchat-table">
            <thead>
                <tr>
                    <th>Property Group</th>
                    <th>Recommendation</th>
                    <th>Potential Impact</th>
                    <th>Difficulty</th>
                    <th>ROI Period</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Residential (C-rated)</td>
                    <td>Smart heating systems upgrade</td>
                    <td><span class="finchat-badge finchat-badge-success">High</span></td>
                    <td>Medium</td>
                    <td>2.4 years</td>
                </tr>
                <tr>
                    <td>Commercial (B-rated)</td>
                    <td>Solar panel installation</td>
                    <td><span class="finchat-badge finchat-badge-success">High</span></td>
                    <td>High</td>
                    <td>4.1 years</td>
                </tr>
                <tr>
                    <td>All Properties</td>
                    <td>Water-efficient fixtures</td>
                    <td><span class="finchat-badge finchat-badge-primary">Medium</span></td>
                    <td>Low</td>
                    <td>1.2 years</td>
                </tr>
                <tr>
                    <td>Older Properties</td>
                    <td>Insulation improvements</td>
                    <td><span class="finchat-badge finchat-badge-success">High</span></td>
                    <td>Medium</td>
                    <td>3.5 years</td>
                </tr>
            </tbody>
        </table>
    </div>
    <div class="finchat-card-footer">
        <span>Recommendations updated monthly</span>
        <a href="#" class="finchat-text-primary">Generate Custom Report</a>
    </div>
</div>
{% endblock %}

{% block insights_panel %}
<div class="finchat-insights-panel">
    <div class="finchat-insights-header">Property Insights</div>
    
    <div class="finchat-insight-item">
        <div class="finchat-insight-title">Market Trend</div>
        <div class="finchat-insight-content">
            A+ rated properties are commanding 12% higher rental yields compared to C-rated properties in the same areas.
        </div>
    </div>
    
    <div class="finchat-insight-item">
        <div class="finchat-insight-title">Regulatory Alert</div>
        <div class="finchat-insight-content">
            New EU regulations will require all commercial buildings to achieve at least a B rating by 2028. 24% of your portfolio needs upgrading.
        </div>
    </div>
    
    <div class="finchat-insight-item">
        <div class="finchat-insight-title">Carbon Reduction</div>
        <div class="finchat-insight-content">
            Your recent smart building technology deployments have reduced carbon emissions by 15.3% in targeted properties.
        </div>
    </div>
    
    <div class="finchat-insight-item">
        <div class="finchat-insight-title">Water Management</div>
        <div class="finchat-insight-content">
            Properties with rainwater harvesting systems are showing 32% lower water costs compared to similar properties.
        </div>
    </div>
    
    <div class="finchat-insight-item">
        <div class="finchat-insight-title">Investment Opportunity</div>
        <div class="finchat-insight-content">
            Green financing rates for A-rated properties are currently 0.4% lower than standard rates, creating refinancing opportunities.
        </div>
    </div>
    
    <div class="finchat-insight-item">
        <div class="finchat-insight-title">Regional Performance</div>
        <div class="finchat-insight-content">
            Nordic properties outperform other regions with 18% better energy efficiency scores on average.
        </div>
    </div>
</div>
{% endblock %}

{% block additional_scripts %}
<script src="{{ url_for('static', filename='js/sustainability-copilot.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Create Portfolio Performance Chart
    createPortfolioChart();
    
    // Create Categories Distribution Chart
    createCategoriesChart();
    
    // Set up event listeners for dropdown changes
    setupEventListeners();
    
    // Initialize Co-Pilot context
    const realEstateContextElement = document.getElementById('realestate-copilot-context');
    if (realEstateContextElement) {
        try {
            const contextData = JSON.parse(realEstateContextElement.textContent);
            // Set data attribute for Co-Pilot to read
            document.body.setAttribute('data-copilot-context', JSON.stringify(contextData));
            console.log('Real Estate Co-Pilot context loaded:', contextData);
        } catch (e) {
            console.error('Error parsing Real Estate Co-Pilot context:', e);
        }
    }
});

function createPortfolioChart() {
    const portfolioData = {
        months: ['Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Jan', 'Feb'],
        energyEfficiency: [68, 69, 71, 72, 74, 75, 77, 79, 80, 82, 83, 85],
        carbonEmissions: [38, 37, 36, 35, 34, 33, 32, 31, 30, 29, 28, 27],
        waterUsage: [220, 215, 210, 205, 200, 198, 195, 192, 190, 188, 185, 183],
        breeamScore: [67, 68, 68, 69, 70, 70, 71, 71, 72, 72, 73, 73]
    };
    
    const trace1 = {
        x: portfolioData.months,
        y: portfolioData.energyEfficiency,
        name: 'Energy Efficiency',
        type: 'scatter',
        mode: 'lines+markers',
        marker: {
            color: '#3a8c7e'
        },
        line: {
            width: 3
        }
    };
    
    const trace2 = {
        x: portfolioData.months,
        y: portfolioData.carbonEmissions,
        name: 'Carbon Emissions',
        type: 'scatter',
        mode: 'lines+markers',
        marker: {
            color: '#4caf50'
        },
        line: {
            width: 3
        },
        yaxis: 'y2'
    };
    
    const trace3 = {
        x: portfolioData.months,
        y: portfolioData.waterUsage,
        name: 'Water Usage',
        type: 'scatter',
        mode: 'lines+markers',
        marker: {
            color: '#2196f3'
        },
        line: {
            width: 3
        },
        yaxis: 'y3'
    };
    
    const trace4 = {
        x: portfolioData.months,
        y: portfolioData.breeamScore,
        name: 'BREEAM Score',
        type: 'scatter',
        mode: 'lines+markers',
        marker: {
            color: '#ff9800'
        },
        line: {
            width: 3
        },
        yaxis: 'y4'
    };
    
    const data = [trace1, trace2, trace3, trace4];
    
    const layout = {
        height: 350,
        margin: {
            l: 50,
            r: 50,
            b: 50,
            t: 30,
            pad: 4
        },
        legend: {
            orientation: "h",
            y: -0.2
        },
        font: {
            family: 'Inter, Segoe UI, sans-serif',
            size: 11,
            color: '#333333'
        },
        yaxis: {
            title: 'Energy Efficiency Score'
        },
        yaxis2: {
            title: 'Carbon (kg CO₂e/m²)',
            titlefont: {color: '#4caf50'},
            tickfont: {color: '#4caf50'},
            overlaying: 'y',
            side: 'right',
            position: 0.85
        },
        yaxis3: {
            title: 'Water (L/day)',
            titlefont: {color: '#2196f3'},
            tickfont: {color: '#2196f3'},
            anchor: 'free',
            overlaying: 'y',
            side: 'right',
            position: 0.95,
            showgrid: false
        },
        yaxis4: {
            title: 'BREEAM Score',
            titlefont: {color: '#ff9800'},
            tickfont: {color: '#ff9800'},
            anchor: 'free',
            overlaying: 'y',
            side: 'right',
            position: 0.75,
            showgrid: false
        }
    };
    
    Plotly.newPlot('portfolioChart', data, layout, {responsive: true});
}

function createCategoriesChart() {
    // EPC Rating distribution data
    const epcData = [
        {value: 12, label: 'A+', color: '#4caf50'},
        {value: 24, label: 'A', color: '#8bc34a'},
        {value: 35, label: 'B', color: '#cddc39'},
        {value: 42, label: 'C', color: '#ffeb3b'},
        {value: 21, label: 'D', color: '#ffc107'},
        {value: 10, label: 'E', color: '#ff9800'},
        {value: 4, label: 'F', color: '#ff5722'}
    ];
    
    const values = epcData.map(item => item.value);
    const labels = epcData.map(item => item.label);
    const colors = epcData.map(item => item.color);
    
    const data = [{
        values: values,
        labels: labels,
        type: 'pie',
        textinfo: 'label+percent',
        textposition: 'inside',
        automargin: true,
        marker: {
            colors: colors
        },
        hole: 0.4
    }];
    
    const layout = {
        height: 350,
        showlegend: true,
        legend: {
            orientation: "h",
            y: -0.2
        },
        margin: {
            l: 20,
            r: 20,
            t: 30,
            b: 0
        },
        annotations: [{
            font: {
                size: 14
            },
            showarrow: false,
            text: 'EPC Ratings',
            x: 0.5,
            y: 0.5
        }]
    };
    
    Plotly.newPlot('categoriesChart', data, layout, {responsive: true});
}

function setupEventListeners() {
    // Time Range Selector for Portfolio Chart
    const timeRangeSelector = document.getElementById('timeRange');
    if (timeRangeSelector) {
        timeRangeSelector.addEventListener('change', function() {
            // This would fetch new data based on the selected time range
            // For demo purposes, we'll just slightly modify the existing chart
            const selectedValue = this.value;
            let factor = 1.0;
            
            if (selectedValue === '2year') {
                factor = 0.9;
            } else if (selectedValue === '5year') {
                factor = 0.8;
            } else if (selectedValue === 'all') {
                factor = 0.7;
            }
            
            // Update the first trace (Energy Efficiency)
            Plotly.update('portfolioChart', {
                'y': [[68*factor, 69*factor, 71*factor, 72*factor, 74*factor, 75*factor, 
                      77*factor, 79*factor, 80*factor, 82*factor, 83*factor, 85*factor]]
            }, {}, [0]);
        });
    }
    
    // Property View Selector for Categories Chart
    const propertyViewSelector = document.getElementById('propertyView');
    if (propertyViewSelector) {
        propertyViewSelector.addEventListener('change', function() {
            const selectedView = this.value;
            
            if (selectedView === 'byType') {
                // Property type distribution data
                const typeData = [
                    {value: 42, label: 'Residential', color: '#3f51b5'},
                    {value: 35, label: 'Commercial', color: '#009688'},
                    {value: 15, label: 'Mixed Use', color: '#673ab7'},
                    {value: 8, label: 'Industrial', color: '#607d8b'}
                ];
                
                updateCategoriesChart(typeData, 'Property Types');
            } else if (selectedView === 'byRegion') {
                // Region distribution data
                const regionData = [
                    {value: 28, label: 'Northern Europe', color: '#2196f3'},
                    {value: 35, label: 'Central Europe', color: '#3f51b5'},
                    {value: 22, label: 'Western Europe', color: '#009688'},
                    {value: 15, label: 'Southern Europe', color: '#ff9800'}
                ];
                
                updateCategoriesChart(regionData, 'Regions');
            } else {
                // Reset to default EPC view
                const epcData = [
                    {value: 12, label: 'A+', color: '#4caf50'},
                    {value: 24, label: 'A', color: '#8bc34a'},
                    {value: 35, label: 'B', color: '#cddc39'},
                    {value: 42, label: 'C', color: '#ffeb3b'},
                    {value: 21, label: 'D', color: '#ffc107'},
                    {value: 10, label: 'E', color: '#ff9800'},
                    {value: 4, label: 'F', color: '#ff5722'}
                ];
                
                updateCategoriesChart(epcData, 'EPC Ratings');
            }
        });
    }
    
    // Performance Metric Selector for Table
    const performanceSelector = document.getElementById('performanceMetric');
    if (performanceSelector) {
        performanceSelector.addEventListener('change', function() {
            // In a real application, this would update the table with new data
            // Here we'll just show a message for demonstration purposes
            const selectedMetric = this.value;
            console.log(`Would show top properties by ${selectedMetric}`);
            
            // Notify the user that this would change the data in a real application
            const footerMessage = document.querySelector('.finchat-card:nth-child(5) .finchat-card-footer span:first-child');
            if (footerMessage) {
                footerMessage.textContent = `Showing top 5 properties by ${getMetricName(selectedMetric)}`;
                
                setTimeout(() => {
                    footerMessage.textContent = 'Showing top 5 of 248 properties';
                }, 3000);
            }
        });
    }
}

function updateCategoriesChart(data, title) {
    const values = data.map(item => item.value);
    const labels = data.map(item => item.label);
    const colors = data.map(item => item.color);
    
    Plotly.update('categoriesChart', {
        'values': [values],
        'labels': [labels],
        'marker.colors': [colors]
    }, {
        'annotations[0].text': title
    });
}

function getMetricName(metricCode) {
    const metricNames = {
        'overall': 'Overall Score',
        'energy': 'Energy Efficiency',
        'water': 'Water Management',
        'carbon': 'Carbon Reduction'
    };
    
    return metricNames[metricCode] || metricCode;
}
</script>
{% endblock %}