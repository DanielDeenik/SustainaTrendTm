{% extends "layouts/atomic_layout.html" %}

{% block title %}Sustainability Trend Analysis - SustainaTrendâ„¢ Platform{% endblock %}

{% block meta_description %}
Analyze sustainability trend data with advanced AI insights and real-time metrics.
{% endblock %}

{% block head_extras %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/trend-analysis.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
{% endblock %}

{% block nav_trends_active %}active{% endblock %}

{% block breadcrumb_current %}Trend Analysis{% endblock %}

{% block breadcrumbs %}
<li class="st-breadcrumb__item">
  <a href="/atomic-home" class="st-breadcrumb__link">Home</a>
</li>
<li class="st-breadcrumb__item">
  <span class="st-breadcrumb__divider">/</span>
  <a href="/atomic-home" class="st-breadcrumb__link">Dashboard</a>
</li>
<li class="st-breadcrumb__item">
  <span class="st-breadcrumb__divider">/</span>
  <span class="st-breadcrumb__text">Trend Analysis</span>
</li>
{% endblock %}

{% block page_title %}Sustainability Trend Analysis{% endblock %}
{% block page_description %}Discover emerging sustainability trends and virality patterns{% endblock %}

{% block page_actions %}
<button class="st-button st-button--secondary" id="export-trends">
  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
  Export Trends
</button>
<button class="st-button" id="generate-report-btn">
  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></svg>
  Generate Report
</button>
{% endblock %}

{% block tabs_navigation %}
<div class="st-tabs">
  <a href="?view=all" class="st-tab {% if not request.args.get('view') or request.args.get('view') == 'all' %}active{% endif %}">All Trends</a>
  <a href="?view=top" class="st-tab {% if request.args.get('view') == 'top' %}active{% endif %}">Top Performers</a>
  <a href="?view=growing" class="st-tab {% if request.args.get('view') == 'growing' %}active{% endif %}">Fastest Growing</a>
  <a href="?view=categories" class="st-tab {% if request.args.get('view') == 'categories' %}active{% endif %}">By Category</a>
</div>
{% endblock %}

{% block left_column %}
<!-- Filters -->
<div class="st-card">
  <div class="st-card__header">
    <h2 class="st-card__title">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
      Filters
    </h2>
  </div>
  <div class="st-card__body">
    <div class="st-form-group">
      <label class="st-form-label" for="category-filter">Category</label>
      <select id="category-filter" class="st-form-select" onchange="window.location.href='?category=' + this.value + '&sort={{ sort }}'">
        <option value="all" {% if category == 'all' %}selected{% endif %}>All Categories</option>
        <option value="Energy" {% if category == 'Energy' %}selected{% endif %}>Energy</option>
        <option value="Carbon" {% if category == 'Carbon' %}selected{% endif %}>Carbon</option>
        <option value="Waste" {% if category == 'Waste' %}selected{% endif %}>Waste Management</option>
        <option value="Water" {% if category == 'Water' %}selected{% endif %}>Water</option>
        <option value="Social" {% if category == 'Social' %}selected{% endif %}>Social Impact</option>
        <option value="Governance" {% if category == 'Governance' %}selected{% endif %}>Governance</option>
      </select>
    </div>
    
    <div class="st-form-group">
      <label class="st-form-label" for="sort-filter">Sort by</label>
      <select id="sort-filter" class="st-form-select" onchange="window.location.href='?category={{ category }}&sort=' + this.value">
        <option value="virality" {% if sort == 'virality' %}selected{% endif %}>Virality Score</option>
        <option value="date" {% if sort == 'date' %}selected{% endif %}>Date (Newest)</option>
        <option value="category" {% if sort == 'category' %}selected{% endif %}>Category</option>
      </select>
    </div>
    
    <div class="st-form-group">
      <label class="st-form-label" for="date-range">Time Period</label>
      <select id="date-range" class="st-form-select">
        <option value="week">Past Week</option>
        <option value="month" selected>Past Month</option>
        <option value="quarter">Past Quarter</option>
        <option value="year">Past Year</option>
      </select>
    </div>
    
    <div class="st-form-group">
      <label class="st-form-label" for="min-score">Minimum Score</label>
      <input type="range" id="min-score" class="st-form-range" min="0" max="100" value="50">
      <div class="st-d-flex st-justify-content-between">
        <span>0</span>
        <span id="min-score-value">50</span>
        <span>100</span>
      </div>
    </div>
    
    <button class="st-button st-button--outline st-w-100 st-mt-3">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
      Reset Filters
    </button>
  </div>
</div>

<!-- Statistics Summary -->
<div class="st-card">
  <div class="st-card__header">
    <h2 class="st-card__title">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-6"/></svg>
      Statistics
    </h2>
  </div>
  <div class="st-card__body">
    <div class="st-statistic">
      <div class="st-statistic__label">Active Trends</div>
      <div class="st-statistic__value">{{ trends|length }}</div>
    </div>
    
    <div class="st-statistic">
      <div class="st-statistic__label">Viral Trends</div>
      <div class="st-statistic__value">{{ trends|selectattr('virality_score', 'defined')|selectattr('virality_score', '>=', 80)|list|length }}</div>
    </div>
    
    <div class="st-statistic">
      <div class="st-statistic__label">Avg Growth</div>
      <div class="st-statistic__value">{{ trends|selectattr('growth_rate', 'defined')|map(attribute='growth_rate')|list|sum / trends|selectattr('growth_rate', 'defined')|list|length|round(1) if trends|selectattr('growth_rate', 'defined')|list|length > 0 else 0 }}%</div>
    </div>
    
    <div class="st-statistic">
      <div class="st-statistic__label">Categories</div>
      <div class="st-statistic__value">{{ trends|selectattr('category', 'defined')|map(attribute='category')|unique|list|length }}</div>
    </div>
  </div>
</div>
{% endblock %}

{% block center_column %}
<!-- Trends Chart -->
<div class="st-card">
  <div class="st-card__header">
    <h2 class="st-card__title">Trend Virality by Category</h2>
    <div class="st-card__actions">
      <button class="st-button st-button--sm st-button--outline" id="refresh-chart">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
        Refresh
      </button>
    </div>
  </div>
  <div class="st-card__body">
    <div class="st-chart-container">
      <canvas id="trendChart" height="300"></canvas>
    </div>
  </div>
</div>

<!-- Trending Items List -->
<div class="st-card">
  <div class="st-card__header">
    <h2 class="st-card__title">Top Sustainability Trends</h2>
    <div class="st-card__actions">
      <button class="st-button st-button--sm st-button--outline" id="toggle-view">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="9" y1="3" x2="9" y2="21"/></svg>
        Toggle View
      </button>
    </div>
  </div>
  <div class="st-card__body st-p-0">
    <div class="st-trend-items">
      {% if trends|length > 0 %}
        {% for trend in trends %}
        <div class="st-trend-item">
          <div class="st-trend-score">
            <div class="st-trend-score-circle" style="--score: {{ trend.virality_score }}">
              <span>{{ trend.virality_score }}</span>
            </div>
          </div>
          <div class="st-trend-content">
            <h3 class="st-trend-title">{{ trend.name }}</h3>
            <p class="st-trend-description">{{ trend.description }}</p>
            <div class="st-trend-meta">
              <span class="st-badge st-badge--primary">{{ trend.category }}</span>
              <span class="st-trend-source">{{ trend.source }}</span>
              <span class="st-trend-date">{{ trend.date.strftime('%b %d, %Y') if trend.date is defined and trend.date is not none else 'N/A' }}</span>
            </div>
          </div>
          <div class="st-trend-growth 
            {% if trend.growth_rate is defined and trend.growth_rate > 0 %}st-trend-up{% elif trend.growth_rate is defined and trend.growth_rate < 0 %}st-trend-down{% endif %}">
            {% if trend.growth_rate is defined %}
              {% if trend.growth_rate > 0 %}
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6-6 6 6"/><path d="M6 12h12"/><path d="m6 15 6 6 6-6"/></svg>
              {% elif trend.growth_rate < 0 %}
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6-6 6 6"/><path d="M6 12h12"/><path d="m6 15 6 6 6-6"/></svg>
              {% endif %}
              {{ trend.growth_rate }}%
            {% else %}
              --
            {% endif %}
          </div>
        </div>
        {% endfor %}
      {% else %}
        <div class="st-empty-state">
          <div class="st-empty-state__icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
          </div>
          <h3 class="st-empty-state__title">No trends found</h3>
          <p class="st-empty-state__message">No trends found for the selected filters. Try changing your filter criteria.</p>
          <button class="st-button" onclick="window.location.href='?category=all&sort=virality'">Reset Filters</button>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Related Insights Section -->
<div class="st-card">
  <div class="st-card__header">
    <h2 class="st-card__title">Related Insights</h2>
  </div>
  <div class="st-card__body">
    <div class="st-related-insights">
      <div class="st-insight-card">
        <div class="st-insight-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>
        </div>
        <h3>Predictive Analytics</h3>
        <p>Forecast upcoming sustainability trends with AI-powered predictive models.</p>
        <a href="/analytics-dashboard" class="st-button st-button--sm st-button--outline">Explore Analytics</a>
      </div>
      
      <div class="st-insight-card">
        <div class="st-insight-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
        </div>
        <h3>Sustainability Stories</h3>
        <p>Discover compelling narratives based on sustainability trend data.</p>
        <a href="/sustainability-stories-atomic" class="st-button st-button--sm st-button--outline">View Stories</a>
      </div>
      
      <div class="st-insight-card">
        <div class="st-insight-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="m18.7 8-5.1 5.2-2.8-2.7L7 14.3"/></svg>
        </div>
        <h3>Real Estate Impact</h3>
        <p>See how sustainability trends are affecting real estate markets.</p>
        <a href="/realestate-unified-dashboard" class="st-button st-button--sm st-button--outline">View Property Data</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block right_column %}
<!-- AI Insights Panel -->
<div class="st-ai-panel">
  <div class="st-ai-panel__header">
    <h2 class="st-ai-panel__title">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 0 0-6.88 17.28L12 13l6.88 6.28A10 10 0 1 0 12 2Z"/><circle cx="12" cy="13" r="2"/><path d="M12 19v-7"/></svg>
      AI Insights
    </h2>
    <button class="st-ai-panel__refresh" id="refresh-insights">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
    </button>
  </div>
  <div class="st-ai-panel__body">
    {% if insights %}
    <div class="st-ai-insight">
      <div class="st-ai-insight__title">Top Performing Category</div>
      <div class="st-ai-insight__content">
        <span class="st-ai-highlight">{{ insights.top_category }}</span> has the highest average virality score of {{ insights.top_score }} in our current dataset.
      </div>
    </div>
    <div class="st-ai-insight">
      <div class="st-ai-insight__title">Fastest Growing</div>
      <div class="st-ai-insight__content">
        <span class="st-ai-highlight">{{ insights.fastest_growing }}</span> trends are showing the strongest growth at {{ insights.growth_rate }}% compared to other categories.
      </div>
    </div>
    {% else %}
    <div class="st-ai-insight">
      <div class="st-ai-insight__title">Emerging Pattern</div>
      <div class="st-ai-insight__content">
        The data suggests that <span class="st-ai-highlight">Water Conservation</span> trends are growing 23% faster than other sustainability categories this quarter.
      </div>
    </div>
    <div class="st-ai-insight">
      <div class="st-ai-insight__title">Prediction</div>
      <div class="st-ai-insight__content">
        Based on current virality patterns, <span class="st-ai-highlight">Circular Economy</span> topics are likely to see significant growth in the next 30-60 days.
      </div>
    </div>
    {% endif %}
    <button class="st-button st-button--sm st-button--outline st-mt-3" id="generate-more-insights">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>
      Generate More Insights
    </button>
  </div>
</div>

<!-- Trend Distribution -->
<div class="st-card">
  <div class="st-card__header">
    <h2 class="st-card__title">Category Distribution</h2>
  </div>
  <div class="st-card__body">
    <div class="st-chart-container" style="height: 200px;">
      <canvas id="distributionChart"></canvas>
    </div>
  </div>
</div>

<!-- Top Trending Keywords -->
<div class="st-card">
  <div class="st-card__header">
    <h2 class="st-card__title">Trending Keywords</h2>
  </div>
  <div class="st-card__body">
    <div class="st-keyword-cloud">
      <span class="st-keyword" style="--size: 1.3;">ESG</span>
      <span class="st-keyword" style="--size: 1.8;">Net Zero</span>
      <span class="st-keyword" style="--size: 1.5;">Circular Economy</span>
      <span class="st-keyword" style="--size: 1.2;">Carbon Neutral</span>
      <span class="st-keyword" style="--size: 1.7;">Renewable Energy</span>
      <span class="st-keyword" style="--size: 1.3;">Biodiversity</span>
      <span class="st-keyword" style="--size: 1.4;">Water Conservation</span>
      <span class="st-keyword" style="--size: 1.1;">Sustainable Finance</span>
      <span class="st-keyword" style="--size: 1.6;">Climate Action</span>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize the trend chart
    const ctx = document.getElementById('trendChart').getContext('2d');
    const chartData = {{ trend_chart_data|safe }};
    
    const chart = new Chart(ctx, {
      type: 'bar',
      data: chartData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            padding: 12,
            titleFont: {
              size: 14,
              weight: 'bold'
            },
            bodyFont: {
              size: 13
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            ticks: {
              font: {
                size: 12
              }
            },
            grid: {
              color: 'rgba(200, 200, 200, 0.15)'
            }
          },
          x: {
            ticks: {
              font: {
                size: 12
              }
            },
            grid: {
              display: false
            }
          }
        }
      }
    });
    
    // Initialize distribution chart
    const distributionCtx = document.getElementById('distributionChart').getContext('2d');
    const distributionChart = new Chart(distributionCtx, {
      type: 'doughnut',
      data: {
        labels: chartData.labels,
        datasets: [{
          data: chartData.datasets[0].data,
          backgroundColor: [
            'rgba(76, 175, 80, 0.7)',
            'rgba(33, 150, 243, 0.7)',
            'rgba(255, 193, 7, 0.7)',
            'rgba(156, 39, 176, 0.7)',
            'rgba(233, 30, 99, 0.7)',
            'rgba(0, 188, 212, 0.7)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'right',
            labels: {
              font: {
                size: 11
              },
              boxWidth: 15
            }
          }
        }
      }
    });
    
    // Range slider value display
    const minScoreSlider = document.getElementById('min-score');
    const minScoreValue = document.getElementById('min-score-value');
    
    minScoreSlider.addEventListener('input', function() {
      minScoreValue.textContent = this.value;
    });
    
    // Handle generate report button
    document.getElementById('generate-report-btn').addEventListener('click', function() {
      alert('Generating sustainability trend report...');
      // In a real implementation, this would trigger a report generation process
    });
    
    // Handle generate more insights button
    document.getElementById('generate-more-insights').addEventListener('click', function() {
      const insightsContainer = this.closest('.st-ai-panel__body');
      const loadingHtml = '<div class="st-ai-insight st-ai-insight--loading"><div class="st-spinner"></div> Generating insights...</div>';
      
      // Insert loading indicator before the button
      this.insertAdjacentHTML('beforebegin', loadingHtml);
      
      // Simulate AI analysis (would be an API call in production)
      setTimeout(() => {
        // Remove loading indicator
        insightsContainer.querySelector('.st-ai-insight--loading').remove();
        
        // Add new insights
        const newInsights = [
          {
            title: "Market Opportunity",
            content: `Companies focusing on <span class="st-ai-highlight">${chartData.labels[Math.floor(Math.random() * chartData.labels.length)]}</span> initiatives are seeing 18% higher consumer engagement rates compared to competitors.`
          },
          {
            title: "Cross-Sector Trend",
            content: `We're detecting increased correlation between <span class="st-ai-highlight">${chartData.labels[Math.floor(Math.random() * chartData.labels.length)]}</span> and <span class="st-ai-highlight">${chartData.labels[Math.floor(Math.random() * chartData.labels.length)]}</span> trends, suggesting integrated sustainability strategies are gaining traction.`
          }
        ];
        
        // Insert new insights before the button
        newInsights.forEach(insight => {
          const insightHtml = `<div class="st-ai-insight st-ai-insight--new">
            <div class="st-ai-insight__title">${insight.title}</div>
            <div class="st-ai-insight__content">${insight.content}</div>
          </div>`;
          this.insertAdjacentHTML('beforebegin', insightHtml);
        });
        
        // Add animation effect to new insights
        document.querySelectorAll('.st-ai-insight--new').forEach(el => {
          el.style.animation = 'fadeIn 0.5s ease-in-out';
        });
      }, 1500);
    });
  });
</script>
{% endblock %}