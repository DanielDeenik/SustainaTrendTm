{% extends "layouts/collapsible_layout.html" %}

{% block title %}Analytics Dashboard | SustainaTrend™{% endblock %}

{% block header_title %}Analytics Dashboard{% endblock %}

{% block header_actions %}
<button class="finchat-button" id="refresh-data-btn">
    <span class="material-icons">refresh</span>
    <span>Refresh Data</span>
</button>
{% endblock %}

{% block additional_css %}
<style>
    /* Core Card Styles */
    .analytics-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    /* Modern KPI Cards with AI-Focus */
    .kpi-card {
        background-color: var(--card-bg);
        border-radius: 16px;
        padding: 22px;
        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.08);
        display: flex;
        flex-direction: column;
        transition: all 0.25s ease-in-out;
        overflow: hidden;
        position: relative;
        border: 1px solid rgba(var(--primary-rgb), 0.1);
    }
    
    .kpi-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }
    
    .kpi-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }
    
    .kpi-card-icon {
        width: 46px;
        height: 46px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: rgba(var(--primary-rgb), 0.1);
    }
    
    .kpi-card-icon .material-icons {
        font-size: 24px;
        color: var(--primary-color);
    }
    
    .kpi-card-title {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-color);
        margin: 0;
    }
    
    .kpi-card-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--primary-color);
        margin: 10px 0 5px 0;
    }
    
    .kpi-card-change {
        display: flex;
        align-items: center;
        font-size: 14px;
        font-weight: 500;
    }
    
    .kpi-card-change.positive {
        color: #2e7d32;
    }
    
    .kpi-card-change.negative {
        color: #c62828;
    }
    
    .kpi-card-change .material-icons {
        font-size: 18px;
        margin-right: 5px;
    }
    
    .kpi-card-description {
        font-size: 14px;
        color: var(--text-muted);
        margin-top: 10px;
    }
    
    .kpi-actions {
        margin-top: 15px;
        display: flex;
        justify-content: flex-end;
    }
    
    .kpi-deep-dive {
        font-size: 13px;
        color: var(--primary-color);
        background: transparent;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        transition: all 0.2s;
    }
    
    .kpi-deep-dive:hover {
        background-color: rgba(var(--primary-rgb), 0.05);
    }
    
    .kpi-deep-dive .material-icons {
        font-size: 16px;
        margin-left: 4px;
    }
    
    /* Advanced Chart Cards */
    .chart-card {
        background-color: var(--card-bg);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.08);
        margin-bottom: 25px;
        transition: all 0.25s ease-in-out;
        border: 1px solid rgba(var(--primary-rgb), 0.05);
    }
    
    .chart-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }
    
    .chart-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .chart-card-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--heading-color);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .chart-card-title .material-icons {
        font-size: 20px;
        color: var(--primary-color);
    }
    
    .chart-card-controls {
        display: flex;
        gap: 10px;
    }
    
    .chart-container {
        height: 300px;
        width: 100%;
    }
    
    /* AI Insight Card - Enhanced */
    .insight-card {
        background-color: #f8f9fa;
        border-radius: 12px;
        padding: 22px;
        margin-top: 20px;
        border-left: 4px solid #9c27b0;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
    }
    
    .insight-card-title {
        font-size: 16px;
        font-weight: 600;
        color: #9c27b0;
        margin: 0 0 12px 0;
        display: flex;
        align-items: center;
    }
    
    .insight-card-title .material-icons {
        margin-right: 8px;
    }
    
    .insight-card-content {
        font-size: 14px;
        line-height: 1.6;
        color: var(--text-color);
    }
    
    .metric-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 15px;
    }
    
    .metric-badge {
        background-color: rgba(156, 39, 176, 0.1);
        color: #9c27b0;
        border-radius: 20px;
        padding: 6px 12px;
        font-size: 13px;
        font-weight: 500;
    }
    
    /* Toggle and Control Buttons */
    .toggle-view-btn {
        background: transparent;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 6px 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
        font-size: 13px;
    }
    
    .toggle-view-btn:hover, .toggle-view-btn.active {
        background-color: rgba(var(--primary-rgb), 0.1);
        border-color: var(--primary-color);
        color: var(--primary-color);
    }
    
    .toggle-view-btn .material-icons {
        font-size: 16px;
    }
    
    /* Data Storytelling Section - Enhanced */
    .data-story {
        background-color: var(--card-bg);
        border-radius: 16px;
        padding: 28px;
        margin-bottom: 30px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(var(--primary-rgb), 0.1);
        position: relative;
        overflow: hidden;
    }
    
    .data-story:before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 5px;
        background: linear-gradient(to right, var(--primary-color), #9c27b0);
    }
    
    .data-story-title {
        font-size: 22px;
        font-weight: 600;
        color: var(--heading-color);
        margin: 0 0 20px 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .data-story-title .material-icons {
        color: var(--primary-color);
    }
    
    .data-story-content {
        font-size: 15px;
        line-height: 1.7;
        color: var(--text-color);
    }
    
    .data-story-highlight {
        font-weight: 600;
        color: var(--primary-color);
    }
    
    .data-story-metrics {
        display: flex;
        gap: 20px;
        margin: 25px 0;
        flex-wrap: wrap;
    }
    
    .data-story-metric {
        background-color: var(--card-bg);
        border-radius: 12px;
        padding: 20px;
        flex: 1;
        min-width: 180px;
        text-align: center;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(var(--primary-rgb), 0.05);
        transition: transform 0.2s;
    }
    
    .data-story-metric:hover {
        transform: translateY(-3px);
    }
    
    .data-story-metric-value {
        font-size: 28px;
        font-weight: 700;
        color: var(--primary-color);
        margin: 0 0 5px 0;
    }
    
    .data-story-metric-label {
        font-size: 14px;
        color: var(--text-muted);
    }
    
    /* Actionable Recommendations - Enhanced */
    .action-items {
        margin-top: 30px;
    }
    
    .action-item {
        display: flex;
        align-items: flex-start;
        gap: 18px;
        padding: 20px;
        background-color: rgba(var(--primary-rgb), 0.03);
        border-radius: 12px;
        margin-bottom: 15px;
        border: 1px solid rgba(var(--primary-rgb), 0.05);
        transition: all 0.25s;
    }
    
    .action-item:hover {
        transform: translateX(5px);
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
    }
    
    .action-item-icon {
        background-color: var(--primary-color);
        color: white;
        width: 42px;
        height: 42px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    
    .action-item-icon .material-icons {
        font-size: 22px;
    }
    
    .action-item-content {
        flex: 1;
    }
    
    .action-item-title {
        font-weight: 600;
        font-size: 16px;
        margin: 0 0 8px 0;
        color: var(--heading-color);
    }
    
    .action-item-description {
        font-size: 14px;
        color: var(--text-color);
        margin: 0;
        line-height: 1.5;
    }
    
    .action-item-meta {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 12px;
    }
    
    .action-priority {
        font-size: 12px;
        font-weight: 500;
        padding: 3px 8px;
        border-radius: 12px;
        background-color: rgba(var(--primary-rgb), 0.1);
        color: var(--primary-color);
    }
    
    .action-priority.high {
        background-color: rgba(244, 67, 54, 0.1);
        color: #f44336;
    }
    
    .action-priority.medium {
        background-color: rgba(255, 152, 0, 0.1);
        color: #ff9800;
    }
    
    .action-potential {
        font-size: 13px;
        color: var(--text-muted);
    }
    
    /* Deep Dive Modal */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        overflow: auto;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .modal.visible {
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 1;
    }
    
    .modal-content {
        background-color: var(--card-bg);
        width: 90%;
        max-width: 900px;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        overflow: hidden;
        transform: translateY(30px);
        transition: transform 0.3s ease;
    }
    
    .modal.visible .modal-content {
        transform: translateY(0);
    }
    
    .modal-header {
        padding: 20px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--border-color);
    }
    
    .modal-header h2 {
        margin: 0;
        font-size: 20px;
        color: var(--heading-color);
    }
    
    .close-modal {
        font-size: 28px;
        font-weight: 400;
        color: var(--text-muted);
        cursor: pointer;
        transition: color 0.2s;
    }
    
    .close-modal:hover {
        color: var(--text-color);
    }
    
    .modal-body {
        padding: 24px;
    }
    
    .deep-dive-chart {
        height: 400px;
        width: 100%;
        margin-bottom: 20px;
    }
    
    .deep-dive-content {
        font-size: 15px;
        line-height: 1.6;
        color: var(--text-color);
    }
    
    .deep-dive-tabs {
        display: flex;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 20px;
    }
    
    .deep-dive-tab {
        padding: 12px 20px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        color: var(--text-muted);
        transition: all 0.2s;
        border-bottom: 2px solid transparent;
    }
    
    .deep-dive-tab:hover {
        color: var(--text-color);
    }
    
    .deep-dive-tab.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
    }
    
    .deep-dive-detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 25px;
    }
    
    .deep-dive-detail-card {
        padding: 16px;
        border-radius: 12px;
        background-color: rgba(var(--primary-rgb), 0.03);
    }
    
    .deep-dive-detail-title {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-muted);
        margin: 0 0 8px 0;
    }
    
    .deep-dive-detail-value {
        font-size: 18px;
        font-weight: 600;
        color: var(--heading-color);
    }
    
    .deep-dive-breakdown {
        margin-top: 25px;
    }
    
    .deep-dive-breakdown-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 15px;
        color: var(--heading-color);
    }
    
    .deep-dive-recommendations {
        margin-top: 30px;
        padding: 20px;
        border-radius: 12px;
        background-color: rgba(156, 39, 176, 0.05);
        border-left: 4px solid #9c27b0;
    }
    
    .deep-dive-recommendations-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 15px;
        color: #9c27b0;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .deep-dive-recommendations ul {
        margin: 0;
        padding-left: 20px;
        line-height: 1.6;
    }
    
    .deep-dive-recommendations li {
        margin-bottom: 10px;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .analytics-container {
            grid-template-columns: 1fr;
        }
        
        .data-story-metrics {
            flex-direction: column;
            gap: 15px;
        }
        
        .data-story-metric {
            min-width: auto;
        }
        
        .modal-content {
            width: 95%;
            height: 90%;
            overflow-y: auto;
        }
        
        .deep-dive-detail-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="st-container">
    <!-- AI-Generated Data Story -->
    <div class="data-story">
        <h2 class="data-story-title">Executive Summary</h2>
        <div class="data-story-content">
            <p>Over the past quarter, your organization has shown significant progress in key sustainability metrics. 
            <span class="data-story-highlight">Carbon emissions decreased by 12%</span> compared to the previous quarter, 
            exceeding your target of 8%. Water usage efficiency improved by 5%, contributing to overall resource conservation efforts.</p>
            
            <p>The most notable improvement has been in <span class="data-story-highlight">renewable energy adoption</span>, 
            which increased from 28% to 35% of total energy consumption. This puts you ahead of industry average (29%) 
            and positions your organization well for the upcoming regulatory changes.</p>
        </div>
        
        <div class="data-story-metrics">
            <div class="data-story-metric">
                <div class="data-story-metric-value">-12%</div>
                <div class="data-story-metric-label">Carbon Emissions</div>
            </div>
            <div class="data-story-metric">
                <div class="data-story-metric-value">35%</div>
                <div class="data-story-metric-label">Renewable Energy</div>
            </div>
            <div class="data-story-metric">
                <div class="data-story-metric-value">87</div>
                <div class="data-story-metric-label">ESG Score</div>
            </div>
        </div>
    </div>

    <!-- KPI Cards - AI-curated core sustainability metrics -->
    <h3 class="st-section-title">
        <span class="material-icons">insights</span>
        Key Performance Indicators
    </h3>
    <div class="analytics-container">
        <!-- Carbon Emissions KPI -->
        <div class="kpi-card">
            <div class="kpi-card-header">
                <h3 class="kpi-card-title">Carbon Emissions</h3>
                <div class="kpi-card-icon">
                    <span class="material-icons">co2</span>
                </div>
            </div>
            <div class="kpi-card-value">12,450 t</div>
            <div class="kpi-card-change positive">
                <span class="material-icons">trending_down</span>
                -12% from last quarter
            </div>
            <div class="kpi-card-description">Total CO2 equivalent emissions across all operations</div>
            <div class="kpi-actions">
                <button class="kpi-deep-dive" onclick="showDeepDiveModal('carbon-emissions')">
                    Deep Dive <span class="material-icons">arrow_forward</span>
                </button>
            </div>
        </div>
        
        <!-- Energy Consumption KPI -->
        <div class="kpi-card">
            <div class="kpi-card-header">
                <h3 class="kpi-card-title">Energy Consumption</h3>
                <div class="kpi-card-icon">
                    <span class="material-icons">bolt</span>
                </div>
            </div>
            <div class="kpi-card-value">8.2M kWh</div>
            <div class="kpi-card-change positive">
                <span class="material-icons">trending_down</span>
                -3% from last quarter
            </div>
            <div class="kpi-card-description">Total energy usage across all facilities</div>
            <div class="kpi-actions">
                <button class="kpi-deep-dive" onclick="showDeepDiveModal('energy-consumption')">
                    Deep Dive <span class="material-icons">arrow_forward</span>
                </button>
            </div>
        </div>
        
        <!-- Water Usage KPI -->
        <div class="kpi-card">
            <div class="kpi-card-header">
                <h3 class="kpi-card-title">Water Usage</h3>
                <div class="kpi-card-icon">
                    <span class="material-icons">water_drop</span>
                </div>
            </div>
            <div class="kpi-card-value">356K m³</div>
            <div class="kpi-card-change positive">
                <span class="material-icons">trending_down</span>
                -5% from last quarter
            </div>
            <div class="kpi-card-description">Total water consumption across operations</div>
            <div class="kpi-actions">
                <button class="kpi-deep-dive" onclick="showDeepDiveModal('water-usage')">
                    Deep Dive <span class="material-icons">arrow_forward</span>
                </button>
            </div>
        </div>
        
        <!-- Renewable Energy KPI -->
        <div class="kpi-card">
            <div class="kpi-card-header">
                <h3 class="kpi-card-title">Renewable Energy</h3>
                <div class="kpi-card-icon">
                    <span class="material-icons">wb_sunny</span>
                </div>
            </div>
            <div class="kpi-card-value">35%</div>
            <div class="kpi-card-change positive">
                <span class="material-icons">trending_up</span>
                +7% from last quarter
            </div>
            <div class="kpi-card-description">Percentage of energy from renewable sources</div>
            <div class="kpi-actions">
                <button class="kpi-deep-dive" onclick="showDeepDiveModal('renewable-energy')">
                    Deep Dive <span class="material-icons">arrow_forward</span>
                </button>
            </div>
        </div>
        
        <!-- Waste Management KPI -->
        <div class="kpi-card">
            <div class="kpi-card-header">
                <h3 class="kpi-card-title">Waste Management</h3>
                <div class="kpi-card-icon">
                    <span class="material-icons">delete</span>
                </div>
            </div>
            <div class="kpi-card-value">82%</div>
            <div class="kpi-card-change positive">
                <span class="material-icons">trending_up</span>
                +4% from last quarter
            </div>
            <div class="kpi-card-description">Percentage of waste diverted from landfill</div>
            <div class="kpi-actions">
                <button class="kpi-deep-dive" onclick="showDeepDiveModal('waste-management')">
                    Deep Dive <span class="material-icons">arrow_forward</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Charts -->
    <div class="st-row">
        <div class="st-col-12">
            <div class="chart-card">
                <div class="chart-card-header">
                    <h3 class="chart-card-title">Carbon Emissions Trend</h3>
                    <div class="chart-card-controls">
                        <button class="toggle-view-btn">
                            <span class="material-icons">stacked_line_chart</span>
                            <span>Line</span>
                        </button>
                        <button class="toggle-view-btn">
                            <span class="material-icons">calendar_today</span>
                            <span>Quarterly</span>
                        </button>
                    </div>
                </div>
                <div class="chart-container" id="emissions-trend-chart"></div>
                
                <div class="insight-card">
                    <h4 class="insight-card-title">
                        <span class="material-icons">lightbulb</span>
                        AI Insight
                    </h4>
                    <div class="insight-card-content">
                        <p>Carbon emissions continue their downward trend, with a significant drop of 12% this quarter. 
                        This reduction is largely attributed to the recent energy efficiency initiatives and increased 
                        renewable energy usage in your manufacturing facilities.</p>
                        
                        <p>At this rate, you're on track to meet your annual reduction target of 20%, currently at 15% YTD.</p>
                        
                        <div class="metric-group">
                            <span class="metric-badge">Factory A: -18%</span>
                            <span class="metric-badge">Factory B: -8%</span>
                            <span class="metric-badge">Office HQ: -12%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="st-row">
        <div class="st-col-6">
            <div class="chart-card">
                <div class="chart-card-header">
                    <h3 class="chart-card-title">Energy Mix</h3>
                </div>
                <div class="chart-container" id="energy-mix-chart"></div>
            </div>
        </div>
        
        <div class="st-col-6">
            <div class="chart-card">
                <div class="chart-card-header">
                    <h3 class="chart-card-title">Water Usage by Facility</h3>
                </div>
                <div class="chart-container" id="water-usage-chart"></div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced AI-Generated Charts - Forecast and Sankey Diagram -->
    <h3 class="st-section-title">
        <span class="material-icons">auto_awesome</span>
        AI-Generated Advanced Visualizations
    </h3>
    
    <div class="st-row">
        <div class="st-col-6">
            <div class="chart-card">
                <div class="chart-card-header">
                    <h3 class="chart-card-title">
                        <span class="material-icons">timeline</span>
                        Carbon Emissions Forecast
                    </h3>
                    <div class="chart-card-controls">
                        <button class="toggle-view-btn active" data-chart="forecast" data-period="quarterly">
                            <span class="material-icons">calendar_today</span>
                            <span>Quarterly</span>
                        </button>
                        <button class="toggle-view-btn" data-chart="forecast" data-period="yearly">
                            <span class="material-icons">calendar_view_year</span>
                            <span>Yearly</span>
                        </button>
                    </div>
                </div>
                <div class="chart-container" id="emissions-forecast-chart"></div>
                <div class="insight-card">
                    <h4 class="insight-card-title">
                        <span class="material-icons">psychology</span>
                        AI Forecast Insight
                    </h4>
                    <div class="insight-card-content">
                        <p>Based on current reduction rates and planned initiatives, carbon emissions are projected to decrease by 18% year-over-year. This AI forecast indicates you'll reach your 2027 reduction target approximately 7 months ahead of schedule if current trends continue.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="st-col-6">
            <div class="chart-card">
                <div class="chart-card-header">
                    <h3 class="chart-card-title">
                        <span class="material-icons">account_tree</span>
                        Energy Flow Visualization
                    </h3>
                </div>
                <div class="chart-container" id="energy-sankey-chart"></div>
                <div class="insight-card">
                    <h4 class="insight-card-title">
                        <span class="material-icons">psychology</span>
                        Energy Flow Insight
                    </h4>
                    <div class="insight-card-content">
                        <p>Manufacturing consumes 65% of your total energy, with HVAC and lighting being the largest contributors. The AI model identified potential energy recapture opportunities in your manufacturing processes that could reduce consumption by up to 12%.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recommended Actions with Priority Tags -->
    <h3 class="st-section-title">
        <span class="material-icons">ballot</span>
        AI-Recommended Actions
    </h3>
    <div class="action-items">
        <div class="action-item">
            <div class="action-item-icon">
                <span class="material-icons">priority_high</span>
            </div>
            <div class="action-item-content">
                <h4 class="action-item-title">Optimize HVAC Systems in Factory B</h4>
                <p class="action-item-description">Factory B shows higher energy consumption for cooling compared to other facilities. 
                Consider optimizing HVAC systems to achieve potential 8-10% energy savings.</p>
                <div class="action-item-meta">
                    <span class="action-priority high">High Priority</span>
                    <span class="action-potential">Potential Savings: $45K/year</span>
                </div>
            </div>
        </div>
        
        <div class="action-item">
            <div class="action-item-icon">
                <span class="material-icons">lightbulb</span>
            </div>
            <div class="action-item-content">
                <h4 class="action-item-title">Expand Solar Panel Installation</h4>
                <p class="action-item-description">Based on current energy usage patterns and available roof space, 
                expanding solar panel installation at HQ would increase renewable energy share by approximately 5%.</p>
                <div class="action-item-meta">
                    <span class="action-priority medium">Medium Priority</span>
                    <span class="action-potential">Potential Savings: $28K/year</span>
                </div>
            </div>
        </div>
        
        <div class="action-item">
            <div class="action-item-icon">
                <span class="material-icons">water_drop</span>
            </div>
            <div class="action-item-content">
                <h4 class="action-item-title">Implement Water Recycling in Production</h4>
                <p class="action-item-description">Analysis shows potential for 20% reduction in water usage by implementing 
                closed-loop water recycling systems in production processes.</p>
                <div class="action-item-meta">
                    <span class="action-priority">Standard Priority</span>
                    <span class="action-potential">Potential Savings: $18K/year</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Deep Dive Modals -->
    <div id="deep-dive-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="deep-dive-title">KPI Deep Dive</h2>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <div id="deep-dive-chart" class="deep-dive-chart"></div>
                <div id="deep-dive-content" class="deep-dive-content">
                    <!-- Dynamic content loaded based on KPI -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block additional_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize standard charts
        initializeEmissionsTrendChart();
        initializeEnergyMixChart();
        initializeWaterUsageChart();
        
        // Initialize advanced charts
        initializeEmissionsForecastChart();
        initializeEnergySankeyChart();
        
        // Set up modal functionality
        setupModals();
        
        // Refresh button functionality
        document.getElementById('refresh-data-btn').addEventListener('click', function() {
            // Show loading spinner
            this.innerHTML = '<span class="material-icons spinning">refresh</span><span>Refreshing...</span>';
            this.disabled = true;
            
            // Simulate data refresh
            setTimeout(() => {
                // Reset button
                this.innerHTML = '<span class="material-icons">refresh</span><span>Refresh Data</span>';
                this.disabled = false;
                
                // Show toast notification
                showToast('Data refreshed successfully');
                
                // Re-render charts with new data
                initializeEmissionsTrendChart();
                initializeEnergyMixChart();
                initializeWaterUsageChart();
                initializeEmissionsForecastChart();
                initializeEnergySankeyChart();
            }, 1500);
        });
        
        // Toggle view buttons
        document.querySelectorAll('.toggle-view-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Get related buttons (for the same chart)
                const chartType = this.getAttribute('data-chart');
                const relatedButtons = document.querySelectorAll(`.toggle-view-btn[data-chart="${chartType}"]`);
                
                // Toggle active state for related buttons only
                relatedButtons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // Show toast notification
                showToast('View updated');
                
                // Additional logic could be added to update specific charts
                // based on the button's data attributes
            });
        });
    });
    
    // Set up modal functionality
    function setupModals() {
        const modal = document.getElementById('deep-dive-modal');
        const closeButton = document.querySelector('.close-modal');
        
        // Close modal when clicking the close button
        closeButton.addEventListener('click', () => {
            modal.classList.remove('visible');
            
            // Allow time for animation before hiding completely
            setTimeout(() => {
                if (!modal.classList.contains('visible')) {
                    modal.style.display = 'none';
                }
            }, 300);
        });
        
        // Close modal when clicking outside the content
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeButton.click();
            }
        });
        
        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modal.classList.contains('visible')) {
                closeButton.click();
            }
        });
    }
    
    // Show Deep Dive modal with content based on KPI type
    function showDeepDiveModal(kpiType) {
        const modal = document.getElementById('deep-dive-modal');
        const modalTitle = document.getElementById('deep-dive-title');
        const modalContent = document.getElementById('deep-dive-content');
        
        // Clear previous content
        modalContent.innerHTML = '';
        
        // Set title and content based on KPI type
        switch (kpiType) {
            case 'carbon-emissions':
                modalTitle.innerHTML = 'Carbon Emissions Deep Dive <span class="material-icons" style="color: var(--primary-color); margin-left: 8px;">co2</span>';
                renderCarbonEmissionsDeepDive();
                break;
                
            case 'energy-consumption':
                modalTitle.innerHTML = 'Energy Consumption Deep Dive <span class="material-icons" style="color: var(--primary-color); margin-left: 8px;">bolt</span>';
                renderEnergyConsumptionDeepDive();
                break;
                
            case 'water-usage':
                modalTitle.innerHTML = 'Water Usage Deep Dive <span class="material-icons" style="color: var(--primary-color); margin-left: 8px;">water_drop</span>';
                renderWaterUsageDeepDive();
                break;
                
            case 'renewable-energy':
                modalTitle.innerHTML = 'Renewable Energy Deep Dive <span class="material-icons" style="color: var(--primary-color); margin-left: 8px;">wb_sunny</span>';
                renderRenewableEnergyDeepDive();
                break;
                
            case 'waste-management':
                modalTitle.innerHTML = 'Waste Management Deep Dive <span class="material-icons" style="color: var(--primary-color); margin-left: 8px;">delete</span>';
                renderWasteManagementDeepDive();
                break;
                
            default:
                modalTitle.textContent = 'KPI Deep Dive';
                modalContent.innerHTML = '<p>No data available for this KPI.</p>';
        }
        
        // Show modal
        modal.style.display = 'flex';
        setTimeout(() => {
            modal.classList.add('visible');
        }, 10);
    }
    
    // Carbon Emissions Deep Dive
    function renderCarbonEmissionsDeepDive() {
        const chartDiv = document.getElementById('deep-dive-chart');
        const contentDiv = document.getElementById('deep-dive-content');
        
        // Add tabs
        contentDiv.innerHTML = `
            <div class="deep-dive-tabs">
                <div class="deep-dive-tab active" data-tab="overview">Overview</div>
                <div class="deep-dive-tab" data-tab="breakdown">Breakdown</div>
                <div class="deep-dive-tab" data-tab="benchmarks">Industry Benchmarks</div>
            </div>
            
            <div class="deep-dive-tab-content" id="tab-overview">
                <p>Carbon emissions have been consistently decreasing over the past 12 months, with a 12% reduction in the current quarter compared to the previous one. This exceeds the quarterly target of 8% and puts the organization on track to meet annual reduction goals.</p>
                
                <div class="deep-dive-detail-grid">
                    <div class="deep-dive-detail-card">
                        <div class="deep-dive-detail-title">Total Emissions (CO2e)</div>
                        <div class="deep-dive-detail-value">12,450 tonnes</div>
                    </div>
                    
                    <div class="deep-dive-detail-card">
                        <div class="deep-dive-detail-title">Scope 1 Emissions</div>
                        <div class="deep-dive-detail-value">4,890 tonnes</div>
                    </div>
                    
                    <div class="deep-dive-detail-card">
                        <div class="deep-dive-detail-title">Scope 2 Emissions</div>
                        <div class="deep-dive-detail-value">6,210 tonnes</div>
                    </div>
                    
                    <div class="deep-dive-detail-card">
                        <div class="deep-dive-detail-title">Scope 3 Emissions</div>
                        <div class="deep-dive-detail-value">1,350 tonnes</div>
                    </div>
                </div>
                
                <div class="deep-dive-recommendations">
                    <h4 class="deep-dive-recommendations-title">
                        <span class="material-icons">psychology</span>
                        AI Recommendations
                    </h4>
                    <ul>
                        <li>Optimize HVAC systems in Factory B to reduce energy consumption by approximately 8-10%.</li>
                        <li>Implement route optimization for your logistics fleet to reduce fuel consumption by an estimated 12%.</li>
                        <li>Expand renewable energy usage in Factory A, targeting a 15% increase in solar energy utilization.</li>
                    </ul>
                </div>
            </div>
            
            <div class="deep-dive-tab-content" id="tab-breakdown" style="display: none;">
                <p>The breakdown shows that manufacturing operations account for the largest share of carbon emissions (65%), followed by logistics (18%), and office operations (17%).</p>
                
                <div class="deep-dive-breakdown">
                    <h4 class="deep-dive-breakdown-title">Emissions by Facility</h4>
                    <div id="emissions-by-facility-chart" style="height: 300px;"></div>
                </div>
                
                <div class="deep-dive-breakdown">
                    <h4 class="deep-dive-breakdown-title">Emissions by Source</h4>
                    <div id="emissions-by-source-chart" style="height: 300px;"></div>
                </div>
            </div>
            
            <div class="deep-dive-tab-content" id="tab-benchmarks" style="display: none;">
                <p>Your organization is performing better than industry peers in terms of carbon emissions reduction. The average quarterly reduction in your industry is 5%, while your organization achieved 12%.</p>
                
                <div class="deep-dive-breakdown">
                    <h4 class="deep-dive-breakdown-title">Industry Comparison</h4>
                    <div id="emissions-benchmark-chart" style="height: 300px;"></div>
                </div>
                
                <div class="deep-dive-detail-grid">
                    <div class="deep-dive-detail-card">
                        <div class="deep-dive-detail-title">Industry Average</div>
                        <div class="deep-dive-detail-value">18,750 tonnes</div>
                    </div>
                    
                    <div class="deep-dive-detail-card">
                        <div class="deep-dive-detail-title">Your Performance</div>
                        <div class="deep-dive-detail-value">12,450 tonnes</div>
                    </div>
                    
                    <div class="deep-dive-detail-card">
                        <div class="deep-dive-detail-title">Top Performer</div>
                        <div class="deep-dive-detail-value">9,200 tonnes</div>
                    </div>
                    
                    <div class="deep-dive-detail-card">
                        <div class="deep-dive-detail-title">Your Percentile</div>
                        <div class="deep-dive-detail-value">85th</div>
                    </div>
                </div>
            </div>
        `;
        
        // Set up tab switching
        document.querySelectorAll('.deep-dive-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // Toggle active state
                document.querySelectorAll('.deep-dive-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Show content for selected tab
                const tabId = this.getAttribute('data-tab');
                document.querySelectorAll('.deep-dive-tab-content').forEach(content => {
                    content.style.display = 'none';
                });
                document.getElementById(`tab-${tabId}`).style.display = 'block';
                
                // Initialize/refresh charts if needed
                if (tabId === 'breakdown') {
                    setTimeout(() => {
                        renderEmissionsByFacilityChart();
                        renderEmissionsBySourceChart();
                    }, 50);
                } else if (tabId === 'benchmarks') {
                    setTimeout(() => {
                        renderEmissionsBenchmarkChart();
                    }, 50);
                }
            });
        });
        
        // Render main chart
        Plotly.newPlot(chartDiv, [
            {
                x: ['Apr 2024', 'May 2024', 'Jun 2024', 'Jul 2024', 'Aug 2024', 'Sep 2024', 'Oct 2024', 'Nov 2024', 'Dec 2024', 'Jan 2025', 'Feb 2025', 'Mar 2025'],
                y: [15900, 15700, 15400, 15200, 14800, 14500, 14100, 13900, 13500, 13100, 12800, 12450],
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Carbon Emissions (tonnes)',
                line: {
                    color: '#2e7d32',
                    width: 3
                },
                marker: {
                    size: 8
                }
            },
            {
                x: ['Apr 2024', 'May 2024', 'Jun 2024', 'Jul 2024', 'Aug 2024', 'Sep 2024', 'Oct 2024', 'Nov 2024', 'Dec 2024', 'Jan 2025', 'Feb 2025', 'Mar 2025'],
                y: [15900, 15700, 15600, 15400, 15300, 15100, 14900, 14800, 14600, 14400, 14200, 14000],
                type: 'scatter',
                mode: 'lines',
                name: 'Target',
                line: {
                    color: '#ff9800',
                    width: 2,
                    dash: 'dot'
                }
            }
        ], {
            autosize: true,
            margin: {
                l: 60,
                r: 40,
                b: 60,
                t: 30,
                pad: 4
            },
            hovermode: 'closest',
            xaxis: {
                title: 'Month'
            },
            yaxis: {
                title: 'Emissions (tonnes CO2e)'
            },
            legend: {
                orientation: 'h',
                yanchor: 'bottom',
                y: -0.2,
                xanchor: 'center',
                x: 0.5
            }
        }, {
            responsive: true
        });
    }
    
    // Chart for emissions by facility (for breakdown tab)
    function renderEmissionsByFacilityChart() {
        const ctx = document.getElementById('emissions-by-facility-chart');
        if (!ctx) return;
        
        Plotly.newPlot(ctx, [{
            x: ['Factory A', 'Factory B', 'Factory C', 'Office HQ', 'Warehouses', 'Distribution'],
            y: [4200, 3100, 2400, 980, 850, 920],
            type: 'bar',
            marker: {
                color: '#2e7d32'
            }
        }], {
            autosize: true,
            margin: {
                l: 60,
                r: 20,
                b: 60,
                t: 30,
                pad: 4
            },
            xaxis: {
                title: 'Facility'
            },
            yaxis: {
                title: 'Emissions (tonnes CO2e)'
            },
            showlegend: false
        }, {
            responsive: true
        });
    }
    
    // Chart for emissions by source (for breakdown tab)
    function renderEmissionsBySourceChart() {
        const ctx = document.getElementById('emissions-by-source-chart');
        if (!ctx) return;
        
        Plotly.newPlot(ctx, [{
            labels: ['Electricity', 'Heating', 'Transportation', 'Manufacturing Process', 'Other'],
            values: [3800, 2450, 2950, 2750, 500],
            type: 'pie',
            textinfo: 'label+percent',
            hole: 0.4,
            marker: {
                colors: ['#2196F3', '#FF5722', '#FFC107', '#673AB7', '#9E9E9E']
            }
        }], {
            autosize: true,
            margin: {
                l: 20,
                r: 20,
                b: 20,
                t: 30,
                pad: 4
            },
            showlegend: false,
            annotations: [{
                font: {
                    size: 16
                },
                showarrow: false,
                text: 'Emission<br>Sources',
                x: 0.5,
                y: 0.5
            }]
        }, {
            responsive: true
        });
    }
    
    // Chart for emissions benchmark (for benchmarks tab)
    function renderEmissionsBenchmarkChart() {
        const ctx = document.getElementById('emissions-benchmark-chart');
        if (!ctx) return;
        
        Plotly.newPlot(ctx, [{
            x: ['Bottom Quartile', 'Industry Median', 'Industry Average', 'Your Company', 'Top Quartile', 'Industry Leader'],
            y: [24500, 21000, 18750, 12450, 11000, 9200],
            type: 'bar',
            marker: {
                color: ['#ccc', '#ccc', '#ccc', '#4CAF50', '#ccc', '#ccc']
            }
        }], {
            autosize: true,
            margin: {
                l: 60,
                r: 20,
                b: 80,
                t: 30,
                pad: 4
            },
            xaxis: {
                title: '',
                tickangle: -45
            },
            yaxis: {
                title: 'Emissions (tonnes CO2e)'
            },
            showlegend: false
        }, {
            responsive: true
        });
    }
    
    // Similar functions for other KPI deep dives would be added here
    function renderEnergyConsumptionDeepDive() {
        const chartDiv = document.getElementById('deep-dive-chart');
        const contentDiv = document.getElementById('deep-dive-content');
        
        // Add overview content
        contentDiv.innerHTML = `
            <p>Energy consumption shows a 3% decrease quarter-over-quarter, with significant improvements in manufacturing facilities. The transition to energy-efficient equipment and installation of smart building controls contributed to these savings.</p>
            
            <div class="deep-dive-detail-grid">
                <div class="deep-dive-detail-card">
                    <div class="deep-dive-detail-title">Total Energy Consumption</div>
                    <div class="deep-dive-detail-value">8.2M kWh</div>
                </div>
                
                <div class="deep-dive-detail-card">
                    <div class="deep-dive-detail-title">Manufacturing</div>
                    <div class="deep-dive-detail-value">5.3M kWh</div>
                </div>
                
                <div class="deep-dive-detail-card">
                    <div class="deep-dive-detail-title">Offices</div>
                    <div class="deep-dive-detail-value">1.7M kWh</div>
                </div>
                
                <div class="deep-dive-detail-card">
                    <div class="deep-dive-detail-title">Other</div>
                    <div class="deep-dive-detail-value">1.2M kWh</div>
                </div>
            </div>
            
            <div class="deep-dive-recommendations">
                <h4 class="deep-dive-recommendations-title">
                    <span class="material-icons">psychology</span>
                    AI Recommendations
                </h4>
                <ul>
                    <li>Replace the remaining conventional lighting with LED alternatives in Factories B and C to reduce lighting-related energy consumption by up to 60%.</li>
                    <li>Implement predictive maintenance for manufacturing equipment to reduce energy waste from inefficient operation.</li>
                    <li>Schedule energy-intensive production processes during off-peak hours to benefit from lower electricity rates and grid optimization.</li>
                </ul>
            </div>
        `;
        
        // Render chart
        Plotly.newPlot(chartDiv, [
            {
                x: ['Apr 2024', 'May 2024', 'Jun 2024', 'Jul 2024', 'Aug 2024', 'Sep 2024', 'Oct 2024', 'Nov 2024', 'Dec 2024', 'Jan 2025', 'Feb 2025', 'Mar 2025'],
                y: [8.9, 8.8, 8.8, 8.7, 8.6, 8.5, 8.5, 8.4, 8.4, 8.3, 8.3, 8.2],
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Energy Consumption (M kWh)',
                line: {
                    color: '#FFC107',
                    width: 3
                },
                marker: {
                    size: 8
                }
            },
            {
                x: ['Apr 2024', 'May 2024', 'Jun 2024', 'Jul 2024', 'Aug 2024', 'Sep 2024', 'Oct 2024', 'Nov 2024', 'Dec 2024', 'Jan 2025', 'Feb 2025', 'Mar 2025'],
                y: [8.9, 8.8, 8.7, 8.6, 8.5, 8.4, 8.3, 8.2, 8.1, 8.0, 7.9, 7.8],
                type: 'scatter',
                mode: 'lines',
                name: 'Target',
                line: {
                    color: '#9E9E9E',
                    width: 2,
                    dash: 'dot'
                }
            }
        ], {
            autosize: true,
            margin: {
                l: 60,
                r: 40,
                b: 60,
                t: 30,
                pad: 4
            },
            hovermode: 'closest',
            xaxis: {
                title: 'Month'
            },
            yaxis: {
                title: 'Energy Consumption (M kWh)'
            },
            legend: {
                orientation: 'h',
                yanchor: 'bottom',
                y: -0.2,
                xanchor: 'center',
                x: 0.5
            }
        }, {
            responsive: true
        });
    }
    
    function renderWaterUsageDeepDive() {
        // Similar implementation to the carbon emissions and energy consumption deep dives
        const chartDiv = document.getElementById('deep-dive-chart');
        const contentDiv = document.getElementById('deep-dive-content');
        
        contentDiv.innerHTML = `
            <p>Water usage has decreased by 5% compared to the previous quarter, primarily due to water recycling initiatives and fixing leaks in the manufacturing water systems. Factory A leads in water conservation with a 7% reduction.</p>
            
            <div class="deep-dive-detail-grid">
                <div class="deep-dive-detail-card">
                    <div class="deep-dive-detail-title">Total Water Usage</div>
                    <div class="deep-dive-detail-value">356K m³</div>
                </div>
                
                <div class="deep-dive-detail-card">
                    <div class="deep-dive-detail-title">Recycled Water</div>
                    <div class="deep-dive-detail-value">42K m³</div>
                </div>
                
                <div class="deep-dive-detail-card">
                    <div class="deep-dive-detail-title">Water Intensity</div>
                    <div class="deep-dive-detail-value">2.4 m³/unit</div>
                </div>
                
                <div class="deep-dive-detail-card">
                    <div class="deep-dive-detail-title">Water Sources</div>
                    <div class="deep-dive-detail-value">3 locations</div>
                </div>
            </div>
            
            <div class="deep-dive-recommendations">
                <h4 class="deep-dive-recommendations-title">
                    <span class="material-icons">psychology</span>
                    AI Recommendations
                </h4>
                <ul>
                    <li>Implement closed-loop water recycling systems in production processes to reduce water consumption by up to the 20%.</li>
                    <li>Install water-efficient fixtures in all facilities to reduce non-industrial water usage.</li>
                    <li>Develop a water management plan that includes regular audits and leak detection to prevent wasted water.</li>
                </ul>
            </div>
        `;
        
        Plotly.newPlot(chartDiv, [
            {
                x: ['Factory A', 'Factory B', 'Factory C', 'Office HQ'],
                y: [180000, 120000, 45000, 11000],
                type: 'bar',
                name: 'Current Quarter',
                marker: {
                    color: '#2196F3'
                }
            },
            {
                x: ['Factory A', 'Factory B', 'Factory C', 'Office HQ'],
                y: [193500, 126000, 47250, 11550],
                type: 'bar',
                name: 'Previous Quarter',
                marker: {
                    color: '#90CAF9'
                }
            }
        ], {
            autosize: true,
            margin: {
                l: 60,
                r: 40,
                b: 60,
                t: 30,
                pad: 4
            },
            barmode: 'group',
            xaxis: {
                title: 'Facility'
            },
            yaxis: {
                title: 'Water Usage (m³)'
            },
            legend: {
                orientation: 'h',
                yanchor: 'bottom',
                y: -0.2,
                xanchor: 'center',
                x: 0.5
            }
        }, {
            responsive: true
        });
    }
    
    // Initialize carbon emissions trend chart
    function initializeEmissionsTrendChart() {
        const ctx = document.getElementById('emissions-trend-chart');
        
        const data = {
            x: ['Q1 2024', 'Q2 2024', 'Q3 2024', 'Q4 2024', 'Q1 2025'],
            y: [15200, 14800, 13900, 13100, 12450],
            type: 'scatter',
            mode: 'lines+markers',
            name: 'Carbon Emissions (tonnes)',
            line: {
                color: '#2e7d32',
                width: 3
            },
            marker: {
                size: 8
            }
        };
        
        const layout = {
            autosize: true,
            margin: {
                l: 50,
                r: 50,
                b: 50,
                t: 30,
                pad: 4
            },
            hovermode: 'closest',
            xaxis: {
                title: 'Quarter'
            },
            yaxis: {
                title: 'Emissions (tonnes CO2e)'
            },
            showlegend: false
        };
        
        const config = {
            responsive: true
        };
        
        Plotly.newPlot(ctx, [data], layout, config);
    }
    
    // Initialize energy mix chart
    function initializeEnergyMixChart() {
        const ctx = document.getElementById('energy-mix-chart');
        
        const data = [{
            values: [35, 30, 25, 10],
            labels: ['Renewable', 'Natural Gas', 'Grid Electricity', 'Other'],
            type: 'pie',
            marker: {
                colors: ['#4CAF50', '#FFC107', '#2196F3', '#9E9E9E']
            },
            hole: 0.4,
            textinfo: 'label+percent',
            insidetextorientation: 'radial'
        }];
        
        const layout = {
            autosize: true,
            margin: {
                l: 20,
                r: 20,
                b: 20,
                t: 30,
                pad: 4
            },
            showlegend: false,
            annotations: [{
                font: {
                    size: 16
                },
                showarrow: false,
                text: 'Energy<br>Sources',
                x: 0.5,
                y: 0.5
            }]
        };
        
        const config = {
            responsive: true
        };
        
        Plotly.newPlot(ctx, data, layout, config);
    }
    
    // Initialize water usage chart
    function initializeWaterUsageChart() {
        const ctx = document.getElementById('water-usage-chart');
        
        const data = [{
            x: ['Factory A', 'Factory B', 'Factory C', 'Office HQ'],
            y: [180000, 120000, 45000, 11000],
            type: 'bar',
            marker: {
                color: '#2196F3'
            }
        }];
        
        const layout = {
            autosize: true,
            margin: {
                l: 50,
                r: 20,
                b: 50,
                t: 30,
                pad: 4
            },
            xaxis: {
                title: 'Facility'
            },
            yaxis: {
                title: 'Water Usage (m³)'
            },
            showlegend: false
        };
        
        const config = {
            responsive: true
        };
        
        Plotly.newPlot(ctx, data, layout, config);
    }
    
    // Initialize carbon emissions forecast chart
    function initializeEmissionsForecastChart() {
        const ctx = document.getElementById('emissions-forecast-chart');
        
        Plotly.newPlot(ctx, [
            {
                x: ['Q1 2025', 'Q2 2025', 'Q3 2025', 'Q4 2025', 'Q1 2026', 'Q2 2026', 'Q3 2026', 'Q4 2026'],
                y: [12450, 11800, 11200, 10600, 10000, 9500, 9000, 8600],
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Projected Emissions',
                line: {
                    color: '#2e7d32',
                    width: 3
                },
                marker: {
                    size: 8
                }
            },
            {
                x: ['Q1 2025', 'Q2 2025', 'Q3 2025', 'Q4 2025', 'Q1 2026', 'Q2 2026', 'Q3 2026', 'Q4 2026'],
                y: [12450, 12000, 11550, 11100, 10650, 10200, 9750, 9300],
                type: 'scatter',
                mode: 'lines',
                name: 'Target Path',
                line: {
                    color: '#FF9800',
                    width: 2,
                    dash: 'dot'
                }
            },
            {
                x: ['Q1 2025', 'Q2 2025', 'Q3 2025', 'Q4 2025', 'Q1 2026', 'Q2 2026', 'Q3 2026', 'Q4 2026'],
                y: [12450, 11700, 10950, 10200, 9450, 8700, 8200, 7700],
                type: 'scatter',
                mode: 'lines',
                name: 'Optimistic Scenario',
                line: {
                    color: '#4CAF50',
                    width: 2,
                    dash: 'dash'
                }
            }
        ], {
            autosize: true,
            margin: {
                l: 50,
                r: 20,
                b: 60,
                t: 30,
                pad: 4
            },
            hovermode: 'closest',
            xaxis: {
                title: 'Quarter'
            },
            yaxis: {
                title: 'Emissions (tonnes CO2e)'
            },
            legend: {
                orientation: 'h',
                yanchor: 'bottom',
                y: -0.2,
                xanchor: 'center',
                x: 0.5
            }
        }, {
            responsive: true
        });
    }
    
    // Initialize energy sankey chart
    function initializeEnergySankeyChart() {
        const ctx = document.getElementById('energy-sankey-chart');
        
        const data = {
            type: "sankey",
            orientation: "h",
            node: {
                pad: 15,
                thickness: 20,
                line: {
                    color: "black",
                    width: 0.5
                },
                label: [
                    "Energy Input", "Renewable", "Grid Electricity", "Natural Gas", 
                    "Manufacturing", "Lighting", "HVAC", "Office Equipment", 
                    "Useful Energy", "Energy Loss"
                ],
                color: [
                    "#00796B", "#43A047", "#1976D2", "#FFA000",
                    "#5D4037", "#7B1FA2", "#0097A7", "#C2185B",
                    "#4CAF50", "#F44336"
                ]
            },
            link: {
                source: [
                    0, 0, 0, 
                    1, 1, 1,
                    2, 2, 2,
                    3, 3,
                    4, 5, 6, 7
                ],
                target: [
                    1, 2, 3, 
                    4, 6, 7,
                    4, 5, 6,
                    4, 6,
                    8, 8, 8, 8
                ],
                value: [
                    35, 40, 25,
                    25, 5, 5,
                    28, 7, 5,
                    22, 3,
                    45, 8, 10, 2
                ],
                color: [
                    "rgba(0, 121, 107, 0.4)", "rgba(0, 121, 107, 0.4)", "rgba(0, 121, 107, 0.4)",
                    "rgba(67, 160, 71, 0.4)", "rgba(67, 160, 71, 0.4)", "rgba(67, 160, 71, 0.4)",
                    "rgba(25, 118, 210, 0.4)", "rgba(25, 118, 210, 0.4)", "rgba(25, 118, 210, 0.4)",
                    "rgba(255, 160, 0, 0.4)", "rgba(255, 160, 0, 0.4)",
                    "rgba(93, 64, 55, 0.4)", "rgba(123, 31, 162, 0.4)", "rgba(0, 151, 167, 0.4)", "rgba(194, 24, 91, 0.4)"
                ]
            }
        };
        
        const layout = {
            title: {
                text: "",
                font: {
                    size: 16
                }
            },
            font: {
                size: 12
            },
            autosize: true,
            margin: {
                l: 5,
                r: 5,
                b: 5,
                t: 5,
                pad: 0
            }
        };
        
        const config = {
            responsive: true
        };
        
        Plotly.newPlot(ctx, [data], layout, config);
    }
    
    // Toast notification
    function showToast(message) {
        // Create toast element if it doesn't exist
        let toast = document.getElementById('toast-notification');
        if (!toast) {
            toast = document.createElement('div');
            toast.id = 'toast-notification';
            toast.style.position = 'fixed';
            toast.style.bottom = '20px';
            toast.style.right = '20px';
            toast.style.backgroundColor = 'var(--primary-color)';
            toast.style.color = 'white';
            toast.style.padding = '12px 20px';
            toast.style.borderRadius = '4px';
            toast.style.boxShadow = '0 2px 10px rgba(0, 0, 0, 0.2)';
            toast.style.zIndex = '9999';
            toast.style.transition = 'opacity 0.3s ease';
            toast.style.display = 'flex';
            toast.style.alignItems = 'center';
            toast.style.gap = '8px';
            document.body.appendChild(toast);
        }
        
        // Set message
        toast.innerHTML = `<span class="material-icons">check_circle</span> ${message}`;
        toast.style.opacity = '1';
        
        // Auto hide after 3 seconds
        setTimeout(() => {
            toast.style.opacity = '0';
        }, 3000);
    }
</script>
{% endblock %}