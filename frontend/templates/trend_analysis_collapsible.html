{% extends "layouts/collapsible_layout.html" %}

{% block title %}Sustainability Trend Analysis - SustainaTrendâ„¢{% endblock %}

{% block header_title %}Sustainability Trend Analysis{% endblock %}

{% block header_actions %}
    <div class="category-filter">
        <select id="category-filter" class="filter-select" onchange="filterTrendsByCategory(this.value)">
            <option value="all">All Categories</option>
            {% for category in categories %}
            <option value="{{ category }}">{{ category|title }}</option>
            {% endfor %}
        </select>
    </div>
    
    <button class="btn-primary" onclick="refreshTrendData()">
        <span class="material-icons">refresh</span>
        Refresh Data
    </button>
{% endblock %}

{% block content %}
<div class="trend-analysis-container">
    <!-- Top Trends Row -->
    <div class="dashboard-row">
        <div class="st-data-card">
            <div class="st-data-card-header">
                <h3 class="st-data-card-title">Top Sustainability Trends</h3>
                <button class="st-data-toggle">
                    <span class="material-icons">expand_more</span>
                </button>
            </div>
            <div class="st-data-content">
                <div class="top-trends-container" id="top-trends-container">
                    <div class="loading-indicator">Loading top trends...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Trend Analysis Dashboard Row -->
    <div class="dashboard-row">
        <div class="st-data-card">
            <div class="st-data-card-header">
                <h3 class="st-data-card-title">Trend Momentum</h3>
                <button class="st-data-toggle">
                    <span class="material-icons">expand_more</span>
                </button>
            </div>
            <div class="st-data-content">
                <div id="momentum-chart" class="trend-chart"></div>
            </div>
        </div>
        
        <div class="st-data-card">
            <div class="st-data-card-header">
                <h3 class="st-data-card-title">Category Distribution</h3>
                <button class="st-data-toggle">
                    <span class="material-icons">expand_more</span>
                </button>
            </div>
            <div class="st-data-content">
                <div id="category-distribution-chart" class="trend-chart"></div>
            </div>
        </div>
    </div>
    
    <!-- Trend Data Table Row -->
    <div class="st-data-card">
        <div class="st-data-card-header">
            <h3 class="st-data-card-title">Trend Data</h3>
            <button class="st-data-toggle">
                <span class="material-icons">expand_more</span>
            </button>
        </div>
        <div class="st-data-content">
            <div class="trends-table-container">
                <table class="trends-table" id="trends-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Virality</th>
                            <th>Momentum</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="trends-table-body">
                        <tr>
                            <td colspan="5" class="loading-text">Loading trend data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Collapsible Co-Pilot Specific to Trend Analysis -->
    <div class="trend-copilot-container" id="trend-copilot-container">
        <!-- Co-Pilot content will be loaded via JavaScript -->
    </div>
</div>
{% endblock %}

{% block additional_css %}
<style>
    .trend-analysis-container {
        padding: 20px;
    }
    
    .dashboard-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .category-filter {
        margin-right: 10px;
    }
    
    .filter-select {
        padding: 8px 12px;
        border-radius: 4px;
        border: 1px solid #e2e8f0;
        background-color: white;
        color: #1e293b;
        font-size: 0.9rem;
    }
    
    .top-trends-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 16px;
    }
    
    .trend-card {
        background-color: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 16px;
        display: flex;
        flex-direction: column;
    }
    
    .trend-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 10px;
    }
    
    .trend-name {
        font-weight: 600;
        color: #1e293b;
        margin: 0;
    }
    
    .trend-category {
        display: inline-block;
        font-size: 0.7rem;
        text-transform: uppercase;
        padding: 3px 8px;
        border-radius: 12px;
        font-weight: 500;
    }
    
    .trend-category.emissions {
        background-color: #dcfce7;
        color: #166534;
    }
    
    .trend-category.energy {
        background-color: #fef3c7;
        color: #92400e;
    }
    
    .trend-category.water {
        background-color: #dbeafe;
        color: #1e40af;
    }
    
    .trend-category.waste {
        background-color: #f3e8ff;
        color: #7e22ce;
    }
    
    .trend-category.social {
        background-color: #fce7f3;
        color: #be185d;
    }
    
    .trend-virality {
        margin-top: 10px;
        display: flex;
        align-items: center;
    }
    
    .virality-bar-container {
        flex: 1;
        height: 6px;
        background-color: #e2e8f0;
        border-radius: 3px;
        overflow: hidden;
        margin-right: 10px;
    }
    
    .virality-bar {
        height: 100%;
        background-color: #2c7744;
        border-radius: 3px;
    }
    
    .virality-score {
        font-size: 0.85rem;
        font-weight: 500;
        color: #1e293b;
    }
    
    .trend-momentum {
        display: flex;
        align-items: center;
        margin-top: 6px;
        font-size: 0.8rem;
    }
    
    .trend-momentum.rising {
        color: #16a34a;
    }
    
    .trend-momentum.steady {
        color: #ca8a04;
    }
    
    .trend-momentum.falling {
        color: #dc2626;
    }
    
    .trend-momentum .material-icons {
        font-size: 1rem;
        margin-right: 4px;
    }
    
    .trend-chart {
        height: 300px;
    }
    
    .trends-table-container {
        overflow-x: auto;
    }
    
    .trends-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .trends-table th,
    .trends-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .trends-table th {
        font-weight: 500;
        color: #64748b;
        background-color: #f8fafc;
    }
    
    .trends-table td {
        color: #1e293b;
    }
    
    .loading-text,
    .loading-indicator {
        text-align: center;
        color: #64748b;
        padding: 20px;
    }
    
    .trend-copilot-container {
        margin-top: 20px;
    }
</style>
{% endblock %}

{% block additional_js %}
<script>
    // Initialize the trend analysis page
    function initializeTrendAnalysis() {
        // Fetch trend data
        fetchTrendData();
        
        // Load trend-specific Co-Pilot content
        loadTrendCopilot();
    }
    
    // Fetch trend data from the API
    function fetchTrendData(category = 'all') {
        const url = `/api/trends?source=mock_service${category !== 'all' ? `&category=${category}` : ''}`;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update trend visualizations
                    updateTopTrends(data.trends);
                    updateTrendCharts(data.trends, data.chart_data, data.category_counts);
                    updateTrendTable(data.trends);
                } else {
                    console.error('Error fetching trend data:', data.error);
                    showErrorMessage('Failed to fetch trend data');
                }
            })
            .catch(error => {
                console.error('Error fetching trend data:', error);
                showErrorMessage('Failed to fetch trend data');
            });
    }
    
    // Update top trends section
    function updateTopTrends(trends) {
        const container = document.getElementById('top-trends-container');
        
        // Clear container
        container.innerHTML = '';
        
        // Display top trends (limit to 6)
        const topTrends = trends.slice(0, 6);
        
        if (topTrends.length === 0) {
            container.innerHTML = '<div class="loading-indicator">No trend data available</div>';
            return;
        }
        
        // Create trend cards
        topTrends.forEach(trend => {
            const momentumIcon = trend.momentum === 'rising' 
                ? 'trending_up' 
                : (trend.momentum === 'falling' ? 'trending_down' : 'trending_flat');
            
            const viralityPercentage = Math.round(trend.virality_score * 100);
            
            const card = document.createElement('div');
            card.className = 'trend-card';
            card.innerHTML = `
                <div class="trend-card-header">
                    <h4 class="trend-name">${trend.name}</h4>
                    <span class="trend-category ${trend.category}">${trend.category}</span>
                </div>
                <div class="trend-virality">
                    <div class="virality-bar-container">
                        <div class="virality-bar" style="width: ${viralityPercentage}%"></div>
                    </div>
                    <span class="virality-score">${viralityPercentage}%</span>
                </div>
                <div class="trend-momentum ${trend.momentum}">
                    <span class="material-icons">${momentumIcon}</span>
                    ${trend.momentum}
                </div>
            `;
            
            container.appendChild(card);
        });
    }
    
    // Update trend charts
    function updateTrendCharts(trends, chartData, categoryCounts) {
        // Momentum chart
        const momentumCounts = {
            rising: 0,
            steady: 0,
            falling: 0
        };
        
        trends.forEach(trend => {
            if (trend.momentum) {
                momentumCounts[trend.momentum]++;
            }
        });
        
        Plotly.newPlot('momentum-chart', [{
            x: Object.keys(momentumCounts).map(k => k.charAt(0).toUpperCase() + k.slice(1)),
            y: Object.values(momentumCounts),
            type: 'bar',
            marker: {
                color: ['#16a34a', '#ca8a04', '#dc2626']
            }
        }], {
            margin: { t: 20, r: 20, l: 50, b: 80 },
            yaxis: { title: 'Number of Trends' }
        }, { responsive: true });
        
        // Category distribution chart
        const categories = Object.keys(categoryCounts);
        const counts = Object.values(categoryCounts);
        
        const colors = {
            emissions: '#16a34a',
            energy: '#ca8a04',
            water: '#0ea5e9',
            waste: '#7e22ce',
            social: '#be185d'
        };
        
        const pieColors = categories.map(cat => colors[cat] || '#64748b');
        
        Plotly.newPlot('category-distribution-chart', [{
            labels: categories.map(c => c.charAt(0).toUpperCase() + c.slice(1)),
            values: counts,
            type: 'pie',
            marker: {
                colors: pieColors
            }
        }], {
            margin: { t: 20, r: 20, l: 20, b: 20 }
        }, { responsive: true });
    }
    
    // Update trends table
    function updateTrendTable(trends) {
        const tableBody = document.getElementById('trends-table-body');
        
        // Clear table
        tableBody.innerHTML = '';
        
        if (trends.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = '<td colspan="5" class="loading-text">No trend data available</td>';
            tableBody.appendChild(row);
            return;
        }
        
        // Add trends to table
        trends.forEach(trend => {
            const row = document.createElement('tr');
            
            // Format timestamp
            let formattedDate = 'N/A';
            if (trend.timestamp) {
                const timestamp = new Date(trend.timestamp);
                formattedDate = timestamp.toLocaleDateString();
            }
            
            // Format virality score
            const viralityPercentage = Math.round(trend.virality_score * 100);
            
            // Momentum icon
            const momentumIcon = trend.momentum === 'rising' 
                ? '<span class="material-icons" style="color: #16a34a;">trending_up</span>' 
                : (trend.momentum === 'falling' 
                    ? '<span class="material-icons" style="color: #dc2626;">trending_down</span>' 
                    : '<span class="material-icons" style="color: #ca8a04;">trending_flat</span>');
            
            row.innerHTML = `
                <td>${trend.name}</td>
                <td><span class="trend-category ${trend.category}">${trend.category}</span></td>
                <td>${viralityPercentage}%</td>
                <td>${momentumIcon} ${trend.momentum}</td>
                <td>${formattedDate}</td>
            `;
            
            tableBody.appendChild(row);
        });
    }
    
    // Filter trends by category
    function filterTrendsByCategory(category) {
        fetchTrendData(category);
    }
    
    // Load trend-specific Co-Pilot content
    function loadTrendCopilot() {
        const container = document.getElementById('trend-copilot-container');
        
        // Check if Co-Pilot script is loaded
        if (typeof initializeCopilot === 'function') {
            // Initialize Co-Pilot with trend analysis context
            initializeCopilot({
                context: 'trend-analysis',
                container: container,
                customPrompts: [
                    'Explain the latest sustainability trends',
                    'How can I leverage the rising trends?',
                    'Which industries are affected by these trends?',
                    'Compare water and emissions trends'
                ]
            });
        } else {
            // Load fallback content
            container.innerHTML = `
                <div class="st-data-card">
                    <div class="st-data-card-header">
                        <h3 class="st-data-card-title">Trend Insights</h3>
                        <button class="st-data-toggle">
                            <span class="material-icons">expand_more</span>
                        </button>
                    </div>
                    <div class="st-data-content">
                        <p>The SustainaTrendâ„¢ platform has identified several key sustainability trends:</p>
                        <ul>
                            <li>Carbon capture technologies are gaining momentum across industries</li>
                            <li>Water footprint optimization is becoming a priority due to increasing scarcity</li>
                            <li>Circular supply chains are being implemented by leading organizations</li>
                            <li>Biodiversity impact assessment is emerging as a critical ESG metric</li>
                        </ul>
                        <p>These trends reflect a growing emphasis on measurable sustainability outcomes and innovative solutions to environmental challenges.</p>
                    </div>
                </div>
            `;
        }
    }
    
    // Refresh trend data
    function refreshTrendData() {
        const categoryFilter = document.getElementById('category-filter');
        const selectedCategory = categoryFilter.value;
        
        fetchTrendData(selectedCategory);
    }
    
    // Show error message
    function showErrorMessage(message) {
        const container = document.getElementById('top-trends-container');
        container.innerHTML = `<div class="error-message">${message}</div>`;
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        initializeTrendAnalysis();
    });
</script>
{% endblock %}