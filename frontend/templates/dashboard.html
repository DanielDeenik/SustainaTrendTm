{% extends "base_new.html" %}

{% block title %}Dashboard | SustainaTrend™{% endblock %}

{% block styles %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
    .metric-card {
        background-color: var(--card-bg);
        border-radius: 0.5rem;
        padding: 1.25rem;
        text-align: center;
        box-shadow: var(--shadow-sm);
        transition: all 0.3s ease;
    }
    
    .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow);
    }
    
    .metric-value {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        color: var(--primary-color);
    }
    
    .metric-label {
        font-size: 0.9rem;
        color: var(--text-muted);
        margin-bottom: 0.5rem;
    }
    
    .metric-change {
        display: inline-block;
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
        border-radius: 1rem;
    }
    
    .positive {
        background-color: rgba(var(--bs-success-rgb), 0.1);
        color: var(--success-color);
    }
    
    .negative {
        background-color: rgba(var(--bs-danger-rgb), 0.1);
        color: var(--danger-color);
    }
    
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .chart-container {
        background-color: var(--card-bg);
        border-radius: 0.5rem;
        box-shadow: var(--shadow-sm);
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }
    
    .chart-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
        color: var(--text-color);
    }
    
    .chart-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    /* Update cards to better support dark mode */
    .card {
        background-color: var(--card-bg);
        border-color: var(--border-color);
    }
    
    .card-header {
        background-color: rgba(var(--bs-primary-rgb), 0.1);
        color: var(--text-color);
        border-color: var(--border-color);
    }
</style>
{% endblock %}

{% block content %}
    <div class="container py-4">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/dashboard">Dashboard & Monetization</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/search">AI Search</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/trend-analysis">Trend Analysis</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/sustainability">Sustainability</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Test Routes
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="/test-route">Test API Route</a></li>
                            <li><a class="dropdown-item" href="/monetization-simple">Simple Monetization</a></li>
                            <li><a class="dropdown-item" href="/monetization?format=text">Debug Monetization</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/debug">Debug Info</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid p-4">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center my-4">SustainaTrend™ Intelligence Dashboard</h1>
                <p class="text-center mb-5">Real-time insights powered by advanced AI analytics with integrated monetization framework</p>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12 col-md-3">
                <div class="card">
                    <div class="card-header">Filter Metrics</div>
                    <div class="card-body">
                        <p>Select Category:</p>
                        <select id="category-filter" class="form-select">
                            <option value="all">All Categories</option>
                            <option value="emissions">Emissions</option>
                            <option value="energy">Energy</option>
                            <option value="water">Water</option>
                            <option value="waste">Waste</option>
                            <option value="social">Social & Governance</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="col-12 col-md-9">
                <div class="card">
                    <div class="card-header">Sustainability Metrics Over Time</div>
                    <div class="card-body">
                        <div id="metrics-time-series" style="height: 400px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12 col-md-4">
                <div class="card">
                    <div class="card-header">Carbon Emissions</div>
                    <div class="card-body">
                        <h3 id="emissions-value" class="text-center">-</h3>
                        <p class="text-center text-muted">tons CO2e</p>
                        <p id="emissions-trend" class="text-center">-</p>
                    </div>
                </div>
            </div>

            <div class="col-12 col-md-4">
                <div class="card">
                    <div class="card-header">Water Usage</div>
                    <div class="card-body">
                        <h3 id="water-value" class="text-center">-</h3>
                        <p class="text-center text-muted">kiloliters</p>
                        <p id="water-trend" class="text-center">-</p>
                    </div>
                </div>
            </div>

            <div class="col-12 col-md-4">
                <div class="card">
                    <div class="card-header">Waste Recycled</div>
                    <div class="card-body">
                        <h3 id="waste-value" class="text-center">-</h3>
                        <p class="text-center text-muted">percent</p>
                        <p id="waste-trend" class="text-center">-</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">AI-Powered Sustainability Insights</div>
                    <div class="card-body">
                        <p>Based on the current trends, your organization is showing positive progress in reducing its environmental footprint.</p>
                        <p>Key insights:</p>
                        <ul>
                            <li>Carbon emissions have reduced by 33% over the past 6 months</li>
                            <li>Water consumption is down 14%, ahead of industry average</li>
                            <li>Waste recycling has improved to 82%, exceeding target goals</li>
                            <li>Energy efficiency measures have reduced consumption by 16%</li>
                        </ul>
                        <p>Recommended actions:</p>
                        <ul>
                            <li>Continue investment in renewable energy sources</li>
                            <li>Implement additional water conservation measures</li>
                            <li>Expand your circular economy initiatives for further waste reduction</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Monetization Framework Section -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h3 class="mb-0">Monetization Framework</h3>
                    </div>
                    <div class="card-body">
                        <h4 class="mb-3">Revenue Channels for SustainaTrend™ 2.0</h4>
                        
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="card h-100 shadow-sm">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0">1. Data-as-a-Service</h5>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Revenue Model:</strong> Subscription-based access to sustainability metrics and insights</p>
                                        <p><strong>Target Customers:</strong> Corporations, ESG consultants, investment firms</p>
                                        <p><strong>Implementation:</strong> Tiered subscription plans with varying access levels and data granularity</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-4">
                                <div class="card h-100 shadow-sm">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0">2. AI-Powered Analytics</h5>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Revenue Model:</strong> Premium analysis of sustainability trends with predictive capabilities</p>
                                        <p><strong>Target Customers:</strong> Strategy executives, sustainability officers</p>
                                        <p><strong>Implementation:</strong> Advanced AI models for trend prediction and strategic recommendations</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-4">
                                <div class="card h-100 shadow-sm">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0">3. Consulting Services</h5>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Revenue Model:</strong> High-touch consulting leveraging platform insights</p>
                                        <p><strong>Target Customers:</strong> Large enterprises, government agencies</p>
                                        <p><strong>Implementation:</strong> Expert-guided sustainability transformation programs</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-4">
                                <div class="card h-100 shadow-sm">
                                    <div class="card-header bg-light">
                                        <h5 class="mb-0">4. API Integration</h5>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Revenue Model:</strong> Developer access to sustainability data via API</p>
                                        <p><strong>Target Customers:</strong> Software developers, SaaS providers</p>
                                        <p><strong>Implementation:</strong> RESTful API with usage-based pricing</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <h4 class="mb-3">Monetization Strategy Summary</h4>
                            <p>Our multi-layered approach combines both data services and human expertise to create multiple revenue streams while maximizing customer value. The AI-powered platform serves as both a stand-alone product and a foundation for premium services.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
    <!-- Visualization utilities with trendViz namespace -->
    <script src="{{ url_for('static', filename='js/visualization-utils.js') }}"></script>
    
    <script>
        // Parse metrics data from Flask
        const metricsData = {{ metrics|tojson }};

        // Process metrics for visualization using trendViz color scheme
        const processMetricsData = (metrics) => {
            const data = [];
            const categories = {};
            const categoryColors = trendViz.categoryColors;

            // Group metrics by name for time series chart
            metrics.forEach(metric => {
                if (!categories[metric.name]) {
                    categories[metric.name] = {
                        x: [],
                        y: [],
                        name: metric.name,
                        type: 'scatter',
                        mode: 'lines+markers',
                        line: {
                            color: categoryColors[metric.category] || categoryColors.emissions
                        }
                    };
                }

                categories[metric.name].x.push(metric.timestamp);
                categories[metric.name].y.push(metric.value);
            });

            // Convert to array for Plotly
            for (const name in categories) {
                data.push(categories[name]);
            }

            return data;
        };

        // Filter metrics by category
        const filterMetricsByCategory = (metrics, category) => {
            if (category === 'all') {
                return metrics;
            }
            return metrics.filter(metric => metric.category === category);
        };

        // Initial plot using trendViz styling
        const plotMetrics = (metrics) => {
            const data = processMetricsData(metrics);
            const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark';

            trendViz.createLineChart('metrics-time-series', data, {
                title: 'Sustainability Metrics Over Time',
                xAxisTitle: 'Date',
                yAxisTitle: 'Value',
                showLegend: true,
                legendPosition: 'top-right',
                gridLines: true
            });
        };

        // Update metric cards
        const updateMetricCards = (metrics) => {
            // Find the latest metrics by name
            const latestMetrics = {};
            const previousMetrics = {};

            // Group metrics by name and find the latest two for each
            metrics.forEach(metric => {
                if (!latestMetrics[metric.name] || new Date(metric.timestamp) > new Date(latestMetrics[metric.name].timestamp)) {
                    previousMetrics[metric.name] = latestMetrics[metric.name];
                    latestMetrics[metric.name] = metric;
                } else if (!previousMetrics[metric.name] || new Date(metric.timestamp) > new Date(previousMetrics[metric.name].timestamp)) {
                    previousMetrics[metric.name] = metric;
                }
            });

            // Update Carbon Emissions card
            if (latestMetrics['Carbon Emissions']) {
                const emissionsValue = latestMetrics['Carbon Emissions'].value;
                const previousValue = previousMetrics['Carbon Emissions'] ? previousMetrics['Carbon Emissions'].value : emissionsValue;
                const percentChange = ((emissionsValue - previousValue) / previousValue) * 100;

                document.getElementById('emissions-value').textContent = emissionsValue.toFixed(1);
                document.getElementById('emissions-trend').textContent = `${Math.abs(percentChange).toFixed(1)}% ${percentChange > 0 ? 'increase' : 'decrease'} from previous period`;
                document.getElementById('emissions-trend').className = percentChange > 0 ? 'text-center text-danger' : 'text-center text-success';
            }

            // Update Water Usage card
            if (latestMetrics['Water Usage']) {
                const waterValue = latestMetrics['Water Usage'].value;
                const previousValue = previousMetrics['Water Usage'] ? previousMetrics['Water Usage'].value : waterValue;
                const percentChange = ((waterValue - previousValue) / previousValue) * 100;

                document.getElementById('water-value').textContent = waterValue.toFixed(1);
                document.getElementById('water-trend').textContent = `${Math.abs(percentChange).toFixed(1)}% ${percentChange > 0 ? 'increase' : 'decrease'} from previous period`;
                document.getElementById('water-trend').className = percentChange > 0 ? 'text-center text-danger' : 'text-center text-success';
            }

            // Update Waste Recycled card
            if (latestMetrics['Waste Recycled']) {
                const wasteValue = latestMetrics['Waste Recycled'].value;
                const previousValue = previousMetrics['Waste Recycled'] ? previousMetrics['Waste Recycled'].value : wasteValue;
                const percentChange = ((wasteValue - previousValue) / previousValue) * 100;

                document.getElementById('waste-value').textContent = wasteValue.toFixed(1) + '%';
                document.getElementById('waste-trend').textContent = `${Math.abs(percentChange).toFixed(1)}% ${percentChange > 0 ? 'increase' : 'decrease'} from previous period`;
                document.getElementById('waste-trend').className = percentChange > 0 ? 'text-center text-success' : 'text-center text-danger';
            }
        };

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Plot initial metrics
            plotMetrics(metricsData);

            // Update metric cards
            updateMetricCards(metricsData);

            // Add event listener for category filter
            document.getElementById('category-filter').addEventListener('change', function() {
                const category = this.value;
                const filteredMetrics = filterMetricsByCategory(metricsData, category);
                plotMetrics(filteredMetrics);
            });
        });
    </script>
{% endblock %}