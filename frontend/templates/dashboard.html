<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sustainability Intelligence Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/">Sustainability Intelligence Platform</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/dashboard">Dashboard</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid p-4">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center my-4">Sustainability Intelligence Dashboard</h1>
                <p class="text-center mb-5">Real-time insights powered by advanced AI analytics</p>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12 col-md-3">
                <div class="card">
                    <div class="card-header">Filter Metrics</div>
                    <div class="card-body">
                        <p>Select Category:</p>
                        <select id="category-filter" class="form-select">
                            <option value="all">All Categories</option>
                            <option value="emissions">Emissions</option>
                            <option value="energy">Energy</option>
                            <option value="water">Water</option>
                            <option value="waste">Waste</option>
                            <option value="social">Social & Governance</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="col-12 col-md-9">
                <div class="card">
                    <div class="card-header">Sustainability Metrics Over Time</div>
                    <div class="card-body">
                        <div id="metrics-time-series" style="height: 400px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12 col-md-4">
                <div class="card">
                    <div class="card-header">Carbon Emissions</div>
                    <div class="card-body">
                        <h3 id="emissions-value" class="text-center">-</h3>
                        <p class="text-center text-muted">tons CO2e</p>
                        <p id="emissions-trend" class="text-center">-</p>
                    </div>
                </div>
            </div>

            <div class="col-12 col-md-4">
                <div class="card">
                    <div class="card-header">Water Usage</div>
                    <div class="card-body">
                        <h3 id="water-value" class="text-center">-</h3>
                        <p class="text-center text-muted">kiloliters</p>
                        <p id="water-trend" class="text-center">-</p>
                    </div>
                </div>
            </div>

            <div class="col-12 col-md-4">
                <div class="card">
                    <div class="card-header">Waste Recycled</div>
                    <div class="card-body">
                        <h3 id="waste-value" class="text-center">-</h3>
                        <p class="text-center text-muted">percent</p>
                        <p id="waste-trend" class="text-center">-</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">AI-Powered Sustainability Insights</div>
                    <div class="card-body">
                        <p>Based on the current trends, your organization is showing positive progress in reducing its environmental footprint.</p>
                        <p>Key insights:</p>
                        <ul>
                            <li>Carbon emissions have reduced by 33% over the past 6 months</li>
                            <li>Water consumption is down 14%, ahead of industry average</li>
                            <li>Waste recycling has improved to 82%, exceeding target goals</li>
                            <li>Energy efficiency measures have reduced consumption by 16%</li>
                        </ul>
                        <p>Recommended actions:</p>
                        <ul>
                            <li>Continue investment in renewable energy sources</li>
                            <li>Implement additional water conservation measures</li>
                            <li>Expand your circular economy initiatives for further waste reduction</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer py-4">
        <div class="container text-center">
            <p>&copy; 2025 Sustainability Intelligence Platform. All rights reserved.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Parse metrics data from Flask
        const metricsData = {{ metrics|tojson }};
        
        // Process metrics for visualization
        const processMetricsData = (metrics) => {
            const data = [];
            const categories = {};
            
            // Group metrics by name for time series chart
            metrics.forEach(metric => {
                if (!categories[metric.name]) {
                    categories[metric.name] = {
                        x: [],
                        y: [],
                        name: metric.name,
                        type: 'scatter',
                        mode: 'lines+markers'
                    };
                }
                
                categories[metric.name].x.push(metric.timestamp);
                categories[metric.name].y.push(metric.value);
            });
            
            // Convert to array for Plotly
            for (const name in categories) {
                data.push(categories[name]);
            }
            
            return data;
        };
        
        // Filter metrics by category
        const filterMetricsByCategory = (metrics, category) => {
            if (category === 'all') {
                return metrics;
            }
            return metrics.filter(metric => metric.category === category);
        };
        
        // Initial plot
        const plotMetrics = (metrics) => {
            const data = processMetricsData(metrics);
            
            const layout = {
                title: 'Sustainability Metrics Over Time',
                xaxis: {
                    title: 'Date'
                },
                yaxis: {
                    title: 'Value'
                },
                margin: {
                    l: 40,
                    r: 40,
                    t: 40,
                    b: 40
                },
                legend: {
                    orientation: 'h',
                    y: 1.1
                }
            };
            
            Plotly.newPlot('metrics-time-series', data, layout);
        };
        
        // Update metric cards
        const updateMetricCards = (metrics) => {
            // Find the latest metrics by name
            const latestMetrics = {};
            const previousMetrics = {};
            
            // Group metrics by name and find the latest two for each
            metrics.forEach(metric => {
                if (!latestMetrics[metric.name] || new Date(metric.timestamp) > new Date(latestMetrics[metric.name].timestamp)) {
                    previousMetrics[metric.name] = latestMetrics[metric.name];
                    latestMetrics[metric.name] = metric;
                } else if (!previousMetrics[metric.name] || new Date(metric.timestamp) > new Date(previousMetrics[metric.name].timestamp)) {
                    previousMetrics[metric.name] = metric;
                }
            });
            
            // Update Carbon Emissions card
            if (latestMetrics['Carbon Emissions']) {
                const emissionsValue = latestMetrics['Carbon Emissions'].value;
                const previousValue = previousMetrics['Carbon Emissions'] ? previousMetrics['Carbon Emissions'].value : emissionsValue;
                const percentChange = ((emissionsValue - previousValue) / previousValue) * 100;
                
                document.getElementById('emissions-value').textContent = emissionsValue.toFixed(1);
                document.getElementById('emissions-trend').textContent = `${Math.abs(percentChange).toFixed(1)}% ${percentChange > 0 ? 'increase' : 'decrease'} from previous period`;
                document.getElementById('emissions-trend').className = percentChange > 0 ? 'text-center text-danger' : 'text-center text-success';
            }
            
            // Update Water Usage card
            if (latestMetrics['Water Usage']) {
                const waterValue = latestMetrics['Water Usage'].value;
                const previousValue = previousMetrics['Water Usage'] ? previousMetrics['Water Usage'].value : waterValue;
                const percentChange = ((waterValue - previousValue) / previousValue) * 100;
                
                document.getElementById('water-value').textContent = waterValue.toFixed(1);
                document.getElementById('water-trend').textContent = `${Math.abs(percentChange).toFixed(1)}% ${percentChange > 0 ? 'increase' : 'decrease'} from previous period`;
                document.getElementById('water-trend').className = percentChange > 0 ? 'text-center text-danger' : 'text-center text-success';
            }
            
            // Update Waste Recycled card
            if (latestMetrics['Waste Recycled']) {
                const wasteValue = latestMetrics['Waste Recycled'].value;
                const previousValue = previousMetrics['Waste Recycled'] ? previousMetrics['Waste Recycled'].value : wasteValue;
                const percentChange = ((wasteValue - previousValue) / previousValue) * 100;
                
                document.getElementById('waste-value').textContent = wasteValue.toFixed(1) + '%';
                document.getElementById('waste-trend').textContent = `${Math.abs(percentChange).toFixed(1)}% ${percentChange > 0 ? 'increase' : 'decrease'} from previous period`;
                document.getElementById('waste-trend').className = percentChange > 0 ? 'text-center text-success' : 'text-center text-danger';
            }
        };
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Plot initial metrics
            plotMetrics(metricsData);
            
            // Update metric cards
            updateMetricCards(metricsData);
            
            // Add event listener for category filter
            document.getElementById('category-filter').addEventListener('change', function() {
                const category = this.value;
                const filteredMetrics = filterMetricsByCategory(metricsData, category);
                plotMetrics(filteredMetrics);
            });
        });
    </script>
</body>
</html>
