{% extends "layouts/finchat_dark_layout.html" %}

{% block title %}VC-Lens™ - SustainaTrend™ Intelligence Platform{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-5">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-1">VC-Lens™</h1>
            <p class="text-muted">AI-powered investor insights and sustainability analysis</p>
        </div>
        <div>
            <a href="/vc-insights/startup-assessment" class="btn btn-primary me-2">
                <i class="fas fa-clipboard-check me-2"></i>Startup Assessment
            </a>
            <a href="/vc-insights/upload-thesis" class="btn btn-outline-primary">
                <i class="fas fa-upload me-2"></i>Upload Thesis
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row g-4">
        <!-- Left Column: Quick Tools -->
        <div class="col-md-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-transparent">
                    <h5 class="card-title mb-0">VC Sustainability Tools</h5>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        <a href="/vc-insights/startup-assessment" class="list-group-item list-group-item-action d-flex align-items-center">
                            <span class="icon-circle bg-primary text-white me-3">
                                <i class="fas fa-chart-pie"></i>
                            </span>
                            <div>
                                <h6 class="mb-1">Startup Sustainability Assessment</h6>
                                <p class="small text-muted mb-0">Evaluate CSRD readiness and impact metrics</p>
                            </div>
                        </a>
                        <a href="/vc-insights/upload-thesis" class="list-group-item list-group-item-action d-flex align-items-center">
                            <span class="icon-circle bg-primary text-white me-3">
                                <i class="fas fa-file-alt"></i>
                            </span>
                            <div>
                                <h6 class="mb-1">Fund Thesis Mapping</h6>
                                <p class="small text-muted mb-0">Map investment criteria to sustainability frameworks</p>
                            </div>
                        </a>
                        <a href="#portfolio-fit-modal" data-bs-toggle="modal" class="list-group-item list-group-item-action d-flex align-items-center">
                            <span class="icon-circle bg-primary text-white me-3">
                                <i class="fas fa-puzzle-piece"></i>
                            </span>
                            <div>
                                <h6 class="mb-1">Portfolio Fit Analysis</h6>
                                <p class="small text-muted mb-0">Assess company alignment with fund strategy</p>
                            </div>
                        </a>
                        <a href="#regulatory-modal" data-bs-toggle="modal" class="list-group-item list-group-item-action d-flex align-items-center">
                            <span class="icon-circle bg-primary text-white me-3">
                                <i class="fas fa-balance-scale"></i>
                            </span>
                            <div>
                                <h6 class="mb-1">Regulatory Alignment Check</h6>
                                <p class="small text-muted mb-0">SFDR, CSRD, and EU Taxonomy assessment</p>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Sustainability Trends -->
        <div class="col-md-8">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">ESG & Impact Portfolio Trends</h5>
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-secondary active">Monthly</button>
                        <button type="button" class="btn btn-outline-secondary">Quarterly</button>
                        <button type="button" class="btn btn-outline-secondary">Annual</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <!-- Trending Categories -->
                        <div class="col-md-6">
                            <h6 class="text-muted small text-uppercase mb-3">Top ESG Categories</h6>
                            <div class="d-flex flex-column gap-3">
                                {% if trending_categories %}
                                    {% for category in trending_categories[:4] %}
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <span class="badge rounded-pill bg-primary-light text-primary">{{ category.growth|round|int }}%</span>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h6 class="mb-0">{{ category.name }}</h6>
                                            <div class="progress mt-1" style="height: 6px;">
                                                <div class="progress-bar" role="progressbar" style="width: {{ category.score }}%;" 
                                                    aria-valuenow="{{ category.score }}" aria-valuemin="0" aria-valuemax="100"></div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <!-- Default trend categories when data is not available -->
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <span class="badge rounded-pill bg-primary-light text-primary">32%</span>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h6 class="mb-0">Climate Tech</h6>
                                            <div class="progress mt-1" style="height: 6px;">
                                                <div class="progress-bar" role="progressbar" style="width: 85%;" 
                                                    aria-valuenow="85" aria-valuemin="0" aria-valuemax="100"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <span class="badge rounded-pill bg-primary-light text-primary">28%</span>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h6 class="mb-0">Circular Economy</h6>
                                            <div class="progress mt-1" style="height: 6px;">
                                                <div class="progress-bar" role="progressbar" style="width: 76%;" 
                                                    aria-valuenow="76" aria-valuemin="0" aria-valuemax="100"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <span class="badge rounded-pill bg-primary-light text-primary">24%</span>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h6 class="mb-0">Carbon Management</h6>
                                            <div class="progress mt-1" style="height: 6px;">
                                                <div class="progress-bar" role="progressbar" style="width: 68%;" 
                                                    aria-valuenow="68" aria-valuemin="0" aria-valuemax="100"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <span class="badge rounded-pill bg-primary-light text-primary">19%</span>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h6 class="mb-0">Sustainable Supply Chain</h6>
                                            <div class="progress mt-1" style="height: 6px;">
                                                <div class="progress-bar" role="progressbar" style="width: 62%;" 
                                                    aria-valuenow="62" aria-valuemin="0" aria-valuemax="100"></div>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Recent Stories -->
                        <div class="col-md-6">
                            <h6 class="text-muted small text-uppercase mb-3">Recent Impact Stories</h6>
                            <div class="d-flex flex-column gap-3">
                                {% if recent_stories %}
                                    {% for story in recent_stories %}
                                    <div class="card bg-light border-0">
                                        <div class="card-body p-3">
                                            <h6 class="card-title">{{ story.title }}</h6>
                                            <p class="card-text small">{{ story.summary|truncate(70) }}</p>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="badge bg-secondary">{{ story.category }}</span>
                                                <small class="text-muted">{{ story.created_at|date }}</small>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <!-- Default stories when data is not available -->
                                    <div class="card bg-light border-0">
                                        <div class="card-body p-3">
                                            <h6 class="card-title">Carbon Reduction Success</h6>
                                            <p class="card-text small">Portfolio companies achieved 28% carbon reduction ahead of targets.</p>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="badge bg-secondary">Environmental</span>
                                                <small class="text-muted">2 days ago</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card bg-light border-0">
                                        <div class="card-body p-3">
                                            <h6 class="card-title">CSRD Readiness Analysis</h6>
                                            <p class="card-text small">New assessment shows 85% of portfolio ready for upcoming CSRD requirements.</p>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="badge bg-secondary">Governance</span>
                                                <small class="text-muted">5 days ago</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card bg-light border-0">
                                        <div class="card-body p-3">
                                            <h6 class="card-title">Diversity Metrics Improvements</h6>
                                            <p class="card-text small">Portfolio-wide diversity metrics show 15% improvement in leadership positions.</p>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="badge bg-secondary">Social</span>
                                                <small class="text-muted">1 week ago</small>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Insights Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-robot me-2 text-primary"></i>AI-Powered Sustainability Insights
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" id="refresh-insights">
                        <i class="fas fa-sync-alt me-2"></i>Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div class="insights-content">
                        {% if ai_available %}
                        <div class="row g-4">
                            <div class="col-md-4">
                                <div class="card bg-light border-0 h-100">
                                    <div class="card-body">
                                        <h6 class="mb-3">EU Regulatory Trends</h6>
                                        <p>Recent CSRD and EU Taxonomy updates indicate increased focus on biodiversity metrics and supply chain emissions. Portfolio companies should prioritize these areas for 2026 reporting.</p>
                                        <div class="mt-3">
                                            <span class="badge bg-success me-2">CSRD</span>
                                            <span class="badge bg-success">EU Taxonomy</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light border-0 h-100">
                                    <div class="card-body">
                                        <h6 class="mb-3">Investment Opportunities</h6>
                                        <p>Climate adaptation technologies show highest growth potential within sustainability sectors with 37% YoY growth. Carbon capture and water efficiency solutions demonstrating strong potential for Series A investments.</p>
                                        <div class="mt-3">
                                            <span class="badge bg-warning me-2">Climate Tech</span>
                                            <span class="badge bg-warning">Water Tech</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light border-0 h-100">
                                    <div class="card-body">
                                        <h6 class="mb-3">Portfolio Recommendations</h6>
                                        <p>Based on current portfolio composition, consider increasing exposure to renewable energy technologies and sustainable agriculture to balance climate risk exposure and improve overall ESG performance metrics.</p>
                                        <div class="mt-3">
                                            <span class="badge bg-info me-2">Portfolio Balance</span>
                                            <span class="badge bg-info">Risk Mitigation</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-robot text-muted mb-3" style="font-size: 3rem;"></i>
                            <h5>AI Insights Not Available</h5>
                            <p class="text-muted">AI-powered insights require Google Gemini API configuration.<br>Configure your API key in settings to enable this feature.</p>
                            <a href="/debug" class="btn btn-outline-primary mt-2">Configure AI Settings</a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Portfolio Fit Modal -->
<div class="modal fade" id="portfolio-fit-modal" tabindex="-1" aria-labelledby="portfolioFitModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="portfolioFitModalLabel">Portfolio Fit Analysis</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="portfolio-fit-form">
                    <div class="mb-3">
                        <label for="company-name" class="form-label">Company Name</label>
                        <input type="text" class="form-control" id="company-name" placeholder="Enter company name">
                    </div>
                    <div class="mb-3">
                        <label for="sector" class="form-label">Sector</label>
                        <select class="form-select" id="sector">
                            <option value="">Select sector</option>
                            <option value="Technology">Technology</option>
                            <option value="Healthcare">Healthcare</option>
                            <option value="Energy">Energy</option>
                            <option value="Manufacturing">Manufacturing</option>
                            <option value="Consumer Goods">Consumer Goods</option>
                            <option value="Financial Services">Financial Services</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Key Sustainability Priorities</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" value="emissions" id="check-emissions" checked>
                                    <label class="form-check-label" for="check-emissions">
                                        Emissions Reduction
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" value="renewable" id="check-renewable" checked>
                                    <label class="form-check-label" for="check-renewable">
                                        Renewable Energy
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" value="water" id="check-water">
                                    <label class="form-check-label" for="check-water">
                                        Water Management
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" value="diversity" id="check-diversity" checked>
                                    <label class="form-check-label" for="check-diversity">
                                        Diversity & Inclusion
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" value="governance" id="check-governance">
                                    <label class="form-check-label" for="check-governance">
                                        Governance Structure
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" value="supply" id="check-supply">
                                    <label class="form-check-label" for="check-supply">
                                        Supply Chain Ethics
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
                <div id="portfolio-fit-results" class="mt-4 d-none">
                    <div class="alert bg-light p-3 mb-4">
                        <div class="d-flex align-items-center mb-3">
                            <h5 class="mb-0 me-2">Fit Score:</h5>
                            <div class="progress flex-grow-1" style="height: 10px;">
                                <div class="progress-bar" id="fit-score-progress" role="progressbar" style="width: 0%;" 
                                    aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <span class="ms-2 fw-bold" id="fit-score-value">0%</span>
                        </div>
                        <p id="fit-analysis-text"></p>
                    </div>
                    
                    <h6>Key Metrics</h6>
                    <div class="row mb-4" id="fit-metrics-container">
                        <!-- Metrics will be populated here -->
                    </div>
                    
                    <h6>Peer Comparison</h6>
                    <div class="chart-container" style="height: 200px;">
                        <canvas id="peer-comparison-chart"></canvas>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="analyze-fit-btn">Analyze Fit</button>
            </div>
        </div>
    </div>
</div>

<!-- Regulatory Modal -->
<div class="modal fade" id="regulatory-modal" tabindex="-1" aria-labelledby="regulatoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="regulatoryModalLabel">Regulatory Alignment Check</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="lead">
                    Check company alignment with key EU sustainability regulations.
                </p>
                
                <form id="regulatory-check-form">
                    <div class="mb-3">
                        <label for="reg-company-name" class="form-label">Company Name</label>
                        <input type="text" class="form-control" id="reg-company-name" placeholder="Enter company name">
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="reg-company-size" class="form-label">Company Size</label>
                                <select class="form-select" id="reg-company-size">
                                    <option value="small">Small (< 50 employees)</option>
                                    <option value="medium">Medium (50-250 employees)</option>
                                    <option value="large">Large (> 250 employees)</option>
                                    <option value="public">Listed Company</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="reg-company-sector" class="form-label">Sector</label>
                                <select class="form-select" id="reg-company-sector">
                                    <option value="tech">Technology</option>
                                    <option value="manufacturing">Manufacturing</option>
                                    <option value="energy">Energy</option>
                                    <option value="financial">Financial Services</option>
                                    <option value="healthcare">Healthcare</option>
                                    <option value="consumer">Consumer Goods</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Regulatory Frameworks to Check</label>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" value="csrd" id="check-csrd" checked>
                            <label class="form-check-label" for="check-csrd">
                                Corporate Sustainability Reporting Directive (CSRD)
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" value="sfdr" id="check-sfdr" checked>
                            <label class="form-check-label" for="check-sfdr">
                                Sustainable Finance Disclosure Regulation (SFDR)
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" value="taxonomy" id="check-taxonomy" checked>
                            <label class="form-check-label" for="check-taxonomy">
                                EU Taxonomy
                            </label>
                        </div>
                    </div>
                </form>
                
                <div id="regulatory-results" class="mt-4 d-none">
                    <h5 class="mb-3">Results</h5>
                    <div class="card mb-3">
                        <div class="card-header bg-transparent">
                            <h6 class="mb-0">CSRD Applicability</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <span class="badge bg-success me-2" id="csrd-status">Applicable</span>
                                <div class="progress flex-grow-1" style="height: 8px;">
                                    <div class="progress-bar" id="csrd-progress" role="progressbar" style="width: 75%;" 
                                        aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <span class="ms-2" id="csrd-score">75% Ready</span>
                            </div>
                            <p id="csrd-text">Based on company size and sector, CSRD reporting will be required starting in FY2025. Current readiness assessment shows good progress with key gaps in biodiversity reporting and Scope 3 emissions inventory.</p>
                        </div>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-header bg-transparent">
                            <h6 class="mb-0">SFDR Impact</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <span class="badge bg-warning me-2" id="sfdr-status">Indirect Impact</span>
                                <div class="progress flex-grow-1" style="height: 8px;">
                                    <div class="progress-bar" id="sfdr-progress" role="progressbar" style="width: 60%;" 
                                        aria-valuenow="60" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <span class="ms-2" id="sfdr-score">60% Ready</span>
                            </div>
                            <p id="sfdr-text">While not directly applicable to non-financial companies, SFDR creates indirect disclosure requirements via investor questionnaires. Current data collection processes meet approximately 60% of typical Article 8 fund requirements.</p>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header bg-transparent">
                            <h6 class="mb-0">EU Taxonomy Alignment</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <span class="badge bg-info me-2" id="taxonomy-status">Partially Eligible</span>
                                <div class="progress flex-grow-1" style="height: 8px;">
                                    <div class="progress-bar" id="taxonomy-progress" role="progressbar" style="width: 45%;" 
                                        aria-valuenow="45" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <span class="ms-2" id="taxonomy-score">45% Eligible</span>
                            </div>
                            <p id="taxonomy-text">Approximately 45% of activities fall under Taxonomy-eligible categories, primarily in climate change mitigation. Of these, only about 30% currently meet the technical screening criteria for full alignment. Key improvement areas include implementing science-based targets and enhancing water usage efficiency.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="check-regulations-btn">Check Alignment</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Portfolio Fit Analysis
    const analyzeFitBtn = document.getElementById('analyze-fit-btn');
    const portfolioFitResults = document.getElementById('portfolio-fit-results');
    const fitScoreProgress = document.getElementById('fit-score-progress');
    const fitScoreValue = document.getElementById('fit-score-value');
    const fitAnalysisText = document.getElementById('fit-analysis-text');
    const fitMetricsContainer = document.getElementById('fit-metrics-container');
    let peerComparisonChart = null;
    
    if (analyzeFitBtn) {
        analyzeFitBtn.addEventListener('click', function() {
            const companyName = document.getElementById('company-name').value || 'Sample Company';
            const sector = document.getElementById('sector').value || 'Technology';
            
            // Show loading state
            analyzeFitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Analyzing...';
            analyzeFitBtn.disabled = true;
            
            // Make API request to analyze portfolio fit
            fetch('/vc-insights/api/portfolio-fit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    company_name: companyName,
                    sector: sector
                }),
            })
            .then(response => response.json())
            .then(data => {
                // Update UI with results
                portfolioFitResults.classList.remove('d-none');
                
                // Update fit score
                fitScoreProgress.style.width = `${data.fit_score}%`;
                fitScoreProgress.setAttribute('aria-valuenow', data.fit_score);
                fitScoreValue.textContent = `${data.fit_score}%`;
                
                // Update analysis text
                fitAnalysisText.textContent = data.analysis;
                
                // Update metrics
                fitMetricsContainer.innerHTML = '';
                Object.entries(data.metrics).forEach(([key, value]) => {
                    const metricName = key.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                    
                    const metricCol = document.createElement('div');
                    metricCol.className = 'col-md-3 col-sm-6 mb-3';
                    
                    const metricCard = document.createElement('div');
                    metricCard.className = 'card h-100';
                    
                    const metricBody = document.createElement('div');
                    metricBody.className = 'card-body text-center';
                    
                    metricBody.innerHTML = `
                        <h2 class="mb-0">${value}%</h2>
                        <p class="small text-muted">${metricName}</p>
                        <div class="progress mt-2" style="height: 5px;">
                            <div class="progress-bar" role="progressbar" style="width: ${value}%;" 
                                aria-valuenow="${value}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    `;
                    
                    metricCard.appendChild(metricBody);
                    metricCol.appendChild(metricCard);
                    fitMetricsContainer.appendChild(metricCol);
                });
                
                // Update peer comparison chart
                if (peerComparisonChart) {
                    peerComparisonChart.destroy();
                }
                
                const ctx = document.getElementById('peer-comparison-chart').getContext('2d');
                const labels = [companyName, ...data.peer_comparison.map(peer => peer.name)];
                const scores = [data.fit_score, ...data.peer_comparison.map(peer => peer.score)];
                
                peerComparisonChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Sustainability Fit Score',
                            data: scores,
                            backgroundColor: [
                                'rgba(54, 162, 235, 0.8)',
                                'rgba(200, 200, 200, 0.7)',
                                'rgba(200, 200, 200, 0.7)',
                                'rgba(200, 200, 200, 0.7)'
                            ],
                            borderColor: [
                                'rgba(54, 162, 235, 1)',
                                'rgba(180, 180, 180, 1)',
                                'rgba(180, 180, 180, 1)',
                                'rgba(180, 180, 180, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
                
                // Reset button state
                analyzeFitBtn.innerHTML = 'Analyze Fit';
                analyzeFitBtn.disabled = false;
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error analyzing portfolio fit. Please try again.');
                
                // Reset button state
                analyzeFitBtn.innerHTML = 'Analyze Fit';
                analyzeFitBtn.disabled = false;
            });
        });
    }
    
    // Regulatory Check
    const checkRegulationsBtn = document.getElementById('check-regulations-btn');
    const regulatoryResults = document.getElementById('regulatory-results');
    
    if (checkRegulationsBtn) {
        checkRegulationsBtn.addEventListener('click', function() {
            // Show results
            regulatoryResults.classList.remove('d-none');
            
            // Update with dynamic data based on form inputs
            const companyName = document.getElementById('reg-company-name').value || 'Sample Company';
            const companySize = document.getElementById('reg-company-size').value;
            const sector = document.getElementById('reg-company-sector').value;
            
            // Update CSRD data based on company size
            if (companySize === 'small') {
                document.getElementById('csrd-status').textContent = 'Not Applicable';
                document.getElementById('csrd-status').className = 'badge bg-secondary me-2';
                document.getElementById('csrd-progress').style.width = '100%';
                document.getElementById('csrd-score').textContent = '100% Ready';
                document.getElementById('csrd-text').textContent = 
                    `${companyName} is not required to report under CSRD due to company size. However, preparing basic sustainability disclosures may be beneficial for investor relations and potential future requirements.`;
            } else if (companySize === 'medium') {
                document.getElementById('csrd-status').textContent = 'Applicable 2026';
                document.getElementById('csrd-status').className = 'badge bg-warning me-2';
                document.getElementById('csrd-progress').style.width = '45%';
                document.getElementById('csrd-score').textContent = '45% Ready';
                document.getElementById('csrd-text').textContent = 
                    `${companyName} will need to report under CSRD starting in FY2026 for the 2027 reporting cycle. Current readiness assessment shows moderate progress with significant gaps in materiality assessment, double materiality analysis, and Scope 3 emissions inventory.`;
            } else {
                document.getElementById('csrd-status').textContent = 'Applicable 2025';
                document.getElementById('csrd-status').className = 'badge bg-success me-2';
                document.getElementById('csrd-progress').style.width = '65%';
                document.getElementById('csrd-score').textContent = '65% Ready';
                document.getElementById('csrd-text').textContent = 
                    `${companyName} will need to report under CSRD starting in FY2025 for the 2026 reporting cycle. Current readiness assessment shows good progress with key gaps in biodiversity reporting, water management, and social indicators.`;
            }
            
            // Update SFDR and Taxonomy based on sector
            if (sector === 'financial') {
                document.getElementById('sfdr-status').textContent = 'Directly Applicable';
                document.getElementById('sfdr-status').className = 'badge bg-success me-2';
                document.getElementById('sfdr-progress').style.width = '70%';
                document.getElementById('sfdr-score').textContent = '70% Ready';
                document.getElementById('sfdr-text').textContent = 
                    `As a financial entity, ${companyName} is directly subject to SFDR requirements. Current processes meet approximately 70% of Article 8 requirements, with gaps in adverse impact reporting and ESG risk integration.`;
            } else {
                document.getElementById('sfdr-status').textContent = 'Indirect Impact';
                document.getElementById('sfdr-status').className = 'badge bg-warning me-2';
                document.getElementById('sfdr-progress').style.width = '55%';
                document.getElementById('sfdr-score').textContent = '55% Ready';
                document.getElementById('sfdr-text').textContent = 
                    `While not directly applicable to ${companyName} as a non-financial company, SFDR creates indirect disclosure requirements via investor questionnaires. Current data collection processes meet approximately 55% of typical Article 8 fund requirements.`;
            }
            
            if (sector === 'energy') {
                document.getElementById('taxonomy-status').textContent = 'Highly Eligible';
                document.getElementById('taxonomy-status').className = 'badge bg-success me-2';
                document.getElementById('taxonomy-progress').style.width = '75%';
                document.getElementById('taxonomy-score').textContent = '75% Eligible';
                document.getElementById('taxonomy-text').textContent = 
                    `As an energy company, ${companyName} has high Taxonomy eligibility with approximately 75% of activities falling under eligible categories, primarily in climate change mitigation and adaptation. Of these, about 60% currently meet the technical screening criteria for full alignment.`;
            } else if (sector === 'tech') {
                document.getElementById('taxonomy-status').textContent = 'Partially Eligible';
                document.getElementById('taxonomy-status').className = 'badge bg-info me-2';
                document.getElementById('taxonomy-progress').style.width = '35%';
                document.getElementById('taxonomy-score').textContent = '35% Eligible';
                document.getElementById('taxonomy-text').textContent = 
                    `For ${companyName} in the technology sector, approximately 35% of activities fall under Taxonomy-eligible categories, primarily in climate change mitigation through enabling technologies. Of these, only about 25% currently meet the technical screening criteria for full alignment.`;
            } else {
                document.getElementById('taxonomy-status').textContent = 'Moderately Eligible';
                document.getElementById('taxonomy-status').className = 'badge bg-primary me-2';
                document.getElementById('taxonomy-progress').style.width = '55%';
                document.getElementById('taxonomy-score').textContent = '55% Eligible';
                document.getElementById('taxonomy-text').textContent = 
                    `For ${companyName}, approximately 55% of activities fall under Taxonomy-eligible categories across multiple environmental objectives. Of these, about 40% currently meet the technical screening criteria for full alignment.`;
            }
        });
    }
    
    // Refresh AI Insights
    const refreshInsightsBtn = document.getElementById('refresh-insights');
    if (refreshInsightsBtn) {
        refreshInsightsBtn.addEventListener('click', function() {
            refreshInsightsBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Refreshing...';
            refreshInsightsBtn.disabled = true;
            
            // Simulate AI refresh (would be an actual API call in production)
            setTimeout(() => {
                refreshInsightsBtn.innerHTML = '<i class="fas fa-sync-alt me-2"></i>Refresh';
                refreshInsightsBtn.disabled = false;
                
                // Show toast notification
                const toastContainer = document.createElement('div');
                toastContainer.className = 'position-fixed bottom-0 end-0 p-3';
                toastContainer.style.zIndex = '1050';
                
                toastContainer.innerHTML = `
                    <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="toast-header">
                            <i class="fas fa-robot me-2 text-primary"></i>
                            <strong class="me-auto">AI Insights</strong>
                            <small>Just now</small>
                            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                        <div class="toast-body">
                            Insights refreshed successfully with latest sustainability data.
                        </div>
                    </div>
                `;
                
                document.body.appendChild(toastContainer);
                
                // Auto-remove toast after 3 seconds
                setTimeout(() => {
                    toastContainer.remove();
                }, 3000);
            }, 1500);
        });
    }
});
</script>
{% endblock %}