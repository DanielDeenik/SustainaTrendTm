{% extends "layouts/finchat_dark_layout.html" %}

{% block title %}Forward-Looking Metrics Assessment - VC-Lens™{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-5">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-1">Forward-Looking Metrics Assessment</h1>
            <p class="text-muted">Forecast sustainability performance metrics and analyze improvement trajectories</p>
        </div>
        <div>
            <a href="/vc-lens/startup-assessment" class="btn btn-outline-secondary me-2">
                <i class="fas fa-arrow-left me-2"></i>Back to Assessment
            </a>
            <button type="button" class="btn btn-primary generate-report-btn d-none">
                <i class="fas fa-file-pdf me-2"></i>Generate Report
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <!-- Assessment Form -->
        <div class="col-lg-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-transparent">
                    <h5 class="card-title mb-0">Company Information</h5>
                </div>
                <div class="card-body">
                    <form id="forward-metrics-form">
                        <div class="mb-3">
                            <label for="company_name" class="form-label">Company Name</label>
                            <input type="text" class="form-control" id="company_name" name="company_name" placeholder="Enter company name" required>
                        </div>
                        <div class="mb-3">
                            <label for="sector" class="form-label">Industry Sector</label>
                            <select class="form-select" id="sector" name="sector" required>
                                <option value="" selected disabled>Select sector</option>
                                <option value="Technology">Technology</option>
                                <option value="Energy">Energy</option>
                                <option value="Manufacturing">Manufacturing</option>
                                <option value="Consumer Goods">Consumer Goods</option>
                                <option value="Healthcare">Healthcare</option>
                                <option value="Financial Services">Financial Services</option>
                                <option value="Food & Agriculture">Food & Agriculture</option>
                                <option value="Transportation">Transportation</option>
                                <option value="Chemicals">Chemicals</option>
                                <option value="Construction">Construction</option>
                                <option value="Retail">Retail</option>
                                <option value="Media & Entertainment">Media & Entertainment</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="size" class="form-label">Company Size</label>
                            <select class="form-select" id="size" name="size" required>
                                <option value="" selected disabled>Select size</option>
                                <option value="Startup (1-50)">Startup (1-50)</option>
                                <option value="Small (51-250)">Small (51-250)</option>
                                <option value="Medium (251-1000)">Medium (251-1000)</option>
                                <option value="Large (1001-5000)">Large (1001-5000)</option>
                                <option value="Enterprise (5000+)">Enterprise (5000+)</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="base_year" class="form-label">Base Year</label>
                            <input type="number" class="form-control" id="base_year" name="base_year" value="2025" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Metrics to Forecast</label>
                            <div class="form-text mb-2">Select metrics relevant to your business</div>
                            
                            {% for metric in metric_types %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="{{ metric.id }}" id="metric_{{ metric.id }}" name="metrics" checked>
                                <label class="form-check-label" for="metric_{{ metric.id }}">
                                    {{ metric.name }} ({{ metric.unit }})
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100">
                            Generate Forecast
                        </button>
                    </form>
                </div>
            </div>
            
            <div class="card shadow-sm mb-4 d-none" id="peer-comparison-card">
                <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Peer Comparison</h5>
                    <span class="badge bg-primary" id="comparison-metric-badge">Carbon Emissions</span>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="position: relative; height:250px;">
                        <canvas id="peer-comparison-chart"></canvas>
                    </div>
                    <div class="mt-3" id="peer-comparison-legend">
                        <!-- Peer comparison legend will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Assessment Results -->
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4 d-none" id="forecast-results-card">
                <div class="card-header bg-transparent">
                    <h5 class="card-title mb-0">Forward-Looking Metrics Forecast</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-12">
                            <p class="mb-3" id="forecast-commentary">
                                <!-- Forecast commentary will be loaded here -->
                            </p>
                        </div>
                    </div>
                    
                    <h6 class="fw-bold mb-3">5-Year Forecasts</h6>
                    <div class="metrics-container">
                        <div class="row" id="metrics-row">
                            <!-- Metric forecast cards will be loaded here -->
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-12">
                            <h6 class="fw-bold mb-3">Detailed Forecast Data</h6>
                            <div class="chart-container" style="position: relative; height:300px;">
                                <canvas id="forecast-chart"></canvas>
                            </div>
                            <div class="d-flex justify-content-center mt-3">
                                <div class="btn-group" role="group" id="metric-selector">
                                    <!-- Metric selector buttons will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card shadow-sm mb-4" id="loading-card">
                <div class="card-body text-center py-5">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5 class="text-muted">Enter company information and select metrics to begin forecast</h5>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for Assessment -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elements
    const forwardMetricsForm = document.getElementById('forward-metrics-form');
    const loadingCard = document.getElementById('loading-card');
    const forecastResultsCard = document.getElementById('forecast-results-card');
    const peerComparisonCard = document.getElementById('peer-comparison-card');
    const forecastCommentaryEl = document.getElementById('forecast-commentary');
    const metricsRow = document.getElementById('metrics-row');
    const metricSelector = document.getElementById('metric-selector');
    const peerComparisonLegend = document.getElementById('peer-comparison-legend');
    const comparisonMetricBadge = document.getElementById('comparison-metric-badge');
    
    // Charts
    let forecastChart = null;
    let peerComparisonChart = null;
    
    // Colors for metrics
    const metricColors = {
        'carbon': '#ff6b81',
        'energy': '#ffa94d',
        'water': '#34c3ff',
        'waste': '#845ef7',
        'circular': '#3dd598',
        'renewable': '#3dd598'
    };
    
    // Labels for metrics
    const metricLabels = {
        'carbon': 'Carbon Emissions (tCO2e)',
        'energy': 'Energy Use (MWh)',
        'water': 'Water Consumption (m³)',
        'waste': 'Waste Generation (tonnes)',
        'circular': 'Circularity Index (%)',
        'renewable': 'Renewable Energy (%)'
    };
    
    // Initialize and update the forecast chart
    function initializeForecastChart(data, selectedMetric = null) {
        // Get available metrics
        const availableMetrics = Object.keys(data.forecasts);
        
        // If no metric is selected, use the first one
        if (!selectedMetric && availableMetrics.length > 0) {
            selectedMetric = availableMetrics[0];
        }
        
        // If no metric is available, show a message
        if (!selectedMetric) {
            return;
        }
        
        // Update the metric selector
        metricSelector.innerHTML = '';
        availableMetrics.forEach(metric => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = `btn btn-sm ${metric === selectedMetric ? 'btn-primary' : 'btn-outline-secondary'}`;
            button.textContent = metric.charAt(0).toUpperCase() + metric.slice(1);
            button.addEventListener('click', () => {
                updateForecastChart(data, metric);
            });
            metricSelector.appendChild(button);
        });
        
        // Get the forecast data for the selected metric
        const forecastData = data.forecasts[selectedMetric];
        
        // Chart data
        const labels = ['Current Year', 'Year 1', 'Year 2', 'Year 3', 'Year 5'];
        const chartData = [
            forecastData.current_year,
            forecastData.year_1,
            forecastData.year_2,
            forecastData.year_3,
            forecastData.year_5
        ];
        
        // Create or update the chart
        const ctx = document.getElementById('forecast-chart').getContext('2d');
        
        if (forecastChart) {
            forecastChart.destroy();
        }
        
        forecastChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: metricLabels[selectedMetric] || selectedMetric.charAt(0).toUpperCase() + selectedMetric.slice(1),
                    data: chartData,
                    backgroundColor: metricColors[selectedMetric] || '#3dd598',
                    borderColor: metricColors[selectedMetric] || '#3dd598',
                    borderWidth: 2,
                    tension: 0.3,
                    pointRadius: 4,
                    pointBackgroundColor: metricColors[selectedMetric] || '#3dd598'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: selectedMetric === 'circular' || selectedMetric === 'renewable',
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }
    
    // Update the forecast chart
    function updateForecastChart(data, selectedMetric) {
        // Update selector buttons
        const buttons = metricSelector.getElementsByTagName('button');
        Array.from(buttons).forEach(button => {
            button.className = 'btn btn-sm btn-outline-secondary';
            if (button.textContent.toLowerCase() === selectedMetric.toLowerCase()) {
                button.className = 'btn btn-sm btn-primary';
            }
        });
        
        // Initialize the chart with new data
        initializeForecastChart(data, selectedMetric);
    }
    
    // Initialize peer comparison chart
    function initializePeerComparisonChart(data) {
        // Get peer comparison data
        const peerData = data.peer_comparison;
        
        if (!peerData || !peerData.peers || peerData.peers.length === 0) {
            peerComparisonCard.classList.add('d-none');
            return;
        }
        
        // Show the peer comparison card
        peerComparisonCard.classList.remove('d-none');
        
        // Update metric badge
        comparisonMetricBadge.textContent = peerData.metric.charAt(0).toUpperCase() + peerData.metric.slice(1);
        
        // Create labels and datasets
        const labels = ['Current', 'Future (5 Yr)'];
        
        // Create dataset for company
        const datasets = [{
            label: 'Your Company',
            data: [peerData.company_current, peerData.company_future],
            backgroundColor: '#3dd598',
            borderColor: '#3dd598',
            borderWidth: 2
        }];
        
        // Create datasets for peers
        peerData.peers.forEach((peer, index) => {
            const colors = ['#ff6b81', '#ffa94d', '#34c3ff', '#845ef7', '#f06595'];
            const colorIndex = index % colors.length;
            
            datasets.push({
                label: peer.name,
                data: [peer.current_value, peer.future_value],
                backgroundColor: colors[colorIndex],
                borderColor: colors[colorIndex],
                borderWidth: 2
            });
        });
        
        // Create or update the chart
        const ctx = document.getElementById('peer-comparison-chart').getContext('2d');
        
        if (peerComparisonChart) {
            peerComparisonChart.destroy();
        }
        
        peerComparisonChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: peerData.metric === 'circular' || peerData.metric === 'renewable',
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
        
        // Create legend
        peerComparisonLegend.innerHTML = '';
        
        datasets.forEach(dataset => {
            const legendItem = document.createElement('div');
            legendItem.className = 'd-flex align-items-center mb-2';
            legendItem.innerHTML = `
                <div style="width: 12px; height: 12px; background-color: ${dataset.backgroundColor}; margin-right: 8px;"></div>
                <span>${dataset.label}</span>
            `;
            peerComparisonLegend.appendChild(legendItem);
        });
    }
    
    // Form Submission
    forwardMetricsForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Show loading state
        loadingCard.innerHTML = `
            <div class="card-body text-center py-5">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5 class="text-muted">Generating sustainability forecasts...</h5>
                <p class="text-muted small">This may take a few moments</p>
            </div>
        `;
        
        // Get form data
        const formData = new FormData(forwardMetricsForm);
        const company_name = formData.get('company_name');
        const sector = formData.get('sector');
        const size = formData.get('size');
        const base_year = formData.get('base_year');
        const metrics = formData.getAll('metrics');
        
        // Prepare request data
        const requestData = {
            company_name,
            sector,
            size,
            base_year,
            metrics
        };
        
        // Send API request
        fetch('/vc-lens/api/assessment/forward-metrics', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            // Show results
            loadingCard.classList.add('d-none');
            forecastResultsCard.classList.remove('d-none');
            
            // Update commentary
            forecastCommentaryEl.textContent = data.commentary;
            
            // Create metric cards
            metricsRow.innerHTML = '';
            Object.entries(data.forecasts).forEach(([metric, forecastData]) => {
                const currentValue = forecastData.current_year;
                const futureValue = forecastData.year_5;
                const improvementData = data.improvement_metrics[metric];
                const trend = improvementData?.trend || 'stable';
                const percentChange = improvementData?.percent_change || 0;
                
                // Determine if this is a positive or negative trend
                // For carbon, energy, water, waste - lower is better (negative trend is good)
                // For circular, renewable - higher is better (positive trend is good)
                const isPositiveMetric = metric === 'circular' || metric === 'renewable';
                const isImproving = (isPositiveMetric && trend === 'improving') || 
                                    (!isPositiveMetric && trend === 'improving');
                
                const trendClass = isImproving ? 'text-success' : 'text-danger';
                const trendIcon = isImproving ? 'fa-arrow-up' : 'fa-arrow-down';
                
                const unit = metric === 'carbon' ? 'tCO2e' : 
                            metric === 'energy' ? 'MWh' : 
                            metric === 'water' ? 'm³' : 
                            metric === 'waste' ? 'tonnes' : '%';
                
                metricsRow.innerHTML += `
                    <div class="col-md-6 col-xl-4 mb-4">
                        <div class="card h-100 bg-dark">
                            <div class="card-body">
                                <h6 class="card-title text-uppercase text-muted mb-2">${metric.charAt(0).toUpperCase() + metric.slice(1)}</h6>
                                <div class="d-flex justify-content-between align-items-baseline mb-3">
                                    <div>
                                        <h3 class="mb-0">${currentValue.toLocaleString()}</h3>
                                        <div class="text-muted small">Current (${unit})</div>
                                    </div>
                                    <div class="text-end">
                                        <h3 class="mb-0">${futureValue.toLocaleString()}</h3>
                                        <div class="text-muted small">Year 5 (${unit})</div>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center">
                                    <div class="me-2 ${trendClass}">
                                        <i class="fas ${trendIcon}"></i>
                                    </div>
                                    <div class="${trendClass} fw-bold">${percentChange}%</div>
                                    <div class="ms-auto text-muted">${trend}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Initialize charts
            initializeForecastChart(data);
            initializePeerComparisonChart(data);
            
            // Show generate report button
            document.querySelector('.generate-report-btn').classList.remove('d-none');
        })
        .catch(error => {
            console.error('Error:', error);
            loadingCard.innerHTML = `
                <div class="card-body text-center py-5">
                    <i class="fas fa-exclamation-circle text-danger fa-3x mb-3"></i>
                    <h5 class="text-danger">Error generating forecast</h5>
                    <p class="text-muted">Please try again later</p>
                    <button class="btn btn-outline-primary mt-2" onclick="location.reload()">
                        <i class="fas fa-redo me-2"></i>Reload Page
                    </button>
                </div>
            `;
        });
    });
    
    // Generate report button
    document.querySelector('.generate-report-btn').addEventListener('click', function() {
        alert('Report generation feature is in development. This will allow you to export this forecast as a PDF.');
    });
});
</script>
{% endblock %}