{% extends "layouts/finchat_dark_layout.html" %}

{% block title %}Startup Sustainability Assessment - VC-Lens™{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-5">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-1">Startup Sustainability Assessment</h1>
            <p class="text-muted">Evaluate startups against key ESG & impact metrics</p>
        </div>
        <div>
            <a href="/vc-insights" class="btn btn-outline-secondary me-2">
                <i class="fas fa-arrow-left me-2"></i>Back to VC-Lens™
            </a>
            <button type="button" class="btn btn-primary generate-report-btn d-none">
                <i class="fas fa-file-pdf me-2"></i>Generate Report
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <!-- Assessment Form -->
        <div class="col-lg-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-transparent">
                    <h5 class="card-title mb-0">Company Information</h5>
                </div>
                <div class="card-body">
                    <form id="startup-assessment-form">
                        <div class="mb-3">
                            <label for="company-name" class="form-label">Company Name</label>
                            <input type="text" class="form-control" id="company-name" placeholder="Enter company name">
                        </div>
                        <div class="mb-3">
                            <label for="company-sector" class="form-label">Sector</label>
                            <select class="form-select" id="company-sector">
                                <option value="">Select sector</option>
                                <option value="Technology">Technology</option>
                                <option value="Energy">Energy</option>
                                <option value="Healthcare">Healthcare</option>
                                <option value="Manufacturing">Manufacturing</option>
                                <option value="Consumer">Consumer Goods</option>
                                <option value="Financial">Financial Services</option>
                                <option value="Transportation">Transportation</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="company-stage" class="form-label">Company Stage</label>
                            <select class="form-select" id="company-stage">
                                <option value="">Select stage</option>
                                <option value="Seed">Seed</option>
                                <option value="Series A">Series A</option>
                                <option value="Series B">Series B</option>
                                <option value="Series C+">Series C+</option>
                                <option value="Growth">Growth</option>
                                <option value="Pre-IPO">Pre-IPO</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="company-size" class="form-label">Company Size</label>
                            <select class="form-select" id="company-size">
                                <option value="">Select size</option>
                                <option value="1-10">1-10 employees</option>
                                <option value="11-50">11-50 employees</option>
                                <option value="51-250">51-250 employees</option>
                                <option value="251-1000">251-1000 employees</option>
                                <option value="1000+">1000+ employees</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="company-revenue" class="form-label">Annual Revenue (€)</label>
                            <select class="form-select" id="company-revenue">
                                <option value="">Select revenue range</option>
                                <option value="Pre-revenue">Pre-revenue</option>
                                <option value="<1M">< €1M</option>
                                <option value="1-5M">€1M - €5M</option>
                                <option value="5-20M">€5M - €20M</option>
                                <option value="20-50M">€20M - €50M</option>
                                <option value="50M+">€50M+</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label d-block">Sustainability Focus Areas</label>
                            <div class="row">
                                <div class="col-6">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" value="emissions" id="check-emissions" checked>
                                        <label class="form-check-label" for="check-emissions">Emissions</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" value="energy" id="check-energy" checked>
                                        <label class="form-check-label" for="check-energy">Energy</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" value="water" id="check-water">
                                        <label class="form-check-label" for="check-water">Water</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" value="waste" id="check-waste">
                                        <label class="form-check-label" for="check-waste">Waste</label>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" value="diversity" id="check-diversity" checked>
                                        <label class="form-check-label" for="check-diversity">Diversity</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" value="governance" id="check-governance" checked>
                                        <label class="form-check-label" for="check-governance">Governance</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" value="supply" id="check-supply">
                                        <label class="form-check-label" for="check-supply">Supply Chain</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" value="community" id="check-community">
                                        <label class="form-check-label" for="check-community">Community</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label d-block">Applicable Frameworks</label>
                            {% for framework in csrd_frameworks %}
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" value="{{ framework.id }}" id="check-{{ framework.id }}">
                                <label class="form-check-label" for="check-{{ framework.id }}">
                                    {{ framework.name }} <span class="text-muted small">({{ framework.description }})</span>
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        <button type="button" id="run-assessment-btn" class="btn btn-primary w-100">
                            <i class="fas fa-chart-line me-2"></i>Run Assessment
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Assessment Results -->
        <div class="col-lg-8">
            <div id="assessment-results" class="d-none">
                <!-- Results Tabs -->
                <ul class="nav nav-tabs mb-4" id="assessmentTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="foundational-tab" data-bs-toggle="tab" data-bs-target="#foundational" type="button" role="tab" aria-controls="foundational" aria-selected="true">
                            <i class="fas fa-clipboard-check me-2"></i>Foundational Readiness
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="metrics-tab" data-bs-toggle="tab" data-bs-target="#metrics" type="button" role="tab" aria-controls="metrics" aria-selected="false">
                            <i class="fas fa-chart-line me-2"></i>Forward-Looking Metrics
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="narrative-tab" data-bs-toggle="tab" data-bs-target="#narrative" type="button" role="tab" aria-controls="narrative" aria-selected="false">
                            <i class="fas fa-comment-alt me-2"></i>Narrative Alignment
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content" id="assessmentTabsContent">
                    <!-- Foundational Readiness Tab -->
                    <div class="tab-pane fade show active" id="foundational" role="tabpanel" aria-labelledby="foundational-tab">
                        <div class="card shadow-sm mb-4">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-4">
                                    <div class="position-relative me-4" style="width: 100px; height: 100px;">
                                        <canvas id="readiness-score-chart" width="100" height="100"></canvas>
                                        <div class="position-absolute top-50 start-50 translate-middle text-center">
                                            <h3 class="mb-0 fw-bold" id="readiness-score-value">0%</h3>
                                        </div>
                                    </div>
                                    <div>
                                        <h5 class="mb-2">CSRD Readiness Score</h5>
                                        <p class="mb-0" id="readiness-commentary">Awaiting assessment...</p>
                                    </div>
                                </div>
                                
                                <h5 class="mb-3">Framework Alignment</h5>
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="framework-chart-container">
                                            <canvas id="framework-alignment-chart"></canvas>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div id="framework-details">
                                            <!-- Framework details will be populated here -->
                                        </div>
                                    </div>
                                </div>
                                
                                <h5 class="mb-3">Key Gaps & Opportunities</h5>
                                <div class="list-group mb-3" id="gap-list">
                                    <!-- Gaps will be populated here -->
                                    <div class="list-group-item d-flex align-items-center placeholder-gap">
                                        <span class="icon-circle bg-warning text-white me-3">
                                            <i class="fas fa-exclamation-triangle"></i>
                                        </span>
                                        <div>
                                            <h6 class="mb-1">Awaiting assessment...</h6>
                                            <p class="mb-0 small">Please run the assessment to identify gaps and opportunities.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Forward-Looking Metrics Tab -->
                    <div class="tab-pane fade" id="metrics" role="tabpanel" aria-labelledby="metrics-tab">
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-transparent">
                                <h5 class="card-title mb-0">Carbon Emissions Forecast</h5>
                            </div>
                            <div class="card-body">
                                <div class="carbon-chart-container mb-4" style="height: 300px;">
                                    <canvas id="carbon-forecast-chart"></canvas>
                                </div>
                                <div class="row" id="carbon-details">
                                    <!-- Carbon details will be populated here -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card shadow-sm h-100">
                                    <div class="card-header bg-transparent">
                                        <h5 class="card-title mb-0">Renewable Energy Growth</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="renewable-chart-container" style="height: 200px;">
                                            <canvas id="renewable-growth-chart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card shadow-sm h-100">
                                    <div class="card-header bg-transparent">
                                        <h5 class="card-title mb-0">Circular Economy Index</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="position-relative me-4" style="width: 100px; height: 100px;">
                                                <canvas id="circular-index-chart" width="100" height="100"></canvas>
                                                <div class="position-absolute top-50 start-50 translate-middle text-center">
                                                    <h3 class="mb-0 fw-bold" id="circular-index-value">0%</h3>
                                                </div>
                                            </div>
                                            <div>
                                                <h5 class="mb-2">Circular Index</h5>
                                                <p class="mb-0 text-muted small">Measures product lifecycle circularity, resource recovery, and waste reduction capabilities.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card shadow-sm">
                            <div class="card-header bg-transparent">
                                <h5 class="card-title mb-0">Resource Efficiency Trends</h5>
                            </div>
                            <div class="card-body">
                                <div class="row" id="efficiency-metrics">
                                    <!-- Efficiency metrics will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Narrative Alignment Tab -->
                    <div class="tab-pane fade" id="narrative" role="tabpanel" aria-labelledby="narrative-tab">
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-transparent">
                                <h5 class="card-title mb-0">Sustainability Narrative</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <h6 class="text-muted small text-uppercase mb-3">SDG Alignment</h6>
                                        <div class="sdg-icons-container" id="sdg-alignment">
                                            <!-- SDG icons will be populated here -->
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-muted small text-uppercase mb-3">Key Messages</h6>
                                        <div id="key-messages">
                                            <!-- Key messages will be populated here -->
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card bg-light border-0 mb-4">
                                    <div class="card-body">
                                        <h5 class="card-title mb-3">Investor Impact Story</h5>
                                        <div id="investor-story">
                                            <p class="placeholder-text">Run the assessment to generate an investor-focused sustainability narrative...</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <h6 class="text-muted small text-uppercase mb-3">Recommended Actions</h6>
                                <div class="row" id="recommended-actions">
                                    <!-- Recommended actions will be populated here -->
                                    <div class="col-md-6 mb-3">
                                        <div class="card h-100">
                                            <div class="card-body">
                                                <div class="d-flex align-items-center mb-3">
                                                    <span class="icon-circle bg-primary text-white me-3">
                                                        <i class="fas fa-clipboard-check"></i>
                                                    </span>
                                                    <h6 class="mb-0">Run the assessment to get recommendations</h6>
                                                </div>
                                                <p class="text-muted small mb-0">Detailed action items will appear here after analysis.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Initial State (Before Assessment) -->
            <div id="pre-assessment" class="text-center py-5">
                <img src="https://via.placeholder.com/150x150?text=Assessment" alt="Assessment" class="mb-4 rounded">
                <h3>Startup Sustainability Assessment</h3>
                <p class="text-muted">Fill out the company information and run the assessment to generate a comprehensive sustainability analysis.</p>
                <div class="mt-4">
                    <h6 class="mb-3">Analysis includes:</h6>
                    <div class="row justify-content-center">
                        <div class="col-md-4">
                            <div class="card border-0 bg-light mb-3">
                                <div class="card-body text-center">
                                    <i class="fas fa-clipboard-check text-primary mb-3" style="font-size: 2rem;"></i>
                                    <h5>Foundational Readiness</h5>
                                    <p class="small text-muted">CSRD readiness scoring, framework alignment, and gap analysis</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-0 bg-light mb-3">
                                <div class="card-body text-center">
                                    <i class="fas fa-chart-line text-primary mb-3" style="font-size: 2rem;"></i>
                                    <h5>Forward Metrics</h5>
                                    <p class="small text-muted">Carbon forecasting, circular economy index, and resource efficiency</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-0 bg-light mb-3">
                                <div class="card-body text-center">
                                    <i class="fas fa-comment-alt text-primary mb-3" style="font-size: 2rem;"></i>
                                    <h5>Narrative Alignment</h5>
                                    <p class="small text-muted">Investor story, SDG mapping, and key sustainability messages</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // DOM elements
    const runAssessmentBtn = document.getElementById('run-assessment-btn');
    const preAssessment = document.getElementById('pre-assessment');
    const assessmentResults = document.getElementById('assessment-results');
    const generateReportBtn = document.querySelector('.generate-report-btn');
    
    // Charts
    let readinessScoreChart = null;
    let frameworkAlignmentChart = null;
    let carbonForecastChart = null;
    let renewableGrowthChart = null;
    let circularIndexChart = null;
    
    // Run Assessment
    if (runAssessmentBtn) {
        runAssessmentBtn.addEventListener('click', function() {
            // Get form data
            const companyName = document.getElementById('company-name').value || 'Sample Company';
            const sector = document.getElementById('company-sector').value || 'Technology';
            
            // Validate form
            if (!companyName) {
                alert('Please enter a company name');
                return;
            }
            
            // Show loading state
            runAssessmentBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Analyzing...';
            runAssessmentBtn.disabled = true;
            
            // Make API request to generate assessment
            fetch('/vc-insights/api/sustainability-assessment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    company_name: companyName,
                    sector: sector
                }),
            })
            .then(response => response.json())
            .then(data => {
                // Hide pre-assessment, show results
                preAssessment.classList.add('d-none');
                assessmentResults.classList.remove('d-none');
                generateReportBtn.classList.remove('d-none');
                
                // Update Foundational Readiness tab
                updateFoundationalReadiness(data);
                
                // Update Forward-Looking Metrics tab
                updateForwardMetrics(data);
                
                // Update Narrative Alignment tab
                updateNarrativeAlignment(data);
                
                // Reset button state
                runAssessmentBtn.innerHTML = '<i class="fas fa-chart-line me-2"></i>Run Assessment';
                runAssessmentBtn.disabled = false;
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error generating assessment. Please try again.');
                
                // Reset button state
                runAssessmentBtn.innerHTML = '<i class="fas fa-chart-line me-2"></i>Run Assessment';
                runAssessmentBtn.disabled = false;
            });
        });
    }
    
    function updateFoundationalReadiness(data) {
        const foundational = data.modules.foundational_readiness;
        
        // Update readiness score
        const readinessScore = foundational.score;
        document.getElementById('readiness-score-value').textContent = `${readinessScore}%`;
        document.getElementById('readiness-commentary').textContent = foundational.maturity_commentary;
        
        // Create/update readiness score chart
        if (readinessScoreChart) {
            readinessScoreChart.destroy();
        }
        
        const ctxReadiness = document.getElementById('readiness-score-chart').getContext('2d');
        readinessScoreChart = new Chart(ctxReadiness, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [readinessScore, 100 - readinessScore],
                    backgroundColor: [
                        '#4CAF50',
                        '#E0E0E0'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                cutout: '75%',
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        enabled: false
                    }
                }
            }
        });
        
        // Update framework alignment chart
        if (frameworkAlignmentChart) {
            frameworkAlignmentChart.destroy();
        }
        
        const ctxFramework = document.getElementById('framework-alignment-chart').getContext('2d');
        const frameworkLabels = Object.keys(foundational.frameworks).map(key => key.toUpperCase());
        const frameworkScores = Object.values(foundational.frameworks);
        
        frameworkAlignmentChart = new Chart(ctxFramework, {
            type: 'radar',
            data: {
                labels: frameworkLabels,
                datasets: [{
                    label: 'Alignment Score',
                    data: frameworkScores,
                    fill: true,
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgb(54, 162, 235)',
                    pointBackgroundColor: 'rgb(54, 162, 235)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgb(54, 162, 235)'
                }]
            },
            options: {
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            stepSize: 20
                        }
                    }
                }
            }
        });
        
        // Update framework details
        const frameworkDetails = document.getElementById('framework-details');
        frameworkDetails.innerHTML = '';
        
        Object.entries(foundational.frameworks).forEach(([key, value]) => {
            const framework = key.toUpperCase();
            const score = value;
            let status = 'Needs Improvement';
            let badgeClass = 'bg-warning';
            
            if (score >= 80) {
                status = 'Excellent';
                badgeClass = 'bg-success';
            } else if (score >= 60) {
                status = 'Good';
                badgeClass = 'bg-primary';
            } else if (score >= 40) {
                status = 'Fair';
                badgeClass = 'bg-info';
            }
            
            const frameworkItem = document.createElement('div');
            frameworkItem.className = 'mb-3';
            frameworkItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <h6 class="mb-0">${framework}</h6>
                    <span class="badge ${badgeClass}">${status}</span>
                </div>
                <div class="progress" style="height: 10px;">
                    <div class="progress-bar" role="progressbar" style="width: ${score}%;" 
                        aria-valuenow="${score}" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <p class="small text-muted mt-1">Alignment score: ${score}%</p>
            `;
            
            frameworkDetails.appendChild(frameworkItem);
        });
        
        // Update gaps list
        const gapList = document.getElementById('gap-list');
        gapList.innerHTML = '';
        
        foundational.gap_analysis.forEach(gap => {
            const gapItem = document.createElement('div');
            gapItem.className = 'list-group-item d-flex align-items-center';
            gapItem.innerHTML = `
                <span class="icon-circle bg-warning text-white me-3">
                    <i class="fas fa-exclamation-triangle"></i>
                </span>
                <div>
                    <h6 class="mb-1">${gap}</h6>
                    <p class="mb-0 small">Priority improvement area for CSRD compliance</p>
                </div>
            `;
            
            gapList.appendChild(gapItem);
        });
    }
    
    function updateForwardMetrics(data) {
        const forwardMetrics = data.modules.forward_metrics;
        
        // Update carbon forecast chart
        if (carbonForecastChart) {
            carbonForecastChart.destroy();
        }
        
        const carbonForecast = forwardMetrics.carbon_forecast;
        const ctxCarbon = document.getElementById('carbon-forecast-chart').getContext('2d');
        
        carbonForecastChart = new Chart(ctxCarbon, {
            type: 'line',
            data: {
                labels: ['Current', 'Year 1', 'Year 2', 'Year 3', 'Year 5'],
                datasets: [{
                    label: 'Carbon Emissions (tCO₂e)',
                    data: [
                        carbonForecast.current_year,
                        carbonForecast.year_1,
                        carbonForecast.year_2,
                        carbonForecast.year_3,
                        carbonForecast.year_5
                    ],
                    fill: false,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1,
                    pointBackgroundColor: 'rgb(75, 192, 192)',
                    pointBorderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: 'Emissions (tCO₂e)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Timeline'
                        }
                    }
                }
            }
        });
        
        // Update carbon details
        const carbonDetails = document.getElementById('carbon-details');
        carbonDetails.innerHTML = '';
        
        // Calculate reduction percentage
        const currentEmissions = carbonForecast.current_year;
        const year5Emissions = carbonForecast.year_5;
        const reductionPercent = Math.round((1 - (year5Emissions / currentEmissions)) * 100);
        
        const carbonSummary = document.createElement('div');
        carbonSummary.className = 'col-12 mb-3';
        carbonSummary.innerHTML = `
            <div class="alert alert-success">
                <h5><i class="fas fa-leaf me-2"></i>Projected ${reductionPercent}% Reduction</h5>
                <p class="mb-0">Based on current sustainability initiatives and industry benchmarks, emissions are 
                projected to decrease from ${currentEmissions} tCO₂e to ${year5Emissions} tCO₂e over the next 5 years.</p>
            </div>
        `;
        
        carbonDetails.appendChild(carbonSummary);
        
        // Update renewable growth chart
        if (renewableGrowthChart) {
            renewableGrowthChart.destroy();
        }
        
        const renewableGrowth = forwardMetrics.renewable_growth;
        const ctxRenewable = document.getElementById('renewable-growth-chart').getContext('2d');
        
        renewableGrowthChart = new Chart(ctxRenewable, {
            type: 'bar',
            data: {
                labels: ['Current', 'Year 5 (Projected)'],
                datasets: [{
                    label: 'Renewable Energy (%)',
                    data: [renewableGrowth.current_year, renewableGrowth.year_5],
                    backgroundColor: [
                        'rgba(255, 159, 64, 0.7)',
                        'rgba(75, 192, 192, 0.7)'
                    ],
                    borderColor: [
                        'rgb(255, 159, 64)',
                        'rgb(75, 192, 192)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Renewable Energy (%)'
                        }
                    }
                }
            }
        });
        
        // Update circular index chart
        if (circularIndexChart) {
            circularIndexChart.destroy();
        }
        
        const circularIndex = forwardMetrics.circular_index;
        document.getElementById('circular-index-value').textContent = `${circularIndex}%`;
        
        const ctxCircular = document.getElementById('circular-index-chart').getContext('2d');
        circularIndexChart = new Chart(ctxCircular, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [circularIndex, 100 - circularIndex],
                    backgroundColor: [
                        '#FF9F40',
                        '#E0E0E0'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                cutout: '75%',
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        enabled: false
                    }
                }
            }
        });
        
        // Update efficiency metrics
        const efficiencyMetrics = document.getElementById('efficiency-metrics');
        efficiencyMetrics.innerHTML = '';
        
        Object.entries(forwardMetrics.efficiency_metrics).forEach(([key, value]) => {
            const metricName = key.charAt(0).toUpperCase() + key.slice(1);
            const trend = value.trend;
            const percentChange = value.percent_change;
            
            let trendIcon = 'fa-arrow-up';
            let trendClass = 'text-success';
            
            if (trend === 'declining') {
                trendIcon = 'fa-arrow-down';
                trendClass = 'text-danger';
            } else if (trend === 'stable') {
                trendIcon = 'fa-equals';
                trendClass = 'text-warning';
            }
            
            const metricCol = document.createElement('div');
            metricCol.className = 'col-md-6 mb-3';
            metricCol.innerHTML = `
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">${metricName} Efficiency</h5>
                            <span class="badge bg-light">
                                <i class="fas ${trendIcon} ${trendClass} me-1"></i>
                                ${percentChange}%
                            </span>
                        </div>
                        <div class="progress mb-2" style="height: 10px;">
                            <div class="progress-bar bg-info" role="progressbar" style="width: ${percentChange}%;" 
                                aria-valuenow="${percentChange}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <p class="text-muted small mb-0">
                            ${trend.charAt(0).toUpperCase() + trend.slice(1)} trend showing a ${percentChange}% 
                            ${trend === 'improving' ? 'improvement' : 'change'} in ${metricName.toLowerCase()} efficiency 
                            over the next 3 years.
                        </p>
                    </div>
                </div>
            `;
            
            efficiencyMetrics.appendChild(metricCol);
        });
    }
    
    function updateNarrativeAlignment(data) {
        const narrative = data.modules.narrative_alignment;
        
        // Update SDG alignment
        const sdgContainer = document.getElementById('sdg-alignment');
        sdgContainer.innerHTML = '';
        
        const sdgRow = document.createElement('div');
        sdgRow.className = 'row g-2';
        
        // Map of SDG numbers to colors
        const sdgColors = {
            1: '#E5243B',  // No Poverty
            2: '#DDA63A',  // Zero Hunger
            3: '#4C9F38',  // Good Health and Well-being
            4: '#C5192D',  // Quality Education
            5: '#FF3A21',  // Gender Equality
            6: '#26BDE2',  // Clean Water and Sanitation
            7: '#FCC30B',  // Affordable and Clean Energy
            8: '#A21942',  // Decent Work and Economic Growth
            9: '#FD6925',  // Industry, Innovation and Infrastructure
            10: '#DD1367', // Reduced Inequalities
            11: '#FD9D24', // Sustainable Cities and Communities
            12: '#BF8B2E', // Responsible Consumption and Production
            13: '#3F7E44', // Climate Action
            14: '#0A97D9', // Life Below Water
            15: '#56C02B', // Life on Land
            16: '#00689D', // Peace, Justice and Strong Institutions
            17: '#19486A'  // Partnerships for the Goals
        };
        
        narrative.sdg_mapping.forEach(sdg => {
            const sdgCol = document.createElement('div');
            sdgCol.className = 'col-3 col-md-2';
            
            const color = sdgColors[sdg] || '#777777';
            
            sdgCol.innerHTML = `
                <div class="sdg-icon" style="background-color: ${color};">
                    <span>${sdg}</span>
                </div>
            `;
            
            sdgRow.appendChild(sdgCol);
        });
        
        sdgContainer.appendChild(sdgRow);
        
        // Update key messages
        const keyMessages = document.getElementById('key-messages');
        keyMessages.innerHTML = '';
        
        const messagesList = document.createElement('ul');
        messagesList.className = 'list-unstyled';
        
        narrative.key_messages.forEach(message => {
            const messageItem = document.createElement('li');
            messageItem.className = 'mb-2';
            messageItem.innerHTML = `
                <div class="d-flex">
                    <i class="fas fa-check-circle text-success mt-1 me-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            messagesList.appendChild(messageItem);
        });
        
        keyMessages.appendChild(messagesList);
        
        // Update investor story
        const investorStory = document.getElementById('investor-story');
        investorStory.innerHTML = `<p>${narrative.investor_story}</p>`;
        
        // Update recommended actions
        const recommendedActions = document.getElementById('recommended-actions');
        recommendedActions.innerHTML = '';
        
        // Sample recommended actions (in a real implementation, these would come from the API)
        const actions = [
            {
                title: 'Enhance CSRD Readiness',
                description: 'Develop a materiality assessment process and formalize governance oversight of sustainability',
                icon: 'clipboard-check',
                color: 'primary'
            },
            {
                title: 'Improve Data Collection',
                description: 'Implement systematic data collection for Scope 3 emissions and supply chain impacts',
                icon: 'database',
                color: 'info'
            },
            {
                title: 'Develop Science-Based Targets',
                description: 'Set formal science-based targets aligned with 1.5°C pathway',
                icon: 'bullseye',
                color: 'success'
            },
            {
                title: 'Enhance Sustainability Reporting',
                description: 'Publish an annual sustainability report following GRI Standards',
                icon: 'file-alt',
                color: 'warning'
            }
        ];
        
        actions.forEach(action => {
            const actionCol = document.createElement('div');
            actionCol.className = 'col-md-6 mb-3';
            actionCol.innerHTML = `
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <span class="icon-circle bg-${action.color} text-white me-3">
                                <i class="fas fa-${action.icon}"></i>
                            </span>
                            <h6 class="mb-0">${action.title}</h6>
                        </div>
                        <p class="text-muted small mb-0">${action.description}</p>
                    </div>
                </div>
            `;
            
            recommendedActions.appendChild(actionCol);
        });
    }
    
    // Generate Report button
    if (generateReportBtn) {
        generateReportBtn.addEventListener('click', function() {
            alert('Report generation feature will be available in the next release.');
        });
    }
});
</script>

<style>
.icon-circle {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
}

.framework-chart-container {
    height: 300px;
    position: relative;
}

.sdg-icon {
    width: 100%;
    padding-top: 100%; /* Creates a square */
    border-radius: 8px;
    position: relative;
    color: white;
    font-weight: bold;
    margin-bottom: 10px;
}

.sdg-icon span {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 1.2rem;
}

.placeholder-text {
    color: #999;
    font-style: italic;
}

#assessment-results {
    animation: fadeIn 0.5s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
</style>
{% endblock %}