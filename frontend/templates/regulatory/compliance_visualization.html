<!-- Compliance Visualization Card - Moved from Strategy Hub to Regulatory AI Agent -->
<div class="p-3">
    <!-- Compliance Visualization Container -->
    <div id="compliance-visualization-container">
        <!-- Framework Selection & Analysis Form -->
        <div class="card bg-darker border-0 rounded-4 shadow-sm mb-4">
            <div class="card-body p-4">
                <h5 class="d-flex align-items-center mb-3 text-danger">
                    <i class="fas fa-balance-scale me-2"></i> Compliance Gap Analysis
                </h5>
                
                <div class="mb-3">
                    <label for="documentInput" class="form-label text-muted small">Select or upload a sustainability report</label>
                    <select class="form-select bg-darker border-0 rounded-pill" id="documentInput">
                        <option value="">Select a document...</option>
                        <option value="latest_report">Latest Sustainability Report</option>
                        <option value="annual_report">Annual Report 2024</option>
                        <option value="climate_disclosure">Climate Disclosure 2024</option>
                        <option value="upload_new">Upload a new document...</option>
                    </select>
                </div>
                
                <div id="uploadDocumentForm" style="display: none;" class="mb-3">
                    <div class="input-group">
                        <input type="file" class="form-control bg-darker border-0" id="complianceDocumentUpload" accept=".pdf,.docx,.txt">
                        <button class="btn btn-outline-danger" type="button" id="uploadComplianceDocBtn">
                            <i class="fas fa-upload me-1"></i> Upload
                        </button>
                    </div>
                </div>
                
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label for="frameworkSelect" class="form-label text-muted small">Regulatory framework</label>
                        <select class="form-select bg-darker border-0 rounded-pill" id="frameworkSelect">
                            <option value="CSRD">CSRD (Corporate Sustainability Reporting Directive)</option>
                            <option value="ESRS">ESRS (European Sustainability Reporting Standards)</option>
                            <option value="SFDR">SFDR (Sustainable Finance Disclosure Regulation)</option>
                            <option value="TCFD">TCFD (Task Force on Climate-related Financial Disclosures)</option>
                            <option value="GRI">GRI (Global Reporting Initiative)</option>
                            <option value="SASB">SASB (Sustainability Accounting Standards Board)</option>
                        </select>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="industryComplianceInput" class="form-label text-muted small">Industry sector</label>
                        <select class="form-select bg-darker border-0 rounded-pill" id="industryComplianceInput">
                            <option value="General">General</option>
                            <option value="Technology">Technology</option>
                            <option value="Manufacturing">Manufacturing</option>
                            <option value="Energy">Energy</option>
                            <option value="Financial Services">Financial Services</option>
                            <option value="Healthcare">Healthcare</option>
                            <option value="Retail">Retail</option>
                            <option value="Transportation">Transportation</option>
                            <option value="Agriculture">Agriculture</option>
                            <option value="Construction">Construction</option>
                            <option value="Real Estate">Real Estate</option>
                        </select>
                    </div>
                </div>
                
                <form id="complianceAnalysisForm">
                    <div class="d-grid">
                        <button type="submit" class="btn btn-danger btn-lg rounded-pill" id="generateComplianceBtn">
                            <i class="fas fa-search me-2"></i> Analyze Compliance Gaps
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Loading Indicator -->
        <div id="complianceLoading" class="text-center my-5 py-5" style="display: none;">
            <div class="position-relative d-inline-block loading-container">
                <div class="spinner-grow text-danger" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Analyzing...</span>
                </div>
                <div class="spinner-grow text-danger position-absolute top-0 start-0" role="status" style="width: 3rem; height: 3rem; opacity: 0.3; animation-delay: 0.2s;">
                    <span class="visually-hidden">Analyzing...</span>
                </div>
                <div class="spinner-grow text-danger position-absolute top-0 start-0" role="status" style="width: 3rem; height: 3rem; opacity: 0.1; animation-delay: 0.4s;">
                    <span class="visually-hidden">Analyzing...</span>
                </div>
            </div>
            <p class="mt-4 text-danger fw-bold">Analyzing your document against regulatory requirements...</p>
            <div class="progress mt-2" style="height: 8px; max-width: 300px; margin: 0 auto;">
                <div class="progress-bar progress-bar-striped progress-bar-animated bg-danger" role="progressbar" style="width: 100%"></div>
            </div>
        </div>
        
        <!-- Compliance Results -->
        <div id="complianceResults" style="display: none;">
            <!-- Header with Framework Badge -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="mb-0 fw-bold" id="complianceFrameworkTitle">CSRD Compliance Analysis</h4>
                <div>
                    <span class="badge bg-danger rounded-pill px-3 py-2 me-2" id="complianceScoreBadge">72%</span>
                    <span class="badge bg-secondary rounded-pill px-3 py-2" id="complianceIndustryBadge">Technology</span>
                </div>
            </div>
            
            <!-- Compliance Overview Card -->
            <div class="card bg-darker border-0 rounded-4 shadow-sm mb-4">
                <div class="card-body p-4">
                    <h5 class="mb-3 text-danger"><i class="fas fa-chart-pie me-2"></i>Compliance Overview</h5>
                    <div id="complianceSummaryDiv" class="mb-4">
                        <p id="complianceSummary" class="lead"></p>
                    </div>
                    
                    <!-- Compliance Score Card -->
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="card bg-darker border-0 shadow-sm rounded-4">
                                <div class="card-body p-3">
                                    <h6 class="text-muted mb-1 small">Overall Compliance</h6>
                                    <div class="d-flex align-items-center">
                                        <div class="compliance-score-chart flex-grow-1" style="height: 6px;">
                                            <div class="progress" style="height: 6px;">
                                                <div id="overallComplianceBar" class="progress-bar bg-danger" role="progressbar" style="width: 72%"></div>
                                            </div>
                                        </div>
                                        <span id="overallComplianceScore" class="ms-3 text-danger fw-bold h4 mb-0">72%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-darker border-0 shadow-sm rounded-4">
                                <div class="card-body p-3">
                                    <h6 class="text-muted mb-1 small">Industry Average</h6>
                                    <div class="d-flex align-items-center">
                                        <div class="compliance-score-chart flex-grow-1" style="height: 6px;">
                                            <div class="progress" style="height: 6px;">
                                                <div id="industryComplianceBar" class="progress-bar bg-secondary" role="progressbar" style="width: 65%"></div>
                                            </div>
                                        </div>
                                        <span id="industryComplianceScore" class="ms-3 text-secondary fw-bold h4 mb-0">65%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Compliance Heatmap -->
            <div class="card bg-darker border-0 rounded-4 shadow-sm mb-4">
                <div class="card-body p-4">
                    <h5 class="mb-3 text-danger"><i class="fas fa-th me-2"></i>Compliance Heatmap</h5>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small text-muted">Compliance level:</span>
                            <div class="d-flex gap-2 align-items-center">
                                <span class="small"><i class="fas fa-square text-danger"></i> Low</span>
                                <span class="small"><i class="fas fa-square text-warning"></i> Medium</span>
                                <span class="small"><i class="fas fa-square text-success"></i> High</span>
                            </div>
                        </div>
                        
                        <!-- Compliance Heatmap Container -->
                        <div id="complianceHeatmapContainer" class="py-2" style="min-height: 350px">
                            <!-- Will be generated by JS -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Compliance Gap Details -->
            <div class="card bg-darker border-0 rounded-4 shadow-sm mb-4">
                <div class="card-body p-4">
                    <h5 class="mb-3 text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Critical Gaps</h5>
                    
                    <div id="criticalGapsList" class="mb-4">
                        <!-- Generated by JavaScript -->
                    </div>
                    
                    <h5 class="mb-3 text-warning"><i class="fas fa-exclamation-circle me-2"></i>Improvement Areas</h5>
                    
                    <div id="improvementAreasList" class="mb-4">
                        <!-- Generated by JavaScript -->
                    </div>
                    
                    <h5 class="mb-3 text-success"><i class="fas fa-check-circle me-2"></i>Strengths</h5>
                    
                    <div id="strengthsList">
                        <!-- Generated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="d-flex justify-content-between">
                <button class="btn btn-outline-danger rounded-pill" id="backToComplianceForm">
                    <i class="fas fa-arrow-left me-2"></i> New Analysis
                </button>
                
                <div>
                    <button class="btn btn-outline-secondary rounded-pill me-2" id="exportComplianceBtn">
                        <i class="fas fa-file-export me-2"></i> Export
                    </button>
                    <button class="btn btn-danger rounded-pill" id="generateComplianceReportBtn">
                        <i class="fas fa-file-pdf me-2"></i> Full Compliance Report
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for Compliance Visualization -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set up document selector
    const documentInput = document.getElementById('documentInput');
    const uploadDocumentForm = document.getElementById('uploadDocumentForm');
    
    if (documentInput) {
        documentInput.addEventListener('change', function() {
            if (this.value === 'upload_new') {
                uploadDocumentForm.style.display = 'block';
            } else {
                uploadDocumentForm.style.display = 'none';
            }
        });
    }
    
    // Set up compliance analysis form
    const complianceForm = document.getElementById('complianceAnalysisForm');
    if (complianceForm) {
        complianceForm.addEventListener('submit', function(e) {
            e.preventDefault();
            generateComplianceAnalysis();
        });
    }
    
    // Back to form button
    const backToFormBtn = document.getElementById('backToComplianceForm');
    if (backToFormBtn) {
        backToFormBtn.addEventListener('click', function() {
            document.getElementById('complianceResults').style.display = 'none';
            document.getElementById('compliance-visualization-container').querySelector('form').reset();
            document.getElementById('uploadDocumentForm').style.display = 'none';
            document.getElementById('complianceLoading').style.display = 'none';
        });
    }
    
    // Generate compliance report button
    const generateReportBtn = document.getElementById('generateComplianceReportBtn');
    if (generateReportBtn) {
        generateReportBtn.addEventListener('click', function() {
            alert('Generating full compliance report...');
            // In a real implementation, this would trigger a PDF generation
        });
    }
    
    // Export compliance data button
    const exportBtn = document.getElementById('exportComplianceBtn');
    if (exportBtn) {
        exportBtn.addEventListener('click', function() {
            alert('Exporting compliance data...');
            // In a real implementation, this would export JSON or CSV
        });
    }
});

/**
 * Generate compliance analysis based on form inputs
 */
function generateComplianceAnalysis() {
    const documentInput = document.getElementById('documentInput').value;
    const frameworkSelect = document.getElementById('frameworkSelect').value;
    const industryInput = document.getElementById('industryComplianceInput').value;
    
    // Basic validation
    if (!documentInput) {
        alert('Please select a document for analysis.');
        return;
    }
    
    // Show loading animation
    document.getElementById('complianceLoading').style.display = 'block';
    document.getElementById('complianceResults').style.display = 'none';
    
    // In a real implementation, this would call the regulatory_ai_agent API
    // We now call the regulatory AI agent API endpoint instead of using mocked data
    fetch('/regulatory-ai/api/assessment', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            document_id: documentInput,
            framework_id: frameworkSelect,
            industry: industryInput
        })
    })
    .then(response => response.json())
    .then(data => {
        // Process the API response
        displayComplianceResults(data);
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while analyzing compliance. Please try again.');
        document.getElementById('complianceLoading').style.display = 'none';
    });
}

/**
 * Display compliance results in the UI
 */
function displayComplianceResults(data) {
    // Update UI with analysis results
    document.getElementById('complianceLoading').style.display = 'none';
    document.getElementById('complianceResults').style.display = 'block';
    
    // Update framework title and badges
    document.getElementById('complianceFrameworkTitle').textContent = 
        data.framework_id + ' Compliance Analysis';
    document.getElementById('complianceIndustryBadge').textContent = data.industry;
    document.getElementById('complianceScoreBadge').textContent = data.overall_score + '%';
    
    // Update compliance summary
    document.getElementById('complianceSummary').textContent = data.summary;
    
    // Update score bars
    document.getElementById('overallComplianceBar').style.width = data.overall_score + '%';
    document.getElementById('overallComplianceScore').textContent = data.overall_score + '%';
    document.getElementById('industryComplianceBar').style.width = data.industry_average + '%';
    document.getElementById('industryComplianceScore').textContent = data.industry_average + '%';
    
    // Populate critical gaps
    const criticalGapsList = document.getElementById('criticalGapsList');
    criticalGapsList.innerHTML = '';
    
    if (data.critical_gaps && data.critical_gaps.length > 0) {
        data.critical_gaps.forEach(gap => {
            const gapElement = document.createElement('div');
            gapElement.className = 'alert alert-danger mb-2';
            gapElement.innerHTML = `
                <h6 class="alert-heading mb-1">${gap.category}</h6>
                <p class="mb-0">${gap.description}</p>
            `;
            criticalGapsList.appendChild(gapElement);
        });
    } else {
        criticalGapsList.innerHTML = '<p class="text-muted">No critical gaps identified.</p>';
    }
    
    // Populate improvement areas
    const improvementAreasList = document.getElementById('improvementAreasList');
    improvementAreasList.innerHTML = '';
    
    if (data.improvement_areas && data.improvement_areas.length > 0) {
        data.improvement_areas.forEach(area => {
            const areaElement = document.createElement('div');
            areaElement.className = 'alert alert-warning mb-2';
            areaElement.innerHTML = `
                <h6 class="alert-heading mb-1">${area.category}</h6>
                <p class="mb-0">${area.description}</p>
            `;
            improvementAreasList.appendChild(areaElement);
        });
    } else {
        improvementAreasList.innerHTML = '<p class="text-muted">No improvement areas identified.</p>';
    }
    
    // Populate strengths
    const strengthsList = document.getElementById('strengthsList');
    strengthsList.innerHTML = '';
    
    if (data.strengths && data.strengths.length > 0) {
        data.strengths.forEach(strength => {
            const strengthElement = document.createElement('div');
            strengthElement.className = 'alert alert-success mb-2';
            strengthElement.innerHTML = `
                <h6 class="alert-heading mb-1">${strength.category}</h6>
                <p class="mb-0">${strength.description}</p>
            `;
            strengthsList.appendChild(strengthElement);
        });
    } else {
        strengthsList.innerHTML = '<p class="text-muted">No strengths identified.</p>';
    }
    
    // Generate compliance heatmap
    generateComplianceHeatmap(data.categories);
}

/**
 * Generate compliance heatmap visualization
 */
function generateComplianceHeatmap(categories) {
    const container = document.getElementById('complianceHeatmapContainer');
    container.innerHTML = '';
    
    if (!categories || categories.length === 0) {
        container.innerHTML = '<p class="text-muted">No category data available for heatmap.</p>';
        return;
    }
    
    // Create heatmap grid
    const heatmapGrid = document.createElement('div');
    heatmapGrid.className = 'row g-3';
    
    categories.forEach(category => {
        // Create category cell
        const cell = document.createElement('div');
        cell.className = 'col-md-6 col-lg-4';
        
        // Determine cell color based on score
        let colorClass = 'bg-danger bg-opacity-15 border-danger';
        if (category.score >= 70) {
            colorClass = 'bg-success bg-opacity-15 border-success';
        } else if (category.score >= 50) {
            colorClass = 'bg-warning bg-opacity-15 border-warning';
        }
        
        cell.innerHTML = `
            <div class="card ${colorClass} border-start border-4 rounded-3">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between">
                        <h6 class="mb-1">${category.name}</h6>
                        <span class="fw-bold">${category.score}%</span>
                    </div>
                    <p class="text-muted small mb-0">${category.description.substring(0, 120)}${category.description.length > 120 ? '...' : ''}</p>
                </div>
            </div>
        `;
        
        heatmapGrid.appendChild(cell);
    });
    
    container.appendChild(heatmapGrid);
}
</script>