{% extends "base.html" %}

{% block title %}Regulatory Document Upload - SustainaTrendâ„¢{% endblock %}

{% block additional_styles %}
<style>
  .upload-container {
    background-color: var(--bs-light);
    border: 2px dashed var(--bs-gray-400);
    border-radius: 10px;
    padding: 2rem;
    text-align: center;
    margin-bottom: 1.5rem;
    position: relative;
    transition: all 0.3s ease;
  }
  
  .upload-container.drag-over {
    border-color: var(--bs-primary);
    background-color: rgba(13, 110, 253, 0.05);
  }
  
  .upload-icon {
    font-size: 3rem;
    color: var(--bs-gray-600);
    margin-bottom: 1rem;
  }
  
  .upload-container.drag-over .upload-icon {
    color: var(--bs-primary);
  }
  
  .upload-title {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }
  
  .upload-subtitle {
    color: var(--bs-gray-600);
    margin-bottom: 1rem;
  }
  
  .file-input {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
  }
  
  .uploaded-file {
    display: flex;
    align-items: center;
    background-color: var(--bs-light);
    border: 1px solid var(--bs-gray-300);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
  }
  
  .file-icon {
    font-size: 1.5rem;
    margin-right: 1rem;
  }
  
  .file-info {
    flex-grow: 1;
  }
  
  .file-name {
    font-weight: 600;
    margin-bottom: 0.25rem;
  }
  
  .file-size {
    font-size: 0.875rem;
    color: var(--bs-gray-600);
  }
  
  .file-actions {
    display: flex;
    gap: 0.5rem;
  }
  
  .progress-container {
    margin-top: 1rem;
  }
  
  .preview-container {
    margin-top: 1.5rem;
    padding: 1.5rem;
    border: 1px solid var(--bs-gray-300);
    border-radius: 8px;
    background-color: var(--bs-light);
  }
  
  .validation-item {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
  }
  
  .validation-icon {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    margin-right: 0.75rem;
  }
  
  .validation-icon.success {
    background-color: var(--bs-success);
    color: white;
  }
  
  .validation-icon.warning {
    background-color: var(--bs-warning);
    color: white;
  }
  
  .validation-icon.error {
    background-color: var(--bs-danger);
    color: white;
  }
  
  .validation-icon.pending {
    background-color: var(--bs-gray-400);
    color: white;
  }
  
  .framework-badge {
    display: inline-block;
    padding: 0.35rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
  }
  
  .framework-badge.primary {
    background-color: rgba(13, 110, 253, 0.1);
    color: var(--bs-primary);
  }
  
  .framework-badge.success {
    background-color: rgba(25, 135, 84, 0.1);
    color: var(--bs-success);
  }
  
  .framework-badge.info {
    background-color: rgba(13, 202, 240, 0.1);
    color: var(--bs-info);
  }
  
  .compliance-table th {
    font-weight: 600;
    background-color: var(--bs-gray-100);
  }
  
  .compliance-level {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.875rem;
    font-weight: 600;
  }
  
  .compliance-level.high {
    background-color: rgba(25, 135, 84, 0.1);
    color: var(--bs-success);
  }
  
  .compliance-level.medium {
    background-color: rgba(255, 193, 7, 0.1);
    color: var(--bs-warning);
  }
  
  .compliance-level.low {
    background-color: rgba(220, 53, 69, 0.1);
    color: var(--bs-danger);
  }

  .results-feed {
    max-height: 500px;
    overflow-y: auto;
    padding-right: 0.5rem;
  }

  .result-item {
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    border: 1px solid var(--bs-gray-300);
    background-color: var(--bs-white);
  }

  .result-type {
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.5rem;
  }

  .result-content {
    font-size: 0.95rem;
  }

  .result-title {
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  /* Dark mode adjustments */
  @media (prefers-color-scheme: dark) {
    .upload-container {
      background-color: var(--bs-dark);
      border-color: var(--bs-gray-700);
    }
    
    .upload-container.drag-over {
      background-color: rgba(13, 110, 253, 0.1);
    }
    
    .uploaded-file, .preview-container {
      background-color: var(--bs-dark);
      border-color: var(--bs-gray-700);
    }
    
    .compliance-table th {
      background-color: var(--bs-gray-800);
    }
    
    .result-item {
      background-color: var(--bs-dark);
      border-color: var(--bs-gray-700);
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="row">
    <div class="col-12">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{{ url_for('analytics.home') }}">Home</a></li>
          <li class="breadcrumb-item"><a href="{{ url_for('regulatory_ai.regulatory_ai_dashboard') }}">Regulatory AI</a></li>
          <li class="breadcrumb-item active" aria-current="page">Document Upload</li>
        </ol>
      </nav>
      
      <h1 class="mb-4">Regulatory Document Upload & Analysis</h1>
      
      <div class="alert alert-info">
        <div class="d-flex">
          <div class="me-3">
            <i class="fas fa-info-circle fa-2x"></i>
          </div>
          <div>
            <h5 class="alert-heading">Enhanced Document Processing</h5>
            <p class="mb-0">Upload your sustainability reports, ESG disclosures, or other regulatory documents for AI-powered analysis. Our system will extract key information, assess compliance with major frameworks (CSRD, ESRS, SFDR, TCFD), and provide detailed recommendations.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="row mt-3">
    <div class="col-lg-8">
      <!-- Document Upload Area -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
          <h4 class="card-title mb-0">Upload Document</h4>
        </div>
        <div class="card-body">
          <div class="upload-container" id="dropZone">
            <i class="fas fa-file-upload upload-icon"></i>
            <h5 class="upload-title">Drag and drop your file here</h5>
            <p class="upload-subtitle">or click to browse files</p>
            <p class="small text-muted">Supported formats: PDF, DOCX, DOC, XLSX, CSV, TXT (max 50MB)</p>
            <input type="file" class="file-input" id="fileInput" accept=".pdf,.docx,.doc,.xlsx,.csv,.txt">
          </div>
          
          <div id="uploadedFileContainer" class="d-none">
            <div class="uploaded-file" id="uploadedFile">
              <div class="file-icon"><i class="fas fa-file-pdf"></i></div>
              <div class="file-info">
                <div class="file-name" id="fileName">document.pdf</div>
                <div class="file-size" id="fileSize">2.4 MB</div>
              </div>
              <div class="file-actions">
                <button class="btn btn-sm btn-outline-danger" id="removeFile">
                  <i class="fas fa-times"></i> Remove
                </button>
              </div>
            </div>
            
            <div class="progress-container d-none" id="progressContainer">
              <label class="form-label">Processing document...</label>
              <div class="progress">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" id="progressBar" style="width: 0%"></div>
              </div>
              <small class="text-muted" id="progressStatus">Initializing...</small>
            </div>
            
            <div class="mt-3">
              <div class="form-group mb-3">
                <label for="frameworkSelect" class="form-label">Primary Regulatory Framework</label>
                <select class="form-select" id="frameworkSelect">
                  <option value="ESRS">European Sustainability Reporting Standards (ESRS)</option>
                  <option value="CSRD">Corporate Sustainability Reporting Directive (CSRD)</option>
                  <option value="SFDR">Sustainable Finance Disclosure Regulation (SFDR)</option>
                  <option value="TCFD">Task Force on Climate-related Financial Disclosures (TCFD)</option>
                  <option value="ISSB">International Sustainability Standards Board (ISSB)</option>
                  <option value="SEC">SEC Climate Disclosure Rules</option>
                </select>
              </div>
              
              <div class="form-group mb-3">
                <label for="analysisType" class="form-label">Analysis Type</label>
                <select class="form-select" id="analysisType">
                  <option value="compliance">Regulatory Compliance</option>
                  <option value="gap">Gap Analysis</option>
                  <option value="recommendations">Implementation Recommendations</option>
                  <option value="comprehensive">Comprehensive Analysis</option>
                </select>
              </div>
              
              <div class="d-grid gap-2">
                <button class="btn btn-primary" id="analyzeBtn">
                  <i class="fas fa-robot me-2"></i>Analyze Document
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Analysis Results -->
      <div class="card shadow-sm mb-4 d-none" id="resultsCard">
        <div class="card-header bg-white">
          <h4 class="card-title mb-0">Analysis Results</h4>
        </div>
        <div class="card-body">
          <!-- Document Information -->
          <div class="mb-4">
            <h5><i class="fas fa-file-alt me-2"></i>Document Information</h5>
            <div class="row">
              <div class="col-md-6">
                <p><strong>Filename:</strong> <span id="resultFileName">sustainability-report-2025.pdf</span></p>
                <p><strong>Document Type:</strong> <span id="resultDocType">Sustainability Report</span></p>
                <p><strong>Page Count:</strong> <span id="resultPageCount">32</span></p>
              </div>
              <div class="col-md-6">
                <p><strong>Primary Framework:</strong> <span id="resultFramework">ESRS</span></p>
                <p><strong>Analysis Type:</strong> <span id="resultAnalysisType">Comprehensive</span></p>
                <p><strong>Overall Compliance:</strong> <span id="resultCompliance" class="compliance-level medium">Medium</span></p>
              </div>
            </div>
          </div>
          
          <!-- Detected Frameworks -->
          <div class="mb-4">
            <h5><i class="fas fa-tags me-2"></i>Detected Frameworks</h5>
            <div id="detectedFrameworks">
              <span class="framework-badge primary">ESRS</span>
              <span class="framework-badge success">CSRD</span>
              <span class="framework-badge info">TCFD</span>
            </div>
          </div>
          
          <!-- Validation Results -->
          <div class="mb-4">
            <h5><i class="fas fa-check-circle me-2"></i>Document Validation</h5>
            <div id="validationResults">
              <div class="validation-item">
                <div class="validation-icon success"><i class="fas fa-check"></i></div>
                <div>Document structure is complete and well-formed</div>
              </div>
              <div class="validation-item">
                <div class="validation-icon success"><i class="fas fa-check"></i></div>
                <div>Text extraction successful (32 pages, approx. 15,200 words)</div>
              </div>
              <div class="validation-item">
                <div class="validation-icon warning"><i class="fas fa-exclamation"></i></div>
                <div>Some tables may have incomplete data extraction</div>
              </div>
              <div class="validation-item">
                <div class="validation-icon success"><i class="fas fa-check"></i></div>
                <div>Document contains expected sustainability disclosures</div>
              </div>
            </div>
          </div>
          
          <!-- Compliance Table -->
          <div class="mb-4">
            <h5><i class="fas fa-clipboard-check me-2"></i>Compliance Assessment</h5>
            <div class="table-responsive">
              <table class="table compliance-table">
                <thead>
                  <tr>
                    <th>Category</th>
                    <th>Framework</th>
                    <th>Compliance Level</th>
                    <th>Key Gaps</th>
                  </tr>
                </thead>
                <tbody id="complianceTable">
                  <tr>
                    <td>Climate Change</td>
                    <td>ESRS E1</td>
                    <td><span class="compliance-level medium">Medium</span></td>
                    <td>Scope 3 emissions incomplete, transition plan lacks details</td>
                  </tr>
                  <tr>
                    <td>Water & Marine Resources</td>
                    <td>ESRS E3</td>
                    <td><span class="compliance-level low">Low</span></td>
                    <td>Missing water stress assessment, incomplete metrics</td>
                  </tr>
                  <tr>
                    <td>Biodiversity</td>
                    <td>ESRS E4</td>
                    <td><span class="compliance-level high">High</span></td>
                    <td>Minor gaps in impact assessment methodology</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          
          <!-- Action Buttons -->
          <div class="d-flex gap-2">
            <button class="btn btn-outline-primary" id="generateReportBtn">
              <i class="fas fa-file-pdf me-2"></i>Generate Report
            </button>
            <button class="btn btn-outline-secondary" id="saveResultsBtn">
              <i class="fas fa-save me-2"></i>Save Results
            </button>
            <button class="btn btn-outline-success" id="showComplianceVisualizationBtn">
              <i class="fas fa-chart-pie me-2"></i>Visualize Compliance
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-4">
      <!-- Document Preview -->
      <div class="card shadow-sm mb-4 d-none" id="previewCard">
        <div class="card-header bg-white">
          <h4 class="card-title mb-0">Document Preview</h4>
        </div>
        <div class="card-body p-0">
          <div id="documentPreview" class="p-3">
            <div class="text-center py-5">
              <i class="fas fa-file-pdf fa-3x text-muted mb-3"></i>
              <p class="mb-0">Document preview will appear here after upload</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- AI Analysis Feed -->
      <div class="card shadow-sm mb-4 d-none" id="feedCard">
        <div class="card-header bg-white">
          <h4 class="card-title mb-0">AI Analysis Feed</h4>
        </div>
        <div class="card-body">
          <div class="results-feed" id="resultsFeed">
            <div class="result-item">
              <div class="result-type text-primary">Framework Detection</div>
              <div class="result-content">
                <div class="result-title">Multiple Frameworks Detected</div>
                <p>This document contains elements from ESRS, CSRD, and TCFD frameworks. Primary framework appears to be ESRS.</p>
              </div>
            </div>
            
            <div class="result-item">
              <div class="result-type text-success">Key Metrics</div>
              <div class="result-content">
                <div class="result-title">Carbon Emissions Data</div>
                <p>Found Scope 1 & 2 emissions data on page 15. Scope 3 emissions appear to be partially reported with methodology gaps.</p>
              </div>
            </div>
            
            <div class="result-item">
              <div class="result-type text-warning">Compliance Gap</div>
              <div class="result-content">
                <div class="result-title">ESRS E3 Water Disclosures</div>
                <p>Water-related disclosures on pages 21-22 are missing key metrics required by ESRS E3, including water withdrawal from water-stressed areas.</p>
              </div>
            </div>
            
            <div class="result-item">
              <div class="result-type text-info">Insight</div>
              <div class="result-content">
                <div class="result-title">Biodiversity Strategy</div>
                <p>Biodiversity strategy on page 24 is well-aligned with ESRS E4 requirements. Strong disclosures on impact assessment methodology.</p>
              </div>
            </div>
          </div>
          
          <!-- Ask Follow-up Question -->
          <div class="mt-4">
            <div class="form-group">
              <label for="followupQuestion" class="form-label">Ask a Follow-up Question</label>
              <div class="input-group">
                <input type="text" class="form-control" id="followupQuestion" placeholder="e.g., What are the key gaps in climate disclosures?">
                <button class="btn btn-primary" id="askBtn">
                  <i class="fas fa-paper-plane"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // DOM Elements
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const uploadedFileContainer = document.getElementById('uploadedFileContainer');
    const uploadedFile = document.getElementById('uploadedFile');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const removeFile = document.getElementById('removeFile');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const progressStatus = document.getElementById('progressStatus');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const previewCard = document.getElementById('previewCard');
    const resultsCard = document.getElementById('resultsCard');
    const feedCard = document.getElementById('feedCard');
    const documentPreview = document.getElementById('documentPreview');
    
    // Drag and drop functionality
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
      dropZone.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight() {
      dropZone.classList.add('drag-over');
    }
    
    function unhighlight() {
      dropZone.classList.remove('drag-over');
    }
    
    // Handle file drop
    dropZone.addEventListener('drop', handleDrop, false);
    
    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      handleFiles(files);
    }
    
    // Handle file input change
    fileInput.addEventListener('change', function() {
      handleFiles(this.files);
    });
    
    // Handle file selection
    function handleFiles(files) {
      if (files.length > 0) {
        const file = files[0];
        displayFileInfo(file);
        updatePreview(file);
      }
    }
    
    // Display file information
    function displayFileInfo(file) {
      uploadedFileContainer.classList.remove('d-none');
      
      // Update file info
      fileName.textContent = file.name;
      fileSize.textContent = formatFileSize(file.size);
      
      // Update file icon based on type
      const fileIconElement = uploadedFile.querySelector('.file-icon i');
      if (file.name.endsWith('.pdf')) {
        fileIconElement.className = 'fas fa-file-pdf';
      } else if (file.name.endsWith('.docx') || file.name.endsWith('.doc')) {
        fileIconElement.className = 'fas fa-file-word';
      } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.csv')) {
        fileIconElement.className = 'fas fa-file-excel';
      } else {
        fileIconElement.className = 'fas fa-file-alt';
      }
    }
    
    // Format file size
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // Update document preview
    function updatePreview(file) {
      previewCard.classList.remove('d-none');
      
      // For PDF files, try to embed a preview
      if (file.name.endsWith('.pdf')) {
        const fileURL = URL.createObjectURL(file);
        documentPreview.innerHTML = `<embed src="${fileURL}" type="application/pdf" width="100%" height="400px">`;
      } else if (file.name.endsWith('.docx') || file.name.endsWith('.doc')) {
        documentPreview.innerHTML = `
          <div class="text-center py-4">
            <i class="fas fa-file-word fa-3x text-primary mb-3"></i>
            <h5>${file.name}</h5>
            <p class="text-muted">Word document preview not available</p>
          </div>
        `;
      } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.csv')) {
        documentPreview.innerHTML = `
          <div class="text-center py-4">
            <i class="fas fa-file-excel fa-3x text-success mb-3"></i>
            <h5>${file.name}</h5>
            <p class="text-muted">Excel/CSV preview not available</p>
          </div>
        `;
      } else if (file.type.startsWith('text/')) {
        // For text files, try to show the content
        const reader = new FileReader();
        reader.onload = function(e) {
          const content = e.target.result;
          documentPreview.innerHTML = `
            <div class="p-3">
              <pre style="white-space: pre-wrap; max-height: 400px; overflow-y: auto;">${content}</pre>
            </div>
          `;
        };
        reader.readAsText(file);
      } else {
        documentPreview.innerHTML = `
          <div class="text-center py-4">
            <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
            <h5>${file.name}</h5>
            <p class="text-muted">Preview not available for this file type</p>
          </div>
        `;
      }
    }
    
    // Remove file
    removeFile.addEventListener('click', function() {
      // Reset file input
      fileInput.value = '';
      
      // Hide containers
      uploadedFileContainer.classList.add('d-none');
      previewCard.classList.add('d-none');
      resultsCard.classList.add('d-none');
      feedCard.classList.add('d-none');
      progressContainer.classList.add('d-none');
      
      // Reset progress
      progressBar.style.width = '0%';
      progressStatus.textContent = 'Initializing...';
    });
    
    // Analyze document
    analyzeBtn.addEventListener('click', function() {
      // Show progress
      progressContainer.classList.remove('d-none');
      progressBar.style.width = '10%';
      progressStatus.textContent = 'Preparing document for upload...';
      
      // Get selected framework and analysis type
      const frameworkId = document.getElementById('frameworkSelect').value;
      const analysisType = document.getElementById('analysisType').value;
      
      // Create FormData object to send the file
      const formData = new FormData();
      formData.append('framework_id', frameworkId);
      formData.append('analysis_type', analysisType);
      
      // Get file from fileInput
      if (fileInput.files.length > 0) {
        formData.append('file', fileInput.files[0]);
        
        // Update progress
        progressBar.style.width = '20%';
        progressStatus.textContent = 'Uploading document...';
        
        // Make API request to file assessment endpoint
        fetch('/regulatory-ai/api/file-assessment', {
          method: 'POST',
          body: formData
        })
        .then(response => {
          progressBar.style.width = '70%';
          progressStatus.textContent = 'Processing server response...';
          
          if (!response.ok) {
            throw new Error(`Server responded with status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          // Complete progress
          progressBar.style.width = '100%';
          progressStatus.textContent = 'Analysis complete!';
          
          // Process assessment data
          processAssessmentResult(data);
          
          // Hide progress after a short delay
          setTimeout(function() {
            progressContainer.classList.add('d-none');
            
            // Show results
            resultsCard.classList.remove('d-none');
            feedCard.classList.remove('d-none');
            
            // Update result information
            document.getElementById('resultFileName').textContent = fileName.textContent;
            document.getElementById('resultFramework').textContent = frameworkId;
            document.getElementById('resultAnalysisType').textContent = document.getElementById('analysisType').options[document.getElementById('analysisType').selectedIndex].text;
            
            // Show document preview if available
            previewCard.classList.remove('d-none');
          }, 500);
        })
        .catch(error => {
          console.error('Error during document analysis:', error);
          progressContainer.classList.add('d-none');
          
          // Show error message
          alert(`Error analyzing document: ${error.message}. Please try again.`);
        });
      } else {
        progressContainer.classList.add('d-none');
        alert('Please select a file to analyze.');
      }
    });
    
    // Process the assessment result
    function processAssessmentResult(data) {
      // Clear previous results
      const complianceTable = document.getElementById('complianceTable');
      complianceTable.innerHTML = '';
      
      const resultsFeed = document.getElementById('resultsFeed');
      resultsFeed.innerHTML = '';
      
      const detectedFrameworks = document.getElementById('detectedFrameworks');
      detectedFrameworks.innerHTML = '';
      
      const validationResults = document.getElementById('validationResults');
      validationResults.innerHTML = '';
      
      // Update overall compliance score
      const overallScore = data.overall_score || 0;
      const complianceElement = document.getElementById('resultCompliance');
      let complianceLevel = 'low';
      if (overallScore >= 70) {
        complianceLevel = 'high';
      } else if (overallScore >= 40) {
        complianceLevel = 'medium';
      }
      complianceElement.className = `compliance-level ${complianceLevel}`;
      complianceElement.textContent = `${overallScore}/100`;
      
      // Add detected frameworks
      if (data.framework) {
        const frameworkBadge = document.createElement('span');
        frameworkBadge.className = 'framework-badge primary';
        frameworkBadge.textContent = data.framework;
        detectedFrameworks.appendChild(frameworkBadge);
      }
      
      // Add validation result items
      validationResults.innerHTML = `
        <div class="validation-item">
          <div class="validation-icon success"><i class="fas fa-check"></i></div>
          <div>Document processed successfully</div>
        </div>
      `;
      
      // Add compliance table rows
      if (data.categories) {
        Object.entries(data.categories).forEach(([categoryId, categoryData]) => {
          const row = document.createElement('tr');
          
          // Get category name
          let categoryName = categoryId;
          if (categoryData.name) {
            categoryName = categoryData.name;
          }
          
          // Get framework
          let framework = data.framework_id || '';
          
          // Get compliance level
          let score = categoryData.score || 0;
          let complianceClass = 'low';
          if (score >= 70) {
            complianceClass = 'high';
          } else if (score >= 40) {
            complianceClass = 'medium';
          }
          
          // Get key gaps
          let keyGaps = '';
          if (categoryData.findings && categoryData.findings.length > 0) {
            keyGaps = categoryData.findings[0];
          }
          
          // Create row cells
          row.innerHTML = `
            <td>${categoryName}</td>
            <td>${framework} ${categoryId}</td>
            <td><span class="compliance-level ${complianceClass}">${score}/100</span></td>
            <td>${keyGaps}</td>
          `;
          
          complianceTable.appendChild(row);
          
          // Add category findings to results feed
          if (categoryData.findings && categoryData.findings.length > 0) {
            const resultItem = document.createElement('div');
            resultItem.className = 'result-item';
            resultItem.innerHTML = `
              <div class="result-type text-primary">Category: ${categoryId}</div>
              <div class="result-content">
                <div class="result-title">${categoryName}</div>
                <p>${categoryData.findings[0]}</p>
              </div>
            `;
            resultsFeed.appendChild(resultItem);
          }
        });
      }
      
      // Add overall findings to results feed
      if (data.overall_findings && data.overall_findings.length > 0) {
        const resultItem = document.createElement('div');
        resultItem.className = 'result-item';
        resultItem.innerHTML = `
          <div class="result-type text-success">Overall Assessment</div>
          <div class="result-content">
            <div class="result-title">Key Findings</div>
            <p>${data.overall_findings[0]}</p>
          </div>
        `;
        resultsFeed.appendChild(resultItem);
      }
      
      // Add recommendations to results feed
      if (data.overall_recommendations && data.overall_recommendations.length > 0) {
        const resultItem = document.createElement('div');
        resultItem.className = 'result-item';
        resultItem.innerHTML = `
          <div class="result-type text-info">Recommendations</div>
          <div class="result-content">
            <div class="result-title">Improvement Actions</div>
            <p>${data.overall_recommendations[0]}</p>
          </div>
        `;
        resultsFeed.appendChild(resultItem);
      }
    }
    }
    
    // Action buttons
    document.getElementById('generateReportBtn').addEventListener('click', function() {
      alert('Generating comprehensive compliance report...');
    });
    
    document.getElementById('saveResultsBtn').addEventListener('click', function() {
      alert('Results saved successfully!');
    });
    
    document.getElementById('showComplianceVisualizationBtn').addEventListener('click', function() {
      window.location.href = '{{ url_for("regulatory_ai.compliance_visualization") }}';
    });
    
    // Follow-up question
    document.getElementById('askBtn').addEventListener('click', function() {
      const question = document.getElementById('followupQuestion').value;
      if (question.trim() !== '') {
        // Add user question to feed
        const userItem = document.createElement('div');
        userItem.className = 'result-item';
        userItem.innerHTML = `
          <div class="result-type text-secondary">Your Question</div>
          <div class="result-content">
            <p>${question}</p>
          </div>
        `;
        document.getElementById('resultsFeed').appendChild(userItem);
        
        // Get current framework
        const frameworkId = document.getElementById('resultFramework').textContent;
        
        // Create loading indicator
        const loadingItem = document.createElement('div');
        loadingItem.className = 'result-item';
        loadingItem.innerHTML = `
          <div class="result-type text-warning">Processing</div>
          <div class="result-content">
            <p><i class="fas fa-spinner fa-spin me-2"></i>Generating response...</p>
          </div>
        `;
        document.getElementById('resultsFeed').appendChild(loadingItem);
        
        // Scroll to bottom of feed
        const resultsFeed = document.getElementById('resultsFeed');
        resultsFeed.scrollTop = resultsFeed.scrollHeight;
        
        // Make API request for follow-up question
        fetch('/regulatory-ai/api/follow-up-question', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            question: question,
            framework_id: frameworkId,
            context: 'document_analysis'
          })
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`Server responded with status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          // Remove loading indicator
          resultsFeed.removeChild(loadingItem);
          
          // Add AI response
          const aiResponse = document.createElement('div');
          aiResponse.className = 'result-item';
          aiResponse.innerHTML = `
            <div class="result-type text-primary">AI Response</div>
            <div class="result-content">
              <div class="result-title">Response to Your Question</div>
              <p>${data.response || "I'm unable to answer that question based on the available information."}</p>
            </div>
          `;
          document.getElementById('resultsFeed').appendChild(aiResponse);
          
          // Scroll to bottom of feed again
          resultsFeed.scrollTop = resultsFeed.scrollHeight;
        })
        .catch(error => {
          // Remove loading indicator
          resultsFeed.removeChild(loadingItem);
          
          // Add error response
          const errorResponse = document.createElement('div');
          errorResponse.className = 'result-item';
          errorResponse.innerHTML = `
            <div class="result-type text-danger">Error</div>
            <div class="result-content">
              <div class="result-title">Error Processing Question</div>
              <p>Sorry, there was an error processing your question: ${error.message}</p>
            </div>
          `;
          document.getElementById('resultsFeed').appendChild(errorResponse);
          
          // Scroll to bottom of feed
          resultsFeed.scrollTop = resultsFeed.scrollHeight;
        });
        
        // Clear input
        document.getElementById('followupQuestion').value = '';
      }
    });
  });
</script>
{% endblock %}