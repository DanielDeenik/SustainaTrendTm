{% extends "finchat_base.html" %}

{% block title %}Strategy Hub{% endblock %}

{% block content %}
<div class="container-fluid dark-theme px-4 py-3">
    <div class="row">
        <div class="col-12">
            <h1 class="display-5 mb-4">Strategy Hub</h1>
            <p class="lead text-muted">
                Your unified center for strategy development, simulation, and monetization planning
            </p>
        </div>
    </div>

    <!-- Strategy Framework Tabs/Quick Select -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card bg-dark-card shadow-sm">
                <div class="card-body p-3">
                    <ul class="nav nav-pills nav-fill" id="strategyTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="frameworks-tab" data-bs-toggle="pill" data-bs-target="#frameworks-content" type="button" role="tab">
                                <i class="fas fa-chart-network"></i> Frameworks
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="simulation-tab" data-bs-toggle="pill" data-bs-target="#simulation-content" type="button" role="tab">
                                <i class="fas fa-vial"></i> Simulation
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="monetization-tab" data-bs-toggle="pill" data-bs-target="#monetization-content" type="button" role="tab">
                                <i class="fas fa-dollar-sign"></i> Monetization
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="planning-tab" data-bs-toggle="pill" data-bs-target="#planning-content" type="button" role="tab">
                                <i class="fas fa-tasks"></i> Strategic Planning
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content">
        <!-- FRAMEWORKS TAB -->
        <div class="tab-pane fade show active" id="frameworks-content" role="tabpanel">
            <!-- Frameworks -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card bg-dark-card shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">Strategic Frameworks</h5>
                            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#frameworkModal">
                                <i class="fas fa-info-circle"></i> Learn More
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                {% for framework_id, framework in frameworks.items() %}
                                <div class="col-md-4 mb-3">
                                    <div class="card h-100 bg-darker">
                                        <div class="card-body">
                                            <h5 class="card-title">
                                                <i class="fas fa-{{ framework.icon }}"></i> 
                                                {{ framework.name }}
                                            </h5>
                                            <p class="card-text small text-muted">{{ framework.description }}</p>
                                            <a href="{{ url_for('strategy.strategy_framework', framework_id=framework_id) }}" 
                                            class="btn btn-sm btn-outline-primary w-100">
                                                Apply Framework
                                            </a>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SIMULATION TAB -->
        <div class="tab-pane fade" id="simulation-content" role="tabpanel">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card bg-dark-card shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">Strategy Simulation</h5>
                            <button class="btn btn-sm btn-outline-info" id="runSimulationBtn">
                                <i class="fas fa-play"></i> Run Simulation
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="simulationFramework" class="form-label">Framework</label>
                                    <select class="form-select bg-darker" id="simulationFramework">
                                        {% for framework_id, framework in frameworks.items() %}
                                            <option value="{{ framework_id }}">{{ framework.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="simulationTimeframe" class="form-label">Timeframe</label>
                                    <select class="form-select bg-darker" id="simulationTimeframe">
                                        <option value="short">Short Term (1 Year)</option>
                                        <option value="medium" selected>Medium Term (3 Years)</option>
                                        <option value="long">Long Term (5+ Years)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-12">
                                    <label for="simulationParameters" class="form-label">Simulation Parameters</label>
                                    <div class="card bg-darker p-3">
                                        <div id="simulationParameters">
                                            <!-- Dynamic parameters will be added here based on selected framework -->
                                            <div class="placeholder-message text-muted text-center p-3">
                                                Select a framework to configure simulation parameters
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Simulation Results (initially hidden) -->
                            <div id="simulationResults" style="display: none;">
                                <hr>
                                <h5>Simulation Results</h5>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="card bg-darker h-100">
                                            <div class="card-header">
                                                <h6 class="card-title mb-0">Key Insights</h6>
                                            </div>
                                            <div class="card-body">
                                                <div id="simulationInsights">
                                                    <!-- Will be populated via JavaScript -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card bg-darker h-100">
                                            <div class="card-header">
                                                <h6 class="card-title mb-0">Strategic Recommendations</h6>
                                            </div>
                                            <div class="card-body">
                                                <ul class="list-group list-group-flush" id="simulationRecommendations">
                                                    <!-- Will be populated via JavaScript -->
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-12">
                                        <div class="card bg-darker">
                                            <div class="card-header">
                                                <h6 class="card-title mb-0">Visualization</h6>
                                            </div>
                                            <div class="card-body">
                                                <div id="simulationChartContainer" style="height: 300px;">
                                                    <!-- Simulation chart will be rendered here -->
                                                    <div class="d-flex justify-content-center align-items-center h-100">
                                                        <div class="text-center text-muted">
                                                            <i class="fas fa-chart-bar fa-3x mb-3"></i>
                                                            <p>Run a simulation to see results</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Loading Indicator -->
                            <div id="simulationLoading" class="text-center my-4" style="display: none;">
                                <div class="spinner-border text-info" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Running simulation...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MONETIZATION TAB -->
        <div class="tab-pane fade" id="monetization-content" role="tabpanel">
            <!-- Monetization -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card bg-dark-card shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">Monetization Strategies</h5>
                            <button class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#monetizationModal">
                                <i class="fas fa-dollar-sign"></i> View All Strategies
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                {% for strategy_id, strategy in monetization_strategies.items() %}
                                    {% if loop.index <= 6 %}
                                    <div class="col-md-4 mb-3">
                                        <div class="card h-100 bg-darker">
                                            <div class="card-body">
                                                <h5 class="card-title">
                                                    <i class="fas fa-{{ strategy.icon }}"></i> 
                                                    {{ strategy.name }}
                                                </h5>
                                                <p class="card-text small text-muted">{{ strategy.short_description }}</p>
                                                <div class="progress mt-2" style="height: 6px;">
                                                    <div class="progress-bar 
                                                        {% if strategy.default_potential >= 75 %}bg-success
                                                        {% elif strategy.default_potential >= 50 %}bg-info
                                                        {% else %}bg-warning{% endif %}" 
                                                        role="progressbar" 
                                                        style="width: {{ strategy.default_potential }}%" 
                                                        aria-valuenow="{{ strategy.default_potential }}" 
                                                        aria-valuemin="0" 
                                                        aria-valuemax="100">
                                                    </div>
                                                </div>
                                                <small class="d-block text-end text-muted mt-1">
                                                    Potential: {{ strategy.default_potential }}%
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            
                            <!-- Monetization Analysis Form -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="card bg-darker">
                                        <div class="card-header">
                                            <h6 class="card-title mb-0">Monetization Opportunity Analysis</h6>
                                        </div>
                                        <div class="card-body">
                                            <form id="monetizationAnalysisForm">
                                                <div class="mb-3">
                                                    <label for="monetizationCompanyName" class="form-label">Company Name</label>
                                                    <input type="text" class="form-control bg-black-50" id="monetizationCompanyName" placeholder="Enter your company name">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="monetizationDocumentText" class="form-label">Business Description</label>
                                                    <textarea class="form-control bg-black-50" id="monetizationDocumentText" rows="3" placeholder="Describe your business model and sustainability initiatives"></textarea>
                                                </div>
                                                <button type="button" id="analyzeMonetizationBtn" class="btn btn-success">
                                                    <i class="fas fa-search-dollar"></i> Analyze Opportunities
                                                </button>
                                            </form>
                                            
                                            <!-- Analysis Results (hidden by default) -->
                                            <div id="monetizationResults" class="mt-4" style="display: none;"></div>
                                            
                                            <!-- Loading Indicator -->
                                            <div id="monetizationLoading" class="text-center my-4" style="display: none;">
                                                <div class="spinner-border text-success" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <p class="mt-2">Analyzing monetization opportunities...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- STRATEGIC PLANNING TAB -->
        <div class="tab-pane fade" id="planning-content" role="tabpanel">
            <!-- Strategic Planning -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card bg-dark-card shadow-sm">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Integrated Strategic Planning</h5>
                        </div>
                        <div class="card-body">
                            <form id="strategicPlanForm">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="companyName" class="form-label">Company Name</label>
                                        <input type="text" class="form-control bg-darker" id="companyName" placeholder="Enter your company name">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="industrySelect" class="form-label">Industry</label>
                                        <select class="form-select bg-darker" id="industrySelect">
                                            <option value="Real Estate">Real Estate</option>
                                            <option value="Energy">Energy</option>
                                            <option value="Manufacturing">Manufacturing</option>
                                            <option value="Technology">Technology</option>
                                            <option value="Finance">Finance</option>
                                            <option value="Healthcare">Healthcare</option>
                                            <option value="Retail">Retail</option>
                                            <option value="Agriculture">Agriculture</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="documentText" class="form-label">Business Description (Optional)</label>
                                    <textarea class="form-control bg-darker" id="documentText" rows="3" placeholder="Enter a brief description of your business, goals, and sustainability initiatives"></textarea>
                                </div>
                                <button type="button" id="generatePlanBtn" class="btn btn-primary">
                                    <i class="fas fa-chart-line"></i> Generate Strategic Plan
                                </button>
                            </form>
                            
                            <!-- Results Area (Hidden by default) -->
                            <div id="planResults" class="mt-4" style="display: none;">
                                <hr>
                                <h5 id="planTitle">Strategic Plan for <span id="resultCompanyName"></span></h5>
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> 
                                    <span id="planSummary"></span>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card bg-darker mb-3">
                                            <div class="card-header">
                                                <h6 class="card-title mb-0">Recommended Strategies</h6>
                                            </div>
                                            <div class="card-body p-0">
                                                <ul class="list-group list-group-flush" id="recommendedStrategies">
                                                    <!-- Dynamically populated -->
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card bg-darker mb-3">
                                            <div class="card-header">
                                                <h6 class="card-title mb-0">Implementation Roadmap</h6>
                                            </div>
                                            <div class="card-body p-0">
                                                <ul class="list-group list-group-flush" id="implementationSteps">
                                                    <!-- Dynamically populated -->
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Loading Indicator (Hidden by default) -->
                            <div id="planLoading" class="text-center my-4" style="display: none;">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Generating your strategic plan...</p>
                            </div>
                            
                            <!-- Error Message (Hidden by default) -->
                            <div id="planError" class="alert alert-danger mt-4" style="display: none;">
                                <i class="fas fa-exclamation-triangle"></i> 
                                <span id="errorMessage">An error occurred while generating your plan.</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Frameworks Modal -->
<div class="modal fade" id="frameworkModal" tabindex="-1" aria-labelledby="frameworkModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark-card">
            <div class="modal-header">
                <h5 class="modal-title" id="frameworkModalLabel">Strategic Frameworks</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Framework</th>
                                <th>Description</th>
                                <th>Best For</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for framework_id, framework in frameworks.items() %}
                            <tr>
                                <td><strong>{{ framework.name }}</strong></td>
                                <td>{{ framework.description }}</td>
                                <td>
                                    {% if framework_id == 'porters' %}
                                    Industry competition analysis
                                    {% elif framework_id == 'swot' %}
                                    Internal/external evaluation
                                    {% elif framework_id == 'bcg' %}
                                    Product portfolio analysis
                                    {% elif framework_id == 'mckinsey' %}
                                    Portfolio ranking
                                    {% elif framework_id == 'blue_ocean' %}
                                    Market differentiation
                                    {% else %}
                                    Strategic planning
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Monetization Modal -->
<div class="modal fade" id="monetizationModal" tabindex="-1" aria-labelledby="monetizationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark-card">
            <div class="modal-header">
                <h5 class="modal-title" id="monetizationModalLabel">Monetization Strategies</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Strategy</th>
                                <th>Description</th>
                                <th>Potential</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for strategy_id, strategy in monetization_strategies.items() %}
                            <tr>
                                <td><strong>{{ strategy.name }}</strong></td>
                                <td>{{ strategy.short_description }}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1 me-2" style="height: 6px;">
                                            <div class="progress-bar 
                                                {% if strategy.default_potential >= 75 %}bg-success
                                                {% elif strategy.default_potential >= 50 %}bg-info
                                                {% else %}bg-warning{% endif %}" 
                                                role="progressbar" 
                                                style="width: {{ strategy.default_potential }}%" 
                                                aria-valuenow="{{ strategy.default_potential }}" 
                                                aria-valuemin="0" 
                                                aria-valuemax="100">
                                            </div>
                                        </div>
                                        <span class="text-muted small">{{ strategy.default_potential }}%</span>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // STRATEGIC PLANNING SECTION
    const generatePlanBtn = document.getElementById('generatePlanBtn');
    const planResults = document.getElementById('planResults');
    const planLoading = document.getElementById('planLoading');
    const planError = document.getElementById('planError');
    const companyNameField = document.getElementById('companyName');
    const industrySelect = document.getElementById('industrySelect');
    const documentTextField = document.getElementById('documentText');
    const resultCompanyName = document.getElementById('resultCompanyName');
    const planSummary = document.getElementById('planSummary');
    const recommendedStrategies = document.getElementById('recommendedStrategies');
    const implementationSteps = document.getElementById('implementationSteps');
    
    // Generate strategic plan
    if (generatePlanBtn) {
        generatePlanBtn.addEventListener('click', function() {
            // Get values
            const companyName = companyNameField.value.trim() || 'Your Company';
            const industry = industrySelect.value;
            const documentText = documentTextField.value.trim();
            
            // Show loading, hide results and errors
            planLoading.style.display = 'block';
            planResults.style.display = 'none';
            planError.style.display = 'none';
            
            // Call the API
            fetch('/api/strategy/strategic-plan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    company_name: companyName,
                    industry: industry,
                    document_text: documentText
                }),
            })
            .then(response => response.json())
            .then(data => {
                // Hide loading
                planLoading.style.display = 'none';
                
                if (data.success) {
                    // Show results
                    planResults.style.display = 'block';
                    
                    // Populate data
                    resultCompanyName.textContent = companyName;
                    planSummary.textContent = data.plan.summary || 'Strategic plan generated successfully.';
                    
                    // Clear previous results
                    recommendedStrategies.innerHTML = '';
                    implementationSteps.innerHTML = '';
                    
                    // Add recommended strategies
                    if (data.plan.recommendations && data.plan.recommendations.length > 0) {
                        data.plan.recommendations.forEach(strategy => {
                            const li = document.createElement('li');
                            li.className = 'list-group-item bg-darker';
                            li.innerHTML = `<strong>${strategy.title}</strong>: ${strategy.description}`;
                            recommendedStrategies.appendChild(li);
                        });
                    } else {
                        const li = document.createElement('li');
                        li.className = 'list-group-item bg-darker';
                        li.textContent = 'No specific recommendations available.';
                        recommendedStrategies.appendChild(li);
                    }
                    
                    // Add implementation steps
                    if (data.plan.implementation_steps && data.plan.implementation_steps.length > 0) {
                        data.plan.implementation_steps.forEach((step, index) => {
                            const li = document.createElement('li');
                            li.className = 'list-group-item bg-darker';
                            li.innerHTML = `<strong>Step ${index+1}:</strong> ${step}`;
                            implementationSteps.appendChild(li);
                        });
                    } else {
                        const li = document.createElement('li');
                        li.className = 'list-group-item bg-darker';
                        li.textContent = 'No implementation steps available.';
                        implementationSteps.appendChild(li);
                    }
                } else {
                    // Show error
                    planError.style.display = 'block';
                    document.getElementById('errorMessage').textContent = data.error || 'An unknown error occurred.';
                }
            })
            .catch(error => {
                // Hide loading and show error
                planLoading.style.display = 'none';
                planError.style.display = 'block';
                document.getElementById('errorMessage').textContent = 'Network error: ' + error.message;
            });
        });
    }
    
    // SIMULATION SECTION
    const runSimulationBtn = document.getElementById('runSimulationBtn');
    const simulationFramework = document.getElementById('simulationFramework');
    const simulationTimeframe = document.getElementById('simulationTimeframe');
    const simulationParameters = document.getElementById('simulationParameters');
    const simulationResults = document.getElementById('simulationResults');
    const simulationLoading = document.getElementById('simulationLoading');
    const simulationInsights = document.getElementById('simulationInsights');
    const simulationRecommendations = document.getElementById('simulationRecommendations');
    
    // Framework parameter templates
    const frameworkParams = {
        'porters': [
            { name: 'supplier_power', label: 'Supplier Power', type: 'range', min: 1, max: 10, default: 5 },
            { name: 'buyer_power', label: 'Buyer Power', type: 'range', min: 1, max: 10, default: 6 },
            { name: 'competitive_rivalry', label: 'Competitive Rivalry', type: 'range', min: 1, max: 10, default: 7 },
            { name: 'threat_of_substitution', label: 'Threat of Substitution', type: 'range', min: 1, max: 10, default: 4 },
            { name: 'threat_of_new_entry', label: 'Threat of New Entry', type: 'range', min: 1, max: 10, default: 3 }
        ],
        'swot': [
            { name: 'strengths', label: 'Strengths', type: 'textarea', placeholder: 'Enter company strengths' },
            { name: 'weaknesses', label: 'Weaknesses', type: 'textarea', placeholder: 'Enter company weaknesses' },
            { name: 'opportunities', label: 'Opportunities', type: 'textarea', placeholder: 'Enter market opportunities' },
            { name: 'threats', label: 'Threats', type: 'textarea', placeholder: 'Enter market threats' }
        ],
        'bcg': [
            { name: 'market_growth', label: 'Market Growth Rate (%)', type: 'number', min: 0, max: 100, default: 10 },
            { name: 'market_share', label: 'Relative Market Share (%)', type: 'number', min: 0, max: 100, default: 15 },
            { name: 'business_units', label: 'Business Units', type: 'textarea', placeholder: 'Enter business units, one per line' }
        ],
        'mckinsey': [
            { name: 'market_attractiveness', label: 'Market Attractiveness', type: 'range', min: 1, max: 10, default: 7 },
            { name: 'competitive_position', label: 'Competitive Position', type: 'range', min: 1, max: 10, default: 6 },
            { name: 'business_units', label: 'Business Units', type: 'textarea', placeholder: 'Enter business units, one per line' }
        ],
        'strategy_pyramid': [
            { name: 'mission', label: 'Mission', type: 'textarea', placeholder: 'Enter sustainability mission' },
            { name: 'objectives', label: 'Objectives', type: 'textarea', placeholder: 'Enter key objectives' },
            { name: 'strategies', label: 'Strategies', type: 'textarea', placeholder: 'Enter strategies' },
            { name: 'tactics', label: 'Tactics', type: 'textarea', placeholder: 'Enter tactical implementation steps' }
        ],
        'blue_ocean': [
            { name: 'eliminate', label: 'Eliminate', type: 'textarea', placeholder: 'What factors should be eliminated?' },
            { name: 'reduce', label: 'Reduce', type: 'textarea', placeholder: 'What factors should be reduced?' },
            { name: 'raise', label: 'Raise', type: 'textarea', placeholder: 'What factors should be raised?' },
            { name: 'create', label: 'Create', type: 'textarea', placeholder: 'What factors should be created?' }
        ]
    };
    
    // Update parameter form based on selected framework
    if (simulationFramework) {
        simulationFramework.addEventListener('change', function() {
            updateSimulationParameters(this.value);
        });
        
        // Initial parameter load
        updateSimulationParameters(simulationFramework.value);
    }
    
    function updateSimulationParameters(frameworkId) {
        if (!simulationParameters) return;
        
        simulationParameters.innerHTML = '';
        
        if (!frameworkParams[frameworkId]) {
            simulationParameters.innerHTML = '<div class="text-muted text-center p-3">No parameters available for this framework</div>';
            return;
        }
        
        const params = frameworkParams[frameworkId];
        
        params.forEach((param, index) => {
            const formGroup = document.createElement('div');
            formGroup.className = 'mb-3';
            
            const label = document.createElement('label');
            label.className = 'form-label';
            label.setAttribute('for', `param_${param.name}`);
            label.textContent = param.label;
            formGroup.appendChild(label);
            
            let input;
            
            if (param.type === 'textarea') {
                input = document.createElement('textarea');
                input.rows = 3;
                input.placeholder = param.placeholder || '';
            } else if (param.type === 'range') {
                input = document.createElement('input');
                input.type = 'range';
                input.min = param.min || 1;
                input.max = param.max || 10;
                input.step = param.step || 1;
                input.value = param.default || ((param.max + param.min) / 2);
                
                const valueDisplay = document.createElement('small');
                valueDisplay.className = 'form-text text-muted d-block text-end';
                valueDisplay.id = `${param.name}_value`;
                valueDisplay.textContent = input.value;
                
                input.addEventListener('input', function() {
                    valueDisplay.textContent = this.value;
                });
                
                formGroup.appendChild(valueDisplay);
            } else {
                input = document.createElement('input');
                input.type = param.type;
                if (param.min !== undefined) input.min = param.min;
                if (param.max !== undefined) input.max = param.max;
                if (param.step !== undefined) input.step = param.step;
                if (param.default !== undefined) input.value = param.default;
                if (param.placeholder !== undefined) input.placeholder = param.placeholder;
            }
            
            input.className = 'form-control bg-black-50';
            input.id = `param_${param.name}`;
            input.name = param.name;
            formGroup.insertBefore(input, formGroup.lastChild);
            
            simulationParameters.appendChild(formGroup);
        });
    }
    
    // Run simulation
    if (runSimulationBtn) {
        runSimulationBtn.addEventListener('click', function() {
            // Show loading and hide results
            simulationLoading.style.display = 'block';
            simulationResults.style.display = 'none';
            
            // Get parameter values
            const framework = simulationFramework.value;
            const timeframe = simulationTimeframe.value;
            const params = {};
            
            if (frameworkParams[framework]) {
                frameworkParams[framework].forEach(param => {
                    const element = document.getElementById(`param_${param.name}`);
                    if (element) {
                        params[param.name] = element.value;
                    }
                });
            }
            
            // Call the API
            fetch('/api/strategy/framework-analysis', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    framework_id: framework,
                    timeframe: timeframe,
                    data: params,
                    company_name: 'Your Company',
                    industry: 'Real Estate'
                }),
            })
            .then(response => response.json())
            .then(data => {
                // Hide loading and show results
                simulationLoading.style.display = 'none';
                simulationResults.style.display = 'block';
                
                if (data && !data.error) {
                    // Show insights
                    simulationInsights.innerHTML = data.analysis || 
                        '<p>Analysis complete. Review the recommendations for strategic guidance.</p>';
                    
                    // Show recommendations
                    simulationRecommendations.innerHTML = '';
                    if (data.recommendations && data.recommendations.length > 0) {
                        data.recommendations.forEach(rec => {
                            const li = document.createElement('li');
                            li.className = 'list-group-item bg-black-50';
                            li.innerHTML = rec;
                            simulationRecommendations.appendChild(li);
                        });
                    } else {
                        const li = document.createElement('li');
                        li.className = 'list-group-item bg-black-50';
                        li.innerHTML = 'No specific recommendations available';
                        simulationRecommendations.appendChild(li);
                    }
                    
                    // Update chart container
                    const chartContainer = document.getElementById('simulationChartContainer');
                    if (chartContainer) {
                        if (data.chartData) {
                            chartContainer.innerHTML = '';
                            // Render chart if chart data is available
                            // This would need a chart library implementation
                        } else {
                            chartContainer.innerHTML = `
                                <div class="d-flex justify-content-center align-items-center h-100">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-chart-bar fa-3x mb-3"></i>
                                        <p>Analysis complete, but no visualization data available</p>
                                    </div>
                                </div>
                            `;
                        }
                    }
                } else {
                    // Handle error
                    simulationInsights.innerHTML = `
                        <div class="alert alert-warning">
                            ${data.error || 'There was an error processing your request'}
                        </div>
                    `;
                    simulationRecommendations.innerHTML = '';
                }
            })
            .catch(error => {
                // Hide loading and show error
                simulationLoading.style.display = 'none';
                simulationResults.style.display = 'block';
                
                simulationInsights.innerHTML = `
                    <div class="alert alert-danger">
                        Network error: ${error.message || 'Unable to connect to server'}
                    </div>
                `;
                simulationRecommendations.innerHTML = '';
            });
        });
    }
    
    // MONETIZATION SECTION
    const analyzeMonetizationBtn = document.getElementById('analyzeMonetizationBtn');
    const monetizationCompanyName = document.getElementById('monetizationCompanyName');
    const monetizationDocumentText = document.getElementById('monetizationDocumentText');
    const monetizationResults = document.getElementById('monetizationResults');
    const monetizationLoading = document.getElementById('monetizationLoading');
    
    if (analyzeMonetizationBtn) {
        analyzeMonetizationBtn.addEventListener('click', function() {
            // Get values
            const companyName = monetizationCompanyName.value.trim() || 'Your Company';
            const documentText = monetizationDocumentText.value.trim();
            
            if (!documentText) {
                alert('Please provide a business description for analysis');
                return;
            }
            
            // Show loading and hide results
            monetizationLoading.style.display = 'block';
            monetizationResults.style.display = 'none';
            
            // Call API
            fetch('/api/strategy/monetization', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    company_name: companyName,
                    document_text: documentText
                }),
            })
            .then(response => response.json())
            .then(data => {
                // Hide loading
                monetizationLoading.style.display = 'none';
                
                if (data.success) {
                    // Display results
                    monetizationResults.style.display = 'block';
                    
                    // Format and display the opportunities
                    const opportunities = data.opportunities;
                    let resultsHTML = `
                        <h5>Monetization Opportunities for ${companyName}</h5>
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i> 
                            Analysis complete. ${opportunities.summary || 'Several monetization opportunities identified.'}
                        </div>
                        <div class="row">
                    `;
                    
                    // Add opportunity cards
                    if (opportunities.top_opportunities && opportunities.top_opportunities.length > 0) {
                        opportunities.top_opportunities.forEach(opp => {
                            resultsHTML += `
                                <div class="col-md-6 mb-3">
                                    <div class="card bg-black-50">
                                        <div class="card-body">
                                            <h6>${opp.name || 'Opportunity'}</h6>
                                            <p class="small">${opp.description || 'No description available'}</p>
                                            <div class="progress mt-2" style="height: 5px;">
                                                <div class="progress-bar bg-success" style="width: ${opp.potential || 70}%" 
                                                    role="progressbar" aria-valuenow="${opp.potential || 70}" 
                                                    aria-valuemin="0" aria-valuemax="100">
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mt-1">
                                                <small>Potential</small>
                                                <small>${opp.potential || 70}%</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        resultsHTML += `
                            <div class="col-12 mb-3">
                                <div class="alert alert-warning">
                                    No specific opportunities found. Please provide more detailed business information.
                                </div>
                            </div>
                        `;
                    }
                    
                    resultsHTML += `</div>`;
                    
                    // Add recommendations section
                    if (opportunities.recommendations) {
                        resultsHTML += `
                            <h6 class="mt-3">Strategic Recommendations</h6>
                            <ul class="list-group mb-3">
                        `;
                        
                        opportunities.recommendations.forEach(rec => {
                            resultsHTML += `
                                <li class="list-group-item bg-black-50">${rec}</li>
                            `;
                        });
                        
                        resultsHTML += `</ul>`;
                    }
                    
                    monetizationResults.innerHTML = resultsHTML;
                } else {
                    // Show error
                    monetizationResults.style.display = 'block';
                    monetizationResults.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i> 
                            Error: ${data.error || 'An unknown error occurred during analysis.'}
                        </div>
                    `;
                }
            })
            .catch(error => {
                // Hide loading and show error
                monetizationLoading.style.display = 'none';
                monetizationResults.style.display = 'block';
                monetizationResults.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> 
                        Network error: ${error.message}
                    </div>
                `;
            });
        });
    }
});
</script>
{% endblock %}