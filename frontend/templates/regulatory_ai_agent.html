{% extends "base.html" %}

{% block title %}Regulatory AI Agent - SustainaTrend™ Intelligence Platform{% endblock %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/strategy.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<style>
  .framework-card {
    border-radius: 8px;
    margin-bottom: 20px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  
  .framework-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
  }
  
  .timeline-event {
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    position: relative;
  }
  
  .timeline-event.high-impact {
    border-left: 5px solid #e74c3c;
  }
  
  .timeline-event.medium-impact {
    border-left: 5px solid #f39c12;
  }
  
  .timeline-event.low-impact {
    border-left: 5px solid #3498db;
  }
  
  .timeline-date {
    position: absolute;
    top: 15px;
    right: 15px;
    font-weight: bold;
  }
  
  .assessment-form {
    background-color: var(--surface);
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
  }
  
  .results-container {
    display: none;
    margin-top: 30px;
  }
  
  .compliance-score {
    font-size: 2.5rem;
    font-weight: bold;
    text-align: center;
    margin-bottom: 15px;
  }
  
  .score-high {
    color: #27ae60;
  }
  
  .score-medium {
    color: #f39c12;
  }
  
  .score-low {
    color: #e74c3c;
  }
  
  .category-card {
    margin-bottom: 15px;
    border-radius: 8px;
    overflow: hidden;
  }
  
  .category-header {
    padding: 10px 15px;
    color: white;
    font-weight: bold;
  }
  
  .category-content {
    padding: 15px;
  }
  
  .category-high {
    background-color: rgba(39, 174, 96, 0.1);
  }
  
  .category-high .category-header {
    background-color: #27ae60;
  }
  
  .category-medium {
    background-color: rgba(243, 156, 18, 0.1);
  }
  
  .category-medium .category-header {
    background-color: #f39c12;
  }
  
  .category-low {
    background-color: rgba(231, 76, 60, 0.1);
  }
  
  .category-low .category-header {
    background-color: #e74c3c;
  }
  
  .recommendation-item {
    margin-bottom: 10px;
    padding-left: 20px;
    position: relative;
  }
  
  .recommendation-item:before {
    content: '→';
    position: absolute;
    left: 0;
    color: var(--primary);
  }
  
  .gap-analysis-container {
    display: none;
    margin-top: 30px;
  }
  
  .nav-tabs .nav-link.active {
    border-color: var(--primary);
    color: var(--primary);
    border-bottom-width: 3px;
  }
  
  .timeline-container {
    position: relative;
    margin-top: 30px;
  }
  
  .timeline-container:before {
    content: '';
    position: absolute;
    top: 0;
    bottom: 0;
    left: 20px;
    width: 3px;
    background: var(--primary-light);
  }
  
  .implementation-timeline-event {
    position: relative;
    margin-left: 40px;
    margin-bottom: 30px;
    padding: 15px;
    border-radius: 8px;
    background: var(--surface-light);
  }
  
  .implementation-timeline-event:before {
    content: '';
    position: absolute;
    top: 20px;
    left: -30px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--primary);
  }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="page-title">Regulatory AI Agent</h1>
        <div>
          <span class="badge bg-primary-light text-primary">AI-Powered</span>
          <span class="badge bg-secondary-light text-secondary">Regulatory Compliance</span>
        </div>
      </div>
      
      <div class="alert alert-primary" role="alert">
        <div class="d-flex align-items-center">
          <i class="fas fa-robot me-3 fs-4"></i>
          <div>
            <h5 class="alert-heading mb-1">AI-Powered Regulatory Assessment</h5>
            <p class="mb-0">Upload your sustainability report or ESG disclosure to analyze compliance with key regulatory frameworks. Receive AI-generated assessments, gap analysis, and implementation recommendations.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="row">
    <div class="col-lg-8">
      <!-- Assessment Form -->
      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <h4 class="card-title mb-0">Regulatory Compliance Assessment</h4>
        </div>
        <div class="card-body">
          <div class="assessment-form">
            <form id="assessmentForm">
              <div class="mb-3">
                <label for="frameworkSelect" class="form-label">Regulatory Framework</label>
                <select class="form-select" id="frameworkSelect" required>
                  {% for framework_id, framework in frameworks.items() %}
                  <option value="{{ framework_id }}">{{ framework.full_name }} ({{ framework_id }})</option>
                  {% endfor %}
                </select>
                <div class="form-text">Select the regulatory framework to assess against.</div>
              </div>
              
              <div class="mb-3">
                <label for="documentInput" class="form-label">Document Text</label>
                <textarea class="form-control" id="documentInput" rows="6" placeholder="Paste the text content of your sustainability report or ESG disclosure here..." required></textarea>
                <div class="form-text">You can also upload a file below.</div>
              </div>
              
              <div class="mb-3">
                <label for="documentFile" class="form-label">Or Upload Document</label>
                <input class="form-control" type="file" id="documentFile" accept=".txt,.pdf,.docx,.doc">
                <div class="form-text">Supported formats: TXT, PDF, DOCX, DOC (text extraction from PDFs is limited)</div>
              </div>
              
              <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary" id="assessButton">
                  <i class="fas fa-check-circle me-2"></i>Assess Compliance
                </button>
              </div>
            </form>
          </div>
          
          <!-- Loading Indicator -->
          <div id="loadingIndicator" class="text-center mt-4 mb-4" style="display: none;">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Analyzing document with AI... This may take a moment.</p>
          </div>
          
          <!-- Assessment Results -->
          <div id="resultsContainer" class="results-container">
            <ul class="nav nav-tabs mb-4" id="resultsTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab" aria-controls="summary" aria-selected="true">Summary</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="categories-tab" data-bs-toggle="tab" data-bs-target="#categories" type="button" role="tab" aria-controls="categories" aria-selected="false">Categories</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="recommendations-tab" data-bs-toggle="tab" data-bs-target="#recommendations" type="button" role="tab" aria-controls="recommendations" aria-selected="false">Recommendations</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="gap-analysis-tab" data-bs-toggle="tab" data-bs-target="#gap-analysis" type="button" role="tab" aria-controls="gap-analysis" aria-selected="false">Gap Analysis</button>
              </li>
            </ul>
            
            <div class="tab-content" id="resultsTabContent">
              <!-- Summary Tab -->
              <div class="tab-pane fade show active" id="summary" role="tabpanel" aria-labelledby="summary-tab">
                <div class="card mb-4">
                  <div class="card-body">
                    <h4 class="card-title" id="frameworkName"></h4>
                    <h5 class="card-subtitle mb-3 text-muted" id="assessmentDate"></h5>
                    
                    <div class="row align-items-center">
                      <div class="col-md-6">
                        <div id="scoreBadge" class="compliance-score"></div>
                        <h5 class="text-center">Overall Compliance Score</h5>
                      </div>
                      <div class="col-md-6">
                        <canvas id="summaryChart" height="200"></canvas>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="card">
                  <div class="card-body">
                    <h5 class="card-title">Key Findings</h5>
                    <ul id="overallFindings" class="list-group list-group-flush mb-4"></ul>
                    
                    <h5 class="card-title">Recommendations</h5>
                    <ul id="overallRecommendations" class="list-group list-group-flush"></ul>
                    
                    <div class="mt-4">
                      <button id="generateGapAnalysisBtn" class="btn btn-outline-primary">
                        <i class="fas fa-file-alt me-2"></i>Generate Detailed Gap Analysis
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Categories Tab -->
              <div class="tab-pane fade" id="categories" role="tabpanel" aria-labelledby="categories-tab">
                <div class="card mb-4">
                  <div class="card-body">
                    <h5 class="card-title">Category Compliance Scores</h5>
                    <canvas id="categoriesChart" height="250"></canvas>
                  </div>
                </div>
                
                <div id="categoryDetails"></div>
              </div>
              
              <!-- Recommendations Tab -->
              <div class="tab-pane fade" id="recommendations" role="tabpanel" aria-labelledby="recommendations-tab">
                <div class="card">
                  <div class="card-body">
                    <h5 class="card-title">Implementation Recommendations</h5>
                    <p>Based on our analysis, we recommend the following actions to improve your regulatory compliance:</p>
                    
                    <div class="mb-4">
                      <h6 class="text-primary"><i class="fas fa-exclamation-circle me-2"></i>High Priority</h6>
                      <ul id="highPriorityRecommendations" class="list-group list-group-flush mb-3"></ul>
                    </div>
                    
                    <div class="mb-4">
                      <h6 class="text-warning"><i class="fas fa-exclamation-triangle me-2"></i>Medium Priority</h6>
                      <ul id="mediumPriorityRecommendations" class="list-group list-group-flush mb-3"></ul>
                    </div>
                    
                    <div>
                      <h6 class="text-info"><i class="fas fa-info-circle me-2"></i>Low Priority</h6>
                      <ul id="lowPriorityRecommendations" class="list-group list-group-flush"></ul>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Gap Analysis Tab -->
              <div class="tab-pane fade" id="gap-analysis" role="tabpanel" aria-labelledby="gap-analysis-tab">
                <div id="gapAnalysisContainer" class="gap-analysis-container">
                  <div class="card mb-4">
                    <div class="card-body">
                      <h5 class="card-title">Compliance Gap Overview</h5>
                      <canvas id="gapChart" height="250"></canvas>
                    </div>
                  </div>
                  
                  <div class="card mb-4">
                    <div class="card-body">
                      <h5 class="card-title">Resources Needed</h5>
                      <ul id="resourcesNeeded" class="list-group list-group-flush"></ul>
                    </div>
                  </div>
                  
                  <div class="card">
                    <div class="card-body">
                      <h5 class="card-title">Implementation Timeline</h5>
                      <div class="timeline-container">
                        <div id="implementationTimeline"></div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div id="gapAnalysisLoading" class="text-center mt-4 mb-4" style="display: none;">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  <p class="mt-2">Generating gap analysis... This may take a moment.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-4">
      <!-- Regulatory Frameworks -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
          <h4 class="card-title mb-0">Regulatory Frameworks</h4>
        </div>
        <div class="card-body">
          <div class="row">
            {% for framework_id, framework in frameworks.items() %}
            <div class="col-12">
              <div class="framework-card card {% if framework_id == 'ESRS' %}border-primary{% else %}border-light{% endif %} mb-3">
                <div class="card-body">
                  <h5 class="card-title">{{ framework.full_name }}</h5>
                  <h6 class="card-subtitle mb-2 text-muted">{{ framework_id }}</h6>
                  <p class="card-text">{{ framework.description }}</p>
                  <div class="d-flex justify-content-between align-items-center mt-3">
                    <span class="badge bg-light text-dark">{{ framework.region }}</span>
                    <span class="badge bg-info text-white">Effective: {{ framework.effective_date }}</span>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      
      <!-- Regulatory Timeline -->
      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <h4 class="card-title mb-0">Regulatory Timeline</h4>
        </div>
        <div class="card-body">
          <div id="timelineContainer">
            {% for event in timeline %}
            <div class="timeline-event {{ event.impact }}-impact">
              <div class="timeline-date">{{ event.date }}</div>
              <h6 class="mb-1">{{ event.framework }}</h6>
              <p class="mb-0">{{ event.event }}</p>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize variables
    let assessmentData = null;
    let gapAnalysisData = null;
    let summaryChart = null;
    let categoriesChart = null;
    let gapChart = null;
    
    // Process document file when selected
    document.getElementById('documentFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      
      reader.onload = function(e) {
        document.getElementById('documentInput').value = e.target.result;
      };
      
      if (file.type === 'text/plain') {
        reader.readAsText(file);
      } else {
        // For other file types, just show placeholder
        document.getElementById('documentInput').value = `[Content of ${file.name} will be processed on submission]`;
      }
    });
    
    // Handle assessment form submission
    document.getElementById('assessmentForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const frameworkId = document.getElementById('frameworkSelect').value;
      const documentText = document.getElementById('documentInput').value;
      const documentFile = document.getElementById('documentFile').files[0];
      
      // Show loading indicator
      document.getElementById('loadingIndicator').style.display = 'block';
      document.getElementById('resultsContainer').style.display = 'none';
      
      // If we have a file that's not a text file, handle it differently
      if (documentFile && documentFile.type !== 'text/plain') {
        // In a real implementation, we would upload the file to the server
        // For this demonstration, we'll just wait and then show a mock result
        setTimeout(function() {
          displayMockResults(frameworkId);
        }, 2000);
        return;
      }
      
      // Otherwise proceed with the text assessment
      fetch('/regulatory-ai/api/assessment', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          framework_id: frameworkId,
          document_text: documentText
        }),
      })
      .then(response => response.json())
      .then(data => {
        // Hide loading indicator
        document.getElementById('loadingIndicator').style.display = 'none';
        
        // Store assessment data
        assessmentData = data;
        
        // Display results
        displayResults(data);
      })
      .catch(error => {
        console.error('Error:', error);
        document.getElementById('loadingIndicator').style.display = 'none';
        alert('An error occurred while processing your document. Please try again.');
      });
    });
    
    // Handle gap analysis generation
    document.getElementById('generateGapAnalysisBtn').addEventListener('click', function() {
      if (!assessmentData) return;
      
      // Show gap analysis tab
      document.getElementById('gap-analysis-tab').click();
      
      // Show loading indicator
      document.getElementById('gapAnalysisLoading').style.display = 'block';
      document.getElementById('gapAnalysisContainer').style.display = 'none';
      
      // Make API request
      fetch('/regulatory-ai/api/gap-analysis', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          assessment: assessmentData
        }),
      })
      .then(response => response.json())
      .then(data => {
        // Hide loading indicator
        document.getElementById('gapAnalysisLoading').style.display = 'none';
        
        // Store gap analysis data
        gapAnalysisData = data;
        
        // Display gap analysis
        displayGapAnalysis(data);
      })
      .catch(error => {
        console.error('Error:', error);
        document.getElementById('gapAnalysisLoading').style.display = 'none';
        alert('An error occurred while generating the gap analysis. Please try again.');
      });
    });
    
    // Function to display assessment results
    function displayResults(data) {
      // Show results container
      document.getElementById('resultsContainer').style.display = 'block';
      
      // Display framework name and date
      document.getElementById('frameworkName').textContent = data.framework || data.framework_name;
      document.getElementById('assessmentDate').textContent = 'Assessment Date: ' + formatDate(data.date);
      
      // Display overall score
      const scoreElement = document.getElementById('scoreBadge');
      scoreElement.textContent = data.overall_score;
      
      if (data.overall_score >= 70) {
        scoreElement.className = 'compliance-score score-high';
      } else if (data.overall_score >= 40) {
        scoreElement.className = 'compliance-score score-medium';
      } else {
        scoreElement.className = 'compliance-score score-low';
      }
      
      // Display overall findings
      const findingsElement = document.getElementById('overallFindings');
      findingsElement.innerHTML = '';
      
      data.overall_findings.forEach(finding => {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.textContent = finding;
        findingsElement.appendChild(li);
      });
      
      // Display overall recommendations
      const recommendationsElement = document.getElementById('overallRecommendations');
      recommendationsElement.innerHTML = '';
      
      data.overall_recommendations.forEach(recommendation => {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.textContent = recommendation;
        recommendationsElement.appendChild(li);
      });
      
      // Display category details
      const categoryDetailsElement = document.getElementById('categoryDetails');
      categoryDetailsElement.innerHTML = '';
      
      // Sort categories by score (descending)
      const sortedCategories = Object.entries(data.categories).sort((a, b) => b[1].score - a[1].score);
      
      sortedCategories.forEach(([categoryId, category]) => {
        // Determine category class based on score
        let categoryClass = '';
        if (category.score >= 70) {
          categoryClass = 'category-high';
        } else if (category.score >= 40) {
          categoryClass = 'category-medium';
        } else {
          categoryClass = 'category-low';
        }
        
        // Create category card
        const card = document.createElement('div');
        card.className = `category-card ${categoryClass}`;
        
        // Create category header
        const header = document.createElement('div');
        header.className = 'category-header';
        header.textContent = `${categoryId} - Score: ${category.score}`;
        
        // Create category content
        const content = document.createElement('div');
        content.className = 'category-content';
        
        // Create findings section
        const findingsTitle = document.createElement('h6');
        findingsTitle.textContent = 'Findings';
        content.appendChild(findingsTitle);
        
        const findingsList = document.createElement('ul');
        findingsList.className = 'mb-3';
        
        category.findings.forEach(finding => {
          const li = document.createElement('li');
          li.textContent = finding;
          findingsList.appendChild(li);
        });
        
        content.appendChild(findingsList);
        
        // Create recommendations section
        const recommendationsTitle = document.createElement('h6');
        recommendationsTitle.textContent = 'Recommendations';
        content.appendChild(recommendationsTitle);
        
        const recommendationsList = document.createElement('ul');
        
        category.recommendations.forEach(recommendation => {
          const li = document.createElement('li');
          li.className = 'recommendation-item';
          li.textContent = recommendation;
          recommendationsList.appendChild(li);
        });
        
        content.appendChild(recommendationsList);
        
        // Assemble card
        card.appendChild(header);
        card.appendChild(content);
        
        // Add card to details container
        categoryDetailsElement.appendChild(card);
      });
      
      // Create priority-based recommendations
      updatePriorityRecommendations(data);
      
      // Create charts
      createSummaryChart(data);
      createCategoriesChart(data);
    }
    
    // Function to create priority-based recommendations
    function updatePriorityRecommendations(data) {
      // Group categories by priority based on score
      const highPriority = [];
      const mediumPriority = [];
      const lowPriority = [];
      
      Object.entries(data.categories).forEach(([categoryId, category]) => {
        const categoryName = getCategoryName(categoryId, data.framework_id);
        const item = {
          category: categoryId,
          name: categoryName,
          recommendations: category.recommendations
        };
        
        if (category.score < 40) {
          highPriority.push(item);
        } else if (category.score < 70) {
          mediumPriority.push(item);
        } else {
          lowPriority.push(item);
        }
      });
      
      // Update recommendation lists
      updateRecommendationList('highPriorityRecommendations', highPriority);
      updateRecommendationList('mediumPriorityRecommendations', mediumPriority);
      updateRecommendationList('lowPriorityRecommendations', lowPriority);
    }
    
    // Function to update a recommendation list
    function updateRecommendationList(elementId, items) {
      const element = document.getElementById(elementId);
      element.innerHTML = '';
      
      if (items.length === 0) {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.textContent = 'No recommendations in this category';
        element.appendChild(li);
        return;
      }
      
      items.forEach(item => {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        
        const header = document.createElement('div');
        header.className = 'fw-bold mb-2';
        header.textContent = `${item.category} - ${item.name}`;
        
        const ul = document.createElement('ul');
        ul.className = 'mb-0';
        
        item.recommendations.forEach(recommendation => {
          const recLi = document.createElement('li');
          recLi.textContent = recommendation;
          ul.appendChild(recLi);
        });
        
        li.appendChild(header);
        li.appendChild(ul);
        
        element.appendChild(li);
      });
    }
    
    // Function to display gap analysis
    function displayGapAnalysis(data) {
      // Show gap analysis container
      document.getElementById('gapAnalysisContainer').style.display = 'block';
      
      // Display resources needed
      const resourcesElement = document.getElementById('resourcesNeeded');
      resourcesElement.innerHTML = '';
      
      data.resources_needed.forEach(resource => {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.textContent = resource;
        resourcesElement.appendChild(li);
      });
      
      // Display implementation timeline
      const timelineElement = document.getElementById('implementationTimeline');
      timelineElement.innerHTML = '';
      
      data.timeline.forEach(timelineItem => {
        const event = document.createElement('div');
        event.className = 'implementation-timeline-event';
        
        const title = document.createElement('h6');
        title.className = 'mb-1';
        title.textContent = `${timelineItem.timeframe} (${timelineItem.date})`;
        
        const actions = document.createElement('ul');
        actions.className = 'mb-0';
        
        timelineItem.actions.forEach(action => {
          const actionItem = document.createElement('li');
          actionItem.textContent = action;
          actions.appendChild(actionItem);
        });
        
        event.appendChild(title);
        event.appendChild(actions);
        
        timelineElement.appendChild(event);
      });
      
      // Create gap chart
      createGapChart(data);
    }
    
    // Function to create summary chart
    function createSummaryChart(data) {
      const ctx = document.getElementById('summaryChart').getContext('2d');
      
      // Destroy existing chart if it exists
      if (summaryChart) {
        summaryChart.destroy();
      }
      
      summaryChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Compliant', 'Non-compliant'],
          datasets: [{
            data: [data.overall_score, 100 - data.overall_score],
            backgroundColor: [
              'rgba(39, 174, 96, 0.8)',
              'rgba(231, 76, 60, 0.8)'
            ],
            borderColor: [
              'rgba(39, 174, 96, 1)',
              'rgba(231, 76, 60, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '70%',
          plugins: {
            legend: {
              position: 'bottom'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.label}: ${context.raw}%`;
                }
              }
            }
          }
        }
      });
    }
    
    // Function to create categories chart
    function createCategoriesChart(data) {
      const ctx = document.getElementById('categoriesChart').getContext('2d');
      
      // Prepare data
      const categories = Object.keys(data.categories);
      const scores = categories.map(category => data.categories[category].score);
      const backgroundColors = scores.map(score => {
        if (score >= 70) {
          return 'rgba(39, 174, 96, 0.8)';
        } else if (score >= 40) {
          return 'rgba(243, 156, 18, 0.8)';
        } else {
          return 'rgba(231, 76, 60, 0.8)';
        }
      });
      
      // Map category IDs to names
      const categoryNames = categories.map(category => getCategoryName(category, data.framework_id));
      
      // Destroy existing chart if it exists
      if (categoriesChart) {
        categoriesChart.destroy();
      }
      
      categoriesChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: categoryNames,
          datasets: [{
            label: 'Compliance Score',
            data: scores,
            backgroundColor: backgroundColors,
            borderColor: backgroundColors.map(color => color.replace('0.8', '1')),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              title: {
                display: true,
                text: 'Score'
              }
            },
            x: {
              ticks: {
                autoSkip: false,
                maxRotation: 45,
                minRotation: 45
              }
            }
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                title: function(context) {
                  const index = context[0].dataIndex;
                  return `${categories[index]} - ${categoryNames[index]}`;
                }
              }
            }
          }
        }
      });
    }
    
    // Function to create gap chart
    function createGapChart(data) {
      const ctx = document.getElementById('gapChart').getContext('2d');
      
      // Prepare data
      const gapCategories = Object.keys(data.gaps);
      const gapScores = gapCategories.map(category => data.gaps[category].score);
      const targetScores = gapCategories.map(() => 100);
      const backgroundColors = gapScores.map(score => {
        if (score >= 70) {
          return 'rgba(39, 174, 96, 0.8)';
        } else if (score >= 40) {
          return 'rgba(243, 156, 18, 0.8)';
        } else {
          return 'rgba(231, 76, 60, 0.8)';
        }
      });
      
      // Map category IDs to names
      const gapCategoryNames = gapCategories.map(category => data.gaps[category].name);
      
      // Destroy existing chart if it exists
      if (gapChart) {
        gapChart.destroy();
      }
      
      gapChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: gapCategoryNames,
          datasets: [
            {
              label: 'Current Score',
              data: gapScores,
              backgroundColor: backgroundColors,
              borderColor: backgroundColors.map(color => color.replace('0.8', '1')),
              borderWidth: 1
            },
            {
              label: 'Target Score',
              data: targetScores,
              backgroundColor: 'rgba(0, 0, 0, 0.1)',
              borderColor: 'rgba(0, 0, 0, 0.2)',
              borderWidth: 1,
              borderDash: [5, 5]
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              title: {
                display: true,
                text: 'Score'
              }
            },
            x: {
              ticks: {
                autoSkip: false,
                maxRotation: 45,
                minRotation: 45
              }
            }
          }
        }
      });
    }
    
    // Helper function to format date
    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleString();
    }
    
    // Helper function to get category name from ID
    function getCategoryName(categoryId, frameworkId) {
      // Get frameworks data from the page
      const frameworksData = JSON.parse('{{ frameworks|tojson }}');
      
      if (frameworksData[frameworkId] && frameworksData[frameworkId].categories[categoryId]) {
        return frameworksData[frameworkId].categories[categoryId];
      }
      
      return categoryId;
    }
    
    // Mock results for demonstration purposes
    function displayMockResults(frameworkId) {
      const mockData = {
        framework: 'European Sustainability Reporting Standards',
        framework_id: frameworkId,
        date: new Date().toISOString(),
        overall_score: 65,
        categories: {
          E1: {
            score: 75,
            compliance_level: 'High compliance',
            findings: ['Strong coverage of climate change mitigation topics'],
            recommendations: ['Consider adding more details on emissions reduction targets']
          },
          E2: {
            score: 45,
            compliance_level: 'Moderate compliance',
            findings: ['Adequate coverage of climate adaptation topics, but some elements may be missing'],
            recommendations: ['Expand coverage of climate adaptation topics', 'Include specific metrics and targets for climate adaptation']
          },
          S1: {
            score: 80,
            compliance_level: 'High compliance',
            findings: ['Strong coverage of workforce topics'],
            recommendations: []
          },
          G1: {
            score: 60,
            compliance_level: 'Moderate compliance',
            findings: ['Adequate coverage of business conduct topics, but some elements may be missing'],
            recommendations: ['Expand coverage of business conduct topics']
          }
        },
        overall_findings: [
          'Moderate overall compliance with European Sustainability Reporting Standards',
          'Strong performance in environmental and workforce topics',
          'Room for improvement in climate adaptation and business conduct'
        ],
        overall_recommendations: [
          'Focus on improving disclosures for: climate adaptation, business conduct',
          'Develop specific metrics and targets for weaker areas'
        ]
      };
      
      // Hide loading indicator
      document.getElementById('loadingIndicator').style.display = 'none';
      
      // Store assessment data
      assessmentData = mockData;
      
      // Display results
      displayResults(mockData);
    }
  });
</script>
{% endblock %}