{% extends "base.html" %}

{% block title %}Gemini AI Search - SustainaTrendâ„¢ Intelligence Platform{% endblock %}

{% block extra_css %}
<style>
    .search-container {
        max-width: 800px;
        margin: 0 auto;
    }
    .search-result {
        margin-bottom: 20px;
        padding: 15px;
        border-radius: 8px;
        background-color: #f8f9fa;
        border-left: 4px solid #198754;
        transition: all 0.3s ease;
        opacity: 1;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .search-result.new-result {
        animation: fadeIn 0.5s ease-in-out;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .search-highlight {
        background-color: rgba(25, 135, 84, 0.1);
        padding: 0 3px;
        border-radius: 3px;
    }
    .search-metadata {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 8px;
    }
    .search-relevance {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: bold;
        color: white;
    }
    .relevance-high {
        background-color: #198754;
    }
    .relevance-medium {
        background-color: #ffc107;
        color: #212529;
    }
    .relevance-low {
        background-color: #dc3545;
    }
    .suggestions-container {
        position: absolute;
        width: 100%;
        background-color: #fff;
        border: 1px solid #ced4da;
        border-radius: 0 0 5px 5px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        z-index: 1000;
        max-height: 250px;
        overflow-y: auto;
        display: none;
    }
    .suggestion-item {
        padding: 8px 15px;
        cursor: pointer;
    }
    .suggestion-item:hover {
        background-color: #f8f9fa;
    }
    .search-form-container {
        position: relative;
    }
    .search-result-source {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        background-color: #e9ecef;
        color: #495057;
        margin-left: 10px;
    }
    .search-result-url {
        font-size: 0.85rem;
        color: #0d6efd;
        margin-top: 5px;
        display: block;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .search-loading {
        display: none;
        align-items: center;
        justify-content: center;
        padding: 20px;
        text-align: center;
    }
    .search-loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #198754;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 10px;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .live-search-toggle {
        margin-left: 10px;
        font-size: 0.85rem;
    }
    .search-error {
        display: none;
        padding: 10px;
        background-color: #f8d7da;
        color: #842029;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    .search-stats {
        font-size: 0.85rem;
        color: #6c757d;
        margin-bottom: 15px;
    }
    .filter-panel {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .filter-panel .form-label {
        font-weight: 600;
        font-size: 0.9rem;
        color: #495057;
    }
    .filter-panel .form-select, 
    .filter-panel .form-check {
        margin-bottom: 0.5rem;
    }
    .filter-badge {
        display: inline-block;
        background-color: #e9ecef;
        color: #495057;
        border-radius: 20px;
        padding: 5px 12px;
        margin-right: 8px;
        margin-bottom: 8px;
        font-size: 0.85rem;
    }
    .filter-badge .badge-remove {
        cursor: pointer;
        margin-left: 5px;
        font-weight: bold;
    }
    .filter-toggle {
        cursor: pointer;
        user-select: none;
    }
    .active-filters {
        margin-bottom: 15px;
    }
    .result-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    .source-icon {
        margin-right: 5px;
        font-size: 0.9rem;
    }
    .category-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        margin-right: 5px;
    }
    .category-Environment {
        background-color: #198754;
        color: white;
    }
    .category-Social {
        background-color: #6f42c1;
        color: white;
    }
    .category-Governance {
        background-color: #0d6efd;
        color: white;
    }
    .category-Technology {
        background-color: #fd7e14;
        color: white;
    }
    .category-Sustainability {
        background-color: #20c997;
        color: white;
    }
    .query-analysis {
        background-color: #f0f8ff;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        border-left: 4px solid #0d6efd;
    }
    .query-analysis h5 {
        color: #0d6efd;
        margin-bottom: 10px;
    }
    .enhanced-query {
        font-weight: 500;
        color: #198754;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="text-center">Gemini-Powered Sustainability Search</h1>
            <p class="text-center text-muted">Leverage Google's Gemini AI and advanced search technology to discover sustainability insights</p>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="search-container">
                <div class="search-form-container mb-4">
                    <form action="/gemini-search" method="get" id="search-form">
                        <div class="input-group input-group-lg">
                            <input type="text" 
                                   class="form-control" 
                                   name="query" 
                                   id="search-query"
                                   placeholder="Search for sustainability insights..." 
                                   value="{{ query }}" 
                                   autocomplete="off"
                                   required>
                            <button class="btn btn-primary" type="submit">
                                <i class="bi bi-search"></i> Search
                            </button>
                        </div>
                        <div id="search-suggestions" class="suggestions-container"></div>
                        <div class="mt-2 d-flex align-items-center">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="mode" id="mode-hybrid" value="hybrid" {% if mode == 'hybrid' or not mode %}checked{% endif %}>
                                <label class="form-check-label" for="mode-hybrid">Hybrid</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="mode" id="mode-gemini" value="gemini" {% if mode == 'gemini' %}checked{% endif %}>
                                <label class="form-check-label" for="mode-gemini">Gemini AI</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="mode" id="mode-google" value="google" {% if mode == 'google' %}checked{% endif %}>
                                <label class="form-check-label" for="mode-google">Google Search</label>
                            </div>
                            <div class="form-check form-switch ms-auto live-search-toggle">
                                <input class="form-check-input" type="checkbox" id="live-search-toggle" checked>
                                <label class="form-check-label" for="live-search-toggle">Live Search</label>
                            </div>
                        </div>
                    </form>
                </div>

                {% if query %}
                <div class="alert alert-primary">
                    <i class="bi bi-info-circle"></i> Showing results for: <strong id="current-query">{{ query }}</strong> using <strong>{{ mode|upper if mode else 'HYBRID' }}</strong> mode
                </div>

                {% if query_analysis %}
                <div class="query-analysis">
                    <h5><i class="bi bi-lightbulb"></i> Query Analysis</h5>
                    <p>{{ query_analysis }}</p>
                    <p><strong>Enhanced Query:</strong> <span class="enhanced-query">{{ enhanced_query }}</span></p>
                </div>
                {% endif %}

                {% if api_status %}
                <div class="api-status alert {% if api_status.using_real_apis %}alert-success{% elif api_status.fallback_active %}alert-warning{% else %}alert-info{% endif %} mt-3">
                    <h5><i class="bi bi-info-circle"></i> API Status</h5>
                    <div class="d-flex flex-wrap">
                        <div class="me-3 mb-2">
                            <span class="fw-bold">Gemini AI:</span> 
                            {% if api_status.gemini_available %}
                            <span class="badge bg-success">Available</span>
                            {% else %}
                            <span class="badge bg-danger">Unavailable</span>
                            {% endif %}
                        </div>
                        <div class="me-3 mb-2">
                            <span class="fw-bold">Google Search:</span> 
                            {% if api_status.google_available %}
                            <span class="badge bg-success">Available</span>
                            {% else %}
                            <span class="badge bg-danger">Unavailable</span>
                            {% endif %}
                        </div>
                        <div class="me-3 mb-2">
                            <span class="fw-bold">Status:</span> 
                            {% if api_status.using_real_apis %}
                            <span class="badge bg-success">Using Real APIs</span>
                            {% elif api_status.fallback_active %}
                            <span class="badge bg-warning text-dark">Using Fallback</span>
                            {% else %}
                            <span class="badge bg-secondary">Standard Search</span>
                            {% endif %}
                        </div>
                        {% if api_status.fallback_mode %}
                        <div class="me-3 mb-2">
                            <span class="fw-bold">Mode:</span> 
                            <span class="badge bg-info">{{ api_status.fallback_mode }}</span>
                        </div>
                        {% endif %}
                        {% if api_status.search_mode and api_status.effective_mode and api_status.search_mode != api_status.effective_mode %}
                        <div class="me-3 mb-2">
                            <span class="fw-bold">Requested Mode:</span> 
                            <span class="badge bg-secondary">{{ api_status.search_mode }}</span>
                            <i class="bi bi-arrow-right mx-1"></i>
                            <span class="fw-bold">Effective Mode:</span>
                            <span class="badge bg-primary">{{ api_status.effective_mode }}</span>
                        </div>
                        {% endif %}
                    </div>
                    
                    {% if api_status.status_message %}
                    <div class="mt-2 alert alert-info py-2">
                        <i class="bi bi-info-circle-fill"></i> {{ api_status.status_message }}
                    </div>
                    {% endif %}
                    
                    {% if api_status.gemini_error %}
                    <div class="mt-2 small text-danger">
                        <strong>Gemini Error:</strong> {{ api_status.gemini_error }}
                    </div>
                    {% endif %}
                    
                    {% if api_status.google_error %}
                    <div class="mt-2 small text-danger">
                        <strong>Google Search Error:</strong> {{ api_status.google_error }}
                    </div>
                    {% endif %}
                    
                    {% if api_status.error_message and not api_status.gemini_error and not api_status.google_error %}
                    <div class="mt-2 small text-danger">
                        <strong>Error:</strong> {{ api_status.error_message }}
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Filter Panel -->
                <div class="filter-panel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0"><i class="bi bi-funnel"></i> Filter Results</h5>
                        <span class="filter-toggle" id="toggle-filters"><i class="bi bi-chevron-down"></i></span>
                    </div>
                    <div id="filter-options">
                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label">Category</label>
                                <div class="d-flex flex-column">
                                    <div class="form-check">
                                        <input class="form-check-input category-filter" type="checkbox" value="Environment" id="filter-environment" checked>
                                        <label class="form-check-label" for="filter-environment">
                                            Environment
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input category-filter" type="checkbox" value="Social" id="filter-social" checked>
                                        <label class="form-check-label" for="filter-social">
                                            Social
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input category-filter" type="checkbox" value="Governance" id="filter-governance" checked>
                                        <label class="form-check-label" for="filter-governance">
                                            Governance
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input category-filter" type="checkbox" value="Technology" id="filter-technology" checked>
                                        <label class="form-check-label" for="filter-technology">
                                            Technology
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input category-filter" type="checkbox" value="Sustainability" id="filter-sustainability" checked>
                                        <label class="form-check-label" for="filter-sustainability">
                                            Sustainability
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Sort By</label>
                                <select class="form-select" id="sort-filter">
                                    <option value="relevance" selected>Relevance</option>
                                    <option value="date-new">Date (Newest First)</option>
                                    <option value="date-old">Date (Oldest First)</option>
                                </select>
                                
                                <label class="form-label mt-3">Relevance Score</label>
                                <input type="range" class="form-range" min="0" max="100" value="0" id="relevance-slider">
                                <div class="d-flex justify-content-between">
                                    <small>0</small>
                                    <small id="relevance-value">0+</small>
                                    <small>100</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Source</label>
                                <div class="form-check">
                                    <input class="form-check-input source-filter" type="checkbox" value="google" id="filter-google" checked>
                                    <label class="form-check-label" for="filter-google">
                                        <i class="bi bi-google source-icon"></i> Google
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input source-filter" type="checkbox" value="gemini" id="filter-gemini" checked>
                                    <label class="form-check-label" for="filter-gemini">
                                        <i class="bi bi-cpu source-icon"></i> Gemini AI
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input source-filter" type="checkbox" value="mock" id="filter-mock" checked>
                                    <label class="form-check-label" for="filter-mock">
                                        <i class="bi bi-database source-icon"></i> Internal Data
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button id="apply-filters" class="btn btn-sm btn-primary">Apply Filters</button>
                            <button id="reset-filters" class="btn btn-sm btn-outline-secondary ms-2">Reset</button>
                        </div>
                    </div>
                </div>

                <!-- Active filters display -->
                <div id="active-filters" class="active-filters"></div>

                <!-- Search error container -->
                <div id="search-error" class="search-error">
                    <i class="bi bi-exclamation-triangle"></i> <span id="error-message">Error fetching search results.</span>
                </div>

                <!-- Search loading spinner -->
                <div id="search-loading" class="search-loading">
                    <div class="search-loading-spinner"></div>
                    <div>Fetching real-time sustainability insights with Gemini AI...</div>
                </div>

                <!-- Search stats -->
                <div id="search-stats" class="search-stats">
                    Found <span id="result-count">{{ results|length }}</span> results
                    (<span id="filtered-count">{{ results|length }}</span> shown)
                </div>

                <!-- Result controls -->
                <div class="result-controls">
                    <div>
                        <button id="summarize-results" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-lightning"></i> Summarize Results
                        </button>
                    </div>
                </div>

                <!-- Search results -->
                <div id="search-results-container">
                    {% if results %}
                        <div id="results-summary" class="mb-4" style="display: none;">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0"><i class="bi bi-lightning"></i> AI Summary</h5>
                                </div>
                                <div class="card-body">
                                    <div id="summary-content">
                                        <p>Loading summary...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {% for result in results %}
                        <div class="search-result" 
                             data-category="{{ result.category }}" 
                             data-relevance="{{ result.relevance_score }}"
                             data-date="{{ result.date }}"
                             data-source="{{ result.source }}">
                            <h4>{{ result.title }}</h4>
                            {% if result.link %}
                            <a href="{{ result.link }}" class="search-result-url" target="_blank">{{ result.link }}</a>
                            {% endif %}
                            <p>{{ result.snippet|safe }}</p>
                            <div class="search-metadata">
                                {% if result.date %}
                                <span class="me-3"><i class="bi bi-calendar"></i> {{ result.date }}</span>
                                {% endif %}
                                {% if result.category %}
                                <span class="me-3">
                                    <span class="category-badge category-{{ result.category }}">
                                        {{ result.category }}
                                    </span>
                                </span>
                                {% endif %}
                                {% if result.source %}
                                <span class="me-3">
                                    <i class="bi bi-{% if result.source == 'gemini' %}cpu{% elif result.source == 'google' %}google{% else %}database{% endif %}"></i> 
                                    {{ result.source|title }}
                                </span>
                                {% endif %}
                                {% if result.relevance_score %}
                                <span>
                                    {% set relevance_class = 'relevance-high' if result.relevance_score >= 70 else ('relevance-medium' if result.relevance_score >= 40 else 'relevance-low') %}
                                    <span class="search-relevance {{ relevance_class }}">
                                        {{ result.relevance_score }} 
                                    </span>
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        {% if query %}
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> No results found for "<strong>{{ query }}</strong>". Try adjusting your search terms or search mode.
                        </div>
                        {% endif %}
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Elements
        const searchForm = document.getElementById('search-form');
        const searchQuery = document.getElementById('search-query');
        const suggestionsContainer = document.getElementById('search-suggestions');
        const resultsContainer = document.getElementById('search-results-container');
        const loadingContainer = document.getElementById('search-loading');
        const errorContainer = document.getElementById('search-error');
        const errorMessage = document.getElementById('error-message');
        const searchStats = document.getElementById('search-stats');
        const currentQueryDisplay = document.getElementById('current-query');
        const liveSearchToggle = document.getElementById('live-search-toggle');
        const resultCount = document.getElementById('result-count');
        const filteredCount = document.getElementById('filtered-count');
        const relevanceSlider = document.getElementById('relevance-slider');
        const relevanceValue = document.getElementById('relevance-value');

        // Filter-related elements
        const toggleFiltersBtn = document.getElementById('toggle-filters');
        const filterOptions = document.getElementById('filter-options');
        const applyFiltersBtn = document.getElementById('apply-filters');
        const resetFiltersBtn = document.getElementById('reset-filters');
        const activeFiltersContainer = document.getElementById('active-filters');
        const categoryFilters = document.querySelectorAll('.category-filter');
        const sourceFilters = document.querySelectorAll('.source-filter');
        const sortFilter = document.getElementById('sort-filter');
        const summarizeBtn = document.getElementById('summarize-results');
        const resultsSummary = document.getElementById('results-summary');
        const summaryContent = document.getElementById('summary-content');

        let debounceTimer;
        const searchResults = document.querySelectorAll('.search-result');
        let searchFilters = {
            categories: Array.from(categoryFilters).filter(f => f.checked).map(f => f.value),
            sources: Array.from(sourceFilters).filter(f => f.checked).map(f => f.value),
            sort: sortFilter.value,
            relevanceThreshold: parseInt(relevanceSlider.value)
        };

        // Update relevance slider value display
        relevanceSlider.addEventListener('input', function() {
            relevanceValue.textContent = this.value + '+';
        });

        // Toggle filter panel
        toggleFiltersBtn.addEventListener('click', function() {
            filterOptions.style.display = filterOptions.style.display === 'none' ? 'block' : 'none';
            this.innerHTML = filterOptions.style.display === 'none' ? 
                '<i class="bi bi-chevron-down"></i>' : 
                '<i class="bi bi-chevron-up"></i>';
        });

        // Apply filters
        applyFiltersBtn.addEventListener('click', function() {
            // Get selected categories
            searchFilters.categories = Array.from(categoryFilters)
                .filter(f => f.checked)
                .map(f => f.value);
                
            // Get selected sources
            searchFilters.sources = Array.from(sourceFilters)
                .filter(f => f.checked)
                .map(f => f.value);
                
            // Get sort option
            searchFilters.sort = sortFilter.value;
            
            // Get relevance threshold
            searchFilters.relevanceThreshold = parseInt(relevanceSlider.value);
            
            // Apply filters
            applyFilters();
            
            // Update active filters display
            updateActiveFiltersDisplay();
        });

        // Reset filters
        resetFiltersBtn.addEventListener('click', function() {
            // Reset checkboxes
            categoryFilters.forEach(f => f.checked = true);
            sourceFilters.forEach(f => f.checked = true);
            
            // Reset sort
            sortFilter.value = 'relevance';
            
            // Reset relevance threshold
            relevanceSlider.value = 0;
            relevanceValue.textContent = '0+';
            
            // Reset filters object
            searchFilters = {
                categories: Array.from(categoryFilters).map(f => f.value),
                sources: Array.from(sourceFilters).map(f => f.value),
                sort: 'relevance',
                relevanceThreshold: 0
            };
            
            // Apply filters
            applyFilters();
            
            // Clear active filters display
            activeFiltersContainer.innerHTML = '';
        });

        // Apply search filters
        function applyFilters() {
            let visibleCount = 0;
            
            // Process each result
            searchResults.forEach(result => {
                const category = result.dataset.category;
                const source = result.dataset.source;
                const relevance = parseInt(result.dataset.relevance) || 0;
                
                // Check if result passes all filters
                const categoryMatch = searchFilters.categories.includes(category);
                const sourceMatch = searchFilters.sources.includes(source);
                const relevanceMatch = relevance >= searchFilters.relevanceThreshold;
                
                if (categoryMatch && sourceMatch && relevanceMatch) {
                    result.style.display = 'block';
                    visibleCount++;
                } else {
                    result.style.display = 'none';
                }
            });
            
            // Update sort order if needed
            if (searchFilters.sort !== 'relevance') {
                sortResults(searchFilters.sort);
            }
            
            // Update result counts
            if (filteredCount) {
                filteredCount.textContent = visibleCount;
            }
        }

        // Sort search results
        function sortResults(sortType) {
            const resultsArray = Array.from(searchResults);
            const sortedResults = resultsArray.sort((a, b) => {
                if (sortType === 'date-new') {
                    return new Date(b.dataset.date) - new Date(a.dataset.date);
                } else if (sortType === 'date-old') {
                    return new Date(a.dataset.date) - new Date(b.dataset.date);
                } else if (sortType === 'relevance') {
                    return parseInt(b.dataset.relevance) - parseInt(a.dataset.relevance);
                }
            });
            
            // Reorder in the DOM
            const parent = resultsContainer;
            sortedResults.forEach(result => {
                parent.appendChild(result);
            });
        }

        // Update active filters display
        function updateActiveFiltersDisplay() {
            // Clear existing
            activeFiltersContainer.innerHTML = '';
            
            // Add category filters
            if (searchFilters.categories.length < categoryFilters.length) {
                searchFilters.categories.forEach(cat => {
                    addFilterBadge('Category: ' + cat, () => {
                        document.querySelector(`.category-filter[value="${cat}"]`).checked = false;
                        searchFilters.categories = searchFilters.categories.filter(c => c !== cat);
                        applyFilters();
                        updateActiveFiltersDisplay();
                    });
                });
            }
            
            // Add source filters
            if (searchFilters.sources.length < sourceFilters.length) {
                searchFilters.sources.forEach(src => {
                    addFilterBadge('Source: ' + src, () => {
                        document.querySelector(`.source-filter[value="${src}"]`).checked = false;
                        searchFilters.sources = searchFilters.sources.filter(s => s !== src);
                        applyFilters();
                        updateActiveFiltersDisplay();
                    });
                });
            }
            
            // Add relevance threshold filter
            if (searchFilters.relevanceThreshold > 0) {
                addFilterBadge(`Relevance: ${searchFilters.relevanceThreshold}+`, () => {
                    relevanceSlider.value = 0;
                    relevanceValue.textContent = '0+';
                    searchFilters.relevanceThreshold = 0;
                    applyFilters();
                    updateActiveFiltersDisplay();
                });
            }
            
            // Add sort filter if not default
            if (searchFilters.sort !== 'relevance') {
                const sortText = searchFilters.sort === 'date-new' ? 'Newest First' : 
                                (searchFilters.sort === 'date-old' ? 'Oldest First' : searchFilters.sort);
                addFilterBadge('Sort: ' + sortText, () => {
                    sortFilter.value = 'relevance';
                    searchFilters.sort = 'relevance';
                    applyFilters();
                    updateActiveFiltersDisplay();
                });
            }
        }

        // Helper to add filter badge
        function addFilterBadge(text, removeCallback) {
            const badge = document.createElement('span');
            badge.className = 'filter-badge';
            badge.innerHTML = text + ' <span class="badge-remove">Ã—</span>';
            badge.querySelector('.badge-remove').addEventListener('click', removeCallback);
            activeFiltersContainer.appendChild(badge);
        }

        // Summarize results
        summarizeBtn.addEventListener('click', function() {
            // Show the summary section with loading message
            resultsSummary.style.display = 'block';
            summaryContent.innerHTML = '<p>Generating summary of search results...</p>';
            
            // Get visible results
            const visibleResults = Array.from(searchResults).filter(r => r.style.display !== 'none');
            
            // Collect result titles and snippets
            const resultTexts = visibleResults.map(r => {
                return {
                    title: r.querySelector('h4').textContent,
                    snippet: r.querySelector('p').textContent,
                    category: r.dataset.category
                };
            });
            
            // Make API call to generate summary (mock for now)
            setTimeout(() => {
                // Generate a mock summary
                const categories = [...new Set(resultTexts.map(r => r.category))];
                
                let summary = `<h5>Summary of ${visibleResults.length} results for "${currentQueryDisplay.textContent}"</h5>`;
                summary += `<p>The search results cover ${categories.length} sustainability categories: ${categories.join(', ')}.</p>`;
                
                summary += '<p>Key insights:</p><ul>';
                
                // Add some mock insights based on result titles
                const topics = new Set();
                resultTexts.forEach(r => {
                    const words = r.title.split(' ');
                    words.forEach(word => {
                        if (word.length > 5 && !['sustainability', 'sustainable'].includes(word.toLowerCase())) {
                            topics.add(word);
                        }
                    });
                });
                
                const topTopics = Array.from(topics).slice(0, 5);
                topTopics.forEach(topic => {
                    summary += `<li>Multiple sources reference ${topic} in relation to sustainability initiatives.</li>`;
                });
                
                summary += '</ul>';
                summary += '<p>These results indicate a growing focus on technology-enabled sustainability solutions with emphasis on measurement and reporting frameworks.</p>';
                
                // Update the summary content
                summaryContent.innerHTML = summary;
            }, 1500);
        });

        // Apply initial filters
        applyFilters();

        // Live search handling
        if (liveSearchToggle && searchQuery) {
            searchQuery.addEventListener('input', function() {
                if (liveSearchToggle.checked && this.value.length > 2) {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => {
                        // Display loading indicator
                        loadingContainer.style.display = 'flex';
                        errorContainer.style.display = 'none';
                        
                        // Update current query display
                        if (currentQueryDisplay) {
                            currentQueryDisplay.textContent = this.value;
                        }
                        
                        // Get selected search mode
                        const selectedMode = document.querySelector('input[name="mode"]:checked').value;
                        
                        // Perform search via AJAX
                        fetch(`/api-gemini-search?query=${encodeURIComponent(this.value)}&mode=${selectedMode}`)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Search request failed');
                                }
                                return response.json();
                            })
                            .then(data => {
                                // Hide loading indicator
                                loadingContainer.style.display = 'none';
                                
                                // Update result count
                                if (resultCount) {
                                    resultCount.textContent = data.results.length;
                                }
                                
                                // Clear existing results
                                const resultsParent = document.getElementById('search-results-container');
                                
                                // Keep the summary div if it exists
                                const summaryDiv = document.getElementById('results-summary');
                                if (summaryDiv) {
                                    summaryDiv.style.display = 'none';
                                }
                                
                                while (resultsParent.firstChild) {
                                    resultsParent.removeChild(resultsParent.firstChild);
                                }
                                
                                // Add summary div back if it exists
                                if (summaryDiv) {
                                    resultsParent.appendChild(summaryDiv);
                                }
                                
                                // Create and append new results
                                data.results.forEach(result => {
                                    const resultDiv = createResultElement(result);
                                    resultsParent.appendChild(resultDiv);
                                });
                                
                                // Re-get the search result elements and apply filters
                                const searchResults = document.querySelectorAll('.search-result');
                                applyFilters();
                                
                                // Update filtered count
                                if (filteredCount) {
                                    const visibleCount = Array.from(searchResults).filter(r => r.style.display !== 'none').length;
                                    filteredCount.textContent = visibleCount;
                                }
                            })
                            .catch(error => {
                                // Display error message
                                loadingContainer.style.display = 'none';
                                errorContainer.style.display = 'block';
                                errorMessage.textContent = 'Error fetching search results: ' + error.message;
                            });
                    }, 500);
                }
            });
        }

        // Helper function to create a result element
        function createResultElement(result) {
            const div = document.createElement('div');
            div.className = 'search-result new-result';
            div.dataset.category = result.category || 'Sustainability';
            div.dataset.source = result.source || 'mock';
            div.dataset.relevance = result.relevance_score || '50';
            div.dataset.date = result.date || '2025-01-01';
            
            // Create title
            const title = document.createElement('h4');
            title.textContent = result.title;
            div.appendChild(title);
            
            // Create URL if available
            if (result.link) {
                const url = document.createElement('a');
                url.className = 'search-result-url';
                url.href = result.link;
                url.textContent = result.link;
                url.target = '_blank';
                div.appendChild(url);
            }
            
            // Create snippet
            const snippet = document.createElement('p');
            snippet.textContent = result.snippet;
            div.appendChild(snippet);
            
            // Create metadata
            const metadata = document.createElement('div');
            metadata.className = 'search-metadata';
            
            // Date
            if (result.date) {
                const dateSpan = document.createElement('span');
                dateSpan.className = 'me-3';
                dateSpan.innerHTML = `<i class="bi bi-calendar"></i> ${result.date}`;
                metadata.appendChild(dateSpan);
            }
            
            // Category
            if (result.category) {
                const categorySpan = document.createElement('span');
                categorySpan.className = 'me-3';
                categorySpan.innerHTML = `<span class="category-badge category-${result.category}">${result.category}</span>`;
                metadata.appendChild(categorySpan);
            }
            
            // Source
            if (result.source) {
                const sourceSpan = document.createElement('span');
                sourceSpan.className = 'me-3';
                
                let sourceIcon = 'database';
                if (result.source === 'gemini') sourceIcon = 'cpu';
                else if (result.source === 'google') sourceIcon = 'google';
                
                sourceSpan.innerHTML = `<i class="bi bi-${sourceIcon}"></i> ${result.source.charAt(0).toUpperCase() + result.source.slice(1)}`;
                metadata.appendChild(sourceSpan);
            }
            
            // Relevance score
            if (result.relevance_score) {
                const score = parseInt(result.relevance_score);
                let relevanceClass = 'relevance-low';
                if (score >= 70) relevanceClass = 'relevance-high';
                else if (score >= 40) relevanceClass = 'relevance-medium';
                
                const relevanceSpan = document.createElement('span');
                relevanceSpan.innerHTML = `<span class="search-relevance ${relevanceClass}">${score}</span>`;
                metadata.appendChild(relevanceSpan);
            }
            
            div.appendChild(metadata);
            
            return div;
        }
    });
</script>
{% endblock %}