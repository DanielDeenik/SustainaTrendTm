{% extends 'base.html' %}

{% block title %}Regulatory Compliance Assessment | SustainaTrend{% endblock %}

{% block styles %}
<style>
    /* Regulatory Compliance specific styles */
    .compliance-card {
        transition: all 0.3s ease;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .compliance-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .framework-badge {
        font-size: 0.8rem;
        padding: 0.3rem 0.6rem;
        border-radius: 30px;
        display: inline-block;
        margin-right: 8px;
        margin-bottom: 8px;
    }
    
    .score-progress {
        height: 10px;
        border-radius: 5px;
        margin-top: 8px;
    }
    
    .score-high {
        background-color: #28a745;
    }
    
    .score-medium {
        background-color: #ffc107;
    }
    
    .score-low {
        background-color: #dc3545;
    }
    
    .category-item {
        border-left: 4px solid #f8f9fa;
        padding-left: 15px;
        margin-bottom: 15px;
        transition: all 0.2s ease;
    }
    
    .category-item:hover {
        border-left-color: #0d6efd;
        background-color: rgba(13, 110, 253, 0.05);
    }
    
    .category-item.high {
        border-left-color: #28a745;
    }
    
    .category-item.medium {
        border-left-color: #ffc107;
    }
    
    .category-item.low {
        border-left-color: #dc3545;
    }
    
    #documentTextArea {
        min-height: 200px;
        font-family: monospace;
    }
    
    .gap-analysis-section {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <h1 class="mb-4">Regulatory Compliance Assessment</h1>
    
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Integrated with Data Moat</h5>
                </div>
                <div class="card-body">
                    <p>The Regulatory AI compliance assessment is now integrated with the Data Moat feature. This allows for seamless analysis of sustainability reports against key regulatory frameworks.</p>
                    <div class="d-flex mt-3">
                        <a href="{{ url_for('data_moat.index') }}" class="btn btn-primary me-2">
                            <i class="fa fa-files-o"></i> Document Repository
                        </a>
                        <a href="{{ url_for('data_moat.document_upload') }}" class="btn btn-success">
                            <i class="fa fa-upload"></i> Upload New Document
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">Select Framework</h5>
                </div>
                <div class="card-body">
                    <div class="form-group mb-3">
                        <label for="frameworkSelect">Regulatory Framework</label>
                        <select class="form-control" id="frameworkSelect">
                            {% for framework_id, framework_name in frameworks.items() %}
                            <option value="{{ framework_id }}">{{ framework_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mt-4">
                        <h6>Supported Frameworks:</h6>
                        <div class="mt-2">
                            {% for framework_id, framework_name in frameworks.items() %}
                            <span class="framework-badge bg-light text-dark">{{ framework_id }}</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <button id="clearResults" class="btn btn-outline-secondary" disabled>Clear Results</button>
                </div>
            </div>
        </div>
        
        <div class="col-md-8">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">Document Text</h5>
                </div>
                <div class="card-body">
                    <div class="form-group mb-3">
                        <label for="documentSelect">Select Existing Document</label>
                        <select class="form-control" id="documentSelect">
                            <option value="">-- Paste text or select a document --</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="documentTextArea">Document Text for Analysis</label>
                        <textarea class="form-control" id="documentTextArea" rows="10" placeholder="Paste document text here or select a document from above"></textarea>
                    </div>
                </div>
                <div class="card-footer d-flex justify-content-between">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="useAI" checked>
                        <label class="form-check-label" for="useAI">
                            Use AI for enhanced analysis
                        </label>
                    </div>
                    <button id="analyzeButton" class="btn btn-primary">
                        <i class="fa fa-search"></i> Analyze Compliance
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Results Section - Initially Hidden -->
    <div id="resultsSection" class="row" style="display: none;">
        <div class="col-md-12 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Compliance Assessment Results</h5>
                    <span id="assessmentDate" class="text-muted small"></span>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="text-center">
                                <h2 id="overallScore">-</h2>
                                <div class="progress score-progress">
                                    <div id="overallScoreBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                                <p class="mt-2">Overall Compliance Score</p>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <h6>Framework: <span id="frameworkName">-</span></h6>
                            <div id="overallFindings" class="mt-3"></div>
                            <h6 class="mt-3">Recommendations:</h6>
                            <div id="overallRecommendations"></div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <h5 class="mb-3">Category Scores</h5>
                    <div id="categoriesContainer" class="row"></div>
                    
                    <div class="d-flex justify-content-end mt-4">
                        <button id="viewGapAnalysis" class="btn btn-outline-primary">
                            <i class="fa fa-chart-bar"></i> View Gap Analysis
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Gap Analysis - Initially Hidden -->
        <div id="gapAnalysisSection" class="col-md-12 gap-analysis-section mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Gap Analysis & Implementation Plan</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Priority Gaps to Address</h6>
                            <div id="priorityGaps"></div>
                        </div>
                        <div class="col-md-6">
                            <h6>Implementation Timeline</h6>
                            <div id="implementationTimeline"></div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <h6>Resources Needed</h6>
                            <div id="resourcesNeeded"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Load existing documents
        fetchDocuments();
        
        // Document select change handler
        $('#documentSelect').on('change', function() {
            const documentId = $(this).val();
            if (documentId) {
                fetchDocumentText(documentId);
            }
        });
        
        // Analyze button click handler
        $('#analyzeButton').on('click', function() {
            const documentText = $('#documentTextArea').val().trim();
            const frameworkId = $('#frameworkSelect').val();
            const documentId = $('#documentSelect').val();
            const useAI = $('#useAI').is(':checked');
            
            if (!documentText) {
                alert('Please enter or select document text to analyze');
                return;
            }
            
            // Show loading state
            $(this).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Analyzing...');
            $(this).prop('disabled', true);
            
            // Perform compliance assessment
            performComplianceAssessment(documentText, frameworkId, documentId, useAI);
        });
        
        // Clear results button click handler
        $('#clearResults').on('click', function() {
            $('#resultsSection').hide();
            $('#gapAnalysisSection').hide();
            $(this).prop('disabled', true);
        });
        
        // View gap analysis button click handler
        $('#viewGapAnalysis').on('click', function() {
            const assessment = window.currentAssessment;
            
            if (!assessment) {
                alert('Please perform compliance assessment first');
                return;
            }
            
            // Show loading state
            $(this).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...');
            $(this).prop('disabled', true);
            
            // Perform gap analysis
            performGapAnalysis(assessment);
        });
    });
    
    // Function to fetch existing documents
    function fetchDocuments() {
        $.ajax({
            url: '/data-moat/api/documents',
            method: 'GET',
            success: function(response) {
                if (response.success && response.documents) {
                    const documents = response.documents;
                    let options = '<option value="">-- Paste text or select a document --</option>';
                    
                    documents.forEach(function(doc) {
                        options += `<option value="${doc.id}">${doc.filename}</option>`;
                    });
                    
                    $('#documentSelect').html(options);
                }
            },
            error: function(xhr, status, error) {
                console.error('Error fetching documents:', error);
            }
        });
    }
    
    // Function to fetch document text
    function fetchDocumentText(documentId) {
        $.ajax({
            url: `/data-moat/api/document/${documentId}`,
            method: 'GET',
            success: function(response) {
                if (response.success && response.document) {
                    const document = response.document;
                    $('#documentTextArea').val(document.text_preview || 'Document text not available');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error fetching document text:', error);
                alert('Error fetching document text: ' + error);
            }
        });
    }
    
    // Function to perform compliance assessment
    function performComplianceAssessment(documentText, frameworkId, documentId, useAI) {
        const data = {
            document_text: documentText,
            framework_id: frameworkId,
            document_id: documentId || null,
            use_ai: useAI
        };
        
        $.ajax({
            url: '/data-moat/api/regulatory-assessment',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                // Reset button state
                $('#analyzeButton').html('<i class="fa fa-search"></i> Analyze Compliance');
                $('#analyzeButton').prop('disabled', false);
                
                if (response.success && response.assessment) {
                    const assessment = response.assessment;
                    
                    // Store assessment for later use
                    window.currentAssessment = assessment;
                    
                    // Display assessment results
                    displayComplianceResults(assessment);
                    
                    // Enable clear results button
                    $('#clearResults').prop('disabled', false);
                } else {
                    alert('Error performing compliance assessment: ' + (response.error || 'Unknown error'));
                }
            },
            error: function(xhr, status, error) {
                // Reset button state
                $('#analyzeButton').html('<i class="fa fa-search"></i> Analyze Compliance');
                $('#analyzeButton').prop('disabled', false);
                
                console.error('Error performing compliance assessment:', error);
                alert('Error performing compliance assessment: ' + error);
            }
        });
    }
    
    // Function to display compliance results
    function displayComplianceResults(assessment) {
        // Update overall information
        const overallScore = assessment.overall_score || 0;
        $('#overallScore').text(overallScore);
        $('#frameworkName').text(assessment.framework || assessment.framework_id);
        $('#assessmentDate').text('Assessment Date: ' + formatDate(assessment.date));
        
        // Update progress bar
        const scoreBar = $('#overallScoreBar');
        scoreBar.css('width', overallScore + '%');
        
        if (overallScore >= 70) {
            scoreBar.removeClass('score-medium score-low').addClass('score-high bg-success');
        } else if (overallScore >= 50) {
            scoreBar.removeClass('score-high score-low').addClass('score-medium bg-warning');
        } else {
            scoreBar.removeClass('score-high score-medium').addClass('score-low bg-danger');
        }
        
        // Update findings and recommendations
        const findings = assessment.overall_findings || [];
        const recommendations = assessment.overall_recommendations || [];
        
        let findingsHtml = '';
        findings.forEach(function(finding) {
            findingsHtml += `<p class="mb-1"><i class="fa fa-check-circle text-muted me-2"></i>${finding}</p>`;
        });
        
        let recommendationsHtml = '';
        recommendations.forEach(function(recommendation) {
            recommendationsHtml += `<p class="mb-1"><i class="fa fa-lightbulb-o text-warning me-2"></i>${recommendation}</p>`;
        });
        
        $('#overallFindings').html(findingsHtml || '<p class="text-muted">No findings available</p>');
        $('#overallRecommendations').html(recommendationsHtml || '<p class="text-muted">No recommendations available</p>');
        
        // Update categories
        const categories = assessment.categories || {};
        let categoriesHtml = '';
        
        Object.keys(categories).forEach(function(categoryId) {
            const category = categories[categoryId];
            const score = category.score || 0;
            let complianceClass = '';
            
            if (score >= 70) {
                complianceClass = 'high';
            } else if (score >= 50) {
                complianceClass = 'medium';
            } else {
                complianceClass = 'low';
            }
            
            categoriesHtml += `
                <div class="col-md-6 mb-3">
                    <div class="category-item ${complianceClass} p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6>${categoryId}: ${category.name || 'Unknown Category'}</h6>
                            <span class="badge ${score >= 70 ? 'bg-success' : score >= 50 ? 'bg-warning' : 'bg-danger'}">${score}</span>
                        </div>
                        <p class="mb-1 text-muted">${category.compliance_level || ''}</p>
                        <div class="progress score-progress">
                            <div class="progress-bar ${score >= 70 ? 'bg-success' : score >= 50 ? 'bg-warning' : 'bg-danger'}" role="progressbar" style="width: ${score}%"></div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        $('#categoriesContainer').html(categoriesHtml || '<div class="col-12"><p class="text-muted">No categories available</p></div>');
        
        // Show results section
        $('#resultsSection').show();
        $('#gapAnalysisSection').hide();
        
        // Reset gap analysis button
        $('#viewGapAnalysis').html('<i class="fa fa-chart-bar"></i> View Gap Analysis');
        $('#viewGapAnalysis').prop('disabled', false);
        
        // Scroll to results
        $('html, body').animate({
            scrollTop: $('#resultsSection').offset().top - 20
        }, 500);
    }
    
    // Function to perform gap analysis
    function performGapAnalysis(assessment) {
        $.ajax({
            url: '/data-moat/api/gap-analysis',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ assessment: assessment }),
            success: function(response) {
                // Reset button state
                $('#viewGapAnalysis').html('<i class="fa fa-chart-bar"></i> View Gap Analysis');
                $('#viewGapAnalysis').prop('disabled', false);
                
                if (response.success && response.gap_analysis) {
                    const gapAnalysis = response.gap_analysis;
                    
                    // Display gap analysis
                    displayGapAnalysis(gapAnalysis);
                    
                    // Show gap analysis section
                    $('#gapAnalysisSection').show();
                    
                    // Scroll to gap analysis
                    $('html, body').animate({
                        scrollTop: $('#gapAnalysisSection').offset().top - 20
                    }, 500);
                } else {
                    alert('Error performing gap analysis: ' + (response.error || 'Unknown error'));
                }
            },
            error: function(xhr, status, error) {
                // Reset button state
                $('#viewGapAnalysis').html('<i class="fa fa-chart-bar"></i> View Gap Analysis');
                $('#viewGapAnalysis').prop('disabled', false);
                
                console.error('Error performing gap analysis:', error);
                alert('Error performing gap analysis: ' + error);
            }
        });
    }
    
    // Function to display gap analysis
    function displayGapAnalysis(gapAnalysis) {
        // Display priority gaps
        const priorityGaps = gapAnalysis.priority_gaps || [];
        let priorityGapsHtml = '';
        
        priorityGaps.forEach(function(gap, index) {
            const priority = index < 3 ? 'high' : index < 6 ? 'medium' : 'low';
            const badgeClass = priority === 'high' ? 'bg-danger' : priority === 'medium' ? 'bg-warning' : 'bg-info';
            
            priorityGapsHtml += `
                <div class="mb-3 p-3 border-start border-4 border-${priority === 'high' ? 'danger' : priority === 'medium' ? 'warning' : 'info'} bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-1">${gap.category}: ${gap.name}</h6>
                        <span class="badge ${badgeClass}">${priority.toUpperCase()}</span>
                    </div>
                    <p class="mb-1 small">${gap.recommendations.join(' ')}</p>
                </div>
            `;
        });
        
        $('#priorityGaps').html(priorityGapsHtml || '<p class="text-muted">No priority gaps identified</p>');
        
        // Display implementation timeline
        const timeline = gapAnalysis.timeline || [];
        let timelineHtml = '';
        
        timeline.forEach(function(item, index) {
            timelineHtml += `
                <div class="mb-3">
                    <div class="d-flex align-items-start">
                        <div class="me-3">
                            <span class="badge bg-primary rounded-circle p-2">${index + 1}</span>
                        </div>
                        <div>
                            <h6 class="mb-1">${item.title || `Phase ${index + 1}`}</h6>
                            <p class="mb-1 small text-muted">${item.timeframe || ''}</p>
                            <p class="mb-0 small">${item.description || ''}</p>
                        </div>
                    </div>
                </div>
            `;
        });
        
        $('#implementationTimeline').html(timelineHtml || '<p class="text-muted">No implementation timeline available</p>');
        
        // Display resources needed
        const resources = gapAnalysis.resources || [];
        let resourcesHtml = '';
        
        resources.forEach(function(resource) {
            resourcesHtml += `
                <div class="mb-2">
                    <i class="fa fa-check-square-o text-primary me-2"></i>
                    <span>${resource}</span>
                </div>
            `;
        });
        
        $('#resourcesNeeded').html(resourcesHtml || '<p class="text-muted">No resources specified</p>');
    }
    
    // Helper function to format date
    function formatDate(dateStr) {
        try {
            const date = new Date(dateStr);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        } catch (e) {
            return dateStr || 'Unknown date';
        }
    }
</script>
{% endblock %}