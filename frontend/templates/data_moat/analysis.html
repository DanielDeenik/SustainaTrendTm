{% extends "base.html" %}

{% block title %}SustainaTrendâ„¢ | Document Analysis{% endblock %}

{% block head %}
<style>
  .analysis-container {
    background-color: white;
    border-radius: 8px;
    padding: 2rem;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
  }
  
  .document-info {
    display: flex;
    align-items: center;
    margin-bottom: 1.5rem;
  }
  
  .document-icon {
    font-size: 2.5rem;
    color: #1e5f74;
    margin-right: 1.5rem;
  }
  
  .document-details h3 {
    margin-bottom: 0.5rem;
    color: #133b5c;
  }
  
  .document-meta {
    color: #666;
    font-size: 0.9rem;
  }
  
  .meta-item {
    display: inline-block;
    margin-right: 1.5rem;
  }
  
  .meta-label {
    font-weight: 600;
    margin-right: 0.25rem;
  }
  
  .section-header {
    border-bottom: 1px solid #eee;
    padding-bottom: 0.75rem;
    margin-bottom: 1.5rem;
    margin-top: 2rem;
    color: #1e5f74;
  }
  
  .framework-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
  }
  
  .framework-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background-color: #e3f2fd;
    color: #1e5f74;
    border-radius: 16px;
    font-size: 0.85rem;
  }
  
  .framework-badge.primary {
    background-color: #1e5f74;
    color: white;
  }
  
  .metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-bottom: 1.5rem;
  }
  
  .metric-card {
    border: 1px solid #eee;
    border-radius: 8px;
    padding: 1.25rem;
    transition: all 0.2s ease;
  }
  
  .metric-card:hover {
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    border-color: #ddd;
  }
  
  .category-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 0.5rem;
  }
  
  .category-emissions {
    background-color: #ef5350;
  }
  
  .category-energy {
    background-color: #42a5f5;
  }
  
  .category-water {
    background-color: #26c6da;
  }
  
  .category-waste {
    background-color: #66bb6a;
  }
  
  .category-social {
    background-color: #ab47bc;
  }
  
  .category-governance {
    background-color: #ffa726;
  }
  
  .metric-category {
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    margin-bottom: 0.75rem;
    color: #555;
  }
  
  .metric-keyword {
    font-weight: 600;
    color: #333;
    margin-bottom: 0.5rem;
  }
  
  .metric-context {
    font-size: 0.9rem;
    color: #555;
    line-height: 1.5;
    margin-bottom: 0.5rem;
    max-height: 4.5rem;
    overflow: hidden;
    position: relative;
  }
  
  .metric-context.expanded {
    max-height: none;
  }
  
  .metric-context::after {
    content: "";
    position: absolute;
    bottom: 0;
    right: 0;
    left: 0;
    height: 1.5rem;
    background: linear-gradient(to bottom, rgba(255, 255, 255, 0), rgba(255, 255, 255, 1));
    pointer-events: none;
  }
  
  .metric-context.expanded::after {
    display: none;
  }
  
  .metric-expand {
    font-size: 0.8rem;
    color: #1e5f74;
    cursor: pointer;
    display: inline-block;
  }
  
  .confidence-score {
    font-size: 0.8rem;
    color: #666;
    margin-top: 0.5rem;
  }
  
  .text-preview {
    background-color: #f9f9f9;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    max-height: 300px;
    overflow-y: auto;
    font-size: 0.9rem;
    line-height: 1.6;
    white-space: pre-wrap;
  }
  
  .document-actions {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
  }
  
  .btn-action {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background-color: #f5f5f5;
    border: none;
    border-radius: 4px;
    color: #333;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .btn-action:hover {
    background-color: #e0e0e0;
  }
  
  .btn-action i {
    font-size: 1.1rem;
    color: #1e5f74;
  }
  
  .btn-primary {
    background-color: #1e5f74;
    color: white;
  }
  
  .btn-primary:hover {
    background-color: #133b5c;
  }
  
  .btn-primary i {
    color: white;
  }
  
  .no-metrics {
    text-align: center;
    padding: 2rem;
    color: #666;
  }
  
  .nav-tabs {
    margin-bottom: 1.5rem;
  }
  
  .nav-tabs .nav-link {
    color: #555;
    font-weight: 500;
  }
  
  .nav-tabs .nav-link.active {
    color: #1e5f74;
    font-weight: 600;
  }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
  <div class="row">
    <div class="col-12">
      {% if document %}
      <div class="analysis-container">
        <div class="document-info">
          <div class="document-icon">
            <i class="fas fa-file-alt"></i>
          </div>
          <div class="document-details">
            <h3>{{ document.original_filename }}</h3>
            <div class="document-meta">
              <div class="meta-item">
                <span class="meta-label">Uploaded:</span>
                <span>{{ document.timestamp }}</span>
              </div>
              <div class="meta-item">
                <span class="meta-label">Size:</span>
                <span>{{ document.text_length|default(0) }} characters</span>
              </div>
              <div class="meta-item">
                <span class="meta-label">Metrics Found:</span>
                <span>{{ document.metrics_count|default(0) }}</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="document-actions">
          <a href="/data-moat/download/{{ document_id }}" class="btn-action">
            <i class="fas fa-download"></i> Download Original
          </a>
          <button class="btn-action" onclick="exportMetrics()">
            <i class="fas fa-file-export"></i> Export Metrics
          </button>
          <button class="btn-action btn-primary" onclick="generateReport()">
            <i class="fas fa-chart-bar"></i> Generate Report
          </button>
        </div>
        
        <!-- Nav tabs -->
        <ul class="nav nav-tabs" id="analysisTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="frameworks-tab" data-bs-toggle="tab" data-bs-target="#frameworks" type="button" role="tab" aria-controls="frameworks" aria-selected="true">Frameworks</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="metrics-tab" data-bs-toggle="tab" data-bs-target="#metrics" type="button" role="tab" aria-controls="metrics" aria-selected="false">Metrics</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="preview-tab" data-bs-toggle="tab" data-bs-target="#preview" type="button" role="tab" aria-controls="preview" aria-selected="false">Text Preview</button>
          </li>
        </ul>
        
        <!-- Tab panes -->
        <div class="tab-content">
          <!-- Frameworks Tab -->
          <div class="tab-pane fade show active" id="frameworks" role="tabpanel" aria-labelledby="frameworks-tab">
            <h4 class="section-header">Detected Frameworks</h4>
            
            {% if document.frameworks and document.frameworks|length > 0 %}
              <div class="framework-badges">
                {% for framework_id, confidence in document.frameworks.items() %}
                  <div class="framework-badge {% if framework_id == document.primary_framework %}primary{% endif %}">
                    {% set framework_name = framework_id|upper %}
                    {% for fw in frameworks|default([]) %}
                      {% if fw.id == framework_id %}
                        {% set framework_name = fw.name %}
                      {% endif %}
                    {% endfor %}
                    {{ framework_name }} <span class="small">({{ (confidence * 100)|round }}%)</span>
                  </div>
                {% endfor %}
              </div>
              
              <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Primary Framework:</strong> {{ document.primary_framework|upper if document.primary_framework else 'None detected' }}
                <p class="mb-0 mt-2 small">The document appears to primarily follow this sustainability framework based on keyword analysis.</p>
              </div>
            {% else %}
              <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                No frameworks were detected in this document. Consider using a different document or enabling OCR if the document contains scanned text.
              </div>
            {% endif %}
          </div>
          
          <!-- Metrics Tab -->
          <div class="tab-pane fade" id="metrics" role="tabpanel" aria-labelledby="metrics-tab">
            <h4 class="section-header">Extracted Metrics</h4>
            
            {% if document.metrics and document.metrics|length > 0 %}
              {% set has_metrics = false %}
              {% for category, metrics in document.metrics.items() %}
                {% if metrics|length > 0 %}
                  {% set has_metrics = true %}
                {% endif %}
              {% endfor %}
              
              {% if has_metrics %}
                {% for category, metrics in document.metrics.items() %}
                  {% if metrics|length > 0 %}
                    <h5 class="mt-4 mb-3">{{ category|title }}</h5>
                    <div class="metrics-grid">
                      {% for metric in metrics %}
                        <div class="metric-card">
                          <div class="metric-category">
                            <span class="category-indicator category-{{ category }}"></span>
                            {{ category|title }}
                          </div>
                          <div class="metric-keyword">{{ metric.keyword|title }}</div>
                          <div class="metric-context" id="context-{{ loop.index }}-{{ category }}">
                            {{ metric.context }}
                          </div>
                          <span class="metric-expand" onclick="expandContext('context-{{ loop.index }}-{{ category }}')">Read more</span>
                          <div class="confidence-score">Confidence: {{ (metric.confidence * 100)|round }}%</div>
                        </div>
                      {% endfor %}
                    </div>
                  {% endif %}
                {% endfor %}
              {% else %}
                <div class="no-metrics">
                  <i class="fas fa-search fa-3x mb-3 text-muted"></i>
                  <p>No metrics were extracted from this document.</p>
                </div>
              {% endif %}
            {% else %}
              <div class="no-metrics">
                <i class="fas fa-search fa-3x mb-3 text-muted"></i>
                <p>No metrics were extracted from this document.</p>
              </div>
            {% endif %}
          </div>
          
          <!-- Text Preview Tab -->
          <div class="tab-pane fade" id="preview" role="tabpanel" aria-labelledby="preview-tab">
            <h4 class="section-header">Document Text Preview</h4>
            
            {% if document.text_preview %}
              <div class="text-preview">{{ document.text_preview }}</div>
            {% else %}
              <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Text preview is not available for this document.
              </div>
            {% endif %}
          </div>
        </div>
      </div>
      {% else %}
      <div class="alert alert-danger">
        <i class="fas fa-exclamation-circle me-2"></i>
        Document not found. This document may no longer exist or you may not have permission to access it.
        <p class="mt-2 mb-0">
          <a href="/data-moat/upload" class="alert-link">Go back to upload page</a>
        </p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  function expandContext(id) {
    const context = document.getElementById(id);
    context.classList.toggle('expanded');
    
    const expandBtn = context.nextElementSibling;
    if (context.classList.contains('expanded')) {
      expandBtn.textContent = 'Show less';
    } else {
      expandBtn.textContent = 'Read more';
    }
  }
  
  function exportMetrics() {
    // In a real implementation, this would download a CSV or JSON file
    alert('This feature would export all extracted metrics to a CSV or JSON file.\n\nImplementation is simplified for this demo.');
  }
  
  function generateReport() {
    // In a real implementation, this would generate a comprehensive report
    alert('This feature would generate a comprehensive sustainability report based on the extracted metrics.\n\nImplementation is simplified for this demo.');
  }
  
  // Initialize tooltips
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tabs if they exist
    if (typeof bootstrap !== 'undefined') {
      const triggerTabList = [].slice.call(document.querySelectorAll('#analysisTabs button'));
      triggerTabList.forEach(function(triggerEl) {
        new bootstrap.Tab(triggerEl);
      });
    }
  });
</script>
{% endblock %}