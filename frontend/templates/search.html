{% extends "base.html" %}

{% block title %}AI Search - Sustainability Intelligence Platform{% endblock %}

{% block extra_css %}
<style>
    .search-container {
        max-width: 800px;
        margin: 0 auto;
    }
    .search-result {
        margin-bottom: 20px;
        padding: 15px;
        border-radius: 5px;
        background-color: #f8f9fa;
        border-left: 4px solid #198754;
        transition: all 0.3s ease;
        opacity: 1;
    }
    .search-result.new-result {
        animation: fadeIn 0.5s ease-in-out;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .search-highlight {
        background-color: rgba(25, 135, 84, 0.1);
        padding: 0 3px;
        border-radius: 3px;
    }
    .search-metadata {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 8px;
    }
    .search-confidence {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: bold;
        color: white;
    }
    .confidence-high {
        background-color: #198754;
    }
    .confidence-medium {
        background-color: #ffc107;
        color: #212529;
    }
    .confidence-low {
        background-color: #dc3545;
    }
    .suggestions-container {
        position: absolute;
        width: 100%;
        background-color: #fff;
        border: 1px solid #ced4da;
        border-radius: 0 0 5px 5px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        z-index: 1000;
        max-height: 250px;
        overflow-y: auto;
        display: none;
    }
    .suggestion-item {
        padding: 8px 15px;
        cursor: pointer;
    }
    .suggestion-item:hover {
        background-color: #f8f9fa;
    }
    .search-form-container {
        position: relative;
    }
    /* New styles for real-time search */
    .search-result-source {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        background-color: #e9ecef;
        color: #495057;
        margin-left: 10px;
    }
    .search-result-url {
        font-size: 0.85rem;
        color: #0d6efd;
        margin-top: 5px;
        display: block;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .search-loading {
        display: none;
        align-items: center;
        justify-content: center;
        padding: 20px;
        text-align: center;
    }
    .search-loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #198754;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 10px;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .live-search-toggle {
        margin-left: 10px;
        font-size: 0.85rem;
    }
    .search-error {
        display: none;
        padding: 10px;
        background-color: #f8d7da;
        color: #842029;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    .search-stats {
        font-size: 0.85rem;
        color: #6c757d;
        margin-bottom: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="text-center">AI-Powered Sustainability Search</h1>
            <p class="text-center text-muted">Leverage advanced NLP models and real-time data to discover insights across sustainability topics</p>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="search-container">
                <div class="search-form-container mb-5">
                    <form action="/search" method="get" id="search-form">
                        <div class="input-group input-group-lg">
                            <input type="text" 
                                   class="form-control" 
                                   name="query" 
                                   id="search-query"
                                   placeholder="Search for sustainability insights..." 
                                   value="{{ query }}" 
                                   autocomplete="off"
                                   required>
                            <button class="btn btn-primary" type="submit">
                                <i class="bi bi-search"></i> Search
                            </button>
                        </div>
                        <div id="search-suggestions" class="suggestions-container"></div>
                        <div class="mt-2 d-flex align-items-center">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="model" id="model-rag" value="rag" {% if model == 'rag' %}checked{% endif %}>
                                <label class="form-check-label" for="model-rag">RAG</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="model" id="model-splade" value="splade" {% if model == 'splade' %}checked{% endif %}>
                                <label class="form-check-label" for="model-splade">SPLADE</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="model" id="model-gnn" value="gnn" {% if model == 'gnn' %}checked{% endif %}>
                                <label class="form-check-label" for="model-gnn">Graph Neural Network</label>
                            </div>
                            <div class="form-check form-switch ms-auto live-search-toggle">
                                <input class="form-check-input" type="checkbox" id="live-search-toggle" checked>
                                <label class="form-check-label" for="live-search-toggle">Live Search</label>
                            </div>
                        </div>
                    </form>
                </div>

                {% if query %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Showing results for: <strong id="current-query">{{ query }}</strong> using <strong>{{ model|upper }}</strong> model
                </div>

                <!-- Search error container -->
                <div id="search-error" class="search-error">
                    <i class="bi bi-exclamation-triangle"></i> <span id="error-message">Error fetching search results.</span>
                </div>

                <!-- Search loading spinner -->
                <div id="search-loading" class="search-loading">
                    <div class="search-loading-spinner"></div>
                    <div>Fetching real-time sustainability insights...</div>
                </div>

                <!-- Search stats -->
                <div id="search-stats" class="search-stats"></div>

                <!-- Search results container -->
                <div id="search-results-container">
                    {% if results %}
                        <h2>Search Results</h2>
                        {% for result in results %}
                        <div class="search-result">
                            <h4>{{ result.title }}</h4>
                            {% if result.url %}
                            <a href="{{ result.url }}" class="search-result-url" target="_blank">{{ result.url }}</a>
                            {% endif %}
                            <p>{{ result.snippet|safe }}</p>
                            <div class="search-metadata">
                                {% if result.date %}
                                <span class="me-3"><i class="bi bi-calendar"></i> {{ result.date }}</span>
                                {% endif %}
                                {% if result.category %}
                                <span class="me-3"><i class="bi bi-tag"></i> {{ result.category }}</span>
                                {% endif %}
                                <span class="search-confidence confidence-{{ result.confidence_level }}">
                                    {{ result.confidence }}% match
                                </span>
                                {% if result.source %}
                                <span class="search-result-source">
                                    {{ result.source }}
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> No results found for your query. Try different keywords or a broader search.
                        </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize any JavaScript required for the search page
    document.addEventListener('DOMContentLoaded', function() {
        // Setup for dynamic search suggestions
        const searchInput = document.getElementById('search-query');
        const suggestionsContainer = document.getElementById('search-suggestions');
        const searchForm = document.getElementById('search-form');
        const resultsContainer = document.getElementById('search-results-container');
        const loadingContainer = document.getElementById('search-loading');
        const errorContainer = document.getElementById('search-error');
        const errorMessage = document.getElementById('error-message');
        const searchStats = document.getElementById('search-stats');
        const currentQueryDisplay = document.getElementById('current-query');
        const liveSearchToggle = document.getElementById('live-search-toggle');

        let debounceTimer;
        let lastQuery = '';
        let isSearching = false;

        // Debounce function to prevent too many API calls
        function debounce(callback, delay = 300) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(callback, delay);
        }

        // Fetch suggestions from OmniParser API
        function fetchSuggestions(query) {
            if (!query || query.length < 2) {
                suggestionsContainer.style.display = 'none';
                return;
            }

            fetch(`/api/omniparser/suggestions?query=${encodeURIComponent(query)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.suggestions && data.suggestions.length > 0) {
                        displaySuggestions(data.suggestions);
                    } else {
                        suggestionsContainer.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error fetching suggestions:', error);
                    suggestionsContainer.style.display = 'none';
                });
        }

        // Display suggestions in dropdown
        function displaySuggestions(suggestions) {
            suggestionsContainer.innerHTML = '';

            suggestions.forEach(suggestion => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.textContent = suggestion;

                item.addEventListener('click', () => {
                    searchInput.value = suggestion;
                    suggestionsContainer.style.display = 'none';

                    // If live search is enabled, perform real-time search
                    if (liveSearchToggle.checked) {
                        performRealTimeSearch(suggestion);
                    } else {
                        // Otherwise submit the form
                        searchForm.submit();
                    }
                });

                suggestionsContainer.appendChild(item);
            });

            suggestionsContainer.style.display = 'block';
        }

        // New function to perform real-time search
        function performRealTimeSearch(query) {
            // Don't search if query is empty or the same as last query
            if (!query.trim() || query === lastQuery || isSearching) {
                return;
            }

            lastQuery = query;
            isSearching = true;

            // Update URL without reloading the page
            const url = new URL(window.location);
            url.searchParams.set('query', query);
            window.history.pushState({}, '', url);

            // Update query display
            if (currentQueryDisplay) {
                currentQueryDisplay.textContent = query;
            }

            // Show loading spinner
            if (loadingContainer) {
                loadingContainer.style.display = 'flex';
            }

            // Hide error message if visible
            if (errorContainer) {
                errorContainer.style.display = 'none';
            }

            // Get selected model
            const modelElements = document.querySelectorAll('input[name="model"]');
            let selectedModel = 'rag';
            for (const modelElement of modelElements) {
                if (modelElement.checked) {
                    selectedModel = modelElement.value;
                    break;
                }
            }

            // Start search timer
            const startTime = performance.now();

            // Fetch real-time search results
            fetch(`/api/realtime-search?query=${encodeURIComponent(query)}&model=${selectedModel}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Search failed: ${response.status} ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Calculate search time
                    const searchTime = ((performance.now() - startTime) / 1000).toFixed(2);

                    // Update search stats
                    if (searchStats) {
                        searchStats.textContent = `Found ${data.results.length} results in ${searchTime} seconds`;
                    }

                    // Display results
                    displaySearchResults(data.results);
                })
                .catch(error => {
                    console.error('Error performing search:', error);

                    // Show error message
                    if (errorContainer && errorMessage) {
                        errorMessage.textContent = error.message || 'Failed to fetch search results. Please try again.';
                        errorContainer.style.display = 'block';
                    }
                })
                .finally(() => {
                    // Hide loading spinner
                    if (loadingContainer) {
                        loadingContainer.style.display = 'none';
                    }
                    isSearching = false;
                });
        }

        // Display search results with smooth animations
        function displaySearchResults(results) {
            if (!resultsContainer) return;

            // Clear existing results
            resultsContainer.innerHTML = '';

            // If no results, show message
            if (!results || results.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> No results found for your query. Try different keywords or a broader search.
                    </div>
                `;
                return;
            }

            // Add results heading
            const heading = document.createElement('h2');
            heading.textContent = 'Search Results';
            resultsContainer.appendChild(heading);

            // Add each result with animation
            results.forEach((result, index) => {
                // Create result element
                const resultElement = document.createElement('div');
                resultElement.className = 'search-result new-result';

                // Calculate staggered delay for smoother animation
                resultElement.style.animationDelay = `${index * 0.1}s`;

                // Build result HTML
                let resultHTML = `
                    <h4>${result.title}</h4>
                `;

                // Add URL if available
                if (result.url) {
                    resultHTML += `<a href="${result.url}" class="search-result-url" target="_blank">${result.url}</a>`;
                }

                // Add snippet
                resultHTML += `<p>${result.snippet}</p>`;

                // Add metadata
                resultHTML += `<div class="search-metadata">`;

                if (result.date) {
                    resultHTML += `<span class="me-3"><i class="bi bi-calendar"></i> ${result.date}</span>`;
                }

                if (result.category) {
                    resultHTML += `<span class="me-3"><i class="bi bi-tag"></i> ${result.category}</span>`;
                }

                resultHTML += `
                    <span class="search-confidence confidence-${result.confidence_level}">
                        ${result.confidence}% match
                    </span>
                `;

                if (result.source) {
                    resultHTML += `
                        <span class="search-result-source">
                            ${result.source}
                        </span>
                    `;
                }

                resultHTML += `</div>`;

                // Set HTML and append to container
                resultElement.innerHTML = resultHTML;
                resultsContainer.appendChild(resultElement);
            });

            // Highlight search terms
            highlightSearchTerms(lastQuery);
        }

        // Highlight search terms in results
        function highlightSearchTerms(query) {
            if (!query) return;

            const terms = query.toLowerCase().split(' ').filter(term => term.length > 2);

            document.querySelectorAll('.search-result p').forEach(el => {
                terms.forEach(term => {
                    const regex = new RegExp('(' + term + ')', 'gi');
                    el.innerHTML = el.innerHTML.replace(
                        regex, 
                        '<span class="search-highlight">$1</span>'
                    );
                });
            });
        }

        // Handle input changes for suggestions and live search
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const query = this.value.trim();

                // Fetch suggestions
                debounce(() => fetchSuggestions(query), 300);

                // Perform live search if enabled and query is long enough
                if (liveSearchToggle && liveSearchToggle.checked && query.length >= 3) {
                    debounce(() => performRealTimeSearch(query), 600);
                }
            });

            // Close suggestions when clicking outside
            document.addEventListener('click', function(event) {
                if (!searchInput.contains(event.target) && !suggestionsContainer.contains(event.target)) {
                    suggestionsContainer.style.display = 'none';
                }
            });

            // Show suggestions when input is focused (if there's text)
            searchInput.addEventListener('focus', function() {
                const query = this.value.trim();
                if (query.length >= 2) {
                    fetchSuggestions(query);
                }
            });

            // Handle form submission for live search
            if (searchForm) {
                searchForm.addEventListener('submit', function(event) {
                    const query = searchInput.value.trim();

                    // If live search is enabled and query is not empty, perform real-time search
                    if (liveSearchToggle && liveSearchToggle.checked && query) {
                        event.preventDefault();
                        performRealTimeSearch(query);
                    }
                    // Otherwise, let the form submit normally
                });
            }
        }

        // Initialize highlighting for existing results
        if ('{{ query }}') {
            highlightSearchTerms('{{ query }}');
        }

        // If there's a query and live search is enabled, perform real-time search on page load
        if ('{{ query }}' && liveSearchToggle && liveSearchToggle.checked) {
            // Slight delay to ensure DOM is fully loaded
            setTimeout(() => {
                performRealTimeSearch('{{ query }}');
            }, 500);
        }
    });
</script>
{% endblock %}