{% extends "layouts/finchat_dark_layout.html" %}

{% block title %}SustainaTrendâ„¢ - Document Upload for Benchmarking{% endblock %}

{% block styles %}
<style>
  .upload-area {
    border: 2px dashed rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    padding: 50px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .upload-area:hover, .upload-area.active {
    border-color: var(--bs-primary);
    background-color: rgba(13, 110, 253, 0.05);
  }
  
  .upload-icon {
    font-size: 4rem;
    color: var(--bs-primary);
    margin-bottom: 1rem;
  }
  
  .source-card {
    border-radius: 8px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    cursor: pointer;
  }
  
  .source-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
  }
  
  .source-card.selected {
    border: 2px solid var(--bs-primary);
  }
  
  .source-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
  }
  
  .extraction-card {
    border-radius: 8px;
    border-left: 5px solid var(--bs-primary);
    margin-bottom: 15px;
  }
  
  .file-item {
    border-radius: 8px;
    background-color: rgba(35, 45, 60, 0.5);
    padding: 10px 15px;
    margin-bottom: 10px;
  }
  
  .processing-animation {
    width: 100%;
    height: 4px;
    background-color: #e9ecef;
    border-radius: 2px;
    overflow: hidden;
    position: relative;
  }
  
  .processing-animation::after {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    width: 30%;
    background-color: var(--bs-primary);
    animation: processing 1.5s infinite ease-in-out;
  }
  
  @keyframes processing {
    0% { left: -30%; }
    100% { left: 100%; }
  }
  
  .progress-status {
    margin-top: 10px;
    font-size: 0.8rem;
    color: #adb5bd;
  }
  
  .extracted-data-item {
    background-color: rgba(35, 45, 60, 0.5);
    border-radius: 8px;
    padding: 10px 15px;
    margin-bottom: 10px;
    transition: all 0.2s ease;
  }
  
  .extracted-data-item:hover {
    background-color: rgba(35, 45, 60, 0.8);
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Document Upload</h1>
        <div>
          <a href="{{ url_for('benchmarking.index') }}" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left me-2"></i>Back to Benchmarking
          </a>
        </div>
      </div>
      <p class="text-muted">
        Upload sustainability reports, disclosures, or other documents to extract data for benchmarking. Our system will 
        analyze your documents and extract relevant sustainability metrics automatically.
      </p>
    </div>
  </div>
  
  <div class="row">
    <!-- Document Upload Section -->
    <div class="col-lg-8">
      <div class="card shadow-sm mb-4">
        <div class="card-body p-4">
          <h4 class="card-title mb-3">Upload Documents</h4>
          
          <form method="post" enctype="multipart/form-data" id="uploadForm">
            <div class="upload-area mb-4" id="dropArea">
              <input type="file" class="d-none" id="fileInput" name="benchmark_file" accept=".pdf,.doc,.docx,.xls,.xlsx,.csv,.txt">
              <div class="upload-icon">
                <i class="fas fa-file-upload"></i>
              </div>
              <h5>Drag & Drop Files Here</h5>
              <p class="text-muted mb-3">or click to browse</p>
              <button type="button" class="btn btn-primary" id="browseButton">
                <i class="fas fa-folder-open me-2"></i>Browse Files
              </button>
            </div>
            
            <div id="fileList" class="mb-4 d-none">
              <h5 class="mb-3">Selected Files</h5>
              <div id="fileItems">
                <!-- File items will be added here -->
              </div>
              
              <div class="mt-3">
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-upload me-2"></i>Upload Files
                </button>
                <button type="button" class="btn btn-outline-secondary ms-2" id="clearButton">
                  <i class="fas fa-times me-2"></i>Clear
                </button>
              </div>
            </div>
          </form>
          
          <div id="processingArea" class="d-none">
            <h5 class="mb-3">Processing Files</h5>
            <div class="file-item" id="processingFile">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                  <i class="fas fa-file-pdf text-danger me-2"></i>
                  <span id="processingFileName">document.pdf</span>
                </div>
                <span class="badge bg-primary">Processing</span>
              </div>
              <div class="processing-animation"></div>
              <div class="progress-status" id="processingStatus">Extracting data points...</div>
            </div>
            
            <div class="alert alert-info mt-3" role="alert">
              <div class="d-flex">
                <div class="me-3">
                  <i class="fas fa-info-circle fa-2x"></i>
                </div>
                <div>
                  <h6 class="alert-heading">AI-Powered Extraction</h6>
                  <p class="mb-0">Our AI is analyzing your document to extract relevant sustainability metrics. This may take a few moments depending on the document size and complexity.</p>
                </div>
              </div>
            </div>
          </div>
          
          <div id="extractedDataArea" class="d-none">
            <h5 class="mb-3">Extracted Data</h5>
            <div id="extractedDataItems">
              <!-- Extracted data items will be added here -->
            </div>
            
            <div class="mt-4">
              <a href="{{ url_for('benchmarking.peer_comparison') }}" class="btn btn-success">
                <i class="fas fa-chart-bar me-2"></i>Continue to Benchmarking
              </a>
              <button type="button" class="btn btn-primary ms-2" id="uploadMoreButton">
                <i class="fas fa-file-upload me-2"></i>Upload More Documents
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Data Quality Analysis -->
      <div class="card shadow-sm mb-4 d-none" id="dataQualityCard">
        <div class="card-body p-4">
          <h4 class="card-title mb-3">Data Quality Analysis</h4>
          
          <div class="alert alert-warning" role="alert">
            <div class="d-flex">
              <div class="me-3">
                <i class="fas fa-exclamation-triangle fa-2x"></i>
              </div>
              <div>
                <h6 class="alert-heading">Missing Critical Data Points</h6>
                <p class="mb-0">We've identified several key metrics that are missing or incomplete in your uploaded documents. These are required for comprehensive benchmarking.</p>
              </div>
            </div>
          </div>
          
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Metric</th>
                  <th>Status</th>
                  <th>Importance</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Scope 3 Emissions</td>
                  <td><span class="badge bg-danger">Missing</span></td>
                  <td><span class="badge bg-warning">Critical</span></td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary">
                      <i class="fas fa-plus-circle me-1"></i> Add Manually
                    </button>
                  </td>
                </tr>
                <tr>
                  <td>Water Consumption</td>
                  <td><span class="badge bg-warning">Incomplete</span></td>
                  <td><span class="badge bg-primary">High</span></td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary">
                      <i class="fas fa-plus-circle me-1"></i> Complete Data
                    </button>
                  </td>
                </tr>
                <tr>
                  <td>Board Diversity</td>
                  <td><span class="badge bg-danger">Missing</span></td>
                  <td><span class="badge bg-primary">High</span></td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary">
                      <i class="fas fa-plus-circle me-1"></i> Add Manually
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Document Sources Guide -->
    <div class="col-lg-4">
      <div class="card shadow-sm mb-4">
        <div class="card-body p-4">
          <h4 class="card-title mb-3">Recommended Documents</h4>
          <p class="text-muted mb-4">
            For the most accurate benchmarking, we recommend uploading the following document types:
          </p>
          
          <div class="row">
            <div class="col-md-6 col-lg-12 col-xl-6 mb-3">
              <div class="source-card card text-center p-3">
                <div class="source-icon text-danger">
                  <i class="fas fa-file-pdf"></i>
                </div>
                <h6>Sustainability Report</h6>
                <p class="small text-muted mb-0">Comprehensive ESG metrics</p>
              </div>
            </div>
            
            <div class="col-md-6 col-lg-12 col-xl-6 mb-3">
              <div class="source-card card text-center p-3">
                <div class="source-icon text-success">
                  <i class="fas fa-file-excel"></i>
                </div>
                <h6>Emissions Data</h6>
                <p class="small text-muted mb-0">GHG inventory spreadsheets</p>
              </div>
            </div>
            
            <div class="col-md-6 col-lg-12 col-xl-6 mb-3">
              <div class="source-card card text-center p-3">
                <div class="source-icon text-primary">
                  <i class="fas fa-file-word"></i>
                </div>
                <h6>CSRD Disclosure</h6>
                <p class="small text-muted mb-0">European compliance reports</p>
              </div>
            </div>
            
            <div class="col-md-6 col-lg-12 col-xl-6 mb-3">
              <div class="source-card card text-center p-3">
                <div class="source-icon text-info">
                  <i class="fas fa-file-alt"></i>
                </div>
                <h6>TCFD Report</h6>
                <p class="small text-muted mb-0">Climate risk disclosures</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="card shadow-sm">
        <div class="card-body p-4">
          <h4 class="card-title mb-3">Data Extraction Guide</h4>
          
          <div class="accordion" id="extractionAccordion">
            <div class="accordion-item bg-transparent border-0 mb-2">
              <h2 class="accordion-header" id="headingOne">
                <button class="accordion-button collapsed bg-transparent" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                  How does the extraction work?
                </button>
              </h2>
              <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#extractionAccordion">
                <div class="accordion-body text-muted">
                  Our system uses a combination of OCR (Optical Character Recognition), NLP (Natural Language Processing), and machine learning to analyze your documents and extract sustainability metrics. It can identify tables, charts, and relevant text to find and extract structured data.
                </div>
              </div>
            </div>
            
            <div class="accordion-item bg-transparent border-0 mb-2">
              <h2 class="accordion-header" id="headingTwo">
                <button class="accordion-button collapsed bg-transparent" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                  What file formats are supported?
                </button>
              </h2>
              <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#extractionAccordion">
                <div class="accordion-body text-muted">
                  We support PDF, Word (.doc, .docx), Excel (.xls, .xlsx), CSV, and plain text (.txt) files. For best results, we recommend PDFs with searchable text or Excel spreadsheets with clearly labeled data.
                </div>
              </div>
            </div>
            
            <div class="accordion-item bg-transparent border-0 mb-2">
              <h2 class="accordion-header" id="headingThree">
                <button class="accordion-button collapsed bg-transparent" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                  What if my data isn't extracted correctly?
                </button>
              </h2>
              <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#extractionAccordion">
                <div class="accordion-body text-muted">
                  After extraction, you'll have the opportunity to review and edit the extracted data before proceeding to benchmarking. You can manually add or correct any metrics that weren't properly identified.
                </div>
              </div>
            </div>
            
            <div class="accordion-item bg-transparent border-0">
              <h2 class="accordion-header" id="headingFour">
                <button class="accordion-button collapsed bg-transparent" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
                  Is my data secure?
                </button>
              </h2>
              <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour" data-bs-parent="#extractionAccordion">
                <div class="accordion-body text-muted">
                  Yes, all your uploaded documents and extracted data are securely stored and processed according to strict data protection standards. We don't share your data with third parties, and you can delete it at any time.
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const dropArea = document.getElementById('dropArea');
    const fileInput = document.getElementById('fileInput');
    const browseButton = document.getElementById('browseButton');
    const fileList = document.getElementById('fileList');
    const fileItems = document.getElementById('fileItems');
    const clearButton = document.getElementById('clearButton');
    const uploadForm = document.getElementById('uploadForm');
    const processingArea = document.getElementById('processingArea');
    const processingFileName = document.getElementById('processingFileName');
    const processingStatus = document.getElementById('processingStatus');
    const extractedDataArea = document.getElementById('extractedDataArea');
    const extractedDataItems = document.getElementById('extractedDataItems');
    const uploadMoreButton = document.getElementById('uploadMoreButton');
    const dataQualityCard = document.getElementById('dataQualityCard');
    
    // Sample metrics for demonstration
    const sampleMetrics = [
      { id: 'scope1_emissions', name: 'Scope 1 Emissions', value: 3450, unit: 'tCO2e', confidence: 0.92 },
      { id: 'scope2_emissions', name: 'Scope 2 Emissions', value: 7820, unit: 'tCO2e', confidence: 0.88 },
      { id: 'energy_consumption', name: 'Energy Consumption', value: 4250, unit: 'MWh', confidence: 0.95 },
      { id: 'renewable_energy', name: 'Renewable Energy', value: 34, unit: '%', confidence: 0.82 },
      { id: 'gender_diversity', name: 'Gender Diversity', value: 42, unit: '%', confidence: 0.89 },
      { id: 'employee_turnover', name: 'Employee Turnover', value: 12.5, unit: '%', confidence: 0.76 }
    ];
    
    // Open file dialog when browse button is clicked
    browseButton.addEventListener('click', function() {
      fileInput.click();
    });
    
    // Handle file selection
    fileInput.addEventListener('change', function() {
      if (this.files.length > 0) {
        showSelectedFiles(this.files);
      }
    });
    
    // Drag and drop functionality
    dropArea.addEventListener('dragover', function(e) {
      e.preventDefault();
      dropArea.classList.add('active');
    });
    
    dropArea.addEventListener('dragleave', function() {
      dropArea.classList.remove('active');
    });
    
    dropArea.addEventListener('drop', function(e) {
      e.preventDefault();
      dropArea.classList.remove('active');
      
      if (e.dataTransfer.files.length > 0) {
        fileInput.files = e.dataTransfer.files;
        showSelectedFiles(e.dataTransfer.files);
      }
    });
    
    // Display selected files
    function showSelectedFiles(files) {
      fileItems.innerHTML = '';
      
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const fileSize = formatFileSize(file.size);
        const fileIcon = getFileIcon(file.name);
        
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <i class="${fileIcon} me-2"></i>
              <span>${file.name}</span>
            </div>
            <span class="badge bg-secondary">${fileSize}</span>
          </div>
        `;
        
        fileItems.appendChild(fileItem);
      }
      
      fileList.classList.remove('d-none');
    }
    
    // Get appropriate icon for file type
    function getFileIcon(filename) {
      const extension = filename.split('.').pop().toLowerCase();
      
      switch (extension) {
        case 'pdf':
          return 'fas fa-file-pdf text-danger';
        case 'doc':
        case 'docx':
          return 'fas fa-file-word text-primary';
        case 'xls':
        case 'xlsx':
        case 'csv':
          return 'fas fa-file-excel text-success';
        case 'txt':
          return 'fas fa-file-alt text-info';
        default:
          return 'fas fa-file text-muted';
      }
    }
    
    // Format file size for display
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // Clear button functionality
    clearButton.addEventListener('click', function() {
      fileInput.value = '';
      fileItems.innerHTML = '';
      fileList.classList.add('d-none');
    });
    
    // Form submission
    uploadForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      if (fileInput.files.length === 0) {
        alert('Please select at least one file to upload.');
        return;
      }
      
      // Hide upload form and show processing area
      fileList.classList.add('d-none');
      dropArea.classList.add('d-none');
      processingArea.classList.remove('d-none');
      
      // Set processing file name
      processingFileName.textContent = fileInput.files[0].name;
      
      // Simulate processing with different status messages
      const statusMessages = [
        'Extracting data points...',
        'Analyzing document structure...',
        'Identifying sustainability metrics...',
        'Processing tables and charts...',
        'Validating extracted data...'
      ];
      
      let currentMessage = 0;
      
      const statusInterval = setInterval(() => {
        processingStatus.textContent = statusMessages[currentMessage];
        currentMessage = (currentMessage + 1) % statusMessages.length;
      }, 2000);
      
      // Simulate completion after 10 seconds
      setTimeout(() => {
        clearInterval(statusInterval);
        processingArea.classList.add('d-none');
        extractedDataArea.classList.remove('d-none');
        dataQualityCard.classList.remove('d-none');
        showExtractedData();
      }, 10000);
    });
    
    // Display extracted data
    function showExtractedData() {
      extractedDataItems.innerHTML = '';
      
      sampleMetrics.forEach(metric => {
        const confidenceClass = metric.confidence > 0.9 ? 'success' : 
                              metric.confidence > 0.8 ? 'primary' : 
                              metric.confidence > 0.7 ? 'warning' : 'danger';
        
        const item = document.createElement('div');
        item.className = 'extracted-data-item';
        item.innerHTML = `
          <div class="row align-items-center">
            <div class="col-md-4">
              <strong>${metric.name}</strong>
            </div>
            <div class="col-md-3">
              <div class="input-group input-group-sm">
                <input type="text" class="form-control" value="${metric.value}">
                <span class="input-group-text">${metric.unit}</span>
              </div>
            </div>
            <div class="col-md-3">
              <div class="d-flex align-items-center">
                <div class="progress flex-grow-1 me-2" style="height: 6px;">
                  <div class="progress-bar bg-${confidenceClass}" role="progressbar" 
                      style="width: ${metric.confidence * 100}%" aria-valuenow="${metric.confidence * 100}" 
                      aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <span class="small">${Math.round(metric.confidence * 100)}%</span>
              </div>
            </div>
            <div class="col-md-2 text-end">
              <button class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-edit"></i>
              </button>
            </div>
          </div>
        `;
        
        extractedDataItems.appendChild(item);
      });
    }
    
    // Upload more button functionality
    uploadMoreButton.addEventListener('click', function() {
      extractedDataArea.classList.add('d-none');
      dataQualityCard.classList.add('d-none');
      dropArea.classList.remove('d-none');
      fileInput.value = '';
    });
  });
</script>
{% endblock %}