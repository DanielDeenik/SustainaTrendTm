{% extends "layouts/finchat_dark_layout.html" %}

{% block title %}SustainaTrend™ - AI Framework Selector{% endblock %}

{% block styles %}
<style>
  .ai-message {
    background-color: rgba(25, 135, 84, 0.15);
    border-radius: 12px;
    border-top-left-radius: 3px;
    padding: 15px;
    margin-bottom: 10px;
    max-width: 80%;
  }
  
  .user-message {
    background-color: rgba(13, 110, 253, 0.15);
    border-radius: 12px;
    border-top-right-radius: 3px;
    padding: 15px;
    margin-bottom: 10px;
    max-width: 80%;
    margin-left: auto;
  }
  
  .chat-container {
    height: 60vh;
    overflow-y: auto;
    padding: 20px;
    border-radius: 8px;
    background-color: rgba(35, 45, 60, 0.5);
  }
  
  .framework-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border-radius: 8px;
    margin-bottom: 15px;
    cursor: pointer;
  }
  
  .framework-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
  }
  
  .framework-card.selected {
    border: 2px solid var(--bs-primary);
  }
  
  .typing-indicator {
    display: inline-flex;
    align-items: center;
  }
  
  .typing-indicator span {
    height: 8px;
    width: 8px;
    margin: 0 2px;
    background-color: rgba(255, 255, 255, 0.5);
    border-radius: 50%;
    display: inline-block;
    animation: blink 1.4s infinite both;
  }
  
  .typing-indicator span:nth-child(2) {
    animation-delay: 0.2s;
  }
  
  .typing-indicator span:nth-child(3) {
    animation-delay: 0.4s;
  }
  
  @keyframes blink {
    0% { opacity: 0.35; }
    20% { opacity: 1; }
    100% { opacity: 0.35; }
  }
  
  .company-profile-card {
    border-radius: 8px;
    background-color: rgba(35, 45, 60, 0.7);
    padding: 15px;
    margin-bottom: 15px;
  }
  
  .data-point-card {
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    transition: all 0.2s ease;
  }
  
  .data-point-card:hover {
    background-color: rgba(35, 45, 60, 0.8);
  }
  
  .data-point-card.available {
    border-left: 4px solid var(--bs-success);
  }
  
  .data-point-card.missing {
    border-left: 4px solid var(--bs-danger);
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">AI Framework Selector</h1>
        <div>
          <a href="{{ url_for('benchmarking.index') }}" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left me-2"></i>Back to Benchmarking
          </a>
        </div>
      </div>
      <p class="text-muted">
        Our Smart RAG Agent will help you identify the most appropriate benchmarking framework based on your company 
        profile, region, and available sustainability data.
      </p>
    </div>
  </div>
  
  <div class="row">
    <!-- AI Chat Interface -->
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-body p-4">
          <h4 class="card-title mb-3">
            <i class="fas fa-robot text-primary me-2"></i>
            Benchmark Advisor
          </h4>
          
          <!-- Chat Messages -->
          <div class="chat-container mb-3" id="chatContainer">
            <div class="ai-message">
              <div class="d-flex align-items-center mb-2">
                <i class="fas fa-robot me-2 text-success"></i>
                <strong>SustainaTrend™ AI</strong>
              </div>
              <p>Hello! I'm your AI Benchmarking Advisor. I'll help you select the most appropriate sustainability benchmarking framework for your company.</p>
              <p>To start, could you tell me what kind of company you're looking to benchmark?</p>
            </div>
            
            <!-- Dynamic chat messages will be added here -->
          </div>
          
          <!-- Chat Input -->
          <div class="d-flex">
            <input type="text" id="userInput" class="form-control me-2" placeholder="Type your response...">
            <button type="button" id="sendButton" class="btn btn-primary">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Framework Selection Panel -->
    <div class="col-lg-4">
      <div class="card shadow-sm">
        <div class="card-body p-4">
          <h4 class="card-title mb-3">
            <i class="fas fa-clipboard-check text-primary me-2"></i>
            Recommended Frameworks
          </h4>
          
          <!-- Company Profile Summary -->
          <div class="company-profile-card mb-4 d-none" id="companyProfileCard">
            <h5 class="h6 mb-3">Company Profile</h5>
            <div id="companyProfileSummary">
              <!-- Dynamic company profile will be added here -->
            </div>
          </div>
          
          <!-- Frameworks will be recommended here -->
          <div id="frameworkRecommendations">
            <p class="text-muted text-center my-4">
              Frameworks will appear here as we learn more about your company through the conversation.
            </p>
          </div>
          
          <!-- Data Points Analysis -->
          <div id="dataPointsAnalysis" class="d-none">
            <h5 class="h6 mb-3 border-top pt-3">Required Data Points</h5>
            <div id="dataPointsList">
              <!-- Dynamic data points will be added here -->
            </div>
          </div>
          
          <!-- Action Buttons -->
          <div class="mt-4 d-none" id="actionButtons">
            <a href="{{ url_for('benchmarking.document_upload') }}" class="btn btn-primary w-100 mb-2">
              <i class="fas fa-file-upload me-2"></i>Upload Documents for Analysis
            </a>
            <a href="{{ url_for('benchmarking.peer_comparison') }}" id="continueButton" class="btn btn-success w-100">
              <i class="fas fa-chart-bar me-2"></i>Continue to Benchmarking
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const chatContainer = document.getElementById('chatContainer');
    const userInput = document.getElementById('userInput');
    const sendButton = document.getElementById('sendButton');
    const frameworkRecommendations = document.getElementById('frameworkRecommendations');
    const companyProfileCard = document.getElementById('companyProfileCard');
    const companyProfileSummary = document.getElementById('companyProfileSummary');
    const dataPointsAnalysis = document.getElementById('dataPointsAnalysis');
    const dataPointsList = document.getElementById('dataPointsList');
    const actionButtons = document.getElementById('actionButtons');
    const continueButton = document.getElementById('continueButton');
    
    // Conversation state
    let conversationState = {
      step: 1,
      companyName: '',
      sector: '',
      region: '',
      size: '',
      hasData: false,
      dataPoints: [],
      recommendedFramework: ''
    };
    
    // Send button click handler
    sendButton.addEventListener('click', function() {
      sendMessage();
    });
    
    // Enter key handler
    userInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });
    
    // Send message function
    function sendMessage() {
      const message = userInput.value.trim();
      if (message === '') return;
      
      // Add user message to chat
      addUserMessage(message);
      userInput.value = '';
      
      // Show typing indicator
      addTypingIndicator();
      
      // Process response based on conversation state
      setTimeout(() => {
        removeTypingIndicator();
        processUserResponse(message);
      }, 1000);
    }
    
    // Add user message to chat
    function addUserMessage(message) {
      const userMessageDiv = document.createElement('div');
      userMessageDiv.className = 'user-message';
      
      const headerDiv = document.createElement('div');
      headerDiv.className = 'd-flex align-items-center mb-2';
      headerDiv.innerHTML = '<i class="fas fa-user me-2 text-primary"></i><strong>You</strong>';
      
      const messageText = document.createElement('p');
      messageText.textContent = message;
      
      userMessageDiv.appendChild(headerDiv);
      userMessageDiv.appendChild(messageText);
      chatContainer.appendChild(userMessageDiv);
      
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    // Add AI message to chat
    function addAIMessage(message) {
      const aiMessageDiv = document.createElement('div');
      aiMessageDiv.className = 'ai-message';
      
      const headerDiv = document.createElement('div');
      headerDiv.className = 'd-flex align-items-center mb-2';
      headerDiv.innerHTML = '<i class="fas fa-robot me-2 text-success"></i><strong>SustainaTrend™ AI</strong>';
      
      aiMessageDiv.appendChild(headerDiv);
      
      // Split message by paragraphs
      if (Array.isArray(message)) {
        message.forEach(paragraph => {
          const p = document.createElement('p');
          p.textContent = paragraph;
          aiMessageDiv.appendChild(p);
        });
      } else {
        const p = document.createElement('p');
        p.textContent = message;
        aiMessageDiv.appendChild(p);
      }
      
      chatContainer.appendChild(aiMessageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    // Add HTML message from AI
    function addAIHtmlMessage(htmlContent) {
      const aiMessageDiv = document.createElement('div');
      aiMessageDiv.className = 'ai-message';
      
      const headerDiv = document.createElement('div');
      headerDiv.className = 'd-flex align-items-center mb-2';
      headerDiv.innerHTML = '<i class="fas fa-robot me-2 text-success"></i><strong>SustainaTrend™ AI</strong>';
      
      aiMessageDiv.appendChild(headerDiv);
      aiMessageDiv.insertAdjacentHTML('beforeend', htmlContent);
      
      chatContainer.appendChild(aiMessageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    // Add typing indicator
    function addTypingIndicator() {
      const typingDiv = document.createElement('div');
      typingDiv.className = 'ai-message typing-message';
      typingDiv.innerHTML = `
        <div class="d-flex align-items-center mb-2">
          <i class="fas fa-robot me-2 text-success"></i>
          <strong>SustainaTrend™ AI</strong>
        </div>
        <div class="typing-indicator">
          <span></span>
          <span></span>
          <span></span>
        </div>
      `;
      chatContainer.appendChild(typingDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    // Remove typing indicator
    function removeTypingIndicator() {
      const typingMessage = document.querySelector('.typing-message');
      if (typingMessage) {
        typingMessage.remove();
      }
    }
    
    // Process user response based on conversation state
    function processUserResponse(message) {
      switch (conversationState.step) {
        case 1: // Process company type
          handleCompanyTypeResponse(message);
          break;
        case 2: // Process company size
          handleCompanySizeResponse(message);
          break;
        case 3: // Process region
          handleRegionResponse(message);
          break;
        case 4: // Process data availability
          handleDataAvailabilityResponse(message);
          break;
        case 5: // Process framework selection
          handleFrameworkSelectionResponse(message);
          break;
        default:
          addAIMessage("Thank you for your message! Is there anything else you'd like to know about sustainability benchmarking?");
      }
    }
    
    // Handle company type response
    function handleCompanyTypeResponse(message) {
      // Extract potential sector from message
      const sectors = ['technology', 'energy', 'manufacturing', 'consumer goods', 'healthcare', 'financial services',
                        'food', 'agriculture', 'transportation', 'logistics', 'chemicals', 'construction', 'retail'];
      
      let detectedSector = '';
      const lowerMessage = message.toLowerCase();
      
      sectors.forEach(sector => {
        if (lowerMessage.includes(sector)) {
          detectedSector = sector.charAt(0).toUpperCase() + sector.slice(1);
        }
      });
      
      // Look for company name patterns
      let companyName = 'Your Company';
      if (message.includes("called") && message.split("called").length > 1) {
        companyName = message.split("called")[1].trim().split(" ")[0];
      }
      
      // Update conversation state
      conversationState.step = 2;
      conversationState.companyName = companyName;
      
      if (detectedSector) {
        conversationState.sector = detectedSector;
        
        // Update company profile
        updateCompanyProfile();
        
        // AI response
        addAIMessage([
          `Thanks for letting me know about your ${detectedSector} company.`,
          "What's the approximate size of your company? (number of employees, annual revenue, etc.)"
        ]);
      } else {
        // AI response asking for more specific sector
        addAIMessage([
          "I'd like to know more about your company's sector to provide better benchmarking recommendations.",
          "Which industry sector does your company operate in? (Technology, Energy, Manufacturing, Healthcare, etc.)"
        ]);
      }
    }
    
    // Handle company size response
    function handleCompanySizeResponse(message) {
      // Parse company size
      let detectedSize = '';
      const lowerMessage = message.toLowerCase();
      
      if (lowerMessage.includes('startup') || lowerMessage.includes('small') || 
          lowerMessage.match(/\b\d{1,2}\b/) || lowerMessage.includes('under 50')) {
        detectedSize = 'Startup (1-50)';
      } else if (lowerMessage.includes('medium') || lowerMessage.match(/\b\d{2,3}\b/) ||
                lowerMessage.includes('under 250')) {
        detectedSize = 'Small (51-250)';
      } else if (lowerMessage.match(/\b\d{3}\b/) || lowerMessage.includes('under 1000')) {
        detectedSize = 'Medium (251-1000)';
      } else if (lowerMessage.match(/\b\d{4}\b/) || lowerMessage.includes('thousand')) {
        detectedSize = 'Large (1001-5000)';
      } else if (lowerMessage.match(/\b\d{5,}\b/) || lowerMessage.includes('over 5000')) {
        detectedSize = 'Enterprise (5000+)';
      } else {
        detectedSize = 'Medium (251-1000)'; // Default if unclear
      }
      
      // Update conversation state
      conversationState.step = 3;
      conversationState.size = detectedSize;
      
      // Update company profile
      updateCompanyProfile();
      
      // AI response
      addAIMessage([
        `Thanks! Based on your response, I've categorized your company as ${detectedSize}.`,
        "What region or country does your company primarily operate in?"
      ]);
    }
    
    // Handle region response
    function handleRegionResponse(message) {
      // Parse region
      let detectedRegion = '';
      const lowerMessage = message.toLowerCase();
      
      if (lowerMessage.includes('eu') || lowerMessage.includes('europe')) {
        detectedRegion = 'EU';
      } else if (lowerMessage.includes('north america') || lowerMessage.includes('us') || 
                lowerMessage.includes('united states') || lowerMessage.includes('canada')) {
        detectedRegion = 'North America';
      } else if (lowerMessage.includes('asia') || lowerMessage.includes('china') || 
                lowerMessage.includes('japan') || lowerMessage.includes('india')) {
        detectedRegion = 'Asia Pacific';
      } else if (lowerMessage.includes('africa') || lowerMessage.includes('middle east')) {
        detectedRegion = 'Middle East & Africa';
      } else if (lowerMessage.includes('latin') || lowerMessage.includes('south america')) {
        detectedRegion = 'Latin America';
      } else if (lowerMessage.includes('nordic') || lowerMessage.includes('scandinavia')) {
        detectedRegion = 'Nordic';
      } else if (lowerMessage.includes('uk') || lowerMessage.includes('france') || 
                lowerMessage.includes('germany') || lowerMessage.includes('italy')) {
        detectedRegion = 'Western Europe';
      } else {
        detectedRegion = 'Global'; // Default if unclear
      }
      
      // Update conversation state
      conversationState.step = 4;
      conversationState.region = detectedRegion;
      
      // Update company profile
      updateCompanyProfile();
      
      // AI response
      addAIMessage([
        `Great! I've noted that your company operates primarily in ${detectedRegion}.`,
        "Do you have any existing sustainability data collected? For example, do you track greenhouse gas emissions, energy usage, or diversity metrics?"
      ]);
    }
    
    // Handle data availability response
    function handleDataAvailabilityResponse(message) {
      // Parse data availability
      const lowerMessage = message.toLowerCase();
      const hasData = !lowerMessage.includes('no') && !lowerMessage.includes('none') && 
                      !lowerMessage.includes("don't") && !lowerMessage.includes("not yet");
      
      // Identify potential data points in the message
      const dataPointKeywords = {
        'emissions': ['scope1_emissions', 'scope2_emissions', 'scope3_emissions'],
        'greenhouse': ['scope1_emissions', 'scope2_emissions', 'scope3_emissions'],
        'ghg': ['scope1_emissions', 'scope2_emissions', 'scope3_emissions'],
        'carbon': ['scope1_emissions', 'scope2_emissions', 'scope3_emissions'],
        'energy': ['energy_consumption', 'renewable_energy'],
        'renewable': ['renewable_energy', 'renewable_percentage'],
        'water': ['water_consumption', 'water_recycled'],
        'diversity': ['diversity_score', 'gender_diversity', 'ethnic_diversity', 'board_diversity'],
        'gender': ['gender_diversity', 'gender_pay_gap'],
        'waste': ['waste_generated', 'waste_recycled'],
        'governance': ['board_diversity', 'ethics_violations'],
        'social': ['diversity_score', 'employee_turnover'],
        'risk': ['physical_risk_exposure', 'transition_risk_exposure', 'esg_risk_rating']
      };
      
      let detectedDataPoints = [];
      
      Object.keys(dataPointKeywords).forEach(keyword => {
        if (lowerMessage.includes(keyword)) {
          detectedDataPoints = [...detectedDataPoints, ...dataPointKeywords[keyword]];
        }
      });
      
      // Remove duplicates
      detectedDataPoints = [...new Set(detectedDataPoints)];
      
      // Update conversation state
      conversationState.step = 5;
      conversationState.hasData = hasData;
      conversationState.dataPoints = detectedDataPoints;
      
      // Update company profile
      updateCompanyProfile();
      
      // Generate framework recommendations
      generateFrameworkRecommendations();
      
      // Update data points analysis
      updateDataPointsAnalysis();
      
      // Show action buttons
      actionButtons.classList.remove('d-none');
      
      // AI response with recommendations
      let responseMessage = '';
      
      if (hasData) {
        responseMessage = `
          <p>Thanks for sharing your data availability. Based on your company profile and the data you mentioned, I've generated framework recommendations.</p>
          <p>The most appropriate framework for your ${conversationState.sector} company in ${conversationState.region} appears to be the <strong>${conversationState.recommendedFramework}</strong>.</p>
          <p>You can view the detailed recommendations and required data points in the panel on the right. From there, you can upload relevant documents for analysis or proceed directly to benchmarking.</p>
          <p>Would you like to continue with the recommended framework, or would you prefer a different option?</p>
        `;
      } else {
        responseMessage = `
          <p>Based on your company profile, I've generated framework recommendations even though you don't currently collect sustainability data.</p>
          <p>For a ${conversationState.sector} company in ${conversationState.region}, I recommend starting with the <strong>${conversationState.recommendedFramework}</strong> framework, which provides a good foundation for sustainability benchmarking.</p>
          <p>You can view the detailed recommendations and required data points in the panel on the right. This will help you understand what data you'll need to collect for effective benchmarking.</p>
          <p>Would you like to continue with the recommended framework, or would you prefer a different option?</p>
        `;
      }
      
      addAIHtmlMessage(responseMessage);
    }
    
    // Handle framework selection response
    function handleFrameworkSelectionResponse(message) {
      // Parse response to see if user wants to proceed with recommendation
      const lowerMessage = message.toLowerCase();
      const isAgreeing = lowerMessage.includes('yes') || lowerMessage.includes('continue') || 
                          lowerMessage.includes('proceed') || lowerMessage.includes('recommended') ||
                          lowerMessage.includes('sounds good') || lowerMessage.includes('ok');
      
      if (isAgreeing) {
        // Update conversation state
        conversationState.step = 6;
        
        // AI response
        addAIHtmlMessage(`
          <p>Excellent! I'll set up the ${conversationState.recommendedFramework} framework for your benchmarking.</p>
          <p>You're now ready to continue to the benchmarking process. Click the "Continue to Benchmarking" button on the right panel to proceed.</p>
          <p>If you need to upload additional documents or data for more accurate benchmarking, you can use the "Upload Documents for Analysis" button.</p>
          <p>Is there anything else you'd like to know about the recommended framework or the benchmarking process?</p>
        `);
      } else {
        // Check if user mentioned a specific framework
        let alternativeFramework = '';
        
        if (lowerMessage.includes('csrd')) {
          alternativeFramework = 'CSRD';
        } else if (lowerMessage.includes('tcfd')) {
          alternativeFramework = 'TCFD';
        } else if (lowerMessage.includes('sdg')) {
          alternativeFramework = 'SDG';
        } else if (lowerMessage.includes('vc')) {
          alternativeFramework = 'VC_METRICS';
        }
        
        if (alternativeFramework) {
          // Update conversation state
          conversationState.step = 6;
          conversationState.recommendedFramework = alternativeFramework;
          
          // Update continue button
          continueButton.href = `{{ url_for('benchmarking.peer_comparison') }}?framework=${alternativeFramework}`;
          
          // AI response
          addAIHtmlMessage(`
            <p>I've updated your preference to the ${alternativeFramework} framework.</p>
            <p>This is a good choice for your company profile. You can now continue to the benchmarking process by clicking the "Continue to Benchmarking" button on the right panel.</p>
            <p>If you need to upload additional documents or data for more accurate benchmarking, you can use the "Upload Documents for Analysis" button.</p>
            <p>Is there anything else you'd like to know about this framework or the benchmarking process?</p>
          `);
        } else {
          // AI response for unclear preference
          addAIMessage([
            "I'm not sure which framework you'd prefer. If you'd like to explore other options, you can see all available frameworks in the recommendations panel on the right.",
            "Please let me know which framework you'd like to use, or if you're happy to proceed with the recommended one."
          ]);
        }
      }
    }
    
    // Update company profile display
    function updateCompanyProfile() {
      if (conversationState.companyName || conversationState.sector || 
          conversationState.region || conversationState.size) {
        
        companyProfileCard.classList.remove('d-none');
        
        let profileHtml = '';
        
        if (conversationState.companyName) {
          profileHtml += `<p class="mb-1"><strong>Company:</strong> ${conversationState.companyName}</p>`;
        }
        
        if (conversationState.sector) {
          profileHtml += `<p class="mb-1"><strong>Sector:</strong> ${conversationState.sector}</p>`;
        }
        
        if (conversationState.size) {
          profileHtml += `<p class="mb-1"><strong>Size:</strong> ${conversationState.size}</p>`;
        }
        
        if (conversationState.region) {
          profileHtml += `<p class="mb-1"><strong>Region:</strong> ${conversationState.region}</p>`;
        }
        
        companyProfileSummary.innerHTML = profileHtml;
      }
    }
    
    // Generate framework recommendations
    function generateFrameworkRecommendations() {
      // Determine which frameworks to recommend based on company profile
      let recommendations = [];
      
      // Logic for CSRD relevance (EU companies)
      let csrdRelevance = 0;
      if (conversationState.region === 'EU' || conversationState.region === 'Western Europe' || 
          conversationState.region === 'Eastern Europe' || conversationState.region === 'Nordic') {
        csrdRelevance = conversationState.size.includes('Large') || conversationState.size.includes('Enterprise') ? 90 : 70;
      } else {
        csrdRelevance = 40; // Less relevant for non-EU companies
      }
      
      // Logic for TCFD relevance
      let tcfdRelevance = 0;
      if (conversationState.sector === 'Financial Services' || conversationState.sector === 'Energy' ||
          conversationState.sector === 'Transportation') {
        tcfdRelevance = 85;
      } else {
        tcfdRelevance = 65; // Still relevant for all sectors
      }
      
      // Logic for SDG relevance (universally applicable)
      let sdgRelevance = 75;
      
      // Logic for VC Metrics relevance (startups and small companies)
      let vcRelevance = 0;
      if (conversationState.size.includes('Startup') || conversationState.size.includes('Small')) {
        vcRelevance = 95;
      } else if (conversationState.size.includes('Medium')) {
        vcRelevance = 70;
      } else {
        vcRelevance = 40; // Less relevant for large companies
      }
      
      // Create recommendation objects
      recommendations.push({
        id: 'CSRD',
        name: 'Corporate Sustainability Reporting Directive',
        relevance: csrdRelevance,
        reason: conversationState.region.includes('EU') ? 
                'EU-based companies will need to comply with CSRD requirements' :
                'Non-EU companies may need to align with CSRD for EU market access'
      });
      
      recommendations.push({
        id: 'TCFD',
        name: 'Task Force on Climate-related Financial Disclosures',
        relevance: tcfdRelevance,
        reason: conversationState.sector === 'Financial Services' ?
                'Financial institutions have specific TCFD disclosure requirements' :
                'Climate-related financial disclosures relevant across sectors'
      });
      
      recommendations.push({
        id: 'SDG',
        name: 'Sustainable Development Goals',
        relevance: sdgRelevance,
        reason: 'Universal framework applicable to all organizations'
      });
      
      recommendations.push({
        id: 'VC_METRICS',
        name: 'VC Sustainability Metrics',
        relevance: vcRelevance,
        reason: conversationState.size.includes('Startup') || conversationState.size.includes('Small') ?
                'Designed specifically for startups and growth companies' :
                'Can complement other frameworks for established companies'
      });
      
      // Sort by relevance
      recommendations.sort((a, b) => b.relevance - a.relevance);
      
      // Set the recommended framework (highest relevance)
      conversationState.recommendedFramework = recommendations[0].name;
      
      // Update continue button href
      continueButton.href = `{{ url_for('benchmarking.peer_comparison') }}?framework=${recommendations[0].id}`;
      
      // Generate HTML for recommendations
      let recommendationsHtml = '';
      
      recommendations.forEach(framework => {
        const cardClass = framework.relevance > 80 ? 'border-success' : 
                          framework.relevance > 60 ? 'border-primary' : 'border-secondary';
        const badgeClass = framework.relevance > 80 ? 'bg-success' : 
                          framework.relevance > 60 ? 'bg-primary' : 'bg-secondary';
                          
        recommendationsHtml += `
          <div class="framework-card card ${cardClass}" data-framework="${framework.id}">
            <div class="card-body p-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="card-title mb-0">${framework.name}</h6>
                <span class="badge ${badgeClass}">${framework.relevance}%</span>
              </div>
              <p class="card-text small text-muted mb-0">${framework.reason}</p>
            </div>
          </div>
        `;
      });
      
      frameworkRecommendations.innerHTML = recommendationsHtml;
      
      // Add click event listeners to framework cards
      document.querySelectorAll('.framework-card').forEach(card => {
        card.addEventListener('click', function() {
          const frameworkId = this.dataset.framework;
          
          // Update selected card styling
          document.querySelectorAll('.framework-card').forEach(c => c.classList.remove('selected'));
          this.classList.add('selected');
          
          // Update continue button href
          continueButton.href = `{{ url_for('benchmarking.peer_comparison') }}?framework=${frameworkId}`;
          
          // Update recommendation in conversation state
          const frameworkName = this.querySelector('.card-title').textContent;
          conversationState.recommendedFramework = frameworkName;
        });
      });
    }
    
    // Update data points analysis
    function updateDataPointsAnalysis() {
      // Show data points section
      dataPointsAnalysis.classList.remove('d-none');
      
      // Get all possible data points for the recommended framework
      const allDataPoints = [
        // Environmental
        { id: 'scope1_emissions', name: 'Scope 1 Emissions', category: 'Environmental' },
        { id: 'scope2_emissions', name: 'Scope 2 Emissions', category: 'Environmental' },
        { id: 'scope3_emissions', name: 'Scope 3 Emissions', category: 'Environmental' },
        { id: 'energy_consumption', name: 'Energy Consumption', category: 'Environmental' },
        { id: 'renewable_energy', name: 'Renewable Energy', category: 'Environmental' },
        { id: 'water_consumption', name: 'Water Consumption', category: 'Environmental' },
        
        // Social
        { id: 'diversity_score', name: 'Workforce Diversity', category: 'Social' },
        { id: 'gender_diversity', name: 'Gender Diversity', category: 'Social' },
        { id: 'ethnic_diversity', name: 'Ethnic Diversity', category: 'Social' },
        { id: 'employee_turnover', name: 'Employee Turnover', category: 'Social' },
        
        // Governance
        { id: 'board_diversity', name: 'Board Diversity', category: 'Governance' },
        { id: 'ethics_violations', name: 'Ethics Violations', category: 'Governance' }
      ];
      
      // Mark data points as available or missing
      let dataPointsHtml = '';
      
      allDataPoints.forEach(dataPoint => {
        const isAvailable = conversationState.dataPoints.includes(dataPoint.id);
        const cardClass = isAvailable ? 'available' : 'missing';
        const iconClass = isAvailable ? 'fas fa-check text-success' : 'fas fa-exclamation-triangle text-danger';
        const statusText = isAvailable ? 'Available' : 'Required';
        
        dataPointsHtml += `
          <div class="data-point-card ${cardClass}">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <p class="mb-0"><strong>${dataPoint.name}</strong> <span class="badge bg-secondary">${dataPoint.category}</span></p>
                <p class="small text-muted mb-0">Required for complete benchmarking</p>
              </div>
              <div>
                <i class="${iconClass} me-1"></i>
                <span class="small ${isAvailable ? 'text-success' : 'text-danger'}">${statusText}</span>
              </div>
            </div>
          </div>
        `;
      });
      
      dataPointsList.innerHTML = dataPointsHtml;
    }
  });
</script>
{% endblock %}