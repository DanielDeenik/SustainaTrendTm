{% extends "layouts/collapsible_layout.html" %}

{% block title %}Sustainability Dashboard - SustainaTrendâ„¢{% endblock %}

{% block header_title %}Sustainability Dashboard{% endblock %}

{% block header_actions %}
    <button class="btn-primary" onclick="refreshData()">
        <span class="material-icons">refresh</span>
        Refresh Data
    </button>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Overview Cards Row -->
    <div class="dashboard-row">
        <!-- Carbon Emissions Card -->
        <div class="st-data-card">
            <div class="st-data-card-header">
                <h3 class="st-data-card-title">Carbon Emissions</h3>
                <button class="st-data-toggle">
                    <span class="material-icons">expand_more</span>
                </button>
            </div>
            <div class="st-data-content">
                <div class="metric-value-large">
                    <span id="carbon-value">--</span>
                    <span class="metric-unit">tons CO2e</span>
                </div>
                <div class="metric-trend positive">
                    <span class="material-icons">trending_down</span>
                    <span id="carbon-trend">-12%</span> vs last period
                </div>
                <div id="carbon-chart" class="metric-chart"></div>
            </div>
        </div>
        
        <!-- Energy Consumption Card -->
        <div class="st-data-card">
            <div class="st-data-card-header">
                <h3 class="st-data-card-title">Energy Consumption</h3>
                <button class="st-data-toggle">
                    <span class="material-icons">expand_more</span>
                </button>
            </div>
            <div class="st-data-content">
                <div class="metric-value-large">
                    <span id="energy-value">--</span>
                    <span class="metric-unit">MWh</span>
                </div>
                <div class="metric-trend negative">
                    <span class="material-icons">trending_up</span>
                    <span id="energy-trend">+3%</span> vs last period
                </div>
                <div id="energy-chart" class="metric-chart"></div>
            </div>
        </div>
        
        <!-- Water Usage Card -->
        <div class="st-data-card">
            <div class="st-data-card-header">
                <h3 class="st-data-card-title">Water Usage</h3>
                <button class="st-data-toggle">
                    <span class="material-icons">expand_more</span>
                </button>
            </div>
            <div class="st-data-content">
                <div class="metric-value-large">
                    <span id="water-value">--</span>
                    <span class="metric-unit">kL</span>
                </div>
                <div class="metric-trend positive">
                    <span class="material-icons">trending_down</span>
                    <span id="water-trend">-8%</span> vs last period
                </div>
                <div id="water-chart" class="metric-chart"></div>
            </div>
        </div>
    </div>
    
    <!-- Trends and Analysis Row -->
    <div class="dashboard-row">
        <!-- Sustainability Score Card -->
        <div class="st-data-card">
            <div class="st-data-card-header">
                <h3 class="st-data-card-title">Sustainability Score</h3>
                <button class="st-data-toggle">
                    <span class="material-icons">expand_more</span>
                </button>
            </div>
            <div class="st-data-content">
                <div class="score-gauge-container">
                    <div id="score-gauge" class="score-gauge"></div>
                    <div class="score-value">
                        <span id="score-value">78</span>
                        <span class="score-max">/100</span>
                    </div>
                </div>
                <div class="score-breakdown">
                    <div class="score-item">
                        <span class="score-label">Environmental</span>
                        <div class="score-bar-container">
                            <div class="score-bar" style="width: 82%"></div>
                        </div>
                        <span class="score-number">82</span>
                    </div>
                    <div class="score-item">
                        <span class="score-label">Social</span>
                        <div class="score-bar-container">
                            <div class="score-bar" style="width: 75%"></div>
                        </div>
                        <span class="score-number">75</span>
                    </div>
                    <div class="score-item">
                        <span class="score-label">Governance</span>
                        <div class="score-bar-container">
                            <div class="score-bar" style="width: 69%"></div>
                        </div>
                        <span class="score-number">69</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Category Performance Card -->
        <div class="st-data-card">
            <div class="st-data-card-header">
                <h3 class="st-data-card-title">Category Performance</h3>
                <button class="st-data-toggle">
                    <span class="material-icons">expand_more</span>
                </button>
            </div>
            <div class="st-data-content">
                <div id="category-chart" class="category-chart"></div>
            </div>
        </div>
    </div>
    
    <!-- Recent Metrics Card -->
    <div class="st-data-card">
        <div class="st-data-card-header">
            <h3 class="st-data-card-title">Recent Metrics</h3>
            <button class="st-data-toggle">
                <span class="material-icons">expand_more</span>
            </button>
        </div>
        <div class="st-data-content">
            <div class="metrics-table-container">
                <table class="metrics-table" id="metrics-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Value</th>
                            <th>Unit</th>
                            <th>Timestamp</th>
                        </tr>
                    </thead>
                    <tbody id="metrics-table-body">
                        <tr>
                            <td colspan="5" class="loading-text">Loading metrics data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block additional_css %}
<style>
    .dashboard-container {
        padding: 20px;
    }
    
    .dashboard-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .metric-value-large {
        font-size: 2rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 8px;
    }
    
    .metric-unit {
        font-size: 1rem;
        color: #64748b;
        margin-left: 4px;
    }
    
    .metric-trend {
        display: flex;
        align-items: center;
        font-size: 0.9rem;
        margin-bottom: 16px;
    }
    
    .metric-trend.positive {
        color: #10b981;
    }
    
    .metric-trend.negative {
        color: #ef4444;
    }
    
    .metric-trend .material-icons {
        font-size: 1.1rem;
        margin-right: 4px;
    }
    
    .metric-chart {
        height: 150px;
    }
    
    .score-gauge-container {
        position: relative;
        width: 200px;
        height: 200px;
        margin: 0 auto 20px;
    }
    
    .score-gauge {
        width: 100%;
        height: 100%;
    }
    
    .score-value {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }
    
    .score-value span:first-child {
        font-size: 2.5rem;
        font-weight: 700;
        color: #1e293b;
    }
    
    .score-max {
        font-size: 1rem;
        color: #64748b;
    }
    
    .score-breakdown {
        margin-top: 20px;
    }
    
    .score-item {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
    }
    
    .score-label {
        width: 110px;
        flex-shrink: 0;
        font-size: 0.9rem;
        color: #475569;
    }
    
    .score-bar-container {
        flex: 1;
        height: 8px;
        background-color: #e2e8f0;
        border-radius: 4px;
        overflow: hidden;
        margin: 0 12px;
    }
    
    .score-bar {
        height: 100%;
        background-color: #2c7744;
        border-radius: 4px;
    }
    
    .score-number {
        width: 30px;
        text-align: right;
        font-size: 0.9rem;
        font-weight: 500;
        color: #1e293b;
    }
    
    .category-chart {
        height: 300px;
    }
    
    .metrics-table-container {
        overflow-x: auto;
    }
    
    .metrics-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .metrics-table th,
    .metrics-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .metrics-table th {
        font-weight: 500;
        color: #64748b;
        background-color: #f8fafc;
    }
    
    .metrics-table td {
        color: #1e293b;
    }
    
    .loading-text {
        text-align: center;
        color: #64748b;
        padding: 20px;
    }
</style>
{% endblock %}

{% block additional_js %}
<script>
    // Initialize the dashboard charts and data
    function initializeDashboard() {
        // Fetch metrics data from the API
        fetchMetricsData();
        
        // Initialize charts
        initializeCharts();
    }
    
    // Fetch metrics data from the API
    function fetchMetricsData() {
        fetch('/api/metrics')
            .then(response => response.json())
            .then(data => {
                // Update metrics values
                updateMetricsValues(data);
                
                // Update metrics table
                updateMetricsTable(data);
            })
            .catch(error => {
                console.error('Error fetching metrics data:', error);
            });
    }
    
    // Update metrics values
    function updateMetricsValues(data) {
        // Get metrics by category
        const metrics = data.metrics || [];
        
        // Carbon emissions
        const carbonMetric = metrics.find(m => m.name === 'Carbon Emissions');
        if (carbonMetric) {
            document.getElementById('carbon-value').textContent = carbonMetric.value;
        }
        
        // Energy consumption
        const energyMetric = metrics.find(m => m.name === 'Energy Consumption');
        if (energyMetric) {
            document.getElementById('energy-value').textContent = energyMetric.value;
        }
        
        // Water usage
        const waterMetric = metrics.find(m => m.name === 'Water Usage');
        if (waterMetric) {
            document.getElementById('water-value').textContent = waterMetric.value;
        }
    }
    
    // Update metrics table
    function updateMetricsTable(data) {
        const metrics = data.metrics || [];
        const tableBody = document.getElementById('metrics-table-body');
        
        // Clear table
        tableBody.innerHTML = '';
        
        // Add metrics to table
        metrics.slice(0, 10).forEach(metric => {
            const row = document.createElement('tr');
            
            // Format timestamp
            const timestamp = new Date(metric.timestamp);
            const formattedDate = timestamp.toLocaleDateString();
            const formattedTime = timestamp.toLocaleTimeString();
            
            row.innerHTML = `
                <td>${metric.name}</td>
                <td>${metric.category}</td>
                <td>${metric.value}</td>
                <td>${metric.unit}</td>
                <td>${formattedDate} ${formattedTime}</td>
            `;
            
            tableBody.appendChild(row);
        });
        
        // If no metrics, show message
        if (metrics.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = '<td colspan="5" class="loading-text">No metrics data available</td>';
            tableBody.appendChild(row);
        }
    }
    
    // Initialize charts
    function initializeCharts() {
        // Carbon emissions chart
        Plotly.newPlot('carbon-chart', [{
            x: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],
            y: [52, 51, 48, 50, 47, 45, 48, 46, 44, 43, 40, 38],
            type: 'scatter',
            mode: 'lines',
            line: { color: '#2c7744' }
        }], {
            margin: { t: 0, r: 0, l: 30, b: 30 },
            xaxis: { showgrid: false, zeroline: false, showticklabels: false },
            yaxis: { showgrid: false, zeroline: false, showticklabels: false }
        }, { responsive: true, displayModeBar: false });
        
        // Energy consumption chart
        Plotly.newPlot('energy-chart', [{
            x: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],
            y: [245, 240, 238, 245, 250, 248, 252, 260, 265, 263, 270, 275],
            type: 'scatter',
            mode: 'lines',
            line: { color: '#f59e0b' }
        }], {
            margin: { t: 0, r: 0, l: 30, b: 30 },
            xaxis: { showgrid: false, zeroline: false, showticklabels: false },
            yaxis: { showgrid: false, zeroline: false, showticklabels: false }
        }, { responsive: true, displayModeBar: false });
        
        // Water usage chart
        Plotly.newPlot('water-chart', [{
            x: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],
            y: [320, 310, 305, 300, 290, 295, 298, 285, 280, 275, 270, 260],
            type: 'scatter',
            mode: 'lines',
            line: { color: '#0ea5e9' }
        }], {
            margin: { t: 0, r: 0, l: 30, b: 30 },
            xaxis: { showgrid: false, zeroline: false, showticklabels: false },
            yaxis: { showgrid: false, zeroline: false, showticklabels: false }
        }, { responsive: true, displayModeBar: false });
        
        // Sustainability score gauge
        Plotly.newPlot('score-gauge', [{
            type: 'indicator',
            mode: 'gauge',
            value: 78,
            gauge: {
                axis: { range: [0, 100], tickwidth: 1, tickcolor: '#f8fafc', visible: false },
                bar: { color: '#2c7744' },
                bgcolor: '#f1f5f9',
                borderwidth: 0,
                steps: [
                    { range: [0, 50], color: '#fee2e2' },
                    { range: [50, 75], color: '#fef3c7' },
                    { range: [75, 100], color: '#dcfce7' }
                ]
            }
        }], {
            margin: { t: 0, r: 0, l: 0, b: 0 }
        }, { responsive: true, displayModeBar: false });
        
        // Category performance chart
        Plotly.newPlot('category-chart', [{
            x: ['Emissions', 'Energy', 'Water', 'Waste', 'Social'],
            y: [78, 65, 82, 70, 75],
            type: 'bar',
            marker: {
                color: ['#2c7744', '#f59e0b', '#0ea5e9', '#8b5cf6', '#ec4899']
            }
        }], {
            margin: { t: 20, r: 20, l: 50, b: 50 },
            yaxis: { range: [0, 100] }
        }, { responsive: true, displayModeBar: false });
    }
    
    // Refresh data
    function refreshData() {
        fetchMetricsData();
    }
    
    // Initialize dashboard on load
    document.addEventListener('DOMContentLoaded', function() {
        initializeDashboard();
    });
</script>
{% endblock %}