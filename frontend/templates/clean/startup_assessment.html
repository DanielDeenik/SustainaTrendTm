{% extends "clean/base.html" %}

{% set active_nav = 'vc_lens' %}

{% block header_title %}Startup Sustainability Assessment - VC-Lensâ„¢{% endblock %}

{% block header_actions %}
<a href="/vc-lens/" class="btn btn-sm btn-outline-secondary">
    <i class="fas fa-arrow-left me-1"></i> Back to VC-Lens
</a>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Assessment Introduction -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h5>Startup Sustainability Assessment</h5>
                        <p class="text-muted">
                            Complete this comprehensive assessment to evaluate your startup's sustainability profile. 
                            This assessment focuses on your environmental, social, and governance practices, alignment with 
                            sustainability goals, and competitive advantages in sustainability-driven markets.
                        </p>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i> Your responses will be evaluated by our AI-powered assessment system and reviewed by sustainability experts.
                        </div>
                    </div>
                    <div class="col-md-4 text-center">
                        <i class="fas fa-clipboard-check fa-5x text-primary mb-3"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Document Upload for Auto-Fill -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">AI-Powered Auto-Fill</h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    Upload a company sustainability report, pitch deck, or business plan to auto-populate the assessment form.
                    Our AI system will analyze your document and extract relevant information.
                </p>
                
                <div class="mb-3">
                    <div class="input-group">
                        <input type="file" class="form-control" id="auto_fill_document" accept=".pdf,.doc,.docx,.txt,.ppt,.pptx">
                        <button class="btn btn-primary" type="button" id="autoFillBtn" onclick="processDocumentForAutoFill()">
                            <i class="fas fa-magic me-1"></i> Auto-Fill Form
                        </button>
                    </div>
                    <div class="form-text">
                        Accepted formats: PDF, Word, PowerPoint, or plain text. Maximum file size: 10MB.
                    </div>
                </div>
                
                <div class="alert alert-info mt-2" id="processingAlert" style="display: none;">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-2" role="status">
                            <span class="visually-hidden">Processing...</span>
                        </div>
                        <div>
                            <strong>AI Processing</strong> - Analyzing document to auto-populate fields...
                        </div>
                    </div>
                </div>
                <div class="alert alert-success mt-2" id="successAlert" style="display: none;">
                    <i class="fas fa-check-circle me-2"></i>
                    <span id="successMessage">Document processed successfully! Fields have been auto-populated.</span>
                </div>
                <div class="alert alert-warning mt-2" id="partialAlert" style="display: none;">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="partialMessage">Some fields could not be auto-populated. Please review and fill in any missing information.</span>
                </div>
                <div class="alert alert-danger mt-2" id="errorAlert" style="display: none;">
                    <i class="fas fa-times-circle me-2"></i>
                    <span id="errorMessage">Error processing document. Please try again or fill the form manually.</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Assessment Form -->
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Startup Assessment Form</h5>
            </div>
            <div class="card-body">
                <form action="/vc-lens/startup-assessment/submit" method="POST" id="assessmentForm" class="needs-validation" novalidate>
                    <!-- Company Information Section -->
                    <div class="mb-4">
                        <h6 class="fw-bold mb-3">
                            <i class="fas fa-building me-2 text-primary"></i>
                            Company Information
                        </h6>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="company_name" class="form-label">Company Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="company_name" name="company_name" required>
                                <div class="invalid-feedback">
                                    Please provide your company name.
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="industry" class="form-label">Industry <span class="text-danger">*</span></label>
                                <select class="form-select" id="industry" name="industry" required>
                                    <option value="" selected disabled>Select your industry</option>
                                    <option value="Clean Energy">Clean Energy</option>
                                    <option value="AgTech">AgTech</option>
                                    <option value="Circular Economy">Circular Economy</option>
                                    <option value="Carbon Tech">Carbon Tech</option>
                                    <option value="Sustainable Transport">Sustainable Transport</option>
                                    <option value="Water Technology">Water Technology</option>
                                    <option value="Green Building">Green Building</option>
                                    <option value="Sustainable Materials">Sustainable Materials</option>
                                    <option value="Waste Management">Waste Management</option>
                                    <option value="Environmental Services">Environmental Services</option>
                                    <option value="ESG Analytics">ESG Analytics</option>
                                    <option value="Sustainable Finance">Sustainable Finance</option>
                                    <option value="Other">Other</option>
                                </select>
                                <div class="invalid-feedback">
                                    Please select your industry.
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="funding_stage" class="form-label">Funding Stage <span class="text-danger">*</span></label>
                                <select class="form-select" id="funding_stage" name="funding_stage" required>
                                    <option value="" selected disabled>Select your funding stage</option>
                                    <option value="Pre-seed">Pre-seed</option>
                                    <option value="Seed">Seed</option>
                                    <option value="Series A">Series A</option>
                                    <option value="Series B">Series B</option>
                                    <option value="Series C+">Series C+</option>
                                    <option value="Growth Stage">Growth Stage</option>
                                    <option value="Bootstrapped">Bootstrapped</option>
                                </select>
                                <div class="invalid-feedback">
                                    Please select your funding stage.
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="founding_year" class="form-label">Founding Year <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="founding_year" name="founding_year" min="1900" max="2025" required>
                                <div class="invalid-feedback">
                                    Please enter a valid founding year.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sustainability Vision Section -->
                    <div class="mb-4">
                        <h6 class="fw-bold mb-3">
                            <i class="fas fa-leaf me-2 text-primary"></i>
                            Sustainability Vision & Strategy
                        </h6>
                        
                        <div class="mb-3">
                            <label for="sustainability_vision" class="form-label">
                                Describe your startup's sustainability vision and mission. How is sustainability integrated into your core business model? <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control" id="sustainability_vision" name="sustainability_vision" rows="4" required></textarea>
                            <div class="invalid-feedback">
                                Please provide your sustainability vision.
                            </div>
                            <div class="form-text">
                                Include your long-term sustainability goals and how they align with UN SDGs or other frameworks.
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="current_practices" class="form-label">
                                What specific sustainability practices do you currently implement in your operations? <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control" id="current_practices" name="current_practices" rows="4" required></textarea>
                            <div class="invalid-feedback">
                                Please describe your current sustainability practices.
                            </div>
                            <div class="form-text">
                                This could include energy efficiency measures, waste reduction, supply chain standards, diversity & inclusion policies, etc.
                            </div>
                        </div>
                    </div>
                    
                    <!-- Challenges & Opportunities Section -->
                    <div class="mb-4">
                        <h6 class="fw-bold mb-3">
                            <i class="fas fa-mountain me-2 text-primary"></i>
                            Sustainability Challenges & Opportunities
                        </h6>
                        
                        <div class="mb-3">
                            <label for="sustainability_challenges" class="form-label">
                                What are the biggest sustainability challenges your startup faces? <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control" id="sustainability_challenges" name="sustainability_challenges" rows="4" required></textarea>
                            <div class="invalid-feedback">
                                Please describe your sustainability challenges.
                            </div>
                            <div class="form-text">
                                Be specific about both internal obstacles and external market or regulatory challenges.
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="metrics_tracked" class="form-label">
                                Which sustainability metrics do you currently track? <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control" id="metrics_tracked" name="metrics_tracked" rows="4" required></textarea>
                            <div class="invalid-feedback">
                                Please describe the sustainability metrics you track.
                            </div>
                            <div class="form-text">
                                Include environmental metrics (emissions, energy, water, waste), social metrics, and governance metrics.
                            </div>
                        </div>
                    </div>
                    
                    <!-- Market & Investor Alignment Section -->
                    <div class="mb-4">
                        <h6 class="fw-bold mb-3">
                            <i class="fas fa-chart-line me-2 text-primary"></i>
                            Market Position & Investor Alignment
                        </h6>
                        
                        <div class="mb-3">
                            <label for="competitive_advantage" class="form-label">
                                How does your sustainability approach provide a competitive advantage? <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control" id="competitive_advantage" name="competitive_advantage" rows="4" required></textarea>
                            <div class="invalid-feedback">
                                Please describe your competitive advantage.
                            </div>
                            <div class="form-text">
                                Explain how your sustainability approach differentiates you from competitors and creates market opportunities.
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="investor_alignment" class="form-label">
                                How do your sustainability goals align with investor expectations and market trends? <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control" id="investor_alignment" name="investor_alignment" rows="4" required></textarea>
                            <div class="invalid-feedback">
                                Please describe your alignment with investor expectations.
                            </div>
                            <div class="form-text">
                                Include how your sustainability strategy could attract impact investors or ESG-focused venture capital.
                            </div>
                        </div>
                    </div>
                    
                    <!-- Submission Section -->
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-paper-plane me-2"></i> Submit Assessment
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Form validation script
    document.addEventListener('DOMContentLoaded', function() {
        // Fetch all forms that need validation
        var forms = document.querySelectorAll('.needs-validation');
        
        // Loop over them and prevent submission
        Array.prototype.slice.call(forms).forEach(function(form) {
            form.addEventListener('submit', function(event) {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                
                form.classList.add('was-validated');
            }, false);
        });
    });
    
    // Document auto-fill functionality
    function processDocumentForAutoFill() {
        const fileInput = document.getElementById('auto_fill_document');
        if (!fileInput.files || fileInput.files.length === 0) {
            showAlert('errorAlert', 'Please select a document to process first.');
            return;
        }
        
        const file = fileInput.files[0];
        showAlert('processingAlert');
        
        // Create FormData and append the file
        const formData = new FormData();
        formData.append('document', file);
        formData.append('form_type', 'startup_assessment');
        
        // Send the file for processing
        fetch('/vc-lens/process-document', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            // Hide processing alert
            hideAlert('processingAlert');
            
            if (data.success) {

                // Populate form fields with extracted data
                if (data.fields) {
                    const fields = data.fields;
                    populateAvailableFields(fields);
                    
                    // Count how many fields were successfully populated
                    const totalFields = Object.keys(fields).length;
                    const populatedFields = Object.values(fields).filter(value => value && value.trim() !== '').length;
                    
                    // Check if we're using the fallback pattern matching method
                    const usingFallback = data.using_fallback || data.method === 'pattern_matching';
                    const methodName = usingFallback ? 'Pattern Matching' : 'AI Analysis';
                    
                    if (populatedFields === totalFields) {
                        let message = `Document processed successfully! All fields have been auto-populated using ${methodName}.`;
                        showAlert('successAlert', message);
                    } else if (populatedFields > 0) {
                        let message = `${populatedFields} out of ${totalFields} fields were auto-populated using ${methodName}. Please review and complete any missing information.`;
                        showAlert('partialAlert', message);
                    } else {
                        showAlert('errorAlert', 'Could not extract information from the document. Please fill in the form manually.');
                    }
                } else {
                    showAlert('errorAlert', 'No fields could be extracted from the document.');
                }







































            } else {
                // Check if it's a known API error with fallback information
                if (data.using_fallback && data.fallback_reason) {
                    let errorMessage = data.error || 'Error processing document.';
                    
                    if (data.fallback_reason === 'api_key_error') {
                        errorMessage = 'API service unavailable for document analysis. Using basic pattern matching instead.';
                        showAlert('partialAlert', errorMessage);
                    } else if (data.fallback_reason === 'quota_exceeded') {
                        errorMessage = 'AI quota exceeded for document analysis. Using basic pattern matching instead.';
                        showAlert('partialAlert', errorMessage);
                    } else {
                        showAlert('errorAlert', errorMessage + ' Please try again or fill the form manually.');
                    }
                    
                    // Even with errors, we might have partial results
                    if (data.fields && Object.keys(data.fields).length > 0) {
                        populateAvailableFields(data.fields);
                    }
                } else {
                    showAlert('errorAlert', data.error || 'Error processing document. Please try again or fill the form manually.');
                }
            }
























                    } else {
                        showAlert('errorAlert', 'Could not extract information from the document. Please fill in the form manually.');
                    }
                } else {
                    showAlert('errorAlert', 'No fields could be extracted from the document.');
                }
            } else {
                showAlert('errorAlert', data.error || 'Error processing document. Please try again or fill the form manually.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            hideAlert('processingAlert');
            showAlert('errorAlert', 'An unexpected error occurred. Please try again later.');
        });
    }
    

    // Helper function to populate available fields from partial extraction
    function populateAvailableFields(fields) {
        // Basic fields
        if (fields.company_name) document.getElementById("company_name").value = fields.company_name;
        
        // Industry dropdown
        if (fields.industry) {
            const industrySelect = document.getElementById("industry");
            const industryOptions = Array.from(industrySelect.options);
            
            // Find best match for industry
            const matchingOption = industryOptions.find(option => 
                option.value.toLowerCase().includes(fields.industry.toLowerCase()) ||
                fields.industry.toLowerCase().includes(option.value.toLowerCase())
            );
            
            if (matchingOption) {
                industrySelect.value = matchingOption.value;
            }
        }
        
        // Funding stage dropdown
        if (fields.funding_stage) {
            const stageSelect = document.getElementById("funding_stage");
            const stageOptions = Array.from(stageSelect.options);
            
            // Find best match for funding stage
            const matchingOption = stageOptions.find(option => 
                option.value.toLowerCase().includes(fields.funding_stage.toLowerCase()) ||
                fields.funding_stage.toLowerCase().includes(option.value.toLowerCase())
            );
            
            if (matchingOption) {
                stageSelect.value = matchingOption.value;
            }
        }
        
        // Founding year
        if (fields.founding_year) {
            const yearInput = document.getElementById("founding_year");
            const year = parseInt(fields.founding_year);
            if (!isNaN(year) && year >= 1900 && year <= 2025) {
                yearInput.value = year;
            }
        }
        
        // Text fields
        if (fields.sustainability_vision) document.getElementById("sustainability_vision").value = fields.sustainability_vision;
        if (fields.current_practices) document.getElementById("current_practices").value = fields.current_practices;
        if (fields.sustainability_challenges) document.getElementById("sustainability_challenges").value = fields.sustainability_challenges;
        if (fields.metrics_tracked) document.getElementById("metrics_tracked").value = fields.metrics_tracked;
        if (fields.competitive_advantage) document.getElementById("competitive_advantage").value = fields.competitive_advantage;
        if (fields.investor_alignment) document.getElementById("investor_alignment").value = fields.investor_alignment;
    }
    function showAlert(alertId, message = null) {
        // Hide all alerts first
        document.querySelectorAll('.alert').forEach(alert => {
            if (alert.id !== 'processingAlert') {
                alert.style.display = 'none';
            }
        });
        
        // Show the specified alert
        const alert = document.getElementById(alertId);
        if (alert) {
            alert.style.display = 'block';
            
            // Update message if provided
            if (message) {
                const messageElement = alert.querySelector('span');
                if (messageElement) {
                    messageElement.textContent = message;
                }
            }
        }
    }
    
    function hideAlert(alertId) {
        const alert = document.getElementById(alertId);
        if (alert) {
            alert.style.display = 'none';
        }
    }
</script>
{% endblock %}
