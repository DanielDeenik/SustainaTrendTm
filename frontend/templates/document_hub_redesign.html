{% extends "layouts/finchat_dark_layout.html" %}

{% block title %}Documents Hub - SustainaTrendâ„¢ Intelligence Platform{% endblock %}

{% block header_title %}Document & Regulatory Intelligence{% endblock %}

{% block additional_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/document-hub-redesign.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/sustainability-copilot.css') }}">
{% endblock %}

{% block main_content %}
<div class="document-hub-container">
    <!-- Main Content Area -->
    <div class="document-hub-main">
        <!-- Tab Navigation -->
        <div class="doc-hub-tabs">
            <button class="doc-hub-tab active" id="uploadDocsTab">Upload Documents</button>
            <button class="doc-hub-tab" id="analyzeDocsTab">Analyze Documents</button>
            <button class="doc-hub-tab" id="viewInsightsTab">View Insights</button>
        </div>
        
        <!-- Upload Documents Tab -->
        <div id="uploadDocsContent" class="doc-hub-tab-content active">
            <div class="simplified-upload-container">
                <div class="upload-zone modern" id="dropZone" aria-label="Document upload area. Drag and drop files here or click to upload.">
                    <div class="upload-icon">
                        <i class="fas fa-file-upload fa-bounce"></i>
                    </div>
                    <h3 class="upload-title">Sustainability Document Analysis</h3>
                    <p class="upload-description">
                        Upload your sustainability reports, ESG disclosures, or regulatory documents for AI-powered analysis and compliance insights.
                    </p>
                    <div class="upload-actions">
                        <button class="upload-btn centered-btn primary-action" id="uploadBtn">
                            <i class="fas fa-upload"></i> Select Document
                        </button>
                        <span class="or-divider">or</span>
                        <button class="text-paste-btn immediate" id="pasteBtn">
                            <i class="fas fa-paste"></i> Paste Text
                        </button>
                    </div>
                    <div class="upload-formats">
                        <span class="format-badge"><i class="fas fa-file-pdf"></i> PDF</span>
                        <span class="format-badge"><i class="fas fa-file-word"></i> DOCX</span>
                        <span class="format-badge"><i class="fas fa-file-alt"></i> TXT</span>
                    </div>
                    <input type="file" id="fileInput" class="hidden" accept=".pdf,.docx,.txt">
                    <div class="drag-message">Drop your file here</div>
                </div>
                
                <!-- Upload States -->
                <!-- 1. File Selected State -->
                <div class="upload-state file-selected" id="fileSelectedState">
                    <div class="file-name">
                        <i class="fas fa-file-pdf"></i>
                        <span id="fileName">Annual_Report_2024.pdf</span>
                    </div>
                    <div class="upload-state-actions">
                        <button class="upload-btn" id="confirmUploadBtn">
                            <i class="fas fa-upload"></i> Upload
                        </button>
                        <button class="cancel-btn" id="cancelUploadBtn">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
                
                <!-- 2. Upload Progress State -->
                <div class="upload-state upload-progress" id="uploadProgressState">
                    <div class="upload-status">
                        <i class="fas fa-sync-alt fa-spin"></i>
                        <span id="uploadStatusText">Uploading...</span>
                        <span id="uploadPercentage">75%</span>
                    </div>
                    <div class="file-progress">
                        <div class="file-progress-bar" id="fileProgressBar"></div>
                    </div>
                </div>
                
                <!-- 3. Upload Success State -->
                <div class="upload-state upload-success" id="uploadSuccessState">
                    <div class="upload-status">
                        <i class="fas fa-check-circle"></i>
                        <span>Upload Successful</span>
                    </div>
                    <div class="upload-state-actions">
                        <button class="success-btn" id="viewDocumentBtn">
                            <i class="fas fa-eye"></i> View Uploaded Document
                        </button>
                        <button class="upload-btn" id="analyzeBtn">
                            <i class="fas fa-chart-line"></i> Analyze Document
                        </button>
                    </div>
                </div>
                
                <!-- 4. Upload Error State -->
                <div class="upload-state upload-error" id="uploadErrorState">
                    <div class="upload-status">
                        <i class="fas fa-exclamation-circle"></i>
                        <span>Upload Failed</span>
                    </div>
                    <p id="errorMessage">File too large. Please try again with a smaller file.</p>
                    <div class="upload-state-actions">
                        <button class="upload-btn" id="retryBtn">
                            <i class="fas fa-redo"></i> Retry
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Analyze Documents Tab -->
        <div id="analyzeDocsContent" class="doc-hub-tab-content">
            <h3 class="sidebar-title mb-4">Document Analysis Tracking</h3>
            
            <!-- Regulatory AI Analysis Section -->
            <div class="regulatory-ai-section">
                <div class="regulatory-ai-header">
                    <div class="regulatory-ai-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="regulatory-ai-title">Regulatory AI Analysis</div>
                    <div class="regulatory-ai-status" id="regulatoryAiStatus">Processing...</div>
                </div>
                
                <div class="regulatory-ai-progress">
                    <div class="regulatory-ai-progress-bar indeterminate" id="regulatoryAiProgressBar"></div>
                </div>
                
                <div id="regulatoryAiStage" class="mb-2">
                    <strong>Current Stage:</strong> 
                    <span id="currentStage">Extracting document content</span>
                </div>
                
                <div id="regulatoryAiMetrics" class="regulatory-ai-metrics hidden">
                    <div class="regulatory-framework">
                        <div class="framework-name">CSRD Overall</div>
                        <div class="framework-score high" id="csrdScore">78%</div>
                        <div class="framework-description">Corporate Sustainability Reporting Directive</div>
                    </div>
                    
                    <div class="regulatory-framework">
                        <div class="framework-name">ESRS E4</div>
                        <div class="framework-score low" id="esrsE4Score">23%</div>
                        <div class="framework-description">Biodiversity & Ecosystems</div>
                    </div>
                    
                    <div class="regulatory-framework">
                        <div class="framework-name">TCFD</div>
                        <div class="framework-score medium" id="tcfdScore">65%</div>
                        <div class="framework-description">Climate-related Financial Disclosures</div>
                    </div>
                    
                    <div class="regulatory-framework">
                        <div class="framework-name">SFDR</div>
                        <div class="framework-score high" id="sfdrScore">86%</div>
                        <div class="framework-description">Sustainable Finance Disclosure</div>
                    </div>
                </div>
                
                <div id="analysisSummary" class="summary-box hidden">
                    <div class="summary-title">Analysis Summary</div>
                    <div class="summary-content">
                        Your sustainability report shows strong CSRD compliance overall (78%), with excellent coverage of social metrics (92%) and climate-related disclosures (65%). However, biodiversity reporting (23%) falls significantly below industry averages and regulatory requirements. Consider enhancing your biodiversity disclosures to meet ESRS E4 standards.
                    </div>
                </div>
                
                <div class="text-center mt-4">
                    <button class="upload-btn" id="viewInsightsBtn">
                        <i class="fas fa-chart-bar"></i> View Detailed Insights
                    </button>
                </div>
            </div>
            
            <h3 class="sidebar-title mb-4 mt-6">Document Queue</h3>
            <div class="document-list">
                <!-- In Progress Document -->
                <div class="document-card active-analysis">
                    <div class="document-header">
                        <div class="document-title">2024 Sustainability Report</div>
                        <div class="document-status">
                            <div class="status-icon inprogress">
                                <i class="fas fa-sync-alt"></i>
                            </div>
                            <span>In Progress</span>
                        </div>
                    </div>
                    <div class="document-summary">
                        Analyzing CSRD compliance and biodiversity disclosures...
                    </div>
                    <div class="file-progress mt-4">
                        <div class="file-progress-bar" style="width: 45%"></div>
                    </div>
                </div>
                
                <!-- Completed Document -->
                <div class="document-card completed" data-id="doc123">
                    <div class="document-header">
                        <div class="document-title">Q1 2024 ESG Update</div>
                        <div class="document-status">
                            <div class="status-icon completed">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <span>Completed</span>
                        </div>
                    </div>
                    <div class="document-summary">
                        78% CSRD compliance, biodiversity gaps detected
                    </div>
                </div>
                
                <!-- Error Document -->
                <div class="document-card">
                    <div class="document-header">
                        <div class="document-title">TCFD Assessment Draft</div>
                        <div class="document-status">
                            <div class="status-icon error">
                                <i class="fas fa-exclamation-circle"></i>
                            </div>
                            <span>Error</span>
                        </div>
                    </div>
                    <div class="document-summary">
                        Document format not supported. Please convert to PDF.
                    </div>
                </div>
            </div>
        </div>
        
        <!-- View Insights Tab -->
        <div id="viewInsightsContent" class="doc-hub-tab-content">
            <!-- Regulatory Timeline (Collapsible) -->
            <div class="regulatory-timeline">
                <div class="timeline-header">
                    <div class="timeline-title">Regulatory Timeline</div>
                    <button class="timeline-toggle" id="timelineToggle">
                        <i class="fas fa-chevron-down"></i> Show Timeline
                    </button>
                </div>
                
                <div class="horizontal-timeline hidden" id="horizontalTimeline">
                    <div class="timeline-connector"></div>
                    
                    <div class="timeline-item">
                        <div class="timeline-point"></div>
                        <div class="timeline-card">
                            <div class="timeline-card-title">CSRD first reporting deadline</div>
                            <div class="timeline-card-date">EU â€¢ January 2025</div>
                        </div>
                    </div>
                    
                    <div class="timeline-item">
                        <div class="timeline-point"></div>
                        <div class="timeline-card">
                            <div class="timeline-card-title">UK SDR phase 2 requirements</div>
                            <div class="timeline-card-date">UK â€¢ June 2025</div>
                        </div>
                    </div>
                    
                    <div class="timeline-item">
                        <div class="timeline-point"></div>
                        <div class="timeline-card">
                            <div class="timeline-card-title">IFRS S1/S2 effective date</div>
                            <div class="timeline-card-date">Global â€¢ January 2026</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Story Cards -->
            <div class="story-cards">
                <!-- Story Card 1 -->
                <div class="story-card" id="story1">
                    <h3 class="story-headline">Biodiversity Disclosure Gap</h3>
                    <div class="story-visualization">
                        <img src="{{ url_for('static', filename='images/charts/biodiversity_compliance.svg') }}" alt="Biodiversity Compliance Chart" onerror="this.onerror=null; this.src='{{ url_for('static', filename='images/charts/placeholder.svg') }}'">
                    </div>
                    <div class="story-narrative">
                        Your sustainability report shows significant gaps in biodiversity disclosures required by ESRS E4. Only 23% of required biodiversity metrics are present, compared to the industry average of 68%.
                    </div>
                    <div class="story-recommendation">
                        <h4>Recommendation</h4>
                        <p>Add biodiversity impact assessments and species protection metrics to Section 3 of your report to align with ESRS E4 requirements.</p>
                    </div>
                    <div class="story-metadata">
                        <span>Source: Q1 2024 ESG Update</span>
                        <span>Reliability: High</span>
                    </div>
                    
                    <!-- Expanded Content (hidden initially) -->
                    <div class="story-expanded">
                        <div class="mt-4">
                            <h4 class="mb-2">Impact Analysis</h4>
                            <p class="mb-4">Failing to address biodiversity disclosures could result in non-compliance with CSRD requirements starting January 2025. Industry peers in your sector have shown 45% improvement in biodiversity reporting over the past year.</p>
                            
                            <h4 class="mb-2">Action Steps</h4>
                            <ol class="mb-4">
                                <li>Conduct biodiversity impact assessment in key operational areas</li>
                                <li>Integrate biodiversity risks into general risk management framework</li>
                                <li>Develop metrics for species protection and ecosystem restoration</li>
                            </ol>
                            
                            <button class="upload-btn">
                                <i class="fas fa-file-export"></i> Generate Detailed Report
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Story Card 2 -->
                <div class="story-card" id="story2">
                    <h3 class="story-headline">Climate Transition Plan Strength</h3>
                    <div class="story-visualization">
                        <img src="{{ url_for('static', filename='images/charts/climate_transition.svg') }}" alt="Climate Transition Chart" onerror="this.onerror=null; this.src='{{ url_for('static', filename='images/charts/placeholder.svg') }}'">
                    </div>
                    <div class="story-narrative">
                        Your climate transition plan scores in the top quartile for your industry, with strong targets and concrete actions. However, your governance mechanisms for climate risk lack clear accountability structures.
                    </div>
                    <div class="story-recommendation">
                        <h4>Recommendation</h4>
                        <p>Establish climate risk accountability at the board level with specific oversight responsibilities and performance metrics tied to compensation.</p>
                    </div>
                    <div class="story-metadata">
                        <span>Source: Q1 2024 ESG Update</span>
                        <span>Reliability: High</span>
                    </div>
                </div>
                
                <!-- Story Card 3 -->
                <div class="story-card" id="story3">
                    <h3 class="story-headline">Social Impact Reporting Opportunity</h3>
                    <div class="story-visualization">
                        <img src="{{ url_for('static', filename='images/charts/social_impact.svg') }}" alt="Social Impact Chart" onerror="this.onerror=null; this.src='{{ url_for('static', filename='images/charts/placeholder.svg') }}'">
                    </div>
                    <div class="story-narrative">
                        While your report contains comprehensive environmental data, social impact metrics are limited. This creates an opportunity to differentiate your reporting through enhanced social disclosures.
                    </div>
                    <div class="story-recommendation">
                        <h4>Recommendation</h4>
                        <p>Expand social impact reporting to include detailed workforce diversity metrics, community engagement outcomes, and human rights due diligence processes.</p>
                    </div>
                    <div class="story-metadata">
                        <span>Source: Q1 2024 ESG Update</span>
                        <span>Reliability: Medium</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Right Sidebar -->
    <div class="insights-sidebar">
        <h3 class="sidebar-title">Document Analysis Insights</h3>
        
        <!-- Key Metrics -->
        <div class="sidebar-section">
            <h4 class="sidebar-section-title">Key Metrics</h4>
            <div class="metric-item">
                <div class="metric-label">ESRS Compliance</div>
                <div class="metric-value medium">78%</div>
            </div>
            <div class="metric-item">
                <div class="metric-label">Climate Disclosure</div>
                <div class="metric-value high">92%</div>
            </div>
            <div class="metric-item">
                <div class="metric-label">Biodiversity Disclosure</div>
                <div class="metric-value low">23%</div>
            </div>
            <div class="metric-item">
                <div class="metric-label">Social Disclosure</div>
                <div class="metric-value medium">45%</div>
            </div>
        </div>
        
        <!-- Sustainability Co-Pilot Options -->
        <div class="sidebar-section">
            <h4 class="sidebar-section-title">Ask Sustainability Co-Pilot</h4>
            <div class="copilot-options">
                <div class="copilot-option" data-action="analyze-esg">
                    Analyze ESG Metrics
                </div>
                <div class="copilot-option" data-action="csrd-overview">
                    CSRD Overview
                </div>
                <div class="copilot-option" data-action="generate-narrative">
                    Generate Narrative
                </div>
                <div class="copilot-option" data-action="custom-query">
                    Custom Query
                </div>
            </div>
        </div>
        
        <!-- Recent Activity -->
        <div class="sidebar-section">
            <h4 class="sidebar-section-title">Recent Activity</h4>
            <div class="news-item">
                <div class="company-icon">
                    <i class="fas fa-file-alt"></i>
                </div>
                <div class="news-content">
                    <div class="news-title">Q1 2024 ESG Update analyzed</div>
                    <div class="news-meta">
                        <span class="news-time">10 minutes ago</span>
                    </div>
                </div>
            </div>
            <div class="news-item">
                <div class="company-icon">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="news-content">
                    <div class="news-title">Co-Pilot generated biodiversity insights</div>
                    <div class="news-meta">
                        <span class="news-time">1 hour ago</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sustainability Co-Pilot Trigger -->
<div class="sustainability-copilot-trigger" id="copilotTrigger">
    <i class="fas fa-robot"></i>
</div>

<!-- Sustainability Co-Pilot Dialog (imported from sustainability-copilot.html) -->
<div id="sustainabilityCopilotDialog" class="sustainability-copilot-dialog hidden">
    <!-- Content will be loaded via JavaScript -->
</div>

<!-- Text Paste Modal -->
<div id="textPasteModal" class="paste-text-modal hidden">
    <div class="paste-text-content">
        <div class="paste-text-header">
            <h3>Paste Sustainability Text for Analysis</h3>
            <button id="closeModalBtn" class="close-modal-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="paste-text-body">
            <textarea id="pasteTextArea" placeholder="Paste your sustainability report text, ESG disclosures, or regulatory document text here..."></textarea>
        </div>
        <div class="paste-text-footer">
            <button id="cancelPasteBtn" class="cancel-btn">
                <i class="fas fa-times"></i> Cancel
            </button>
            <button id="processPasteBtn" class="upload-btn primary-action">
                <i class="fas fa-check"></i> Process Text
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/sustainability-copilot.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize the upload states - hide all states initially
    function initializeUploadUI() {
        const fileSelectedState = document.getElementById('fileSelectedState');
        const uploadProgressState = document.getElementById('uploadProgressState');
        const uploadSuccessState = document.getElementById('uploadSuccessState');
        const uploadErrorState = document.getElementById('uploadErrorState');
        
        if (fileSelectedState && uploadProgressState && uploadSuccessState && uploadErrorState) {
            fileSelectedState.style.display = 'none';
            uploadProgressState.style.display = 'none';
            uploadSuccessState.style.display = 'none';
            uploadErrorState.style.display = 'none';
        }
    }
    
    // Run initialization after a brief timeout to ensure all elements are loaded
    setTimeout(initializeUploadUI, 100);
    // Tab Navigation
    const tabs = document.querySelectorAll('.doc-hub-tab');
    const tabContents = document.querySelectorAll('.doc-hub-tab-content');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            // Remove active class from all tabs and content
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Add active class to clicked tab
            tab.classList.add('active');
            
            // Show corresponding content
            const tabId = tab.id;
            const contentId = tabId.replace('Tab', 'Content');
            document.getElementById(contentId).classList.add('active');
        });
    });
    
    // Document Upload Elements
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const pasteBtn = document.getElementById('pasteBtn');
    
    // Upload State Elements
    const fileSelectedState = document.getElementById('fileSelectedState');
    const uploadProgressState = document.getElementById('uploadProgressState');
    const uploadSuccessState = document.getElementById('uploadSuccessState');
    const uploadErrorState = document.getElementById('uploadErrorState');
    
    // Action Buttons
    const confirmUploadBtn = document.getElementById('confirmUploadBtn');
    const cancelUploadBtn = document.getElementById('cancelUploadBtn');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const viewDocumentBtn = document.getElementById('viewDocumentBtn');
    const retryBtn = document.getElementById('retryBtn');
    
    // Status Elements
    const fileName = document.getElementById('fileName');
    const uploadStatusText = document.getElementById('uploadStatusText');
    const uploadPercentage = document.getElementById('uploadPercentage');
    const fileProgressBar = document.getElementById('fileProgressBar');
    const errorMessage = document.getElementById('errorMessage');
    
    // Hide all upload states initially
    function hideAllStates() {
        fileSelectedState.style.display = 'none';
        uploadProgressState.style.display = 'none';
        uploadSuccessState.style.display = 'none';
        uploadErrorState.style.display = 'none';
    }
    
    // Show a specific upload state
    function showState(stateElement) {
        hideAllStates();
        stateElement.style.display = 'block';
    }
    
    // Upload button click - open file picker
    uploadBtn.addEventListener('click', () => {
        fileInput.click();
    });
    
    // File input change - handle selected file
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            const file = e.target.files[0];
            handleFileSelected(file);
        }
    });
    
    // Drag and drop events
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
    });
    
    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('drag-over');
    });
    
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        
        if (e.dataTransfer.files.length > 0) {
            const file = e.dataTransfer.files[0];
            handleFileSelected(file);
        }
    });
    
    // Handle file selected state
    function handleFileSelected(file) {
        // Update file name in the selected state
        fileName.textContent = file.name;
        
        // Show the file selected state
        showState(fileSelectedState);
        
        // Store file in global scope for later use
        window.selectedFile = file;
    }
    
    // Confirm Upload Button - Start upload
    confirmUploadBtn.addEventListener('click', () => {
        if (window.selectedFile) {
            beginFileUpload(window.selectedFile);
        }
    });
    
    // Cancel Upload Button - Reset
    cancelUploadBtn.addEventListener('click', () => {
        hideAllStates();
        fileInput.value = ''; // Clear file input
        window.selectedFile = null;
    });
    
    // Begin file upload process
    function beginFileUpload(file) {
        // Show upload progress state
        showState(uploadProgressState);
        
        // Reset progress bar
        fileProgressBar.style.width = '0%';
        
        // Simulate upload progress
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += 5;
            fileProgressBar.style.width = `${progress}%`;
            uploadPercentage.textContent = `${progress}%`;
            
            if (progress >= 100) {
                clearInterval(progressInterval);
                // Show upload success after a short delay
                setTimeout(() => {
                    if (Math.random() > 0.2) { // 80% chance of success for simulation
                        uploadComplete(file);
                    } else {
                        uploadFailed('File upload failed. Network error occurred.');
                    }
                }, 500);
            }
        }, 200);
    }
    
    // Handle successful upload
    function uploadComplete(file) {
        // Show success state
        showState(uploadSuccessState);
        
        // Enable analyze button
        analyzeBtn.disabled = false;
    }
    
    // Handle failed upload
    function uploadFailed(message) {
        // Show error state
        showState(uploadErrorState);
        
        // Update error message
        errorMessage.textContent = message;
    }
    
    // Retry button - Try upload again
    retryBtn.addEventListener('click', () => {
        if (window.selectedFile) {
            beginFileUpload(window.selectedFile);
        } else {
            // If no file in memory, go back to file selected state
            hideAllStates();
        }
    });
    
    // View Document button 
    viewDocumentBtn.addEventListener('click', () => {
        alert('Document viewer would open here in a production environment.');
    });
    
    // Analyze button click
    analyzeBtn.addEventListener('click', () => {
        // Switch to Analyze Documents tab
        document.getElementById('analyzeDocsTab').click();
        
        // Start simulated regulatory AI analysis
        simulateRegulatoryAIAnalysis();
    });
    
    // Text Paste Modal Elements
    const textPasteModal = document.getElementById('textPasteModal');
    const pasteTextArea = document.getElementById('pasteTextArea');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const cancelPasteBtn = document.getElementById('cancelPasteBtn');
    const processPasteBtn = document.getElementById('processPasteBtn');
    
    // Paste text button - Show modal
    pasteBtn.addEventListener('click', () => {
        // Show the modal
        textPasteModal.classList.remove('hidden');
        
        // Focus the textarea
        setTimeout(() => {
            pasteTextArea.focus();
        }, 100);
    });
    
    // Close button functionality
    closeModalBtn.addEventListener('click', () => {
        textPasteModal.classList.add('hidden');
        pasteTextArea.value = '';
    });
    
    // Cancel button functionality
    cancelPasteBtn.addEventListener('click', () => {
        textPasteModal.classList.add('hidden');
        pasteTextArea.value = '';
    });
    
    // Process pasted text button
    processPasteBtn.addEventListener('click', () => {
        const text = pasteTextArea.value.trim();
        
        if (text) {
            // Hide modal
            textPasteModal.classList.add('hidden');
            
            // Show success state with document details
            fileName.textContent = "Pasted Text Document";
            const textLength = text.length;
            const wordCount = text.split(/\s+/).length;
            
            // Create a virtual file object for consistency
            window.selectedFile = {
                name: "Pasted Text Document",
                size: textLength,
                type: "text/plain",
                content: text,
                wordCount: wordCount
            };
            
            // Show success state immediately for text paste
            showState(uploadSuccessState);
        }
    });
    
    // Function to simulate Regulatory AI analysis process
    function simulateRegulatoryAIAnalysis() {
        // Get elements
        const progressBar = document.getElementById('regulatoryAiProgressBar');
        const statusEl = document.getElementById('regulatoryAiStatus');
        const stageEl = document.getElementById('currentStage');
        const metricsEl = document.getElementById('regulatoryAiMetrics');
        const summaryEl = document.getElementById('analysisSummary');
        const viewInsightsBtn = document.getElementById('viewInsightsBtn');
        
        // Remove indeterminate class and set width to 0
        progressBar.classList.remove('indeterminate');
        progressBar.style.width = '0%';
        
        // Initial status
        statusEl.textContent = 'Starting analysis...';
        stageEl.textContent = 'Initializing document processing';
        
        // Define analysis stages
        const stages = [
            { text: 'Extracting document content', progress: 10 },
            { text: 'Parsing sustainability metrics', progress: 25 },
            { text: 'Analyzing CSRD compliance', progress: 40 },
            { text: 'Evaluating ESRS requirements', progress: 55 },
            { text: 'Checking TCFD disclosures', progress: 70 },
            { text: 'Assessing biodiversity reporting', progress: 85 },
            { text: 'Generating compliance assessment', progress: 95 },
            { text: 'Analysis complete', progress: 100 }
        ];
        
        // Simulate progress through stages
        let currentStage = 0;
        
        const analysisInterval = setInterval(() => {
            if (currentStage < stages.length) {
                // Update progress
                const stage = stages[currentStage];
                progressBar.style.width = `${stage.progress}%`;
                stageEl.textContent = stage.text;
                
                if (stage.progress < 100) {
                    statusEl.textContent = `Processing (${stage.progress}%)...`;
                } else {
                    statusEl.textContent = 'Complete';
                }
                
                currentStage++;
            } else {
                // Analysis complete
                clearInterval(analysisInterval);
                
                // Show metrics and summary
                setTimeout(() => {
                    metricsEl.classList.remove('hidden');
                    metricsEl.style.animation = 'fadeInUp 0.5s ease forwards';
                    
                    // Show summary after a short delay
                    setTimeout(() => {
                        summaryEl.classList.remove('hidden');
                        summaryEl.style.animation = 'fadeInUp 0.5s ease forwards';
                        
                        // Enable view insights button
                        viewInsightsBtn.disabled = false;
                    }, 800);
                }, 500);
            }
        }, 1200); // Each step takes 1.2 seconds
        
        // Setup button to view insights
        viewInsightsBtn.addEventListener('click', () => {
            document.getElementById('viewInsightsTab').click();
        });
    }
    
    // Story card expansion
    const storyCards = document.querySelectorAll('.story-card');
    
    storyCards.forEach(card => {
        card.addEventListener('click', () => {
            card.classList.toggle('expanded');
        });
    });
    
    // Timeline toggle
    const timelineToggle = document.getElementById('timelineToggle');
    const horizontalTimeline = document.getElementById('horizontalTimeline');
    
    timelineToggle.addEventListener('click', () => {
        horizontalTimeline.classList.toggle('hidden');
        
        // Update toggle text and icon
        if (horizontalTimeline.classList.contains('hidden')) {
            timelineToggle.innerHTML = '<i class="fas fa-chevron-down"></i> Show Timeline';
        } else {
            timelineToggle.innerHTML = '<i class="fas fa-chevron-up"></i> Hide Timeline';
        }
    });
    
    // Copilot suggestions
    const copilotOptions = document.querySelectorAll('.copilot-option');
    
    copilotOptions.forEach(option => {
        option.addEventListener('click', () => {
            // If the option has a suggestion, open the copilot with that suggestion
            const suggestion = option.getAttribute('data-suggestion');
            if (suggestion) {
                // Open co-pilot with suggestion
                openSustainabilityCopilot(suggestion);
            }
            
            // If the option has an action, handle it
            const action = option.getAttribute('data-action');
            if (action) {
                handleCopilotAction(action);
            }
        });
    });
    
    // Handle copilot actions
    function handleCopilotAction(action) {
        let query = '';
        
        switch (action) {
            case 'analyze-esg':
                query = 'Analyze our ESG metrics and suggest improvements';
                break;
            case 'csrd-overview':
                query = 'Explain CSRD requirements and our compliance status';
                break;
            case 'generate-narrative':
                query = 'Generate a sustainability narrative based on our data';
                break;
            case 'custom-query':
                query = prompt('Enter your sustainability question:');
                if (!query) return; // Exit if canceled
                break;
            default:
                return;
        }
        
        openSustainabilityCopilot(query);
    }
    
    // Initialize Sustainability Co-Pilot
    initSustainabilityCopilot();
    
    // Co-Pilot trigger button
    const copilotTrigger = document.getElementById('copilotTrigger');
    
    copilotTrigger.addEventListener('click', () => {
        openSustainabilityCopilot();
    });
    
    // Document Card Click in Analyze Documents Tab
    const completedDocCards = document.querySelectorAll('.document-card.completed');
    
    completedDocCards.forEach(card => {
        card.addEventListener('click', () => {
            // Switch to View Insights tab
            document.getElementById('viewInsightsTab').click();
        });
    });
});
</script>
{% endblock %}