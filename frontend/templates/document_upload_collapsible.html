{% extends "layouts/collapsible_layout.html" %}

{% block title %}Sustainability Document Analysis | SustainaTrendâ„¢{% endblock %}

{% block header_title %}Document Analysis{% endblock %}

{% block header_actions %}
<button class="finchat-button" id="upload-new-btn">
    <span class="material-icons">add</span>
    <span>New Document</span>
</button>
{% endblock %}

{% block additional_css %}
<style>
    .upload-container {
        background-color: var(--card-bg);
        border: 2px dashed var(--border-color);
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        margin-bottom: 30px;
        transition: all var(--transition-speed);
    }
    
    .upload-container:hover, .upload-container.drag-active {
        border-color: var(--primary-color);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    
    .upload-icon {
        font-size: 3rem;
        color: var(--primary-color);
        margin-bottom: 15px;
    }
    
    .document-preview {
        background-color: var(--card-bg);
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        border: 1px solid var(--border-color);
        display: none;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .analysis-result {
        background-color: var(--card-bg);
        border-radius: 8px;
        padding: 20px;
        margin-top: 30px;
        border-left: 4px solid var(--primary-color);
        display: none;
    }
    
    .analysis-card {
        margin-bottom: 20px;
        background-color: var(--card-bg);
        border-radius: 8px;
        padding: 20px;
        border: 1px solid var(--border-color);
        transition: all var(--transition-speed);
    }
    
    .analysis-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    
    .metric-item {
        background-color: var(--card-bg);
        border-radius: 8px;
        padding: 15px;
        border: 1px solid var(--border-color);
        transition: all var(--transition-speed);
    }
    
    .metric-item:hover {
        border-color: var(--primary-color);
        transform: translateY(-2px);
    }
    
    .metric-category {
        color: var(--primary-color);
        font-weight: 500;
        margin-bottom: 5px;
    }
    
    .framework-badges {
        margin-top: 15px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .framework-badge {
        background-color: var(--secondary-bg);
        color: var(--text-color);
        border-radius: 20px;
        padding: 5px 10px;
        font-size: 0.8rem;
        display: inline-flex;
        align-items: center;
    }
    
    .framework-badge-count {
        background-color: var(--primary-color);
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        margin-left: 5px;
    }
    
    .kpi-list {
        margin-top: 20px;
    }
    
    .kpi-item {
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border-color);
    }
    
    .kpi-item:last-child {
        border-bottom: none;
    }
    
    .kpi-value {
        font-size: 1.2rem;
        font-weight: 500;
        color: var(--primary-color);
    }
    
    .chart-container {
        height: 300px;
        width: 100%;
        margin-top: 20px;
    }
    
    .rag-query-container {
        margin-top: 30px;
    }
    
    .rag-responses {
        margin-top: 20px;
    }
    
    .rag-response {
        background-color: var(--card-bg);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        border-left: 4px solid var(--primary-color);
    }
    
    .loading-indicator {
        display: none;
        text-align: center;
        margin: 20px 0;
    }
    
    .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top: 4px solid var(--primary-color);
        width: 40px;
        height: 40px;
        margin: 0 auto 15px;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    #rag-query-btn {
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 4px;
        padding: 10px 15px;
        cursor: pointer;
        transition: background-color var(--transition-speed);
    }
    
    #rag-query-btn:hover {
        background-color: var(--primary-dark);
    }
    
    .collapsible-section {
        margin-top: 20px;
        transition: all var(--transition-speed);
    }
    
    .collapsible-header {
        padding: 15px;
        background-color: var(--secondary-bg);
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .collapsible-content {
        padding: 20px;
        border: 1px solid var(--border-color);
        border-top: none;
        border-radius: 0 0 8px 8px;
        display: none;
    }
    
    .collapsible-open .collapsible-content {
        display: block;
    }
    
    .collapsible-open .collapsible-header {
        border-radius: 8px 8px 0 0;
    }
    
    .download-report-btn {
        display: inline-flex;
        align-items: center;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 4px;
        padding: 10px 15px;
        cursor: pointer;
        transition: background-color var(--transition-speed);
        text-decoration: none;
    }
    
    .download-report-btn span {
        margin-right: 8px;
    }
    
    .download-report-btn:hover {
        background-color: var(--primary-dark);
    }
</style>
{% endblock %}

{% block content %}
<div class="st-container">
    <div class="st-row">
        <div class="st-col-12">
            <div class="upload-container" id="upload-zone">
                <div class="upload-icon">
                    <span class="material-icons">cloud_upload</span>
                </div>
                <h2>Upload Sustainability Document</h2>
                <p>Drag and drop a PDF file or click to browse</p>
                <p class="upload-formats">Supported formats: PDF</p>
                <input type="file" id="file-input" accept=".pdf" style="display: none;">
                <button class="st-btn st-btn-primary" id="browse-btn">Browse Files</button>
                <div class="upload-options">
                    <label class="upload-option">
                        <input type="checkbox" id="use-ocr">
                        Use OCR for scanned documents
                    </label>
                </div>
            </div>
            
            <div class="loading-indicator" id="loading-indicator">
                <div class="spinner"></div>
                <p>Processing document... This may take a minute.</p>
            </div>
            
            <div class="document-preview" id="document-preview">
                <h3>Document Preview</h3>
                <div class="document-info">
                    <p><strong>Pages:</strong> <span id="page-count">0</span></p>
                    <p><strong>Words:</strong> <span id="word-count">0</span></p>
                </div>
                <div class="text-preview" id="text-preview"></div>
                <button class="st-btn st-btn-primary" id="analyze-btn">Analyze Document</button>
            </div>
            
            <div class="analysis-result" id="analysis-result">
                <h3>Document Analysis Results</h3>
                
                <div class="collapsible-section collapsible-open">
                    <div class="collapsible-header">
                        <h4>Executive Summary</h4>
                        <span class="material-icons">expand_more</span>
                    </div>
                    <div class="collapsible-content">
                        <div id="executive-summary"></div>
                    </div>
                </div>
                
                <div class="collapsible-section">
                    <div class="collapsible-header">
                        <h4>Sustainability Metrics</h4>
                        <span class="material-icons">expand_more</span>
                    </div>
                    <div class="collapsible-content">
                        <div id="metrics-identified" class="metrics-grid"></div>
                    </div>
                </div>
                
                <div class="collapsible-section">
                    <div class="collapsible-header">
                        <h4>Framework Alignment</h4>
                        <span class="material-icons">expand_more</span>
                    </div>
                    <div class="collapsible-content">
                        <div id="frameworks-mentioned" class="framework-badges"></div>
                        <div id="framework-chart" class="chart-container"></div>
                    </div>
                </div>
                
                <div class="collapsible-section">
                    <div class="collapsible-header">
                        <h4>Numerical KPIs</h4>
                        <span class="material-icons">expand_more</span>
                    </div>
                    <div class="collapsible-content">
                        <div id="numerical-kpis" class="kpi-list"></div>
                        <div id="kpi-visualization" class="chart-container"></div>
                    </div>
                </div>
                
                <div class="collapsible-section">
                    <div class="collapsible-header">
                        <h4>Regulatory Compliance</h4>
                        <span class="material-icons">expand_more</span>
                    </div>
                    <div class="collapsible-content">
                        <div id="regulatory-compliance"></div>
                        <a href="#" class="download-report-btn" id="download-report-btn">
                            <span class="material-icons">download</span>
                            Download Compliance Report
                        </a>
                    </div>
                </div>
                
                <div class="rag-query-container">
                    <h4>Ask Questions About This Document</h4>
                    <div class="st-input-group">
                        <input type="text" id="rag-query-input" class="st-input" placeholder="Ask a question about this document...">
                        <button id="rag-query-btn" class="st-btn st-btn-primary">Ask</button>
                    </div>
                    <div class="rag-responses" id="rag-responses"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block additional_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Upload zone functionality
        const uploadZone = document.getElementById('upload-zone');
        const fileInput = document.getElementById('file-input');
        const browseBtn = document.getElementById('browse-btn');
        const uploadNewBtn = document.getElementById('upload-new-btn');
        const useOcr = document.getElementById('use-ocr');
        const loadingIndicator = document.getElementById('loading-indicator');
        const documentPreview = document.getElementById('document-preview');
        const pageCount = document.getElementById('page-count');
        const wordCount = document.getElementById('word-count');
        const textPreview = document.getElementById('text-preview');
        const analyzeBtn = document.getElementById('analyze-btn');
        const analysisResult = document.getElementById('analysis-result');
        
        // Allow drag and drop
        uploadZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadZone.classList.add('drag-active');
        });
        
        uploadZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadZone.classList.remove('drag-active');
        });
        
        uploadZone.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadZone.classList.remove('drag-active');
            if (e.dataTransfer.files.length) {
                handleFileUpload(e.dataTransfer.files[0]);
            }
        });
        
        // Browse button click
        browseBtn.addEventListener('click', function() {
            fileInput.click();
        });
        
        // Upload new button click
        uploadNewBtn.addEventListener('click', function() {
            resetForm();
        });
        
        // File input change
        fileInput.addEventListener('change', function() {
            if (fileInput.files.length) {
                handleFileUpload(fileInput.files[0]);
            }
        });
        
        // Analyze button click
        analyzeBtn.addEventListener('click', function() {
            analyzeDocument();
        });
        
        // Handle file upload
        function handleFileUpload(file) {
            // Check if file is a PDF
            if (file.type !== 'application/pdf') {
                alert('Please upload a PDF file.');
                return;
            }
            
            // Show loading indicator
            uploadZone.style.display = 'none';
            loadingIndicator.style.display = 'block';
            
            // Create FormData object
            const formData = new FormData();
            formData.append('file', file);
            formData.append('use_ocr', useOcr.checked);
            
            // Upload the file
            fetch('/upload-sustainability-document', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                loadingIndicator.style.display = 'none';
                
                if (data.success) {
                    // Store document ID
                    document.documentId = data.document_id;
                    
                    // Show document preview
                    documentPreview.style.display = 'block';
                    pageCount.textContent = data.page_count;
                    wordCount.textContent = data.word_count;
                    textPreview.textContent = data.text_preview;
                } else {
                    alert('Error: ' + data.error);
                    resetForm();
                }
            })
            .catch(error => {
                loadingIndicator.style.display = 'none';
                alert('Error: ' + error);
                resetForm();
            });
        }
        
        // Analyze document
        function analyzeDocument() {
            // Check if document ID exists
            if (!document.documentId) {
                alert('Please upload a document first.');
                return;
            }
            
            // Show loading indicator
            documentPreview.style.display = 'none';
            loadingIndicator.style.display = 'block';
            
            // Analyze the document
            fetch('/analyze-sustainability-document/' + document.documentId)
            .then(response => response.json())
            .then(data => {
                loadingIndicator.style.display = 'none';
                
                if (data.success) {
                    // Show analysis result
                    analysisResult.style.display = 'block';
                    
                    // Executive summary
                    document.getElementById('executive-summary').innerHTML = data.executive_summary;
                    
                    // Metrics identified
                    const metricsContainer = document.getElementById('metrics-identified');
                    metricsContainer.innerHTML = '';
                    
                    Object.entries(data.metrics_identified).forEach(([category, metrics]) => {
                        if (metrics.length) {
                            metrics.forEach(metric => {
                                const metricItem = document.createElement('div');
                                metricItem.className = 'metric-item';
                                metricItem.innerHTML = `
                                    <div class="metric-category">${category}</div>
                                    <div class="metric-name">${metric}</div>
                                `;
                                metricsContainer.appendChild(metricItem);
                            });
                        }
                    });
                    
                    // Frameworks mentioned
                    const frameworksContainer = document.getElementById('frameworks-mentioned');
                    frameworksContainer.innerHTML = '';
                    
                    const frameworkData = [];
                    Object.entries(data.frameworks_mentioned).forEach(([framework, count]) => {
                        const frameworkBadge = document.createElement('div');
                        frameworkBadge.className = 'framework-badge';
                        frameworkBadge.innerHTML = `
                            ${framework}
                            <span class="framework-badge-count">${count}</span>
                        `;
                        frameworksContainer.appendChild(frameworkBadge);
                        
                        frameworkData.push({
                            framework: framework,
                            count: count
                        });
                    });
                    
                    // Framework chart
                    if (frameworkData.length) {
                        const frameworkChartData = {
                            x: frameworkData.map(item => item.framework),
                            y: frameworkData.map(item => item.count),
                            type: 'bar',
                            marker: {
                                color: 'rgba(55, 128, 191, 0.8)'
                            }
                        };
                        
                        const frameworkChartLayout = {
                            title: 'Framework Mentions in Document',
                            xaxis: {
                                title: 'Framework'
                            },
                            yaxis: {
                                title: 'Mentions'
                            },
                            margin: {
                                l: 50,
                                r: 50,
                                b: 100,
                                t: 50,
                                pad: 4
                            }
                        };
                        
                        Plotly.newPlot('framework-chart', [frameworkChartData], frameworkChartLayout);
                    }
                    
                    // Numerical KPIs
                    const kpisContainer = document.getElementById('numerical-kpis');
                    kpisContainer.innerHTML = '';
                    
                    const kpiData = [];
                    data.numerical_kpis.forEach(kpi => {
                        const kpiItem = document.createElement('div');
                        kpiItem.className = 'kpi-item';
                        kpiItem.innerHTML = `
                            <div class="kpi-context">${kpi.context}</div>
                            <div class="kpi-value">${kpi.value} ${kpi.unit}</div>
                        `;
                        kpisContainer.appendChild(kpiItem);
                        
                        if (kpi.value && !isNaN(parseFloat(kpi.value))) {
                            kpiData.push({
                                name: kpi.context,
                                value: parseFloat(kpi.value),
                                unit: kpi.unit
                            });
                        }
                    });
                    
                    // KPI visualization
                    if (kpiData.length && kpiData.length <= 10) {
                        const kpiChartData = {
                            x: kpiData.map(item => item.name),
                            y: kpiData.map(item => item.value),
                            type: 'bar',
                            marker: {
                                color: 'rgba(50, 171, 96, 0.7)'
                            }
                        };
                        
                        const kpiChartLayout = {
                            title: 'Key Performance Indicators',
                            xaxis: {
                                title: 'Metric'
                            },
                            yaxis: {
                                title: 'Value'
                            },
                            margin: {
                                l: 50,
                                r: 50,
                                b: 120,
                                t: 50,
                                pad: 4
                            }
                        };
                        
                        Plotly.newPlot('kpi-visualization', [kpiChartData], kpiChartLayout);
                    }
                    
                    // Regulatory compliance
                    const complianceContainer = document.getElementById('regulatory-compliance');
                    const compliance = data.regulatory_compliance;
                    
                    complianceContainer.innerHTML = `
                        <p><strong>Overall Assessment:</strong> ${compliance.overall_assessment}</p>
                        <h5>Framework Compliance:</h5>
                        <ul>
                            ${Object.entries(compliance.frameworks).map(([framework, score]) => 
                                `<li><strong>${framework}:</strong> ${score}%</li>`
                            ).join('')}
                        </ul>
                        <h5>Key Recommendations:</h5>
                        <ul>
                            ${compliance.recommendations.map(rec => 
                                `<li>${rec}</li>`
                            ).join('')}
                        </ul>
                    `;
                    
                    // Download compliance report button
                    const downloadReportBtn = document.getElementById('download-report-btn');
                    downloadReportBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        generateComplianceReport();
                    });
                    
                    // Set up RAG query functionality
                    setupRagQuery();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                loadingIndicator.style.display = 'none';
                alert('Error: ' + error);
            });
        }
        
        // Generate compliance report
        function generateComplianceReport() {
            if (!document.documentId) {
                alert('Document information not available.');
                return;
            }
            
            fetch('/generate-compliance-report/' + document.documentId)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Create a download link
                    const downloadLink = document.createElement('a');
                    downloadLink.href = data.report_url;
                    downloadLink.download = data.filename;
                    downloadLink.click();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                alert('Error: ' + error);
            });
        }
        
        // Setup RAG query functionality
        function setupRagQuery() {
            const ragQueryInput = document.getElementById('rag-query-input');
            const ragQueryBtn = document.getElementById('rag-query-btn');
            const ragResponses = document.getElementById('rag-responses');
            
            ragQueryBtn.addEventListener('click', function() {
                const query = ragQueryInput.value.trim();
                
                if (!query) {
                    alert('Please enter a question.');
                    return;
                }
                
                loadingIndicator.style.display = 'block';
                
                fetch('/api/sustainability-document-query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        document_id: document.documentId,
                        query: query
                    })
                })
                .then(response => response.json())
                .then(data => {
                    loadingIndicator.style.display = 'none';
                    
                    if (data.success) {
                        const responseEl = document.createElement('div');
                        responseEl.className = 'rag-response';
                        responseEl.innerHTML = `
                            <h5>Q: ${query}</h5>
                            <div class="rag-response-content">${data.response}</div>
                        `;
                        
                        if (data.supporting_metrics && data.supporting_metrics.length) {
                            const metricsList = document.createElement('div');
                            metricsList.className = 'supporting-metrics';
                            metricsList.innerHTML = `
                                <h6>Related Metrics:</h6>
                                <ul>
                                    ${data.supporting_metrics.map(metric => 
                                        `<li>${metric}</li>`
                                    ).join('')}
                                </ul>
                            `;
                            responseEl.appendChild(metricsList);
                        }
                        
                        ragResponses.insertBefore(responseEl, ragResponses.firstChild);
                        ragQueryInput.value = '';
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    loadingIndicator.style.display = 'none';
                    alert('Error: ' + error);
                });
            });
        }
        
        // Reset form
        function resetForm() {
            uploadZone.style.display = 'block';
            loadingIndicator.style.display = 'none';
            documentPreview.style.display = 'none';
            analysisResult.style.display = 'none';
            fileInput.value = '';
            document.documentId = null;
        }
        
        // Collapsible sections
        const collapsibleHeaders = document.querySelectorAll('.collapsible-header');
        collapsibleHeaders.forEach(header => {
            header.addEventListener('click', function() {
                const section = this.parentElement;
                section.classList.toggle('collapsible-open');
                
                const icon = this.querySelector('.material-icons');
                if (section.classList.contains('collapsible-open')) {
                    icon.textContent = 'expand_less';
                } else {
                    icon.textContent = 'expand_more';
                }
            });
        });
    });
</script>

<!-- Document analysis capabilities for Sustainability Co-Pilot -->
<script type="application/json" id="document-copilot-context">
{
    "context": "document_analysis",
    "document_types": ["sustainability_report", "esg_disclosure", "regulatory_filing", "impact_assessment", "carbon_disclosure"],
    "frameworks": ["GRI", "SASB", "TCFD", "EU CSRD", "ESRS", "CDP", "Science Based Targets"],
    "analysis_capabilities": [
        "ESG metrics extraction", 
        "Regulatory compliance assessment", 
        "Framework alignment", 
        "KPI identification", 
        "Executive summary generation",
        "Comparative benchmarking",
        "Climate risk exposure"
    ],
    "suggested_actions": [
        "Framework gap analysis",
        "Compliance prediction",
        "Materiality assessment",
        "Peer comparison",
        "Risk identification",
        "Improvement recommendations"
    ]
}
</script>
{% endblock %}