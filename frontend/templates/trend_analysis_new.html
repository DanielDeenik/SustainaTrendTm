{% extends "base.html" %}

{% block title %}Sustainability Trend Analysis | SustainaTrend™{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/common.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/dark-theme.css') }}">
<!-- Plotly.js for interactive charts -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
{% endblock %}

{% block content %}
<!-- Toast notifications container -->
<div class="toast-container" id="toast-container"></div>

{% include "partials/page_header.html" with 
    title="Sustainability Trend Analysis",
    description="AI-driven insights into emerging sustainability trends",
    show_actions=true,
    show_toggle=true,
    show_filter=true,
    show_export=true
%}

<!-- Filter Modal -->
<div class="filter-modal" id="filter-modal">
    <div class="filter-modal-content">
        <div class="filter-modal-header">
            <h3>Filter Sustainability Trends</h3>
            <button class="close-modal" id="close-modal">&times;</button>
        </div>
        <div class="filter-modal-body">
            <div class="filter-group">
                <label>Time Period</label>
                <div class="filter-options">
                    <label class="filter-option">
                        <input type="radio" name="timeframe" value="all" checked> All Time
                    </label>
                    <label class="filter-option">
                        <input type="radio" name="timeframe" value="year"> Last Year
                    </label>
                    <label class="filter-option">
                        <input type="radio" name="timeframe" value="6month"> Last 6 Months
                    </label>
                    <label class="filter-option">
                        <input type="radio" name="timeframe" value="3month"> Last 3 Months
                    </label>
                    <label class="filter-option">
                        <input type="radio" name="timeframe" value="month"> Last Month
                    </label>
                </div>
            </div>
            <div class="filter-group">
                <label>Categories</label>
                <div class="filter-options">
                    <label class="filter-option">
                        <input type="checkbox" name="category" value="emissions" checked> Emissions
                    </label>
                    <label class="filter-option">
                        <input type="checkbox" name="category" value="energy" checked> Energy
                    </label>
                    <label class="filter-option">
                        <input type="checkbox" name="category" value="water" checked> Water
                    </label>
                    <label class="filter-option">
                        <input type="checkbox" name="category" value="waste" checked> Waste
                    </label>
                    <label class="filter-option">
                        <input type="checkbox" name="category" value="social" checked> Social
                    </label>
                    <label class="filter-option">
                        <input type="checkbox" name="category" value="governance" checked> Governance
                    </label>
                </div>
            </div>
            <div class="filter-group">
                <label>Minimum Virality Score</label>
                <input type="range" class="form-range" id="virality-slider" min="0" max="100" value="30">
                <div class="d-flex justify-content-between">
                    <span>0</span>
                    <span id="virality-value">30</span>
                    <span>100</span>
                </div>
            </div>
        </div>
        <div class="filter-modal-footer">
            <button class="btn btn-outline-secondary" id="reset-filters">Reset</button>
            <button class="btn btn-primary" id="apply-filters">Apply Filters</button>
        </div>
    </div>
</div>

<!-- Analytics Summary Cards -->
<div class="container">
    <div class="analytics-grid mb-4">
        {% include "partials/analytics_card.html" with 
            card_title="Top Trending Metric",
            icon_class="graph-up",
            important=true,
            badge={
                "text": "↑ 24%",
                "type": "success"
            }
        %}
            {% block card_content %}
            <h4 class="fs-2 fw-bold text-success mb-1">Renewable Energy Usage</h4>
            <p class="text-muted mb-0">Highest growth rate across all metrics</p>
            <div class="mt-3 small"><i class="bi bi-info-circle"></i> <span class="text-muted">Virality Score: 92</span></div>
            {% endblock %}
        </div>
        
        {% include "partials/analytics_card.html" with 
            card_title="Emerging Trends",
            icon_class="activity",
            badge={
                "text": "New",
                "type": "info"
            }
        %}
            {% block card_content %}
            <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex align-items-center border-0 px-0">
                    <div class="me-auto">Carbon Capture Implementation</div>
                    <span class="badge bg-primary">↑ 18%</span>
                </li>
                <li class="list-group-item d-flex align-items-center border-0 px-0">
                    <div class="me-auto">Water Recycling Programs</div>
                    <span class="badge bg-success">↑ 14%</span>
                </li>
                <li class="list-group-item d-flex align-items-center border-0 px-0">
                    <div class="me-auto">Diversity Initiatives</div>
                    <span class="badge bg-primary">↑ 12%</span>
                </li>
            </ul>
            {% endblock %}
        </div>
        
        {% include "partials/analytics_card.html" with 
            card_title="Improvement Areas",
            icon_class="flag",
            badge={
                "text": "Attention",
                "type": "warning"
            }
        %}
            {% block card_content %}
            <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex align-items-center border-0 px-0">
                    <div class="me-auto">Scope 3 Emissions</div>
                    <span class="badge bg-danger">↑ 7%</span>
                </li>
                <li class="list-group-item d-flex align-items-center border-0 px-0">
                    <div class="me-auto">Waste Management</div>
                    <span class="badge bg-warning">↓ 3%</span>
                </li>
            </ul>
            {% endblock %}
        </div>
    </div>
</div>

<!-- Main Dashboard Charts -->
<div class="container mt-5">
    <div class="row g-4">
        <!-- Main Trend Chart -->
        <div class="col-lg-8">
            {% include "partials/dashboard_card.html" with
                card_title="Sustainability Trend Analysis",
                icon_class="graph-up",
                card_class="trend-chart-card",
                show_controls=true
            %}
                {% block card_controls %}
                <select id="chart-time-range" class="form-select form-select-sm">
                    <option value="3month">Last 3 Months</option>
                    <option value="6month">Last 6 Months</option>
                    <option value="year" selected>Last Year</option>
                    <option value="all">All Time</option>
                </select>
                {% endblock %}
                
                {% block card_content %}
                <div id="trend-chart" class="trend-chart-container"></div>
                {% endblock %}
            </div>
        </div>
        
        <!-- Category Distribution -->
        <div class="col-lg-4">
            {% include "partials/dashboard_card.html" with
                card_title="Category Distribution",
                icon_class="pie-chart",
                card_class="h-100"
            %}
                {% block card_content %}
                <div id="category-distribution" class="chart-container"></div>
                {% endblock %}
            </div>
        </div>
        
        <!-- Virality Radar -->
        <div class="col-lg-6">
            {% include "partials/dashboard_card.html" with
                card_title="Virality Radar by Category",
                icon_class="bullseye"
            %}
                {% block card_content %}
                <div id="virality-radar" class="chart-container"></div>
                {% endblock %}
            </div>
        </div>
        
        <!-- Sustainability Metrics -->
        <div class="col-lg-6">
            {% include "partials/dashboard_card.html" with
                card_title="Key Metrics Overview",
                icon_class="speedometer2"
            %}
                {% block card_content %}
                <div class="row g-3 text-center">
                    <div class="col-6">
                        <div class="metric-circle">
                            <div class="metric-value" id="total-trends">--</div>
                            <div class="metric-label">Total Trends</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="metric-circle">
                            <div class="metric-value" id="avg-virality">--</div>
                            <div class="metric-label">Avg. Virality</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="metric-circle positive">
                            <div class="metric-value" id="improving-trends">--</div>
                            <div class="metric-label">Improving</div>
                            <div class="metric-percent" id="improving-percent">--%</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="metric-circle negative">
                            <div class="metric-value" id="worsening-trends">--</div>
                            <div class="metric-label">Worsening</div>
                            <div class="metric-percent" id="worsening-percent">--%</div>
                        </div>
                    </div>
                </div>
                {% endblock %}
            </div>
        </div>
    </div>
</div>

<!-- Trend Data Table -->
<div class="container mt-5">
    {% include "partials/dashboard_card.html" with
        card_title="Detailed Trend Data",
        icon_class="table",
        show_controls=true
    %}
        {% block card_controls %}
        <button class="btn btn-sm btn-outline-primary me-2" id="refresh-table">
            <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
        <select id="table-category-filter" class="form-select form-select-sm d-inline-block" style="width: auto;">
            <option value="all">All Categories</option>
            <option value="emissions">Emissions</option>
            <option value="energy">Energy</option>
            <option value="water">Water</option>
            <option value="waste">Waste</option>
            <option value="social">Social</option>
        </select>
        {% endblock %}
        
        {% block card_content %}
        <div class="table-responsive">
            <table class="table table-hover trend-table" id="trend-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Name</th>
                        <th>Category</th>
                        <th>Virality Score</th>
                        <th>Direction</th>
                        <th>Duration</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Will be populated dynamically -->
                    <tr class="placeholder-glow">
                        <td colspan="7" class="text-center py-5">
                            <span class="placeholder col-6"></span>
                            <p class="small text-muted mt-2">Loading trend data...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        {% endblock %}
    </div>
</div>

<!-- React App Mount Point -->
<div id="react-trend-dashboard" class="mt-5">
    <!-- Loading state that will be replaced by React -->
    <div class="d-flex justify-content-center my-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading trend dashboard...</span>
        </div>
    </div>
    
    <!-- Fallback content if JavaScript is disabled -->
    <noscript>
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Please enable JavaScript to view the interactive trend dashboard.
        </div>
    </noscript>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/common.js') }}"></script>
<script src="{{ url_for('static', filename='js/trend-analysis.js') }}"></script>
{% endblock %}