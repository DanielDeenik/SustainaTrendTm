{% extends "base_new.html" %}
{% from "partials/analytics_card.html" import analytics_card %}
{% from "partials/strategy_framework.html" import framework_card, recommendations_list, swot_quadrant %}

{% block title %}{{ title }} | SustainaTrendâ„¢{% endblock %}

{% block styles %}
<link rel="stylesheet" href="/static/css/strategy-simulation.css">
{% endblock %}

{% block content %}
<div class="container-fluid fade-in">
  <!-- Use consistent page header partial -->
  {% with 
    title="Strategy Simulation & McKinsey-Style Reporting",
    description="Apply strategic frameworks to transform sustainability data into actionable business strategies",
    show_actions=true,
    show_export=true
  %}
    {% include "partials/page_header.html" %}
  {% endwith %}

  <!-- Additional action buttons specific to this page -->
  <div class="additional-actions mb-4">
    <button type="button" class="btn btn-outline-primary me-2" id="resetFrameworkBtn">
      <i class="bi bi-arrow-repeat"></i> Reset
    </button>
    <button type="button" class="btn btn-outline-success me-2" id="exportReportBtn">
      <i class="bi bi-file-earmark-pdf"></i> Export Report
    </button>
  </div>

  <!-- Framework Selection Phase -->
  <div id="frameworkSelectionPhase" class="mb-4">
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Select a Strategic Framework</h5>
        <p class="text-muted">Choose a framework to analyze your sustainability initiatives and develop actionable strategies.</p>
      </div>
    </div>
    
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
      {% for id, fw in frameworks.items() %}
        <div class="col">
          {{ framework_card(id, fw.name, fw.description, fw.icon) }}
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- Data Input Phase (initially hidden) -->
  <div id="dataInputPhase" class="mb-4" style="display: none;">
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Data Input: <span id="selectedFrameworkName"></span></h5>
        <button class="btn btn-sm btn-outline-secondary" id="changeFrameworkBtn">
          <i class="bi bi-arrow-left me-1"></i> Change Framework
        </button>
      </div>
      <div class="card-body">
        <form id="frameworkDataForm">
          <div class="mb-3">
            <label for="companyName" class="form-label">Company/Entity Name</label>
            <input type="text" class="form-control" id="companyName" placeholder="Enter your company name">
          </div>
          <div class="mb-3">
            <label for="industrySelect" class="form-label">Industry</label>
            <select class="form-select" id="industrySelect">
              <option selected>Real Estate Development</option>
              <option>Property Management</option>
              <option>Housing Association</option>
              <option>Construction</option>
              <option>Investment Trust (REIT)</option>
              <option>Facilities Management</option>
              <option>Other</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Data Source</label>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="dataSource" id="useConnectedData" value="connected" checked>
              <label class="form-check-label" for="useConnectedData">
                Use connected sustainability data
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="dataSource" id="useUploadedData" value="uploaded">
              <label class="form-check-label" for="useUploadedData">
                Upload custom data file
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="dataSource" id="useSampleData" value="sample">
              <label class="form-check-label" for="useSampleData">
                Use sample data (for demonstration)
              </label>
            </div>
          </div>
          
          <div id="uploadDataSection" class="mb-3" style="display: none;">
            <label for="dataFileUpload" class="form-label">Upload Data File</label>
            <input class="form-control" type="file" id="dataFileUpload">
            <div class="form-text">Supported formats: CSV, Excel, or JSON</div>
          </div>
          
          <div class="d-grid gap-2">
            <button type="button" class="btn btn-primary" id="analyzeDataBtn">
              <i class="bi bi-lightning-charge me-1"></i> Analyze Data
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Analysis Results Phase (initially hidden) -->
  <div id="analysisResultsPhase" class="mb-4" style="display: none;">
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Strategic Analysis Results</h5>
        <div>
          <button class="btn btn-sm btn-outline-secondary me-2" id="editDataBtn">
            <i class="bi bi-pencil me-1"></i> Edit Data
          </button>
          <button class="btn btn-sm btn-primary" id="generateReportBtn">
            <i class="bi bi-file-earmark-text me-1"></i> Generate Full Report
          </button>
        </div>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-8">
            <h4 id="analysis-company-name"></h4>
            <h6 class="text-muted mb-4" id="analysis-industry"></h6>
          </div>
          <div class="col-md-4 text-md-end">
            <span class="badge bg-primary mb-2">Framework: <span id="analysis-framework-name"></span></span>
            <p class="mb-0 small text-muted">Analysis Date: <span id="analysis-date"></span></p>
          </div>
        </div>
        
        <!-- Framework-specific results will be loaded here dynamically -->
        <div id="frameworkResults" class="mt-4"></div>
      </div>
    </div>
    
    <!-- Strategic Recommendations -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">Strategic Recommendations</h5>
      </div>
      <div class="card-body">
        <div id="recommendationsList"></div>
      </div>
    </div>
    
    <!-- Implementation Timeline -->
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Implementation Timeline</h5>
      </div>
      <div class="card-body">
        <div class="implementation-timeline">
          <div class="row">
            <div class="col-md-4">
              <div class="card h-100">
                <div class="card-header bg-primary text-white">
                  <h6 class="mb-0">Short-term (0-6 months)</h6>
                </div>
                <div class="card-body">
                  <ul class="list-group list-group-flush" id="shortTermActions">
                    <!-- Actions will be loaded here -->
                  </ul>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card h-100">
                <div class="card-header bg-primary text-white">
                  <h6 class="mb-0">Medium-term (6-18 months)</h6>
                </div>
                <div class="card-body">
                  <ul class="list-group list-group-flush" id="mediumTermActions">
                    <!-- Actions will be loaded here -->
                  </ul>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card h-100">
                <div class="card-header bg-primary text-white">
                  <h6 class="mb-0">Long-term (18+ months)</h6>
                </div>
                <div class="card-body">
                  <ul class="list-group list-group-flush" id="longTermActions">
                    <!-- Actions will be loaded here -->
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="/static/js/strategy-simulation.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize the strategy simulation interface
    initStrategySimulation();
    
    // Framework selection logic
    const frameworkCards = document.querySelectorAll('.framework-card');
    frameworkCards.forEach(card => {
      card.addEventListener('click', function() {
        const frameworkId = this.getAttribute('data-framework-id');
        const frameworkName = this.querySelector('.card-title').textContent;
        
        // Update UI to show the data input phase
        document.getElementById('frameworkSelectionPhase').style.display = 'none';
        document.getElementById('dataInputPhase').style.display = 'block';
        document.getElementById('selectedFrameworkName').textContent = frameworkName;
        document.getElementById('dataInputPhase').setAttribute('data-selected-framework', frameworkId);
      });
    });
    
    // Data source selection logic
    const dataSourceRadios = document.querySelectorAll('input[name="dataSource"]');
    dataSourceRadios.forEach(radio => {
      radio.addEventListener('change', function() {
        const uploadSection = document.getElementById('uploadDataSection');
        if (this.value === 'uploaded') {
          uploadSection.style.display = 'block';
        } else {
          uploadSection.style.display = 'none';
        }
      });
    });
    
    // Change framework button
    document.getElementById('changeFrameworkBtn').addEventListener('click', function() {
      document.getElementById('dataInputPhase').style.display = 'none';
      document.getElementById('frameworkSelectionPhase').style.display = 'block';
    });
    
    // Analyze data button
    document.getElementById('analyzeDataBtn').addEventListener('click', function() {
      const frameworkId = document.getElementById('dataInputPhase').getAttribute('data-selected-framework');
      const companyName = document.getElementById('companyName').value || 'Sample Company';
      const industry = document.getElementById('industrySelect').value;
      const dataSource = document.querySelector('input[name="dataSource"]:checked').value;
      
      // Show loading state
      this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Analyzing...';
      this.disabled = true;
      
      // Simulate API call with setTimeout
      setTimeout(() => {
        // Get framework analysis
        fetch('/strategy-simulation/api/framework-analysis', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            framework_id: frameworkId,
            company_name: companyName,
            industry: industry,
            data_source: dataSource
          })
        })
        .then(response => response.json())
        .then(data => {
          // Update analysis phase with results
          document.getElementById('dataInputPhase').style.display = 'none';
          document.getElementById('analysisResultsPhase').style.display = 'block';
          
          // Update analysis headers
          document.getElementById('analysis-company-name').textContent = companyName;
          document.getElementById('analysis-industry').textContent = industry;
          document.getElementById('analysis-framework-name').textContent = 
            document.getElementById('selectedFrameworkName').textContent;
          document.getElementById('analysis-date').textContent = new Date().toLocaleDateString();
          
          // Display framework-specific results
          displayAnalysisResults(frameworkId, data);
          
          // Display recommendations
          const recommendationsList = document.getElementById('recommendationsList');
          if (data.recommendations && data.recommendations.length > 0) {
            recommendationsList.innerHTML = '';
            const recList = document.createElement('div');
            recList.className = 'list-group';
            
            data.recommendations.forEach(rec => {
              const item = document.createElement('div');
              item.className = 'list-group-item list-group-item-action';
              
              const header = document.createElement('div');
              header.className = 'd-flex w-100 justify-content-between';
              
              const title = document.createElement('h5');
              title.className = 'mb-1';
              title.textContent = rec.title;
              
              const badge = document.createElement('span');
              badge.className = `badge bg-${rec.impact.toLowerCase() === 'high' ? 'danger' : 
                                           rec.impact.toLowerCase() === 'medium' ? 'warning' : 'success'}`;
              badge.textContent = rec.impact;
              
              header.appendChild(title);
              header.appendChild(badge);
              
              const description = document.createElement('p');
              description.className = 'mb-1';
              description.textContent = rec.description;
              
              const footer = document.createElement('div');
              footer.className = 'mt-2 d-flex justify-content-between align-items-center';
              
              const timeframe = document.createElement('small');
              timeframe.className = 'text-muted';
              timeframe.textContent = `Timeframe: ${rec.timeframe}`;
              
              const metrics = document.createElement('div');
              if (rec.key_metrics && rec.key_metrics.length > 0) {
                rec.key_metrics.forEach(metric => {
                  const badge = document.createElement('span');
                  badge.className = 'badge bg-light text-dark me-1';
                  badge.textContent = metric;
                  metrics.appendChild(badge);
                });
              }
              
              footer.appendChild(timeframe);
              footer.appendChild(metrics);
              
              item.appendChild(header);
              item.appendChild(description);
              item.appendChild(footer);
              
              recList.appendChild(item);
            });
            
            recommendationsList.appendChild(recList);
            
            // Populate implementation timeline
            populateImplementationTimeline(data.recommendations);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showNotification('Error analyzing data. Please try again.', 'bi-exclamation-triangle', 'error');
        })
        .finally(() => {
          // Reset button state
          document.getElementById('analyzeDataBtn').innerHTML = '<i class="bi bi-lightning-charge me-1"></i> Analyze Data';
          document.getElementById('analyzeDataBtn').disabled = false;
        });
      }, 1500);
    });
    
    // Edit data button
    document.getElementById('editDataBtn').addEventListener('click', function() {
      document.getElementById('analysisResultsPhase').style.display = 'none';
      document.getElementById('dataInputPhase').style.display = 'block';
    });
    
    // Reset button
    document.getElementById('resetFrameworkBtn').addEventListener('click', function() {
      document.getElementById('analysisResultsPhase').style.display = 'none';
      document.getElementById('dataInputPhase').style.display = 'none';
      document.getElementById('frameworkSelectionPhase').style.display = 'block';
    });
  });
  
  // Helper function to display analysis results based on framework
  function displayAnalysisResults(frameworkId, data) {
    const resultsContainer = document.getElementById('frameworkResults');
    resultsContainer.innerHTML = '';
    
    if (frameworkId === 'porters') {
      displayPortersResults(data);
    } else if (frameworkId === 'swot') {
      displaySwotResults(data);
    } else if (frameworkId === 'bcg') {
      displayBcgResults(data);
    } else if (frameworkId === 'mckinsey') {
      displayMcKinseyResults(data);
    } else if (frameworkId === 'strategy_pyramid') {
      displayStrategyPyramidResults(data);
    } else if (frameworkId === 'blue_ocean') {
      displayBlueOceanResults(data);
    }
  }
  
  // Helper function to populate the implementation timeline
  function populateImplementationTimeline(recommendations) {
    const shortTermList = document.getElementById('shortTermActions');
    const mediumTermList = document.getElementById('mediumTermActions');
    const longTermList = document.getElementById('longTermActions');
    
    // Clear existing items
    shortTermList.innerHTML = '';
    mediumTermList.innerHTML = '';
    longTermList.innerHTML = '';
    
    // Sort recommendations into timeframes
    recommendations.forEach(rec => {
      const timeframe = rec.timeframe.toLowerCase();
      const listItem = document.createElement('li');
      listItem.className = 'list-group-item border-0 px-0';
      
      const title = document.createElement('strong');
      title.textContent = rec.title;
      
      const description = document.createElement('p');
      description.className = 'mb-0 small text-muted';
      description.textContent = rec.description;
      
      listItem.appendChild(title);
      listItem.appendChild(description);
      
      if (timeframe.includes('0-6') || timeframe.includes('3-9') || timeframe.includes('short')) {
        shortTermList.appendChild(listItem);
      } else if (timeframe.includes('6-12') || timeframe.includes('6-18') || timeframe.includes('medium')) {
        mediumTermList.appendChild(listItem);
      } else {
        longTermList.appendChild(listItem);
      }
    });
  }
</script>
{% endblock %}