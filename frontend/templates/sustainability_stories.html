{% extends "base_new.html" %}

{% block title %}Sustainability Storytelling | SustainaTrend™{% endblock %}

{% block styles %}
<style>
    .stories-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    .story-card {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        overflow: hidden;
        transition: transform 0.3s ease;
    }
    .story-card:hover {
        transform: translateY(-5px);
    }
    .story-header {
        padding: 20px;
        background: linear-gradient(135deg, #1e5631, #2e7d32);
        color: white;
    }
    .story-title {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
    }
    .story-meta {
        display: flex;
        justify-content: space-between;
        font-size: 0.9rem;
        margin-top: 8px;
    }
    .story-body {
        padding: 20px;
    }
    .story-metrics {
        display: flex;
        margin-top: 15px;
        border-top: 1px solid #eee;
        padding-top: 15px;
    }
    .metric {
        display: flex;
        align-items: center;
        margin-right: 20px;
        color: #555;
    }
    .metric i {
        margin-right: 5px;
    }
    .story-tags {
        display: flex;
        flex-wrap: wrap;
        margin-top: 15px;
    }
    .tag {
        background-color: #e9f5ea;
        color: #2e7d32;
        border-radius: 20px;
        padding: 5px 12px;
        margin-right: 8px;
        margin-bottom: 8px;
        font-size: 0.85rem;
    }
    .story-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
    }
    .story-form {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        padding: 25px;
        margin-bottom: 30px;
    }
    .form-title {
        margin-top: 0;
        margin-bottom: 20px;
        color: #2e7d32;
        font-weight: 600;
    }
    #story-loading {
        display: none;
        text-align: center;
        padding: 20px;
    }
    .section-title {
        position: relative;
        padding-bottom: 10px;
        margin-bottom: 20px;
        font-weight: 600;
        color: #2e7d32;
    }
    .section-title::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 50px;
        height: 3px;
        background-color: #2e7d32;
    }
    .recommendation-list {
        list-style-type: none;
        padding: 0;
    }
    .recommendation-list li {
        padding: 10px 0;
        border-bottom: 1px solid #f0f0f0;
    }
    .recommendation-list li:last-child {
        border-bottom: none;
    }
    .recommendation-list li:before {
        content: '✓';
        color: #2e7d32;
        margin-right: 10px;
    }
    .story-detail {
        padding: 30px;
        margin-top: 20px;
    }
    .benchmark-item {
        padding: 10px 15px;
        margin-bottom: 10px;
        background-color: #f9f9f9;
        border-left: 3px solid #2e7d32;
        border-radius: 0 4px 4px 0;
    }
    .financial-impact-card {
        background-color: #f0f7f0;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
    }
    .financial-metric {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px dashed #ccc;
    }
    .financial-metric:last-child {
        border-bottom: none;
    }
    .financial-metric-value {
        font-weight: bold;
    }
    .positive-value {
        color: #2e7d32;
    }
    .negative-value {
        color: #c62828;
    }
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }
    .metric-card {
        background-color: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
    }
    .metric-name {
        font-size: 0.85rem;
        color: #555;
        margin-bottom: 8px;
    }
    .metric-description {
        font-weight: 600;
        color: #333;
    }
    .swot-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr;
        gap: 15px;
        margin-top: 15px;
    }
    .swot-cell {
        padding: 15px;
        border-radius: 8px;
    }
    .swot-strengths {
        background-color: rgba(46, 125, 50, 0.1);
        border-left: 4px solid #2e7d32;
    }
    .swot-weaknesses {
        background-color: rgba(198, 40, 40, 0.1);
        border-left: 4px solid #c62828;
    }
    .swot-opportunities {
        background-color: rgba(33, 150, 243, 0.1);
        border-left: 4px solid #2196f3;
    }
    .swot-threats {
        background-color: rgba(245, 124, 0, 0.1);
        border-left: 4px solid #f57c00;
    }
    .swot-title {
        font-weight: 600;
        margin-bottom: 10px;
    }
    .score-indicator {
        display: inline-block;
        width: 50px;
        height: 50px;
        line-height: 50px;
        text-align: center;
        font-weight: bold;
        font-size: 1.2rem;
        border-radius: 50%;
        color: white;
        margin-right: 15px;
    }
    .score-high {
        background-color: #2e7d32;
    }
    .score-medium {
        background-color: #f57c00;
    }
    .score-low {
        background-color: #c62828;
    }
</style>
{% endblock %}

{% block content %}
<div class="container stories-container">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="mb-4">Sustainability Storytelling</h1>
            <p class="lead">Generate AI-powered sustainability transformation stories using McKinsey frameworks to create strategic narratives, business flywheels, and monetization pathways.</p>
        </div>
    </div>

    <!-- Story Generation Form -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="story-form">
                <h3 class="form-title">Generate a Sustainability Story</h3>
                <form id="story-form">
                    <div class="mb-3">
                        <label for="company-name" class="form-label">Company Name</label>
                        <input type="text" class="form-control" id="company-name" name="company_name" placeholder="Enter company name" required>
                    </div>
                    <div class="mb-3">
                        <label for="industry" class="form-label">Industry</label>
                        <select class="form-select" id="industry" name="industry" required>
                            <option value="" selected disabled>Select an industry</option>
                            <option value="technology">Technology</option>
                            <option value="manufacturing">Manufacturing</option>
                            <option value="retail">Retail</option>
                            <option value="energy">Energy</option>
                            <option value="healthcare">Healthcare</option>
                            <option value="finance">Finance</option>
                            <option value="transportation">Transportation</option>
                            <option value="agriculture">Agriculture</option>
                            <option value="construction">Construction</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Generate Story</button>
                </form>
                <div id="story-loading" class="mt-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Generating story...</span>
                    </div>
                    <p class="mt-2">Generating your sustainability story with AI...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Story Detail View (hidden initially) -->
    <div id="story-detail" class="row mb-5" style="display: none;">
        <div class="col-12">
            <div class="card story-detail">
                <div class="card-header bg-success text-white">
                    <h2 id="detail-title" class="card-title mb-0"></h2>
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <span id="detail-company-industry"></span>
                        <span id="detail-date" class="text-white-50"></span>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Industry Context -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="d-flex align-items-center mb-3">
                                <i class="bi bi-globe2 fs-4 me-2 text-success"></i>
                                <h4 class="section-title mb-0">Industry Context</h4>
                            </div>
                            <p id="detail-industry-context"></p>
                        </div>
                    </div>

                    <!-- Main Content Row -->
                    <div class="row">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center mb-3">
                                <i class="bi bi-bullseye fs-4 me-2 text-success"></i>
                                <h4 class="section-title mb-0">Sustainability Strategy</h4>
                            </div>
                            <p id="detail-strategy"></p>

                            <!-- Benchmarking -->
                            <div class="d-flex align-items-center mb-3 mt-4">
                                <i class="bi bi-bar-chart fs-4 me-2 text-success"></i>
                                <h4 class="section-title mb-0">Competitor Benchmarking</h4>
                            </div>
                            <div id="detail-benchmarking">
                                <!-- Benchmarking items will be added here dynamically -->
                            </div>

                            <!-- Monetization Model -->
                            <div class="d-flex align-items-center mb-3 mt-4">
                                <i class="bi bi-cash-coin fs-4 me-2 text-success"></i>
                                <h4 class="section-title mb-0">Monetization Model</h4>
                            </div>
                            <p id="detail-monetization"></p>

                            <!-- Investment Pathway -->
                            <div class="d-flex align-items-center mb-3 mt-4">
                                <i class="bi bi-graph-up-arrow fs-4 me-2 text-success"></i>
                                <h4 class="section-title mb-0">Investment Pathway</h4>
                            </div>
                            <p id="detail-investment"></p>

                            <!-- Financial Impact -->
                            <div class="d-flex align-items-center mb-3 mt-4">
                                <i class="bi bi-cash-stack fs-4 me-2 text-success"></i>
                                <h4 class="section-title mb-0">Estimated Financial Impact</h4>
                            </div>
                            <div class="financial-impact-card">
                                <div id="detail-financial-impact">
                                    <!-- Financial impact metrics will be added here dynamically -->
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <!-- Performance Metrics -->
                            <div class="card mb-4">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0">Key Performance Metrics</h5>
                                </div>
                                <div class="card-body">
                                    <div id="detail-performance-metrics">
                                        <!-- Performance metrics will be added here dynamically -->
                                    </div>
                                </div>
                            </div>

                            <!-- Recommendations -->
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0">Actionable Recommendations</h5>
                                </div>
                                <div class="card-body">
                                    <ul id="detail-recommendations" class="recommendation-list">
                                        <!-- Recommendations will be added here dynamically -->
                                    </ul>
                                </div>
                            </div>

                            <!-- Story Engagement -->
                            <div class="card mt-4">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0">Story Engagement</h5>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div class="metric">
                                            <i class="bi bi-eye"></i> <span id="detail-views">0</span> Views
                                        </div>
                                        <div class="metric">
                                            <i class="bi bi-hand-thumbs-up"></i> <span id="detail-likes">0</span> Likes
                                        </div>
                                        <div class="metric">
                                            <i class="bi bi-share"></i> <span id="detail-shares">0</span> Shares
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 text-end">
                        <button id="btn-like" class="btn btn-outline-success btn-sm">
                            <i class="bi bi-hand-thumbs-up"></i> Like
                        </button>
                        <button id="btn-share" class="btn btn-outline-primary btn-sm ms-2">
                            <i class="bi bi-share"></i> Share
                        </button>
                        <button id="btn-download" class="btn btn-outline-secondary btn-sm ms-2">
                            <i class="bi bi-download"></i> Download PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stories List (will be populated with JavaScript) -->
    <div class="row">
        <div class="col-12">
            <h3 class="mb-4">Recent Stories</h3>
            <div id="stories-container">
                <div class="text-center py-5">
                    <p class="text-muted">No stories available yet. Generate your first sustainability story!</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const storyForm = document.getElementById('story-form');
    const storyLoading = document.getElementById('story-loading');
    const storyDetail = document.getElementById('story-detail');
    const storiesContainer = document.getElementById('stories-container');

    // Story detail elements
    const detailTitle = document.getElementById('detail-title');
    const detailCompanyIndustry = document.getElementById('detail-company-industry');
    const detailDate = document.getElementById('detail-date');
    const detailIndustryContext = document.getElementById('detail-industry-context');
    const detailStrategy = document.getElementById('detail-strategy');
    const detailBenchmarking = document.getElementById('detail-benchmarking');
    const detailMonetization = document.getElementById('detail-monetization');
    const detailInvestment = document.getElementById('detail-investment');
    const detailFinancialImpact = document.getElementById('detail-financial-impact');
    const detailPerformanceMetrics = document.getElementById('detail-performance-metrics');
    const detailRecommendations = document.getElementById('detail-recommendations');
    const detailViews = document.getElementById('detail-views');
    const detailLikes = document.getElementById('detail-likes');
    const detailShares = document.getElementById('detail-shares');

    // Action buttons
    const btnLike = document.getElementById('btn-like');
    const btnShare = document.getElementById('btn-share');
    const btnDownload = document.getElementById('btn-download');

    // Load existing stories
    fetchStories();

    // Handle story form submission
    storyForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const companyName = document.getElementById('company-name').value;
        const industry = document.getElementById('industry').value;

        if (!companyName || !industry) {
            alert('Please enter both company name and industry');
            return;
        }

        // Show loading indicator
        storyLoading.style.display = 'block';

        // Call API to generate story
        generateStory(companyName, industry);
    });

    // Generate a sustainability story
    function generateStory(companyName, industry) {
        fetch('/api/storytelling', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                company_name: companyName,
                industry: industry
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to generate story');
            }
            return response.json();
        })
        .then(data => {
            // Hide loading indicator
            storyLoading.style.display = 'none';

            // Display the generated story
            displayStoryDetail(data);

            // Refresh stories list
            fetchStories();
        })
        .catch(error => {
            console.error('Error generating story:', error);
            storyLoading.style.display = 'none';
            alert('Failed to generate story. Please try again.');
        });
    }

    // Fetch existing stories
    function fetchStories() {
        // This would call the API in a real implementation
        // For now, we'll use mock data
        const mockStories = [
            {
                id: 1,
                title: 'Sustainable Transformation Strategy',
                company_name: 'EcoTech Solutions',
                industry: 'Technology',
                created_at: '2025-02-15T14:30:00',
                metrics: {
                    views: 156,
                    likes: 42,
                    shares: 18
                }
            },
            {
                id: 2,
                title: 'Green Manufacturing Roadmap',
                company_name: 'IndustryCraft',
                industry: 'Manufacturing',
                created_at: '2025-02-10T09:15:00',
                metrics: {
                    views: 89,
                    likes: 23,
                    shares: 7
                }
            }
        ];

        displayStoriesList(mockStories);
    }

    // Display story detail
    function displayStoryDetail(story) {
        // Set basic story information
        detailTitle.textContent = `Sustainability Strategy for ${story.Company}`;
        detailCompanyIndustry.textContent = `${story.Company} | ${story.Industry}`;
        detailDate.textContent = new Date().toLocaleDateString();

        // Set story content sections
        detailIndustryContext.textContent = story.Industry_Context || 
            `The ${story.Industry} industry is facing increasing regulatory pressure, consumer demand for sustainability, and investor scrutiny on ESG performance.`;

        detailStrategy.textContent = story.Sustainability_Strategy || story.Sustainability_Strategy;
        detailMonetization.textContent = story.Monetization_Model || "Not available";
        detailInvestment.textContent = story.Investment_Pathway || "Not available";

        // Clear and populate benchmarking
        detailBenchmarking.innerHTML = '';
        const benchmarks = story.Competitor_Benchmarking || [];
        if (Array.isArray(benchmarks)) {
            benchmarks.forEach(benchmark => {
                const div = document.createElement('div');
                div.className = 'benchmark-item';
                div.textContent = benchmark;
                detailBenchmarking.appendChild(div);
            });
        } else if (typeof benchmarks === 'string') {
            const div = document.createElement('div');
            div.className = 'benchmark-item';
            div.textContent = benchmarks;
            detailBenchmarking.appendChild(div);
        }

        // Clear and populate financial impact
        detailFinancialImpact.innerHTML = '';
        const financialImpact = story.Estimated_Financial_Impact || {};

        for (const [key, value] of Object.entries(financialImpact)) {
            const div = document.createElement('div');
            div.className = 'financial-metric';

            const label = document.createElement('span');
            label.textContent = key.replace(/_/g, ' ');

            const valueSpan = document.createElement('span');
            valueSpan.className = 'financial-metric-value';

            // Add color coding based on value (green for positive, red for negative)
            if (value.toString().includes('+')) {
                valueSpan.classList.add('positive-value');
            } else if (value.toString().includes('-')) {
                valueSpan.classList.add('negative-value');
            }

            valueSpan.textContent = value;

            div.appendChild(label);
            div.appendChild(valueSpan);
            detailFinancialImpact.appendChild(div);
        }

        // Clear and populate performance metrics
        detailPerformanceMetrics.innerHTML = '';
        const metrics = story.Performance_Metrics || [];

        if (metrics.length > 0) {
            const metricsGrid = document.createElement('div');
            metricsGrid.className = 'metrics-grid';

            metrics.forEach(metric => {
                const div = document.createElement('div');
                div.className = 'metric-card';

                const metricName = document.createElement('div');
                metricName.className = 'metric-name';
                metricName.textContent = metric;

                div.appendChild(metricName);
                metricsGrid.appendChild(div);
            });

            detailPerformanceMetrics.appendChild(metricsGrid);
        } else {
            detailPerformanceMetrics.textContent = 'No performance metrics available';
        }

        // Clear and populate recommendations
        detailRecommendations.innerHTML = '';
        const recommendations = story.Actionable_Recommendations || [];

        recommendations.forEach(recommendation => {
            const li = document.createElement('li');
            li.textContent = recommendation;
            detailRecommendations.appendChild(li);
        });

        // Set initial metrics
        detailViews.textContent = '1';
        detailLikes.textContent = '0';
        detailShares.textContent = '0';

        // Show the detail view
        storyDetail.style.display = 'block';

        // Scroll to the detail view
        storyDetail.scrollIntoView({ behavior: 'smooth' });
    }

    // Display stories list
    function displayStoriesList(stories) {
        if (!stories || stories.length === 0) {
            storiesContainer.innerHTML = `
                <div class="text-center py-5">
                    <p class="text-muted">No stories available yet. Generate your first sustainability story!</p>
                </div>
            `;
            return;
        }

        let html = '';
        stories.forEach(story => {
            html += `
                <div class="story-card">
                    <div class="story-header">
                        <h3 class="story-title">${story.title}</h3>
                        <div class="story-meta">
                            <span>${story.company_name} | ${story.industry}</span>
                            <span>${formatDate(story.created_at)}</span>
                        </div>
                    </div>
                    <div class="story-body">
                        <p>Sustainability transformation strategy for ${story.company_name} in the ${story.industry} sector...</p>
                        <div class="story-metrics">
                            <div class="metric">
                                <i class="bi bi-eye"></i> ${story.metrics.views}
                            </div>
                            <div class="metric">
                                <i class="bi bi-hand-thumbs-up"></i> ${story.metrics.likes}
                            </div>
                            <div class="metric">
                                <i class="bi bi-share"></i> ${story.metrics.shares}
                            </div>
                        </div>
                        <div class="story-actions mt-3">
                            <button class="btn btn-primary btn-sm" onclick="viewStory(${story.id})">View Details</button>
                        </div>
                    </div>
                </div>
            `;
        });

        storiesContainer.innerHTML = html;
    }

    // Format date
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString();
    }

    // Add event listeners for action buttons
    btnLike.addEventListener('click', function() {
        const currentLikes = parseInt(detailLikes.textContent);
        detailLikes.textContent = currentLikes + 1;
        btnLike.disabled = true;
        btnLike.innerHTML = '<i class="bi bi-hand-thumbs-up-fill"></i> Liked';
    });

    btnShare.addEventListener('click', function() {
        const currentShares = parseInt(detailShares.textContent);
        detailShares.textContent = currentShares + 1;
        alert('Story sharing would be implemented in a production environment.');
    });

    btnDownload.addEventListener('click', function() {
        alert('PDF download would be implemented in a production environment.');
    });

    // Global function to view a story (needs to be global for onclick)
    window.viewStory = function(storyId) {
        alert(`In a production environment, this would load story #${storyId}`);
    };
});
</script>
{% endblock %}