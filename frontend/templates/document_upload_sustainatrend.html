{% extends "layouts/sustainatrend_inspired_layout.html" %}

{% block title %}Document Analysis - SustainaTrend™{% endblock %}

{% block header_title %}Document Analysis{% endblock %}

{% block header_actions %}
<span class="finchat-badge finchat-badge-primary">AI-Powered</span>
{% endblock %}

{% block additional_styles %}
<style>
    .finchat-drop-area {
        border: 2px dashed var(--fc-border);
        padding: 2rem;
        border-radius: var(--fc-radius-lg);
        text-align: center;
        transition: all 0.2s;
        cursor: pointer;
        margin-bottom: 1.5rem;
        background-color: var(--fc-bg);
    }
    
    .finchat-drop-area:hover,
    .finchat-drop-area.drag-active {
        border-color: var(--fc-primary);
        background-color: rgba(var(--primary-rgb), 0.05);
    }
    
    .finchat-upload-icon {
        font-size: 2.5rem;
        color: var(--fc-primary);
        margin-bottom: 1rem;
    }
    
    .finchat-file-preview {
        display: flex;
        align-items: center;
        padding: 1rem;
        background-color: var(--fc-bg);
        border-radius: var(--fc-radius);
        margin-bottom: 1rem;
        border: 1px solid var(--fc-border);
    }
    
    .finchat-file-icon {
        font-size: 1.5rem;
        color: var(--fc-primary);
        margin-right: 1rem;
    }
    
    .finchat-file-details {
        flex: 1;
    }
    
    .finchat-file-name {
        font-weight: 600;
        margin-bottom: 0.25rem;
    }
    
    .finchat-file-meta {
        font-size: 0.85rem;
        color: var(--fc-text-secondary);
    }
    
    .finchat-progress-container {
        height: 4px;
        border-radius: 2px;
        background-color: var(--fc-border);
        margin-top: 0.5rem;
        overflow: hidden;
    }
    
    .finchat-progress-fill {
        height: 100%;
        background-color: var(--fc-primary);
        width: 0%;
        transition: width 0.3s;
    }
    
    .finchat-analysis-section {
        margin-top: 2rem;
    }
    
    .finchat-section-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .finchat-metric-card {
        background-color: white;
        border-radius: var(--fc-radius);
        padding: 1rem;
        border: 1px solid var(--fc-border);
        margin-bottom: 1rem;
        transition: all 0.2s;
    }
    
    .finchat-metric-card:hover {
        border-color: var(--fc-primary);
        box-shadow: var(--fc-shadow);
        transform: translateY(-2px);
    }
    
    .finchat-metric-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }
    
    .finchat-metric-title {
        font-weight: 600;
    }
    
    .finchat-metric-value {
        color: var(--fc-primary);
        font-weight: 700;
    }
    
    .finchat-metric-desc {
        font-size: 0.9rem;
        color: var(--fc-text-secondary);
    }
    
    .finchat-compliance-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .finchat-compliance-item {
        background-color: white;
        border-radius: var(--fc-radius);
        padding: 1rem;
        text-align: center;
        border: 1px solid var(--fc-border);
    }
    
    .finchat-compliance-score {
        font-size: 1.75rem;
        font-weight: 700;
        margin: 0.5rem 0;
    }
    
    .finchat-compliance-score.high {
        color: #10b981;
    }
    
    .finchat-compliance-score.medium {
        color: #f59e0b;
    }
    
    .finchat-compliance-score.low {
        color: #ef4444;
    }
    
    .finchat-tag {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 2rem;
        font-size: 0.75rem;
        background-color: rgba(var(--primary-rgb), 0.1);
        color: var(--fc-primary);
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }
</style>
{% endblock %}

{% block main_content %}
<!-- Document Upload Section -->
<div class="finchat-section">
    <h2 class="finchat-section-title">
        <i class="fas fa-file-pdf"></i> Upload Sustainability Document
    </h2>
    <p class="finchat-section-desc">Upload sustainability reports, ESG disclosures, or regulatory filings for AI-powered analysis and insights.</p>
    
    <div class="finchat-drop-area" id="dropArea">
        <i class="fas fa-cloud-upload-alt finchat-upload-icon"></i>
        <h3>Drag & Drop PDF Documents</h3>
        <p>or</p>
        <input type="file" id="fileInput" class="d-none" accept=".pdf">
        <button class="finchat-button" onclick="document.getElementById('fileInput').click()">
            <i class="fas fa-folder-open"></i> Browse Files
        </button>
        <p class="mt-3 text-muted">Maximum file size: 20MB</p>
    </div>
    
    <div class="finchat-file-preview" id="filePreviewContainer" style="display: none;">
        <div class="finchat-file-icon">
            <i class="fas fa-file-pdf"></i>
        </div>
        <div class="finchat-file-details">
            <div class="finchat-file-name" id="fileName">sustainability-report-2024.pdf</div>
            <div class="finchat-file-meta"><span id="fileSize">0 KB</span> • <span id="fileType">PDF Document</span></div>
            <div class="finchat-progress-container" id="uploadProgress" style="display: none;">
                <div class="finchat-progress-fill" id="progressFill"></div>
            </div>
        </div>
        <button class="finchat-button-icon" id="cancelUpload" title="Cancel">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <div class="finchat-options">
        <label class="finchat-checkbox">
            <input type="checkbox" id="ocrCheck">
            <span class="finchat-checkbox-label">Enable OCR for scanned documents</span>
        </label>
        <small class="finchat-help-text">Use Optical Character Recognition for better results with scanned reports (processing may take longer)</small>
    </div>
</div>

<!-- Analysis Results (Initially Hidden) -->
<div class="finchat-analysis-section" id="analysisResults" style="display: none;">
    <h2 class="finchat-section-title">
        <i class="fas fa-chart-line"></i> Document Analysis Results
    </h2>
    
    <!-- Executive Summary -->
    <div class="finchat-card mb-4">
        <div class="finchat-card-header">
            <h3 class="finchat-card-title"><i class="fas fa-file-alt me-2"></i>Executive Summary</h3>
        </div>
        <div class="finchat-card-body">
            <p id="executiveSummary" class="finchat-summary">
                This sustainability report demonstrates Company X's commitment to reducing environmental impact while maintaining strong social governance. Key highlights include a 15% reduction in carbon emissions, implementation of water conservation initiatives, and improved supply chain transparency. The report aligns with GRI standards and TCFD recommendations, though some areas of improvement remain in biodiversity impact assessment and scope 3 emissions reporting.
            </p>
        </div>
    </div>
    
    <!-- Extracted Metrics -->
    <div class="finchat-grid">
        <div class="finchat-card">
            <div class="finchat-card-header">
                <h3 class="finchat-card-title"><i class="fas fa-calculator me-2"></i>ESG Metrics</h3>
                <span class="finchat-badge" id="metricsCount">12</span>
            </div>
            <div class="finchat-card-body">
                <div id="metricsResults">
                    <div class="finchat-metric-card">
                        <div class="finchat-metric-header">
                            <div class="finchat-metric-title">Carbon Emissions</div>
                            <div class="finchat-metric-value">-15.4%</div>
                        </div>
                        <div class="finchat-metric-desc">Year-over-year reduction in Scope 1 & 2 emissions</div>
                        <div class="finchat-tags mt-2">
                            <span class="finchat-tag">Environmental</span>
                            <span class="finchat-tag">Climate</span>
                        </div>
                    </div>
                    
                    <div class="finchat-metric-card">
                        <div class="finchat-metric-header">
                            <div class="finchat-metric-title">Water Intensity</div>
                            <div class="finchat-metric-value">2.3 m³/unit</div>
                        </div>
                        <div class="finchat-metric-desc">Reduction from 2.8 m³/unit in previous reporting period</div>
                        <div class="finchat-tags mt-2">
                            <span class="finchat-tag">Environmental</span>
                            <span class="finchat-tag">Water</span>
                        </div>
                    </div>
                    
                    <div class="finchat-metric-card">
                        <div class="finchat-metric-header">
                            <div class="finchat-metric-title">Renewable Energy</div>
                            <div class="finchat-metric-value">38%</div>
                        </div>
                        <div class="finchat-metric-desc">Of total energy consumption from renewable sources</div>
                        <div class="finchat-tags mt-2">
                            <span class="finchat-tag">Environmental</span>
                            <span class="finchat-tag">Energy</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Framework Compliance -->
        <div class="finchat-card">
            <div class="finchat-card-header">
                <h3 class="finchat-card-title"><i class="fas fa-check-circle me-2"></i>Compliance Assessment</h3>
                <span class="finchat-badge" id="frameworksCount">4</span>
            </div>
            <div class="finchat-card-body">
                <div id="complianceResults">
                    <div class="finchat-compliance-grid">
                        <div class="finchat-compliance-item">
                            <div>GRI</div>
                            <div class="finchat-compliance-score high">87%</div>
                        </div>
                        <div class="finchat-compliance-item">
                            <div>TCFD</div>
                            <div class="finchat-compliance-score high">92%</div>
                        </div>
                        <div class="finchat-compliance-item">
                            <div>SASB</div>
                            <div class="finchat-compliance-score medium">74%</div>
                        </div>
                        <div class="finchat-compliance-item">
                            <div>CSRD</div>
                            <div class="finchat-compliance-score medium">68%</div>
                        </div>
                    </div>
                    
                    <div class="finchat-section-title">
                        <i class="fas fa-exclamation-triangle"></i> Compliance Gaps
                    </div>
                    <div class="finchat-metric-card">
                        <div class="finchat-metric-header">
                            <div class="finchat-metric-title">Scope 3 Emissions</div>
                        </div>
                        <div class="finchat-metric-desc">Missing detailed breakdown of value chain emissions required by CSRD Article 8</div>
                    </div>
                    <div class="finchat-metric-card">
                        <div class="finchat-metric-header">
                            <div class="finchat-metric-title">Biodiversity Impact</div>
                        </div>
                        <div class="finchat-metric-desc">Missing assessment of impacts on biodiversity and ecosystems required by GRI 304</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block insights_panel %}
<div class="finchat-insights-panel">
    <div class="finchat-insights-header">
        <h3>Document Insights</h3>
    </div>
    <div class="finchat-insights-content">
        <div class="finchat-insight-item">
            <div class="finchat-insight-icon">
                <i class="fas fa-lightbulb"></i>
            </div>
            <div class="finchat-insight-content">
                <h4>Extract KPIs Automatically</h4>
                <p>Upload your sustainability report to automatically extract environmental metrics, social indicators, and governance KPIs.</p>
            </div>
        </div>
        <div class="finchat-insight-item">
            <div class="finchat-insight-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="finchat-insight-content">
                <h4>Framework Compliance</h4>
                <p>Get instant assessment of your document's compliance with GRI, SASB, TCFD, CSRD and other sustainability frameworks.</p>
            </div>
        </div>
        <div class="finchat-insight-item">
            <div class="finchat-insight-icon">
                <i class="fas fa-comments"></i>
            </div>
            <div class="finchat-insight-content">
                <h4>Ask Questions About Your Document</h4>
                <p>Use the AI co-pilot to ask natural language questions about your sustainability report.</p>
            </div>
        </div>
        <div class="finchat-insight-item">
            <div class="finchat-insight-icon">
                <i class="fas fa-file-alt"></i>
            </div>
            <div class="finchat-insight-content">
                <h4>Auto-Generate Stories</h4>
                <p>Transform your document insights into compelling sustainability stories for stakeholders.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block chat_interface %}
<div class="finchat-chat">
    <div class="finchat-chat-header">
        <div class="finchat-chat-title">
            <i class="fas fa-robot"></i> Document Co-Pilot
        </div>
    </div>
    <div class="finchat-chat-messages" id="chatMessages">
        <div class="finchat-chat-message finchat-chat-message-ai">
            <div class="finchat-chat-avatar">
                <i class="fas fa-robot"></i>
            </div>
            <div class="finchat-chat-bubble">
                <p>Hello! I'm your Document Analysis Co-Pilot. Upload a sustainability document and I can help you:</p>
                <ul>
                    <li>Extract key sustainability metrics and KPIs</li>
                    <li>Assess framework compliance (GRI, SASB, TCFD, CSRD)</li>
                    <li>Identify reporting gaps and improvement opportunities</li>
                    <li>Answer questions about the document content</li>
                </ul>
                <p>What would you like to do today?</p>
            </div>
        </div>
    </div>
    <div class="finchat-chat-input">
        <input type="text" class="finchat-chat-input-field" id="chatInput" placeholder="Ask me about sustainability documents..." />
        <button class="finchat-chat-send-btn" id="sendMessageBtn">
            <i class="fas fa-paper-plane"></i>
        </button>
    </div>
    <div class="finchat-chat-suggested-prompts">
        <button class="finchat-suggested-prompt">What frameworks are supported?</button>
        <button class="finchat-suggested-prompt">How does document analysis work?</button>
        <button class="finchat-suggested-prompt">What KPIs can be extracted?</button>
    </div>
</div>
{% endblock %}

{% block additional_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // DOM Elements
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        const filePreviewContainer = document.getElementById('filePreviewContainer');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const fileType = document.getElementById('fileType');
        const uploadProgress = document.getElementById('uploadProgress');
        const progressFill = document.getElementById('progressFill');
        const cancelUpload = document.getElementById('cancelUpload');
        const analysisResults = document.getElementById('analysisResults');
        
        // Drag and drop functionality
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            dropArea.classList.add('drag-active');
        }
        
        function unhighlight() {
            dropArea.classList.remove('drag-active');
        }
        
        dropArea.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                handleFiles(files);
            }
        }
        
        fileInput.addEventListener('change', function() {
            if (fileInput.files.length > 0) {
                handleFiles(fileInput.files);
            }
        });
        
        function handleFiles(files) {
            const file = files[0]; // Only process the first file for now
            
            // Check if it's a PDF
            if (file.type !== 'application/pdf') {
                alert('Please upload a PDF file');
                return;
            }
            
            // Check file size (max 20MB)
            if (file.size > 20 * 1024 * 1024) {
                alert('File size exceeds 20MB limit');
                return;
            }
            
            displayFilePreview(file);
            
            // Simulate file upload process
            simulateUpload(file);
        }
        
        function displayFilePreview(file) {
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileType.textContent = 'PDF Document';
            filePreviewContainer.style.display = 'flex';
            uploadProgress.style.display = 'block';
        }
        
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' bytes';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            else return (bytes / 1048576).toFixed(1) + ' MB';
        }
        
        function simulateUpload(file) {
            let progress = 0;
            progressFill.style.width = '0%';
            
            const interval = setInterval(() => {
                progress += 5;
                progressFill.style.width = progress + '%';
                
                if (progress >= 100) {
                    clearInterval(interval);
                    uploadProgress.style.display = 'none';
                    
                    // Show analysis results after "processing"
                    setTimeout(() => {
                        analysisResults.style.display = 'block';
                        
                        // Add a message from the AI
                        addAiMessage('I\'ve analyzed your document "' + file.name + '" and extracted key sustainability metrics, framework compliance, and insights. You can now explore the results or ask me specific questions about the document.');
                    }, 1000);
                }
            }, 100);
        }
        
        cancelUpload.addEventListener('click', function() {
            filePreviewContainer.style.display = 'none';
            fileInput.value = '';
            analysisResults.style.display = 'none';
        });
        
        // Chat functionality
        const chatInput = document.getElementById('chatInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const chatMessages = document.getElementById('chatMessages');
        const suggestedPrompts = document.querySelectorAll('.finchat-suggested-prompt');
        
        sendMessageBtn.addEventListener('click', sendMessage);
        
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        suggestedPrompts.forEach(prompt => {
            prompt.addEventListener('click', function() {
                chatInput.value = this.textContent;
                sendMessage();
            });
        });
        
        function sendMessage() {
            const message = chatInput.value.trim();
            if (message === '') return;
            
            // Add user message
            addUserMessage(message);
            
            // Clear input
            chatInput.value = '';
            
            // Simulate AI response (in a real app, this would be an API call)
            setTimeout(() => {
                let aiResponse = '';
                
                if (message.toLowerCase().includes('framework')) {
                    aiResponse = 'SustainaTrend™ supports analysis against all major sustainability frameworks including:<ul><li>GRI (Global Reporting Initiative)</li><li>SASB (Sustainability Accounting Standards Board)</li><li>TCFD (Task Force on Climate-related Financial Disclosures)</li><li>CSRD (Corporate Sustainability Reporting Directive)</li><li>ESRS (European Sustainability Reporting Standards)</li></ul>The AI analyzes your document against these frameworks and provides a compliance score with specific gap analysis.';
                } else if (message.toLowerCase().includes('kpi') || message.toLowerCase().includes('metric')) {
                    aiResponse = 'The document analysis can extract various sustainability KPIs, including:<ul><li>Environmental: Carbon emissions, energy usage, water consumption, waste metrics, renewable energy percentage</li><li>Social: Diversity statistics, employee turnover, health & safety metrics, community investment</li><li>Governance: Board diversity, ethics violations, pay ratios, supply chain compliance</li></ul>The exact metrics extracted depend on what\'s present in your document.';
                } else if (message.toLowerCase().includes('analysis') || message.toLowerCase().includes('work')) {
                    aiResponse = 'Here\'s how the document analysis process works:<ol><li>You upload a sustainability report or ESG disclosure</li><li>Our AI system processes the document, extracting text and tabular data</li><li>The system identifies metrics, KPIs, and statements related to sustainability</li><li>It compares the content against framework requirements</li><li>The AI generates a compliance assessment and identifies reporting gaps</li><li>You can then ask questions about the document content</li></ol>';
                } else {
                    aiResponse = 'I\'d be happy to help with that. After you upload a document, I can analyze it and provide insights on your sustainability reporting. Is there anything specific about document analysis you\'d like to know?';
                }
                
                addAiMessage(aiResponse);
            }, 1000);
        }
        
        function addUserMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.className = 'finchat-chat-message finchat-chat-message-user';
            messageElement.innerHTML = `
                <div class="finchat-chat-bubble">
                    ${message}
                </div>
            `;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function addAiMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.className = 'finchat-chat-message finchat-chat-message-ai';
            messageElement.innerHTML = `
                <div class="finchat-chat-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="finchat-chat-bubble">
                    ${message}
                </div>
            `;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    });
</script>
{% endblock %}